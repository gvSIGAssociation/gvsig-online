{% extends "base.html" %} 
{% load staticfiles %} 
{% load i18n %} 

{% block content %}
<div class="row">
	<div class="col-md-12">
		<div class="row">
			<div class="col-md-12 form-group">
				<div class="box-tools pull-right">
					<a href="{% url 'connection_list' %}" class="btn btn-default btn-sm">
						<i class="fa fa-arrow-left margin-r-5"></i> {% trans "Back to connections" %}
					</a>
				</div>
			</div>
		</div>

		<div class="box box-primary">
			<div class="box-header with-border">
				<span class="label label-primary pull-right">{{ connection.name }}</span>
			</div>
			<div class="box-body">
				<ul class="nav nav-tabs">
					<li class="active">
						<a href="#tab-triggers" data-toggle="tab">{% trans "Triggers" %}</a>
					</li>
					<!-- Futuras pestañas pueden añadirse aquí -->
				</ul>
				
				<div class="tab-content" style="padding-top: 15px;">
					<!-- Tab Triggers -->
					<div class="tab-pane active" id="tab-triggers">
						<div class="row" style="margin-bottom: 10px;">
							<div class="col-md-6">
								<div class="input-group input-group-sm" style="max-width: 300px;">
									<input type="text" class="form-control" id="triggers-search" placeholder="{% trans 'Search...' %}">
									<span class="input-group-btn">
										<button class="btn btn-default" type="button" id="triggers-search-btn">
											<i class="fa fa-search"></i>
										</button>
									</span>
								</div>
							</div>
							<div class="col-md-6">
								<div class="box-tools pull-right">
									<a href="{% url 'connection_trigger_add' connection.id %}" class="btn btn-success btn-sm">
										<i class="fa fa-plus margin-r-5"></i> {% trans "Add trigger" %}
									</a>
								</div>
							</div>
						</div>
						
						<table class="table" id="triggers-table">
							<thead>
								<tr>
									<th>{% trans "Name" %}</th>
									<th>{% trans "Description" %}</th>
									<th>{% trans "Event" %}</th>
									<th>{% trans "Scope" %}</th>
									<th></th>
									<th></th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								{% for trigger in triggers %}
								<tr data-id="{{ trigger.id }}">
									<td>
										<strong>{{ trigger.name }}</strong>
										{% if trigger.is_calculated_field %}
											<span class="label label-warning" title="{% trans 'Can be used as calculated field' %}">
												<i class="fa fa-calculator"></i>
											</span>
										{% endif %}
									</td>
									<td>{{ trigger.description|default:"-"|truncatechars:60 }}</td>
									<td>
										<span class="label label-default">{{ trigger.timing }}</span>
										{% for evt in trigger.get_events_list %}
											<span class="label label-info">{{ evt }}</span>
										{% endfor %}
									</td>
									<td>
										{% if trigger.scope == 'global' %}
											<span class="label label-primary">{% trans "Global" %}</span>
										{% else %}
											<span class="label label-default" title="{{ trigger.schemas }}">
												{% trans "Schemas" %} ({{ trigger.get_schemas_list|length }})
											</span>
										{% endif %}
									</td>
									<td>
										<a href="{% url 'connection_trigger_update' connection.id trigger.id %}" 
											class="btn btn-success" title="{% trans 'Edit' %}">
											<i class="fa fa-edit"></i>
										</a>
									</td>
									<td>
										<button type="button" class="btn btn-info btn-duplicate-trigger" 
											data-id="{{ trigger.id }}" data-name="{{ trigger.name }}"
											title="{% trans 'Duplicate to another connection' %}">
											<i class="fa fa-copy"></i>
										</button>
									</td>
									<td>
										<button type="button" class="btn btn-danger btn-delete-trigger" 
											data-id="{{ trigger.id }}" data-name="{{ trigger.name }}"
											title="{% trans 'Delete' %}">
											<i class="fa fa-trash"></i>
										</button>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
						
						<!-- Paginación estilo Bootstrap -->
						<div class="box-footer clearfix" id="triggers-pagination-footer" style="display: none;">
							<ul class="pagination pagination-sm no-margin pull-right" id="triggers-pagination">
							</ul>
							<div class="pull-left" style="margin-top: 5px;">
								<span class="text-muted" id="triggers-info"></span>
							</div>
						</div>
					</div>
					<!-- Fin Tab Triggers -->
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="modal-delete-trigger" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title">{% trans "Delete trigger" %}</h4>
			</div>
			<div class="modal-body">
				<p>{% trans "Are you sure you want to delete this trigger? This action cannot be undone." %}</p>
				<p><strong id="delete-trigger-name"></strong></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
				<button type="button" class="btn btn-danger" id="btn-confirm-delete-trigger">{% trans "Delete" %}</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal Duplicar Trigger -->
<div class="modal fade" id="modal-duplicate-trigger" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title">{% trans "Duplicate trigger" %}</h4>
			</div>
			<div class="modal-body">
				<p>{% trans "Select the target connection to duplicate this trigger:" %}</p>
				<p><strong id="duplicate-trigger-name"></strong></p>
				<div class="form-group">
					<label for="target-connection">{% trans "Target connection" %} (PostGIS)</label>
					<select id="target-connection" class="form-control">
						<option value="">{% trans "Select a connection..." %}</option>
						{% for conn in other_connections %}
						<option value="{{ conn.id }}">{{ conn.name }} ({{ conn.type }})</option>
						{% endfor %}
					</select>
					<small class="text-muted">{% trans "Only PostGIS connections are shown" %}</small>
				</div>
				{% if not other_connections %}
				<div class="alert alert-warning">
					<i class="fa fa-warning"></i>
					{% trans "No other PostGIS connections available." %}
				</div>
				{% endif %}
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
				<button type="button" class="btn btn-primary" id="btn-confirm-duplicate-trigger" {% if not other_connections %}disabled{% endif %}>
					{% trans "Duplicate" %}
				</button>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block extra-scripts %}
<script>
	$('#menu-manage-services').addClass("active");
	$('#submenu-connections').addClass("active");
</script>
<script>
$(document).ready(function() {
	var connectionId = {{ connection.id }};
	var triggersUrl = '/gvsigonline/services/api/connections/' + connectionId + '/triggers/';
	var currentTriggerId = null;
	
	// Inicializar DataTables con paginación personalizada
	var table = $('#triggers-table').DataTable({
		responsive: true,
		language: {
			processing		: '{% trans "Processing request..." %}',
			search			: '',
			lengthMenu		: '',
			info			: '',
			infoEmpty		: '',
			infoFiltered	: '',
			infoPostFix		: "",
			loadingRecords	: '{% trans "Loading..." %}',
			zeroRecords		: '{% trans "No records available" %}',
			emptyTable		: '{% trans "No triggers defined for this connection" %}',
			paginate: {
				first		: '{% trans "First" %}',
				previous	: '{% trans "Previous" %}',
				next		: '{% trans "Next" %}',
				last		: '{% trans "Last" %}'
			},
			aria: {
				sortAscending: '{% blocktrans with sep=": " %}{{sep}}Sort ascending{% endblocktrans %}',
				sortDescending: '{% blocktrans with sep=": " %}{{sep}}Sort descending{% endblocktrans %}'
			}
		},
		"columnDefs": [
			{ "orderable": false, "targets": [4, 5, 6] }
		],
		"dom": 'T<"clear">rt',
		"paging": true,
		"pageLength": 10,
		"bLengthChange": false,
		"searching": true,
		"info": false,
		"drawCallback": function(settings) {
			updateCustomPagination(this.api());
		}
	});
	
	// Función para actualizar paginación personalizada estilo Bootstrap
	function updateCustomPagination(api) {
		var info = api.page.info();
		var $footer = $('#triggers-pagination-footer');
		var $pagination = $('#triggers-pagination');
		var $info = $('#triggers-info');
		
		if (info.pages <= 1) {
			$footer.hide();
			return;
		}
		
		$footer.show();
		$pagination.empty();
		
		// Info text
		var start = info.start + 1;
		var end = info.end;
		var total = info.recordsDisplay;
		$info.text('{% trans "Showing" %} ' + start + ' {% trans "to" %} ' + end + ' {% trans "of" %} ' + total + ' {% trans "triggers" %}');
		
		// First & Previous
		if (info.page > 0) {
			$pagination.append('<li><a href="#" data-page="0">&laquo; {% trans "First" %}</a></li>');
			$pagination.append('<li><a href="#" data-page="' + (info.page - 1) + '">{% trans "Previous" %}</a></li>');
		} else {
			$pagination.append('<li class="disabled"><span>&laquo; {% trans "First" %}</span></li>');
			$pagination.append('<li class="disabled"><span>{% trans "Previous" %}</span></li>');
		}
		
		// Page numbers
		var startPage = Math.max(0, info.page - 2);
		var endPage = Math.min(info.pages - 1, info.page + 2);
		
		for (var i = startPage; i <= endPage; i++) {
			if (i === info.page) {
				$pagination.append('<li class="active"><span>' + (i + 1) + '</span></li>');
			} else {
				$pagination.append('<li><a href="#" data-page="' + i + '">' + (i + 1) + '</a></li>');
			}
		}
		
		// Next & Last
		if (info.page < info.pages - 1) {
			$pagination.append('<li><a href="#" data-page="' + (info.page + 1) + '">{% trans "Next" %}</a></li>');
			$pagination.append('<li><a href="#" data-page="' + (info.pages - 1) + '">{% trans "Last" %} &raquo;</a></li>');
		} else {
			$pagination.append('<li class="disabled"><span>{% trans "Next" %}</span></li>');
			$pagination.append('<li class="disabled"><span>{% trans "Last" %} &raquo;</span></li>');
		}
	}
	
	// Click en paginación
	$('#triggers-pagination').on('click', 'a', function(e) {
		e.preventDefault();
		var page = $(this).data('page');
		if (page !== undefined) {
			table.page(page).draw('page');
		}
	});
	
	// Búsqueda personalizada
	$('#triggers-search').on('keyup', function() {
		table.search($(this).val()).draw();
	});
	
	$('#triggers-search-btn').on('click', function() {
		table.search($('#triggers-search').val()).draw();
	});
	
	// Confirmar eliminación
	$('#triggers-table tbody').on('click', '.btn-delete-trigger', function() {
		currentTriggerId = $(this).data('id');
		var triggerName = $(this).data('name');
		$('#delete-trigger-name').text(triggerName);
		$('#modal-delete-trigger').modal('show');
	});
	
	// Eliminar trigger
	$('#btn-confirm-delete-trigger').click(function() {
		if (!currentTriggerId) return;
		
		$.ajax({
			type: 'DELETE',
			url: triggersUrl + currentTriggerId + '/',
			beforeSend: function(xhr) {
				xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
			},
			success: function() {
				$('#modal-delete-trigger').modal('hide');
				location.reload();
			},
			error: function(xhr) {
				$('#modal-delete-trigger').modal('hide');
				messageBox.show('error', '{% trans "Error deleting trigger" %}');
			}
		});
	});
	
	// Duplicar trigger
	$('#triggers-table tbody').on('click', '.btn-duplicate-trigger', function() {
		currentTriggerId = $(this).data('id');
		var triggerName = $(this).data('name');
		$('#duplicate-trigger-name').text(triggerName);
		$('#target-connection').val('');
		$('#modal-duplicate-trigger').modal('show');
	});
	
	// Confirmar duplicación
	$('#btn-confirm-duplicate-trigger').click(function() {
		if (!currentTriggerId) return;
		
		var targetConnectionId = $('#target-connection').val();
		if (!targetConnectionId) {
			messageBox.show('warning', '{% trans "Please select a target connection" %}');
			return;
		}
		
		var $btn = $(this);
		$btn.prop('disabled', true).html('{% trans "Duplicating..." %}');
		
		$.ajax({
			type: 'POST',
			url: '/gvsigonline/services/api/connection_trigger/duplicate/',
			beforeSend: function(xhr) {
				xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
			},
			data: {
				'trigger_id': currentTriggerId,
				'target_connection_id': targetConnectionId
			},
			success: function(response) {
				$('#modal-duplicate-trigger').modal('hide');
				$btn.prop('disabled', false).html('{% trans "Duplicate" %}');
				if (response.success) {
					messageBox.show('success', '{% trans "Trigger duplicated successfully as:" %} ' + response.name);
				}
			},
			error: function(xhr) {
				$('#modal-duplicate-trigger').modal('hide');
				$btn.prop('disabled', false).html('{% trans "Duplicate" %}');
				var error = '{% trans "Error duplicating trigger" %}';
				try {
					var resp = JSON.parse(xhr.responseText);
					if (resp.error) error = resp.error;
				} catch(e) {}
				messageBox.show('error', error);
			}
		});
	});
});
</script>
{% endblock %}
