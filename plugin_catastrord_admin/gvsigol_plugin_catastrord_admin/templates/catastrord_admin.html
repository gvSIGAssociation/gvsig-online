{% extends "base.html" %}
{% load staticfiles %}
{% load i18n %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="box">
      <div class="box-header with-border">
        <h3 class="box-title">
          <i class="fa fa-database"></i>
          {% trans "Catastro RD – Administración y Migración SIC" %}
        </h3>
      </div>

      <div class="box-body">

        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist" id="catastrord-tabs">
          <li class="active">
            <a href="#tab-projects" data-toggle="tab">
              <i class="fa fa-folder-open"></i> {% trans "Proyectos" %}
            </a>
          </li>
          <li>
            <a href="#tab-applications" data-toggle="tab">
              <i class="fa fa-th-large"></i> {% trans "Aplicaciones" %}
            </a>
          </li>
          <li>
            <a href="#tab-migrations" data-toggle="tab">
              <i class="fa fa-exchange"></i> {% trans "Migraciones" %}
            </a>
          </li>
          <li>
            <a href="#tab-enumerations" data-toggle="tab">
              <i class="fa fa-list-ul"></i> {% trans "Enumeraciones" %}
            </a>
          </li>
        </ul>

        <div class="tab-content" style="margin-top: 15px;">

          {# ========================================================== #}
          {# TAB 1: PROYECTOS                                           #}
          {# ========================================================== #}
          <div class="tab-pane active" id="tab-projects">
            <div class="row">
              <div class="col-md-12">

                <div class="clearfix" style="margin-bottom: 10px;">
                  <button class="btn btn-default" id="refresh-projects">
                    <i class="fa fa-refresh"></i> {% trans "Refrescar" %}
                  </button>
                </div>

                <form id="form-new-project" class="form-inline" style="margin-bottom: 15px;" method="post">
                  <div class="form-group">
                    <label for="projectType" class="control-label">
                      {% trans "Tipo de proyecto" %}
                    </label>
                    <select name="projectType" id="projectType" class="form-control input-sm" required>
                      <option value="cadastral_edition">{% trans "Edición catastral" %}</option>
                      <option value="cadastral_investigation">{% trans "Investigación catastral" %}</option>
                      <option value="cadastral_inspection_template">{% trans "Plantilla inspección" %}</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fa fa-plus"></i> {% trans "Crear proyecto" %}
                  </button>
                </form>

                <table class="table table-striped table-bordered table-hover" id="table-projects">
                  <thead>
                    <tr>
                      <th style="width: 80px;">ID</th>
                      <th>{% trans "Tipo" %}</th>
                      <th>{% trans "Workspace" %}</th>
                      <th>{% trans "Proyecto OL" %}</th>
                      <th>{% trans "Creado por" %}</th>
                      <th class="text-center" style="width: 130px;">{% trans "Acciones" %}</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-projects">
                    {# Rellenado por JS vía /catastrord/project/ #}
                  </tbody>
                </table>

                <p class="text-muted small">
                  {% trans "NOTA: esta tabla se alimenta de la API /catastrord/project/. Ajusta las columnas según tu serializer." %}
                </p>

              </div>
            </div>
          </div>

          {# ========================================================== #}
          {# TAB 2: APLICACIONES                                        #}
          {# ========================================================== #}
          <div class="tab-pane" id="tab-applications">
            <div class="row">
              <div class="col-md-12">

                <div class="clearfix" style="margin-bottom: 10px;">
                  <button class="btn btn-default" id="refresh-applications">
                    <i class="fa fa-refresh"></i> {% trans "Refrescar" %}
                  </button>
                </div>

                <form id="form-new-application" class="form-inline" style="margin-bottom: 15px;" method="post">
                  <div class="form-group">
                    <label for="appName" class="control-label">
                      {% trans "Nombre de la aplicación" %}
                    </label>
                    <input type="text" name="appName" id="appName"
                           class="form-control input-sm" required
                           placeholder="{% trans 'Nombre interno (único)' %}">
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fa fa-plus"></i> {% trans "Crear aplicación" %}
                  </button>
                </form>

                <table class="table table-striped table-bordered table-hover" id="table-applications">
                  <thead>
                    <tr>
                      <th style="width: 80px;">ID</th>
                      <th>{% trans "Nombre" %}</th>
                      <th>{% trans "OL Application" %}</th>
                      <th>{% trans "Creada por" %}</th>
                      <th class="text-center" style="width: 130px;">{% trans "Acciones" %}</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-applications">
                    {# Rellenado por JS vía /catastrord/application/ #}
                  </tbody>
                </table>

                <p class="text-muted small">
                  {% trans "NOTA: esta tabla se alimenta de la API /catastrord/application/. Ajusta las columnas según tu serializer." %}
                </p>
              </div>
            </div>
          </div>

          {# ========================================================== #}
          {# TAB 3: MIGRACIONES                                         #}
          {# ========================================================== #}
          <div class="tab-pane" id="tab-migrations">
            <div class="row">
              <div class="col-md-6">

                <!-- MIGRACIÓN INMUEBLES (SICMigration) -->
                <div class="box box-info">
                  <div class="box-header with-border">
                    <h4 class="box-title">
                      <i class="fa fa-home"></i> {% trans "Migración de Inmuebles (SICMigration)" %}
                    </h4>
                  </div>
                  <div class="box-body">
                    <form id="form-migrate-inmuebles" method="post">
                      <div class="form-group">
                        <label>{% trans "Provincia" %}</label>
                        {# SELECT que envía nationalCadastralZoningReference como 'provincia' #}
                        <select name="provincia" id="provincia-inmuebles" class="form-control" required>
                          <option value="">{% trans "Seleccione una provincia..." %}</option>
                        </select>
                        <p class="help-block small">
                          {% trans "Se enviará el código nationalCadastralZoningReference (ej: 01, 02, 30) al backend." %}
                        </p>
                      </div>
                      <div class="form-group">
                        <label>{% trans "Municipio (código)" %}</label>
                        <input type="text" name="municipio" class="form-control" value="01">
                      </div>
                      <div class="form-group">
                        <label>{% trans "Distrito municipal (código)" %}</label>
                        <input type="text" name="distrito_municipal" class="form-control" value="01">
                      </div>
                      <div class="form-group">
                        <label>{% trans "Sección (código)" %}</label>
                        <input type="text" name="seccion" class="form-control" value="01">
                      </div>
                      <div class="form-group">
                        <label>{% trans "Sector/Barrio (código)" %}</label>
                        <input type="text" name="sector" class="form-control" value="24">
                      </div>
                      <div class="form-group">
                        <label>{% trans "Sub-barrio (código)" %}</label>
                        <input type="text" name="subbarrio" class="form-control" value="01">
                      </div>
                      <div class="form-group">
                        <label>{% trans "Manzana física (código)" %}</label>
                        <input type="text" name="manzana" class="form-control" value="029">
                      </div>

                      <button type="submit" class="btn btn-primary">
                        <i class="fa fa-play"></i> {% trans "Ejecutar migración de inmuebles" %}
                      </button>
                    </form>
                    <p class="help-block small">
                      {% trans "Internamente llama a SICMigration.post()." %}
                    </p>
                    <pre class="small" id="log-migrate-inmuebles"></pre>
                  </div>
                </div>

                <!-- MIGRACIÓN PARCELAS (SICMigrationParcelas) -->
                <div class="box box-warning">
                  <div class="box-header with-border">
                    <h4 class="box-title">
                      <i class="fa fa-map"></i> {% trans "Migración de Parcelas" %}
                    </h4>
                  </div>
                  <div class="box-body">
                    <form id="form-migrate-parcelas" method="post">
                      <div class="form-group">
                        <label>{% trans "Provincia" %}</label>
                        <select name="provincia" id="provincia-parcelas" class="form-control" required>
                          <option value="">{% trans "Seleccione una provincia..." %}</option>
                        </select>
                        <p class="help-block small">
                        </p>
                      </div>
                      <div class="checkbox">
                        <label>
                          <input type="checkbox" name="filtrar" checked>
                          {% trans "Filtrar por provincia (si no se marca migrará todo)" %}
                        </label>
                      </div>
                      <button type="submit" class="btn btn-warning">
                        <i class="fa fa-play"></i> {% trans "Migrar parcelas" %}
                      </button>
                    </form>
                    <pre class="small" id="log-migrate-parcelas"></pre>
                  </div>
                </div>

              </div>

              <div class="col-md-6">

                <!-- MIGRACIÓN ZONING (SICMigrationZoning) -->
                <div class="box box-success">
                  <div class="box-header with-border">
                    <h4 class="box-title">
                      <i class="fa fa-object-group"></i> {% trans "Migración de Zonificación" %}
                    </h4>
                  </div>
                  <div class="box-body">
                    <form id="form-migrate-zoning" method="post">
                      <p class="small text-muted">
                        {% trans "Selecciona qué niveles de zonificación migrar desde el esquema 'migration'." %}
                      </p>
                      <div class="checkbox"><label><input type="checkbox" name="provincia"> {% trans "Provincias" %}</label></div>
                      <div class="checkbox"><label><input type="checkbox" name="municipio"> {% trans "Municipios" %}</label></div>
                      <div class="checkbox"><label><input type="checkbox" name="distrito_municipal"> {% trans "Distritos Municipales" %}</label></div>
                      <div class="checkbox"><label><input type="checkbox" name="seccion"> {% trans "Secciones" %}</label></div>
                      <div class="checkbox"><label><input type="checkbox" name="sector"> {% trans "Sectores / Barrios / Parajes" %}</label></div>
                      <div class="checkbox"><label><input type="checkbox" name="subbarrio"> {% trans "Sub-barrios" %}</label></div>
                      <div class="checkbox"><label><input type="checkbox" name="manzana"> {% trans "Manzanas" %}</label></div>

                      <button type="submit" class="btn btn-success">
                        <i class="fa fa-play"></i> {% trans "Migrar zonificación seleccionada" %}
                      </button>
                    </form>
                    <pre class="small" id="log-migrate-zoning"></pre>
                  </div>
                </div>

                <!-- MIGRACIÓN PUNTOS (SICMigrationPuntos) -->
                <div class="box box-danger">
                  <div class="box-header with-border">
                    <h4 class="box-title">
                      <i class="fa fa-map-marker"></i> {% trans "Migración de Puntos" %}
                    </h4>
                  </div>
                  <div class="box-body">
                    <form id="form-migrate-puntos" method="post">
                      <div class="form-group">
                        <label>{% trans "SRID origen (geom / x,y)" %}</label>
                        <input type="number" name="srid_origen" class="form-control" value="32619">
                      </div>
                      <div class="form-group">
                        <label>{% trans "SRID destino (original_location)" %}</label>
                        <input type="number" name="srid_destino" class="form-control" placeholder="{% trans 'Vacío = SRID de RD_Point.original_location' %}">
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" name="calcular_este_norte" checked> {% trans "Calcular easting/northing desde la geometría" %}</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" name="truncar"> {% trans "Truncar RD_Point antes de migrar" %}</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" name="conservar_id_en_descripcion" checked> {% trans "Conservar ID fuente en la descripción" %}</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" name="anotar_z_si_no_hay_elevacion" checked> {% trans "Anotar Z en la descripción si no hay campo elevation" %}</label>
                      </div>

                      <button type="submit" class="btn btn-danger">
                        <i class="fa fa-play"></i> {% trans "Migrar puntos" %}
                      </button>
                    </form>
                    <pre class="small" id="log-migrate-puntos"></pre>
                  </div>
                </div>

                <!-- DELETE (limpieza) -->
                <div class="box box-default">
                  <div class="box-header with-border">
                    <h4 class="box-title">
                      <i class="fa fa-trash"></i> {% trans "Eliminar datos de Catastro LADM-RD" %}
                    </h4>
                  </div>
                  <div class="box-body">
                    <p class="text-danger small">
                      <strong>{% trans "PELIGRO:" %}</strong>
                      {% trans "esta operación llama a /catastrord/migrate/delete y borra datos masivamente." %}
                    </p>

                    <form id="form-delete-ladmrd" method="post">
                      <div class="row">
                        <div class="col-sm-4">
                          <label class="text-bold">{% trans "Parties / Derechos / Restricciones" %}</label>
                          <div class="checkbox"><label><input type="checkbox" name="party"> {% trans "Parties" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="rights"> {% trans "Rights" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="responsabilities"> {% trans "Responsibilities" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="restrictions"> {% trans "Restrictions" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="addresses"> {% trans "Addresses" %}</label></div>
                        </div>
                        <div class="col-sm-4">
                          <label class="text-bold">{% trans "Unidades / Edificaciones / Parqueos" %}</label>
                          <div class="checkbox"><label><input type="checkbox" name="parqueos"> {% trans "Parqueos" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="units"> {% trans "BuildingUnits (APARTAMENTOS)" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="parts"> {% trans "BuildingParts" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="buildings"> {% trans "Buildings" %}</label></div>
                        </div>
                        <div class="col-sm-4">
                          <label class="text-bold">{% trans "Zonificación / Parcelas / Predios" %}</label>
                          <div class="checkbox"><label><input type="checkbox" name="cadastralparcels"> {% trans "CadastralParcels (PREDIOS)" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="parcelas"> {% trans "Parcelas" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="manzanas"> {% trans "Manzanas" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="subbarrios"> {% trans "Sub-barrios" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="sectores"> {% trans "Sectores" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="secciones"> {% trans "Secciones" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="distritosmunicipales"> {% trans "Distritos Municipales" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="municipios"> {% trans "Municipios" %}</label></div>
                          <div class="checkbox"><label><input type="checkbox" name="provincias"> {% trans "Provincias" %}</label></div>
                        </div>
                      </div>

                      <div class="form-group" style="margin-top: 10px;">
                        <label>{% trans "Escribe ELIMINAR para confirmar" %}</label>
                        <input type="text" id="delete-confirm" class="form-control" placeholder="ELIMINAR">
                      </div>

                      <button type="submit" class="btn btn-danger" id="btn-delete-ladmrd" disabled>
                        <i class="fa fa-trash"></i> {% trans "Ejecutar borrado" %}
                      </button>
                    </form>
                    <pre class="small" id="log-delete-ladmrd"></pre>
                  </div>
                </div>

              </div>
            </div>
          </div>

          {# ========================================================== #}
          {# TAB 4: ENUMERACIONES                                       #}
          {# ========================================================== #}
          <div class="tab-pane" id="tab-enumerations">
            <div class="row">
              <div class="col-md-6">
                <div class="box box-primary">
                  <div class="box-header with-border">
                    <h4 class="box-title">
                      <i class="fa fa-list-ul"></i> {% trans "Creación de enumeraciones gvSIG Online" %}
                    </h4>
                  </div>
                  <div class="box-body">
                    <p class="small text-muted">
                      {% trans "Llama a /catastrord/enumerations y convierte los codelist de LADM-RD en objetos Enumeration/EnumerationItem." %}
                    </p>
                    <form id="form-enumerations" method="post">
                      <div class="checkbox">
                        <label>
                          <input type="checkbox" name="override">
                          {% trans "Sobrescribir enumeraciones existentes" %}
                        </label>
                      </div>
                      <button type="submit" class="btn btn-primary">
                        <i class="fa fa-play"></i> {% trans "Generar enumeraciones" %}
                      </button>
                    </form>
                    <pre class="small" id="log-enumerations"></pre>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div> <!-- /.tab-content -->
      </div>   <!-- /.box-body -->
    </div>     <!-- /.box -->
  </div>
</div>

{# ================================================================ #}
{# JS: llamadas AJAX a tus endpoints                                #}
{# ================================================================ #}
<script>
$(function () {

  var BASE = "/gvsigonline/catastrord/";

  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      var cookies = document.cookie.split(";");
      for (var i = 0; i < cookies.length; i++) {
        var cookie = $.trim(cookies[i]);
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  var csrftoken = getCookie("csrftoken");

  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      if (!(/^GET|HEAD|OPTIONS|TRACE$/.test(settings.type))) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    }
  });

  function showToast(type, message) {
    var alertClass = (type === "success") ? "alert-success" : "alert-danger";
    var icon = (type === "success") ? "fa-check" : "fa-exclamation-triangle";

    var alert = $('<div class="alert ' + alertClass + ' alert-dismissible" ' +
                  'style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 320px;">' +
                  '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                  '<i class="fa ' + icon + '"></i> ' + message + '</div>');
    $("body").append(alert);
    setTimeout(function() {
      alert.fadeOut(function() { alert.remove(); });
    }, 5000);
  }

  /* ====================== PROYECTOS ====================== */

  function loadProjects() {
    $.getJSON(BASE + "project/", function(data) {
      var tbody = $("#tbody-projects");
      tbody.empty();
      $.each(data, function(idx, item) {
        var row = $("<tr/>");
        row.append("<td>" + item.id + "</td>");
        row.append("<td>" + (item.projectType || "") + "</td>");
        row.append("<td>" + (item.workspace || "") + "</td>");
        row.append("<td>" + (item.projectOl || "") + "</td>");
        row.append("<td>" + (item.createdBy || "") + "</td>");
        var btnDel = '<button class="btn btn-danger btn-xs btn-delete-project" data-id="' + item.id + '">' +
                     '<i class="fa fa-trash"></i></button>';
        row.append('<td class="text-center">' + btnDel + "</td>");
        tbody.append(row);
      });
    }).fail(function(xhr) {
      showToast("error", "Error cargando proyectos: " + xhr.responseText);
    });
  }

  $("#refresh-projects").on("click", function() {
    loadProjects();
  });

  $("#tbody-projects").on("click", ".btn-delete-project", function() {
    var id = $(this).data("id");
    if (!confirm("¿Eliminar proyecto " + id + "?")) return;
    $.ajax({
      url: BASE + "project/" + id + "/",
      type: "DELETE",
      success: function() {
        showToast("success", "Proyecto eliminado.");
        loadProjects();
      },
      error: function(xhr) {
        showToast("error", "Error eliminando proyecto: " + xhr.responseText);
      }
    });
  });

  $("#form-new-project").on("submit", function(e) {
    e.preventDefault();
    var data = {
      projectType: $("#projectType").val()
    };
    $.ajax({
      url: BASE + "project/",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(data),
      success: function() {
        showToast("success", "Proyecto creado correctamente.");
        loadProjects();
      },
      error: function(xhr) {
        showToast("error", "Error creando proyecto: " + xhr.responseText);
      }
    });
  });

  /* ====================== APLICACIONES ====================== */

  function loadApplications() {
    $.getJSON(BASE + "application/", function(data) {
      var tbody = $("#tbody-applications");
      tbody.empty();
      $.each(data, function(idx, item) {
        var row = $("<tr/>");
        row.append("<td>" + item.id + "</td>");
        row.append("<td>" + (item.appName || "") + "</td>");
        row.append("<td>" + (item.applicationOl || "") + "</td>");
        row.append("<td>" + (item.createdBy || "") + "</td>");
        var btnDel = '<button class="btn btn-danger btn-xs btn-delete-app" data-id="' + item.id + '">' +
                     '<i class="fa fa-trash"></i></button>';
        row.append('<td class="text-center">' + btnDel + "</td>");
        tbody.append(row);
      });
    }).fail(function(xhr) {
      showToast("error", "Error cargando aplicaciones: " + xhr.responseText);
    });
  }

  $("#refresh-applications").on("click", function() {
    loadApplications();
  });

  $("#tbody-applications").on("click", ".btn-delete-app", function() {
    var id = $(this).data("id");
    if (!confirm("¿Eliminar aplicación " + id + "?")) return;
    $.ajax({
      url: BASE + "application/" + id + "/",
      type: "DELETE",
      success: function() {
        showToast("success", "Aplicación eliminada.");
        loadApplications();
      },
      error: function(xhr) {
        showToast("error", "Error eliminando aplicación: " + xhr.responseText);
      }
    });
  });

  $("#form-new-application").on("submit", function(e) {
    e.preventDefault();
    var data = {
      appName: $("#appName").val()
    };
    $.ajax({
      url: BASE + "application/",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(data),
      success: function() {
        showToast("success", "Aplicación creada correctamente.");
        $("#appName").val("");
        loadApplications();
      },
      error: function(xhr) {
        showToast("error", "Error creando aplicación: " + xhr.responseText);
      }
    });
  });

  /* ====================== CARGAR PROVINCIAS (zoning1) ====================== */

  function loadProvincias() {
    var $selInm = $("#provincia-inmuebles");
    var $selParc = $("#provincia-parcelas");

    // Limpia y deja el placeholder
    $selInm.empty().append('<option value="">{% trans "Seleccione una provincia..." %}</option>');
    $selParc.empty().append('<option value="">{% trans "Seleccione una provincia..." %}</option>');

    $.getJSON(BASE + "zoning1/", function(data) {
      var results = data.results || data; // por si no va paginado

      var provincias = $.grep(results, function(r) {
        return r.levelName === "Provincia";
      });

      // Orden por nationalCadastralZoningReference
      provincias.sort(function(a, b) {
        return (a.nationalCadastralZoningReference || "").localeCompare(
          b.nationalCadastralZoningReference || "",
          "es",
          { numeric: true }
        );
      });

      $.each(provincias, function(idx, p) {
        var code = p.nationalCadastralZoningReference;
        var name = p.name;
        // IMPORTANTE: value = nationalCadastralZoningReference
        var optHtml = '<option value="' + p.id + '" data-code="' + code + '">[' + code + '] ' + name + "</option>";
        $selInm.append(optHtml);
        $selParc.append(optHtml);
      });

      showToast("success", "Provincias cargadas correctamente.");
    }).fail(function(xhr) {
      showToast("error", "Error cargando provincias (zoning1): " + xhr.responseText);
    });
  }

  /* ====================== MIGRACIONES ====================== */

  $("#form-migrate-inmuebles").on("submit", function(e) {
    e.preventDefault();
    var form = $(this);

    if (!$("#provincia-inmuebles").val()) {
      alert("{% trans 'Debe seleccionar una provincia.' %}");
      return;
    }

    var data = form.serialize();
    $("#log-migrate-inmuebles").text("Ejecutando migración...");
    $.post(BASE + "migrate/inmuebles", data)
      .done(function(resp) {
        showToast("success", "Migración de inmuebles lanzada correctamente.");
        $("#log-migrate-inmuebles").text(resp);
      })
      .fail(function(xhr) {
        showToast("error", "Error en migración de inmuebles.");
        $("#log-migrate-inmuebles").text(xhr.responseText);
      });
  });

  $("#form-migrate-parcelas").on("submit", function(e) {
    e.preventDefault();

    if (!$("#provincia-parcelas").val()) {
      alert("{% trans 'Debe seleccionar una provincia.' %}");
      return;
    }

    var data = $(this).serialize();
    $("#log-migrate-parcelas").text("Ejecutando migración de parcelas...");
    $.post(BASE + "migrate/parcelas", data)
      .done(function(resp) {
        showToast("success", "Migración de parcelas lanzada correctamente.");
        $("#log-migrate-parcelas").text(resp);
      })
      .fail(function(xhr) {
        showToast("error", "Error en migración de parcelas.");
        $("#log-migrate-parcelas").text(xhr.responseText);
      });
  });

  $("#form-migrate-zoning").on("submit", function(e) {
    e.preventDefault();
    var data = $(this).serialize();
    $("#log-migrate-zoning").text("Ejecutando migración de zonificación...");
    $.post(BASE + "migrate/zoning", data)
      .done(function(resp) {
        showToast("success", "Migración de zonificación lanzada correctamente.");
        $("#log-migrate-zoning").text(resp);
      })
      .fail(function(xhr) {
        showToast("error", "Error en migración de zonificación.");
        $("#log-migrate-zoning").text(xhr.responseText);
      });
  });

  $("#form-migrate-puntos").on("submit", function(e) {
    e.preventDefault();
    var data = $(this).serialize();
    $("#log-migrate-puntos").text("Ejecutando migración de puntos...");
    $.post(BASE + "migrate/puntos", data)
      .done(function(resp) {
        showToast("success", "Migración de puntos terminada.");
        $("#log-migrate-puntos").text(JSON.stringify(resp, null, 2));
      })
      .fail(function(xhr) {
        showToast("error", "Error en migración de puntos.");
        $("#log-migrate-puntos").text(xhr.responseText);
      });
  });

  $("#delete-confirm").on("keyup change", function() {
    var val = $(this).val().trim().toUpperCase();
    $("#btn-delete-ladmrd").prop("disabled", val !== "ELIMINAR");
  });

  $("#form-delete-ladmrd").on("submit", function(e) {
    e.preventDefault();
    if ($("#btn-delete-ladmrd").prop("disabled")) return;
    var data = $(this).serialize();
    $("#log-delete-ladmrd").text("Lanzando borrado masivo...");
    $.post(BASE + "migrate/delete", data)
      .done(function(resp) {
        showToast("success", "Borrado ejecutado.");
        $("#log-delete-ladmrd").text(resp);
      })
      .fail(function(xhr) {
        showToast("error", "Error en borrado.");
        $("#log-delete-ladmrd").text(xhr.responseText);
      });
  });

  /* ====================== ENUMERACIONES ====================== */

  $("#form-enumerations").on("submit", function(e) {
    e.preventDefault();
    var data = $(this).serialize();
    $("#log-enumerations").text("Generando enumeraciones...");
    $.post(BASE + "enumerations", data)
      .done(function(resp) {
        showToast("success", "Enumeraciones generadas.");
        $("#log-enumerations").text(resp);
      })
      .fail(function(xhr) {
        showToast("error", "Error generando enumeraciones.");
        $("#log-enumerations").text(xhr.responseText);
      });
  });

  /* ====================== CARGA INICIAL ====================== */

  loadProjects();
  loadApplications();
  loadProvincias();  // <- aquí cargamos las provincias en los selects

});
</script>

{% endblock %}
