if(window.ol&&!ol.ext){ol.ext={};}
ol.ext.inherits=function(child,parent){child.prototype=Object.create(parent.prototype);child.prototype.constructor=child;};if(window.ol){if(!ol.inherits)ol.inherits=ol.ext.inherits;}
if(window.NodeList&&!NodeList.prototype.forEach){NodeList.prototype.forEach=Array.prototype.forEach;}
if(window.Element&&!Element.prototype.remove){Element.prototype.remove=function(){if(this.parentNode)this.parentNode.removeChild(this);}}
ol.ext.Ajax=function(options){options=options||{};ol.Object.call(this);this._auth=options.auth;this.set('dataType',options.dataType||'JSON');};ol.ext.inherits(ol.ext.Ajax,ol.Object);ol.ext.Ajax.get=function(options){var ajax=new ol.ext.Ajax(options);if(options.success)ajax.on('success',function(e){options.success(e.response,e);});if(options.error)ajax.on('error',function(e){options.error(e);});ajax.send(options.url,options.data,options.options);};ol.ext.Ajax.prototype.send=function(url,data,options){options=options||{};var self=this;var encode=(options.encode!==false)
if(encode)url=encodeURI(url);var parameters='';for(var index in data){if(data.hasOwnProperty(index)&&data[index]!==undefined){parameters+=(parameters?'&':'?')+index+'='+(encode?encodeURIComponent(data[index]):data[index]);}}
if(this._request&&options.abort!==false){this._request.abort();}
var ajax=this._request=new XMLHttpRequest();ajax.open('GET',url+parameters,true);if(this._auth){ajax.setRequestHeader("Authorization","Basic "+this._auth);}
this.dispatchEvent({type:'loadstart'});ajax.onload=function(){self._request=null;self.dispatchEvent({type:'loadend'});if(this.status>=200&&this.status<400){var response;try{switch(self.get('dataType')){case'JSON':{response=JSON.parse(this.response);break;}
default:{response=this.response;}}}catch(e){self.dispatchEvent({type:'error',status:0,statusText:'parsererror',error:e,options:options,jqXHR:this});return;}
self.dispatchEvent({type:'success',response:response,status:this.status,statusText:this.statusText,options:options,jqXHR:this});}else{self.dispatchEvent({type:'error',status:this.status,statusText:this.statusText,options:options,jqXHR:this});}};ajax.onerror=function(){self._request=null;self.dispatchEvent({type:'loadend'});self.dispatchEvent({type:'error',status:this.status,statusText:this.statusText,options:options,jqXHR:this});};ajax.send();};ol.ext.element={};ol.ext.element.create=function(tagName,options){options=options||{};var elt;if(tagName==='TEXT'){elt=document.createTextNode(options.html||'');if(options.parent)options.parent.appendChild(elt);}else{elt=document.createElement(tagName);if(/button/i.test(tagName))elt.setAttribute('type','button');for(var attr in options){switch(attr){case'className':{if(options.className&&options.className.trim)elt.setAttribute('class',options.className.trim());break;}
case'html':{if(options.html instanceof Element)elt.appendChild(options.html)
else if(options.html!==undefined)elt.innerHTML=options.html;break;}
case'parent':{options.parent.appendChild(elt);break;}
case'style':{this.setStyle(elt,options.style);break;}
case'change':case'click':{ol.ext.element.addListener(elt,attr,options[attr]);break;}
case'on':{for(var e in options.on){ol.ext.element.addListener(elt,e,options.on[e]);}
break;}
case'checked':{elt.checked=!!options.checked;break;}
default:{elt.setAttribute(attr,options[attr]);break;}}}}
return elt;};ol.ext.element.setHTML=function(element,html){if(html instanceof Element)element.appendChild(html)
else if(html!==undefined)element.innerHTML=html;};ol.ext.element.appendText=function(element,text){element.appendChild(document.createTextNode(text||''));};ol.ext.element.addListener=function(element,eventType,fn){if(typeof eventType==='string')eventType=eventType.split(' ');eventType.forEach(function(e){element.addEventListener(e,fn);});};ol.ext.element.removeListener=function(element,eventType,fn){if(typeof eventType==='string')eventType=eventType.split(' ');eventType.forEach(function(e){element.removeEventListener(e,fn);});};ol.ext.element.show=function(element){element.style.display='';};ol.ext.element.hide=function(element){element.style.display='none';};ol.ext.element.hidden=function(element){return ol.ext.element.getStyle(element,'display')==='none';};ol.ext.element.toggle=function(element){element.style.display=(element.style.display==='none'?'':'none');};ol.ext.element.setStyle=function(el,st){for(var s in st){switch(s){case'top':case'left':case'bottom':case'right':case'minWidth':case'maxWidth':case'width':case'height':{if(typeof(st[s])==='number'){el.style[s]=st[s]+'px';}else{el.style[s]=st[s];}
break;}
default:{el.style[s]=st[s];}}}};ol.ext.element.getStyle=function(el,styleProp){var value,defaultView=(el.ownerDocument||document).defaultView;if(defaultView&&defaultView.getComputedStyle){styleProp=styleProp.replace(/([A-Z])/g,"-$1").toLowerCase();value=defaultView.getComputedStyle(el,null).getPropertyValue(styleProp);}else if(el.currentStyle){styleProp=styleProp.replace(/-(\w)/g,function(str,letter){return letter.toUpperCase();});value=el.currentStyle[styleProp];if(/^\d+(em|pt|%|ex)?$/i.test(value)){return(function(value){var oldLeft=el.style.left,oldRsLeft=el.runtimeStyle.left;el.runtimeStyle.left=el.currentStyle.left;el.style.left=value||0;value=el.style.pixelLeft+"px";el.style.left=oldLeft;el.runtimeStyle.left=oldRsLeft;return value;})(value);}}
if(/px$/.test(value))return parseInt(value);return value;};ol.ext.element.outerHeight=function(elt){return elt.offsetHeight+ol.ext.element.getStyle(elt,'marginBottom')};ol.ext.element.outerWidth=function(elt){return elt.offsetWidth+ol.ext.element.getStyle(elt,'marginLeft')};ol.ext.element.offsetRect=function(elt){var rect=elt.getBoundingClientRect();return{top:rect.top+(window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0),left:rect.left+(window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0),height:rect.height||(rect.bottom-rect.top),width:rect.widtth||(rect.right-rect.left)}};ol.ext.element.scrollDiv=function(elt,options){var pos=false;var speed=0;var d,dt=0;var onmove=(typeof(options.onmove)==='function'?options.onmove:function(){});var page=options.vertical?'pageY':'pageX';var scroll=options.vertical?'scrollTop':'scrollLeft';var moving=false;elt.querySelectorAll('img').forEach(function(i){i.ondragstart=function(){return false;};});ol.ext.element.addListener(elt,['mousedown'],function(e){moving=false;pos=e[page];dt=new Date();elt.classList.add('ol-move');});ol.ext.element.addListener(window,['mousemove'],function(e){moving=true;if(pos!==false){var delta=pos-e[page];elt[scroll]+=delta;d=new Date();if(d-dt){speed=(speed+delta/(d-dt))/2;}
pos=e[page];dt=d;if(delta)onmove(true);}else{onmove(false);}});ol.ext.element.addListener(window,['mouseup'],function(e){if(moving)setTimeout(function(){elt.classList.remove('ol-move');});else elt.classList.remove('ol-move');moving=false;dt=new Date()-dt;if(dt>100){speed=0;}else if(dt>0){speed=((speed||0)+(pos-e[page])/dt)/2;}
elt[scroll]+=speed*100;pos=false;speed=0;dt=0;});if(options.mousewheel&&!elt.classList.contains('ol-touch')){ol.ext.element.addListener(elt,['mousewheel','DOMMouseScroll','onmousewheel'],function(e){var delta=Math.max(-1,Math.min(1,(e.wheelDelta||-e.detail)));elt.classList.add('ol-move');elt[scroll]-=delta*30;elt.classList.remove('ol-move');return false;});}};ol.ext.element.dispatchEvent=function(eventName,element){var event;try{event=new CustomEvent(eventName);}catch(e){event=document.createEvent("CustomEvent");event.initCustomEvent(eventName,true,true,{});}
element.dispatchEvent(event);};ol.ext.getMapCanvas=function(map){if(!map)return null;var canvas=map.getViewport().getElementsByClassName('ol-fixedoverlay')[0];if(!canvas){if(map.getViewport().querySelector('.ol-layers')){canvas=document.createElement('canvas');canvas.className='ol-fixedoverlay';map.getViewport().querySelector('.ol-layers').after(canvas);map.on('precompose',function(e){canvas.width=map.getSize()[0]*e.frameState.pixelRatio;canvas.height=map.getSize()[1]*e.frameState.pixelRatio;});}else{canvas=map.getViewport().querySelector('canvas');}}
return canvas;};if(window.ol&&!ol.sphere){ol.sphere={};ol.sphere.getDistance=function(c1,c2,radius){var sphere=new ol.Sphere(radius||6371008.8);return sphere.haversineDistance(c1,c2);}
ol.sphere.getArea=ol.Sphere.getArea;ol.sphere.getLength=ol.Sphere.getLength;}
ol.control.CanvasBase=function(options){if(!options)options={};this.setStyle(options.style);ol.control.Control.call(this,options);}
ol.ext.inherits(ol.control.CanvasBase,ol.control.Control);ol.control.CanvasBase.prototype.setMap=function(map){this.getCanvas(map);var oldmap=this.getMap();if(this._listener){ol.Observable.unByKey(this._listener);this._listener=null;}
ol.control.Control.prototype.setMap.call(this,map);if(oldmap)oldmap.renderSync();if(map){this._listener=map.on('postcompose',this._draw.bind(this));}};ol.control.CanvasBase.prototype.getCanvas=function(map){return ol.ext.getMapCanvas(map);};ol.control.CanvasBase.prototype.getContext=function(e){var ctx=e.context;if(!ctx&&this.getMap()){var c=this.getMap().getViewport().getElementsByClassName('ol-fixedoverlay')[0];ctx=c?c.getContext('2d'):null;}
return ctx;};ol.control.CanvasBase.prototype.setStyle=function(style){this._style=style||new ol.style.Style({});};ol.control.CanvasBase.prototype.getStyle=function(){return this._style;};ol.control.CanvasBase.prototype.getStroke=function(){var t=this._style.getStroke();if(!t)this._style.setStroke(new ol.style.Stroke({color:'#000',width:1.25}));return this._style.getStroke();};ol.control.CanvasBase.prototype.getFill=function(){var t=this._style.getFill();if(!t)this._style.setFill(new ol.style.Fill({color:'#fff'}));return this._style.getFill();};ol.control.CanvasBase.prototype.getTextStroke=function(){var t=this._style.getText();if(!t)t=new ol.style.Text({});if(!t.getStroke())t.setStroke(new ol.style.Stroke({color:'#fff',width:3}));return t.getStroke();};ol.control.CanvasBase.prototype.getTextFill=function(){var t=this._style.getText();if(!t)t=new ol.style.Text({});if(!t.getFill())t.setFill(new ol.style.Fill({color:'#fff',width:3}));return t.getFill();};ol.control.CanvasBase.prototype.getTextFont=function(){var t=this._style.getText();if(!t)t=new ol.style.Text({});if(!t.getFont())t.setFont('12px sans-serif');return t.getFont();};ol.control.CanvasBase.prototype._draw=function(){console.warn('[CanvasBase] draw function not implemented.');};ol.control.SelectBase=function(options){if(!options)options={};this._features=this.setFeatures(options.features);var element;if(options.target){element=document.createElement("div");}else{element=document.createElement("div");element.className='ol-select ol-unselectable ol-control ol-collapsed';ol.ext.element.create('BUTTON',{type:'button',on:{'click touchstart':function(e){element.classList.toggle('ol-collapsed');e.preventDefault();}},parent:element});}
if(options.className)element.classList.add(options.className);element.appendChild(options.content);ol.ext.element.create('BUTTON',{html:options.btInfo||'OK',className:'ol-ok',on:{'click touchstart':this.doSelect.bind(this)},parent:options.content});ol.control.Control.call(this,{element:element,target:options.target});this.setSources(options.source);};ol.ext.inherits(ol.control.SelectBase,ol.control.Control);ol.control.SelectBase.prototype.setSources=function(source){if(source){this.set('source',(source instanceof Array)?source:[source]);}else{this.unset('source');}};ol.control.SelectBase.prototype.setFeatures=function(features){if(features instanceof ol.Collection)this._features=features;else this._features=null;};ol.control.SelectBase.prototype.getFeatures=function(){return this._features;};ol.control.SelectBase.prototype.operationsList={'=':'=','!=':'≠','<':'<','<=':'≤','>=':'≥','>':'>','contain':'⊂','!contain':'⊄','regexp':'≈'};ol.control.SelectBase.prototype._escape=function(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');};ol.control.SelectBase.prototype._checkCondition=function(f,condition,usecase){if(!condition.attr)return true;var val=f.get(condition.attr);var rex;switch(condition.op){case'=':rex=new RegExp('^'+this._escape(condition.val)+'$',usecase?'':'i');return rex.test(val);case'!=':rex=new RegExp('^'+this._escape(condition.val)+'$',usecase?'':'i');return!rex.test(val);case'<':return val<condition.val;case'<=':return val<=condition.val;case'>':return val>condition.val;case'>=':return val>=condition.val;case'contain':rex=new RegExp(this._escape(condition.val),usecase?'':'i');return rex.test(val);case'!contain':rex=new RegExp(this._escape(condition.val),usecase?'':'i');return!rex.test(val);case'regexp':rex=new RegExp(condition.val,usecase?'':'i');return rex.test(val);default:return false;}};ol.control.SelectBase.prototype._selectFeatures=function(result,features,conditions,all,usecase){conditions=conditions||[];var f;for(var i=features.length-1;f=features[i];i--){var isok=all;for(var k=0,c;c=conditions[k];k++){if(c.attr){if(all){isok=isok&&this._checkCondition(f,c,usecase);}
else{isok=isok||this._checkCondition(f,c,usecase);}}}
if(isok){result.push(f);}else if(this._features){this._features.removeAt(i);}}
return result;};ol.control.SelectBase.prototype.getSources=function(){if(this.get('source'))return this.get('source');var sources=[];function getSources(layers){layers.forEach(function(l){if(l.getLayers){getSources(l.getLayers());}else if(l.getSource&&l.getSource()instanceof ol.source.Vector){sources.push(l.getSource());}});}
if(this.getMap()){getSources(this.getMap().getLayers());}
return sources;};ol.control.SelectBase.prototype.doSelect=function(options){options=options||{};var features=[];if(options.features){this._selectFeatures(features,options.features,options.conditions,options.matchAll,options.useCase);}else if(this._features){this._selectFeatures(features,this._features.getArray(),options.conditions,options.matchAll,options.useCase);}else{var sources=options.sources||this.getSources();sources.forEach(function(s){this._selectFeatures(features,s.getFeatures(),options.conditions,options.matchAll,options.useCase);}.bind(this));}
this.dispatchEvent({type:"select",features:features});return features;};ol.control.Search=function(options){var self=this;if(!options)options={};if(options.typing==undefined)options.typing=300;this._classname=options.className||'search';var classNames=(options.className||'')+' ol-search'
+(options.target?'':' ol-unselectable ol-control ol-collapsed');var element=ol.ext.element.create('DIV',{className:classNames+' ol-collapsed'})
if(!options.target){this.button=document.createElement("BUTTON");var iconButton=document.createElement("i");iconButton.setAttribute("class","fa fa-search");this.button.appendChild(iconButton);this.button.setAttribute("type","button");this.button.setAttribute("title",options.label||"search");this.button.addEventListener("click",function(){element.classList.toggle("ol-collapsed");if(!element.classList.contains("ol-collapsed")){element.querySelector("input.search").focus();var listElements=element.querySelectorAll("li");for(var i=0;i<listElements.length;i++){listElements[i].classList.remove("select");}
if(!input.value){self.drawList_();}}});element.appendChild(this.button);}
if(options.inputLabel){var label=document.createElement("LABEL");label.innerText=options.inputLabel;element.appendChild(label);}
var tout,cur="";var input=this._input=document.createElement("INPUT");input.setAttribute("type","search");input.setAttribute("class","search");input.setAttribute("autocomplete","off");input.setAttribute("placeholder",options.placeholder||"Search...");input.addEventListener("change",function(e){self.dispatchEvent({type:"change:input",input:e,value:input.value});});var doSearch=function(e){var li=element.querySelector("ul.autocomplete li.select");var val=input.value;if(e.key=='ArrowDown'||e.key=='ArrowUp'||e.key=='Down'||e.key=='Up'){if(li){li.classList.remove("select");li=(/Down/.test(e.key))?li.nextElementSibling:li.previousElementSibling;if(li)li.classList.add("select");}
else element.querySelector("ul.autocomplete li").classList.add("select");}
else if(e.type=='input'&&!val){setTimeout(function(){self.drawList_();},200);}
else if(li&&(e.type=="search"||e.key=="Enter")){if(element.classList.contains("ol-control"))input.blur();li.classList.remove("select");cur=val;self._handleSelect(self._list[li.getAttribute("data-search")]);}
else if((e.type=="search"||e.key=='Enter')||(cur!=val&&options.typing>=0)){cur=val;if(cur){if(tout)clearTimeout(tout);tout=setTimeout(function(){if(cur.length>=self.get("minLength")){var s=self.autocomplete(cur,function(auto){self.drawList_(auto);});if(s)self.drawList_(s);}
else self.drawList_();},options.typing);}
else self.drawList_();}
else{li=element.querySelector("ul.autocomplete li");if(li)li.classList.remove('select');}};input.addEventListener("keyup",doSearch);input.addEventListener("search",doSearch);input.addEventListener("cut",doSearch);input.addEventListener("paste",doSearch);input.addEventListener("input",doSearch);if(!options.noCollapse){input.addEventListener('blur',function(){setTimeout(function(){if(input!==document.activeElement){element.classList.add('ol-collapsed');this.set('reverse',false);element.classList.remove('ol-revers');}}.bind(this),200);}.bind(this));input.addEventListener('focus',function(){if(!this.get('reverse')){element.classList.remove('ol-collapsed');element.classList.remove('ol-revers');}}.bind(this));}
element.appendChild(input);if(options.reverse){var reverse=ol.ext.element.create('BUTTON',{tyoe:'button',class:'ol-revers',title:'click on the map',click:function(){if(!this.get('reverse')){this.set('reverse',!this.get('reverse'));input.focus();element.classList.add('ol-revers');}else{this.set('reverse',false);}}.bind(this)});element.appendChild(reverse);}
var ul=document.createElement('UL');ul.setAttribute("style","text-align:left;");ul.classList.add('autocomplete');element.appendChild(ul);ol.control.Control.call(this,{element:element,target:options.target});if(typeof(options.getTitle)=='function')this.getTitle=options.getTitle;if(typeof(options.autocomplete)=='function')this.autocomplete=options.autocomplete;this.set('copy',options.copy);this.set('minLength',options.minLength||1);this.set('maxItems',options.maxItems||10);this.set('maxHistory',options.maxHistory||options.maxItems||10);this.restoreHistory();this.drawList_();};ol.ext.inherits(ol.control.Search,ol.control.Control);ol.control.Search.prototype.setMap=function(map){if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.control.Control.prototype.setMap.call(this,map);if(map){this._listener=map.on('click',this._handleClick.bind(this));}};ol.control.Search.prototype.getInputField=function(){return this._input;};ol.control.Search.prototype.getTitle=function(f){return f.name||"No title";};ol.control.Search.prototype.search=function(){var search=this.element.querySelector("input.search");this._triggerCustomEvent('search',search);};ol.control.Search.prototype._handleClick=function(e){if(this.get('reverse')){document.activeElement.blur();this.reverseGeocode(e.coordinate);}};ol.control.Search.prototype.reverseGeocode=function(){};ol.control.Search.prototype._triggerCustomEvent=function(eventName,element){ol.ext.element.dispatchEvent(eventName,element);};ol.control.Search.prototype.setInput=function(value,search){var input=this.element.querySelector("input.search");input.value=value;if(search)this._triggerCustomEvent("keyup",input);};ol.control.Search.prototype.select=function(f,reverse){this.dispatchEvent({type:"select",search:f,reverse:!!reverse});};ol.control.Search.prototype._handleSelect=function(f,reverse){if(!f)return;var hist=this.get('history');var i;try{var fstr=JSON.stringify(f);for(i=hist.length-1;i>=0;i--){if(!hist[i]||JSON.stringify(hist[i])===fstr){hist.splice(i,1);}}}catch(e){for(i=hist.length-1;i>=0;i--){if(hist[i]===f){hist.splice(i,1);}}}
hist.unshift(f);while(hist.length>(this.get('maxHistory')||10)){hist.pop();}
this.saveHistory();this.select(f,reverse);};ol.control.Search.prototype._history={};ol.control.Search.prototype.saveHistory=function(){if(this.get('maxHistory')>=0){try{localStorage["ol@search-"+this._classname]=JSON.stringify(this.get('history'));}catch(e){}}else{localStorage.removeItem("ol@search-"+this._classname);}};ol.control.Search.prototype.restoreHistory=function(){if(this._history[this._classname]){this.set('history',this._history[this._classname]);}else{try{this._history[this._classname]=JSON.parse(localStorage["ol@search-"+this._classname]);this.set('history',this._history[this._classname]);}catch(e){this.set('history',[]);}}};ol.control.Search.prototype.clearHistory=function(){this.set('history',[]);this.saveHistory();this.drawList_();};ol.control.Search.prototype.getHistory=function(){return this.get('history');};ol.control.Search.prototype.autocomplete=function(s,cback){cback([]);return false;};ol.control.Search.prototype.drawList_=function(auto){var self=this;var ul=this.element.querySelector("ul.autocomplete");ul.innerHTML='';this._list=[];if(!auto){var input=this.element.querySelector("input.search");var value=input.value;if(!value){auto=this.get('history');}else{return;}
ul.setAttribute('class','autocomplete history');}else{ul.setAttribute('class','autocomplete');}
var li,max=Math.min(self.get("maxItems"),auto.length);for(var i=0;i<max;i++){if(auto[i]){if(!i||!self.equalFeatures(auto[i],auto[i-1])){li=document.createElement("LI");li.setAttribute("data-search",this._list.length);this._list.push(auto[i]);li.addEventListener("click",function(e){self._handleSelect(self._list[e.currentTarget.getAttribute("data-search")]);});var title=self.getTitle(auto[i]);if(title instanceof Element)li.appendChild(title);else li.innerHTML=title;ul.appendChild(li);}}}
if(max&&this.get("copy")){li=document.createElement("LI");li.classList.add("copy");li.innerHTML=this.get("copy");ul.appendChild(li);}};ol.control.Search.prototype.equalFeatures=function(){return false;};ol.control.SearchJSON=function(options){options=options||{};options.className=options.className||'JSON';delete options.autocomplete;options.minLength=options.minLength||3;options.typing=options.typing||800;ol.control.Search.call(this,options);var url=options.url||"";if(window.location.protocol==="https:"){var parser=document.createElement('a');parser.href=url;parser.protocol=window.location.protocol;url=parser.href;}
this.set('url',url);this._ajax=new ol.ext.Ajax({dataType:'JSON',auth:options.authentication});this._ajax.on('success',function(resp){if(resp.status>=200&&resp.status<400){if(typeof(this._callback)==='function')this._callback(resp.response);}else{console.log('AJAX ERROR',arguments);}}.bind(this));this._ajax.on('error',function(){console.log('AJAX ERROR',arguments);}.bind(this));this._ajax.on('loadstart',function(){this.element.classList.add('searching');}.bind(this));this._ajax.on('loadend',function(){this.element.classList.remove('searching');}.bind(this));if(typeof(options.handleResponse)==='function')this.handleResponse=options.handleResponse;};ol.ext.inherits(ol.control.SearchJSON,ol.control.Search);ol.control.SearchJSON.prototype.ajax=function(url,data,cback,options){options=options||{};this._callback=cback;this._ajax.set('dataType',options.dataType||'JSON');this._ajax.send(url,data,options);};ol.control.SearchJSON.prototype.autocomplete=function(s,cback){var data=this.requestData(s);var url=encodeURI(this.get('url'));this.ajax(url,data,function(resp){if(typeof(cback)==='function')cback(this.handleResponse(resp));});};ol.control.SearchJSON.prototype.requestData=function(s){return{q:s};};ol.control.SearchJSON.prototype.handleResponse=function(response){return response;};ol.control.SearchPhoton=function(options){options=options||{};options.className=options.className||'photon';options.url=options.url||'http://photon.komoot.de/api/';options.copy='<a href="http://www.openstreetmap.org/copyright" target="new">&copy; OpenStreetMap contributors</a>';ol.control.SearchJSON.call(this,options);this.set('lang',options.lang);this.set('position',options.position);};ol.ext.inherits(ol.control.SearchPhoton,ol.control.SearchJSON);ol.control.SearchPhoton.prototype.getTitle=function(f){var p=f.properties;return(p.housenumber||"")
+" "+(p.street||p.name||"")
+"<i>"
+" "+(p.postcode||"")
+" "+(p.city||"")
+" ("+p.country
+")</i>";};ol.control.SearchPhoton.prototype.requestData=function(s){var data={q:s,lang:this.get('lang'),limit:this.get('maxItems')}
if(this.get('position')){var view=this.getMap().getView();var pt=new ol.geom.Point(view.getCenter());pt=(pt.transform(view.getProjection(),"EPSG:4326")).getCoordinates();data.lon=pt[0];data.lat=pt[1];}
return data;};ol.control.SearchPhoton.prototype.handleResponse=function(response){return response.features;};ol.control.SearchPhoton.prototype.equalFeatures=function(f1,f2){return(this.getTitle(f1)===this.getTitle(f2)&&f1.geometry.coordinates[0]===f2.geometry.coordinates[0]&&f1.geometry.coordinates[1]===f2.geometry.coordinates[1]);};ol.control.SearchPhoton.prototype.select=function(f){var c=f.geometry.coordinates;try{c=ol.proj.transform(f.geometry.coordinates,'EPSG:4326',this.getMap().getView().getProjection());}catch(e){}
this.dispatchEvent({type:"select",search:f,coordinate:c});};ol.control.SearchPhoton.prototype.reverseData=function(coord){var lonlat=ol.proj.transform(coord,this.getMap().getView().getProjection(),'EPSG:4326');return{lon:lonlat[0],lat:lonlat[1]};};ol.control.SearchPhoton.prototype.reverseGeocode=function(coord,cback){this.ajax(this.get('url').replace('/api/','/reverse/').replace('/search/','/reverse/'),this.reverseData(coord),function(resp){if(resp.features)resp=resp.features;if(!(resp instanceof Array))resp=[resp];if(cback){cback.call(this,resp);}else{this._handleSelect(resp[0],true);}}.bind(this));};ol.control.SearchGeoportail=function(options){options=options||{};options.className=options.className||'IGNF';options.typing=options.typing||500;options.url="https://wxs.ign.fr/"+options.apiKey+"/ols/apis/completion";options.copy='<a href="https://www.geoportail.gouv.fr/" target="new">&copy; IGN-Géoportail</a>';ol.control.SearchJSON.call(this,options);this.set('type',options.type||'StreetAddress,PositionOfInterest');};ol.ext.inherits(ol.control.SearchGeoportail,ol.control.SearchJSON);ol.control.SearchGeoportail.prototype.reverseGeocode=function(coord,cback){var type=this.get('type')==='Commune'?'PositionOfInterest':this.get('type')||'StreetAddress';type='StreetAddress';var lonlat=ol.proj.transform(coord,this.getMap().getView().getProjection(),'EPSG:4326');var request='<?xml version="1.0" encoding="UTF-8"?>'
+'<XLS xmlns:xls="http://www.opengis.net/xls" xmlns:gml="http://www.opengis.net/gml" xmlns="http://www.opengis.net/xls" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.2" xsi:schemaLocation="http://www.opengis.net/xls http://schemas.opengis.net/ols/1.2/olsAll.xsd">'
+' <Request requestID="1" version="1.2" methodName="ReverseGeocodeRequest" maximumResponses="1" >'
+'  <ReverseGeocodeRequest>'
+'   <ReverseGeocodePreference>'+type+'</ReverseGeocodePreference>'
+'   <Position>'
+'    <gml:Point><gml:pos>'+lonlat[1]+' '+lonlat[0]+'</gml:pos></gml:Point>'
+'   </Position>'
+'  </ReverseGeocodeRequest>'
+' </Request>'
+'</XLS>';this.ajax(this.get('url').replace('ols/apis/completion','geoportail/ols'),{xls:request},function(xml){if(xml){xml=xml.replace(/\n|\r/g,'');var p=(xml.replace(/.*<gml:pos>(.*)<\/gml:pos>.*/,"$1")).split(' ');var f={};if(!Number(p[1])&&!Number(p[0])){f={x:lonlat[0],y:lonlat[1],fulltext:String(lonlat)}}else{f.x=lonlat[0];f.y=lonlat[1];f.city=(xml.replace(/.*<Place type="Municipality">([^<]*)<\/Place>.*/,"$1"));f.insee=(xml.replace(/.*<Place type="INSEE">([^<]*)<\/Place>.*/,"$1"));f.zipcode=(xml.replace(/.*<PostalCode>([^<]*)<\/PostalCode>.*/,"$1"));if(/<Street>/.test(xml)){f.kind='';f.country='StreetAddress';f.street=(xml.replace(/.*<Street>([^<]*)<\/Street>.*/,"$1"));var number=(xml.replace(/.*<Building number="([^"]*).*/,"$1"));f.fulltext=number+' '+f.street+', '+f.zipcode+' '+f.city;}else{f.kind=(xml.replace(/.*<Place type="Nature">([^<]*)<\/Place>.*/,"$1"));f.country='PositionOfInterest';f.street='';f.fulltext=f.zipcode+' '+f.city;}}
if(cback){cback.call(this,[f]);}else{this._handleSelect(f,true);}}}.bind(this),{dataType:'XML'});};ol.control.SearchGeoportail.prototype.getTitle=function(f){var title=f.fulltext;return(title);};ol.control.SearchGeoportail.prototype.requestData=function(s){return{text:s,type:this.get('type')==='Commune'?'PositionOfInterest':this.get('type')||'StreetAddress,PositionOfInterest',maximumResponses:this.get('maxItems')};};ol.control.SearchGeoportail.prototype.handleResponse=function(response){var features=response.results;if(this.get('type')==='Commune'){for(var i=features.length-1;i>=0;i--){if(features[i].kind&&(features[i].classification>5||features[i].kind=="Département")){features.splice(i,1);}}}
return features;};ol.control.SearchGeoportail.prototype.select=function(f){if(f.x||f.y){var c=[Number(f.x),Number(f.y)];try{c=ol.proj.transform(c,'EPSG:4326',this.getMap().getView().getProjection());}catch(e){}
if(this.get('type')==='Commune'){this.searchCommune(f,function(){this.dispatchEvent({type:"select",search:f,coordinate:c});});}else{this.dispatchEvent({type:"select",search:f,coordinate:c});}}else{this.searchCommune(f);}};ol.control.SearchGeoportail.prototype.searchCommune=function(f,cback){var request='<?xml version="1.0" encoding="UTF-8"?>'
+'<XLS xmlns:xls="http://www.opengis.net/xls" xmlns:gml="http://www.opengis.net/gml" xmlns="http://www.opengis.net/xls" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.2" xsi:schemaLocation="http://www.opengis.net/xls http://schemas.opengis.net/ols/1.2/olsAll.xsd">'
+'<RequestHeader/>'
+'<Request requestID="1" version="1.2" methodName="LocationUtilityService">'
+'<GeocodeRequest returnFreeForm="false">'
+'<Address countryCode="PositionOfInterest">'
+'<freeFormAddress>'+f.fulltext+'+</freeFormAddress>'
+'</Address>'
+'</GeocodeRequest>'
+'</Request>'
+'</XLS>'
this.ajax(this.get('url').replace('ols/apis/completion','geoportail/ols'),{'xls':request},function(xml){if(xml){xml=xml.replace(/\n|\r/g,'');var p=(xml.replace(/.*<gml:pos>(.*)<\/gml:pos>.*/,"$1")).split(' ');f.x=Number(p[1]);f.y=Number(p[0]);f.kind=(xml.replace(/.*<Place type="Nature">([^<]*)<\/Place>.*/,"$1"));f.insee=(xml.replace(/.*<Place type="INSEE">([^<]*)<\/Place>.*/,"$1"));if(f.x||f.y){if(cback)cback.call(this,[f]);else this._handleSelect(f);}}}.bind(this),{dataType:'XML'});};ol.control.LayerSwitcher=function(options){options=options||{};var self=this;this.dcount=0;this.show_progress=options.show_progress;this.oninfo=(typeof(options.oninfo)=="function"?options.oninfo:null);this.onextent=(typeof(options.onextent)=="function"?options.onextent:null);this.hasextent=options.extent||options.onextent;this.hastrash=options.trash;this.reordering=(options.reordering!==false);this._layers=[];if(typeof(options.displayInLayerSwitcher)==='function'){this.displayInLayerSwitcher=options.displayInLayerSwitcher;}
var element;if(options.target){element=ol.ext.element.create('DIV',{className:options.switcherClass||"ol-layerswitcher"});}else{element=ol.ext.element.create('DIV',{className:(options.switcherClass||"ol-layerswitcher")+' ol-unselectable ol-control'});if(options.collapsed!==false)element.classList.add('ol-collapsed');else element.classList.add('ol-forceopen');this.button=ol.ext.element.create('BUTTON',{type:'button',parent:element});this.button.addEventListener('touchstart',function(e){element.classList.toggle('ol-collapsed');self.dispatchEvent({type:'toggle',collapsed:element.classList.contains('ol-collapsed')});e.preventDefault();self.overflow();});this.button.addEventListener('click',function(){element.classList.toggle('ol-forceopen');element.classList.add('ol-collapsed');self.dispatchEvent({type:'toggle',collapsed:!element.classList.contains('ol-forceopen')});self.overflow();});if(options.mouseover){element.addEventListener('mouseleave',function(){element.classList.add("ol-collapsed");self.dispatchEvent({type:'toggle',collapsed:true});});element.addEventListener('mouseover',function(){element.classList.remove("ol-collapsed");self.dispatchEvent({type:'toggle',collapsed:false});});}
this.topv=ol.ext.element.create('DIV',{className:'ol-switchertopdiv',parent:element,click:function(){self.overflow("+50%");}});this.botv=ol.ext.element.create('DIV',{className:'ol-switcherbottomdiv',parent:element,click:function(){self.overflow("-50%");}});}
this.panel_=ol.ext.element.create('UL',{className:'panel',parent:element});ol.ext.element.addListener(this.panel_,'mousewheel DOMMouseScroll onmousewheel',function(e){if(self.overflow(Math.max(-1,Math.min(1,(e.wheelDelta||-e.detail))))){e.stopPropagation();e.preventDefault();}});this.header_=ol.ext.element.create('LI',{className:'ol-header',parent:this.panel_});ol.control.Control.call(this,{element:element,target:options.target});this.set('drawDelay',options.drawDelay||0);};ol.ext.inherits(ol.control.LayerSwitcher,ol.control.Control);ol.control.LayerSwitcher.prototype.tip={up:"up/down",down:"down",info:"informations...",extent:"zoom to extent",trash:"remove layer",plus:"expand/shrink"};ol.control.LayerSwitcher.prototype.displayInLayerSwitcher=function(layer){return(layer.get("displayInLayerSwitcher")!==false);};ol.control.LayerSwitcher.prototype.setMap=function(map){ol.control.Control.prototype.setMap.call(this,map);this.drawPanel();if(this._listener){if(this._listener)ol.Observable.unByKey(this._listener.change);if(this._listener)ol.Observable.unByKey(this._listener.moveend);if(this._listener)ol.Observable.unByKey(this._listener.size);}
this._listener=null;if(map){this._listener={change:map.getLayerGroup().on('change',this.drawPanel.bind(this)),moveend:map.on('moveend',this.viewChange.bind(this)),size:map.on('change:size',this.overflow.bind(this))}}};ol.control.LayerSwitcher.prototype.show=function(){this.element.classList.add("ol-forceopen");this.overflow();};ol.control.LayerSwitcher.prototype.hide=function(){this.element.classList.remove("ol-forceopen");this.overflow();};ol.control.LayerSwitcher.prototype.toggle=function(){this.element.classList.toggle("ol-forceopen");this.overflow();};ol.control.LayerSwitcher.prototype.isOpen=function(){return this.element.classList.contains("ol-forceopen");};ol.control.LayerSwitcher.prototype.setHeader=function(html){ol.ext.element.setHTML(this.header_,html);};ol.control.LayerSwitcher.prototype.overflow=function(dir){if(this.button){if(ol.ext.element.hidden(this.panel_)){ol.ext.element.setStyle(this.element,{height:'auto'});return;}
var h=ol.ext.element.outerHeight(this.element);var hp=ol.ext.element.outerHeight(this.panel_);var dh=this.button.offsetTop+ol.ext.element.outerHeight(this.button);var top=this.panel_.offsetTop-dh;if(hp>h-dh){ol.ext.element.setStyle(this.element,{height:'100%'});var lh=2*ol.ext.element.getStyle(this.panel_.querySelectorAll('li.visible .li-content')[0],'height');switch(dir){case 1:top+=lh;break;case-1:top-=lh;break;case"+50%":top+=Math.round(h/2);break;case"-50%":top-=Math.round(h/2);break;default:break;}
if(top+hp<=h-3*dh/2){top=h-3*dh/2-hp;ol.ext.element.hide(this.botv);}else{ol.ext.element.show(this.botv);}
if(top>=0){top=0;ol.ext.element.hide(this.topv);}else{ol.ext.element.show(this.topv);}
ol.ext.element.setStyle(this.panel_,{top:top+"px"});return true;}else{ol.ext.element.setStyle(this.element,{height:"auto"});ol.ext.element.setStyle(this.panel_,{top:0});ol.ext.element.hide(this.botv);ol.ext.element.hide(this.topv);return false;}}
else return false;};ol.control.LayerSwitcher.prototype._setLayerForLI=function(li,layer){this._layers.push({li:li,layer:layer});};ol.control.LayerSwitcher.prototype._getLayerForLI=function(li){for(var i=0,l;l=this._layers[i];i++){if(l.li===li)return l.layer;}
return null;};ol.control.LayerSwitcher.prototype.viewChange=function(){this.panel_.querySelectorAll('li').forEach(function(li){var l=this._getLayerForLI(li);if(l){if(this.testLayerVisibility(l))li.classList.remove('ol-layer-hidden');else li.classList.add('ol-layer-hidden');}}.bind(this));};ol.control.LayerSwitcher.prototype.drawPanel=function(){if(!this.getMap())return;var self=this;this.dcount++;setTimeout(function(){self.drawPanel_();},this.get('drawDelay')||0);};ol.control.LayerSwitcher.prototype.drawPanel_=function(){if(--this.dcount||this.dragging_)return;this._layers=[];this.panel_.querySelectorAll('li').forEach(function(li){if(!li.classList.contains('ol-header'))li.remove();}.bind(this));this.drawList(this.panel_,this.getMap().getLayers());};ol.control.LayerSwitcher.prototype.switchLayerVisibility=function(l,layers){if(!l.get('baseLayer')){l.setVisible(!l.getVisible());}else{if(!l.getVisible())l.setVisible(true);layers.forEach(function(li){if(l!==li&&li.get('baseLayer')&&li.getVisible())li.setVisible(false);});}};ol.control.LayerSwitcher.prototype.testLayerVisibility=function(layer){if(!this.getMap())return true;var res=this.getMap().getView().getResolution();if(layer.getMaxResolution()<=res||layer.getMinResolution()>=res){return false;}else{var ex0=layer.getExtent();if(ex0){var ex=this.getMap().getView().calculateExtent(this.getMap().getSize());return ol.extent.intersects(ex,ex0);}
return true;}};ol.control.LayerSwitcher.prototype.dragOrdering_=function(e){e.stopPropagation();e.preventDefault();var self=this;var elt=e.currentTarget.parentNode.parentNode;var start=true;var panel=this.panel_;var pageY;var pageY0=e.pageY||(e.touches&&e.touches.length&&e.touches[0].pageY)||(e.changedTouches&&e.changedTouches.length&&e.changedTouches[0].pageY);var target,dragElt;var layer,group;elt.parentNode.classList.add('drag');function stop(){if(target){var drop=layer;if(drop&&target){var collection;if(group)collection=group.getLayers();else collection=self.getMap().getLayers();var layers=collection.getArray();for(var i=0;i<layers.length;i++){if(layers[i]==drop){collection.removeAt(i);break;}}
for(var j=0;j<layers.length;j++){if(layers[j]==target){if(i>j)collection.insertAt(j,drop);else collection.insertAt(j+1,drop);break;}}}}
elt.parentNode.querySelectorAll('li').forEach(function(li){li.classList.remove('dropover');li.classList.remove('dropover-after');li.classList.remove('dropover-before');});elt.classList.remove("drag");elt.parentNode.classList.remove("drag");self.element.classList.remove('drag');if(dragElt)dragElt.remove();ol.ext.element.removeListener(document,'mousemove touchmove',move);ol.ext.element.removeListener(document,'mouseup touchend touchcancel',stop);}
function move(e){pageY=e.pageY||(e.touches&&e.touches.length&&e.touches[0].pageY)||(e.changedTouches&&e.changedTouches.length&&e.changedTouches[0].pageY);if(start&&Math.abs(pageY0-pageY)>2){start=false;elt.classList.add("drag");layer=self._getLayerForLI(elt);target=false;group=self._getLayerForLI(elt.parentNode.parentNode);dragElt=ol.ext.element.create('LI',{className:'ol-dragover',html:elt.innerHTML,style:{position:"absolute","z-index":10000,left:elt.offsetLeft,opacity:0.5,width:ol.ext.element.outerWidth(elt),height:ol.ext.element.getStyle(elt,'height'),},parent:panel});self.element.classList.add('drag');}
if(!start){e.preventDefault();e.stopPropagation();ol.ext.element.setStyle(dragElt,{top:pageY-ol.ext.element.offsetRect(panel).top+panel.scrollTop+5});var li;if(!e.touches){li=e.target;}else{li=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);}
if(li.classList.contains("ol-switcherbottomdiv")){self.overflow(-1);}else if(li.classList.contains("ol-switchertopdiv")){self.overflow(1);}
while(li&&li.tagName!=='LI'){li=li.parentNode;}
if(!li||!li.classList.contains('dropover')){elt.parentNode.querySelectorAll('li').forEach(function(li){li.classList.remove('dropover');li.classList.remove('dropover-after');li.classList.remove('dropover-before');});}
if(li&&li.parentNode.classList.contains('drag')&&li!==elt){target=self._getLayerForLI(li);if(target&&!target.get('allwaysOnTop')==!layer.get('allwaysOnTop')){li.classList.add("dropover");li.classList.add((elt.offsetTop<li.offsetTop)?'dropover-after':'dropover-before');}else{target=false;}
ol.ext.element.show(dragElt);}else{target=false;if(li===elt)ol.ext.element.hide(dragElt);else ol.ext.element.show(dragElt);}
if(!target)dragElt.classList.add("forbidden");else dragElt.classList.remove("forbidden");}}
ol.ext.element.addListener(document,'mousemove touchmove',move);ol.ext.element.addListener(document,'mouseup touchend touchcancel',stop);};ol.control.LayerSwitcher.prototype.dragOpacity_=function(e){e.stopPropagation();e.preventDefault();var self=this
var elt=e.target;var layer=this._getLayerForLI(elt.parentNode.parentNode.parentNode);if(!layer)return;var x=e.pageX||(e.touches&&e.touches.length&&e.touches[0].pageX)||(e.changedTouches&&e.changedTouches.length&&e.changedTouches[0].pageX);var start=ol.ext.element.getStyle(elt,'left')-x;self.dragging_=true;function stop(){ol.ext.element.removeListener(document,"mouseup touchend touchcancel",stop);ol.ext.element.removeListener(document,"mousemove touchmove",move);self.dragging_=false;}
function move(e){var x=e.pageX||(e.touches&&e.touches.length&&e.touches[0].pageX)||(e.changedTouches&&e.changedTouches.length&&e.changedTouches[0].pageX);var delta=(start+x)/ol.ext.element.getStyle(elt.parentNode,'width');var opacity=Math.max(0,Math.min(1,delta));ol.ext.element.setStyle(elt,{left:(opacity*100)+"%"});elt.parentNode.nextElementSibling.innerHTML=Math.round(opacity*100);layer.setOpacity(opacity);}
ol.ext.element.addListener(document,"mouseup touchend touchcancel",stop);ol.ext.element.addListener(document,"mousemove touchmove",move);};ol.control.LayerSwitcher.prototype.drawList=function(ul,collection){var self=this;var layers=collection.getArray();var setVisibility=function(e){e.stopPropagation();e.preventDefault();var l=self._getLayerForLI(this.parentNode.parentNode);self.switchLayerVisibility(l,collection);};function onInfo(e){e.stopPropagation();e.preventDefault();var l=self._getLayerForLI(this.parentNode.parentNode);self.oninfo(l);self.dispatchEvent({type:"info",layer:l});}
function zoomExtent(e){e.stopPropagation();e.preventDefault();var l=self._getLayerForLI(this.parentNode.parentNode);if(self.onextent)self.onextent(l);else self.getMap().getView().fit(l.getExtent(),self.getMap().getSize());self.dispatchEvent({type:"extent",layer:l});}
function removeLayer(e){e.stopPropagation();e.preventDefault();var li=this.parentNode.parentNode.parentNode.parentNode;var layer,group=self._getLayerForLI(li);if(group){layer=self._getLayerForLI(this.parentNode.parentNode);group.getLayers().remove(layer);if(group.getLayers().getLength()==0&&!group.get('noSwitcherDelete')){removeLayer.call(li.querySelectorAll('.layerTrash')[0],e);}}else{li=this.parentNode.parentNode;self.getMap().removeLayer(self._getLayerForLI(li));}}
for(var i=layers.length-1;i>=0;i--){var layer=layers[i];if(!self.displayInLayerSwitcher(layer))continue;var li=ol.ext.element.create('LI',{className:(layer.getVisible()?"visible ":" ")+(layer.get('baseLayer')?"baselayer":""),parent:ul});this._setLayerForLI(li,layer);var layer_buttons=ol.ext.element.create('DIV',{className:'ol-layerswitcher-buttons',parent:li});var d=ol.ext.element.create('DIV',{className:'li-content',parent:li});ol.ext.element.create('INPUT',{type:layer.get('baseLayer')?'radio':'checkbox',checked:layer.getVisible(),click:setVisibility,parent:d});ol.ext.element.create('LABEL',{html:layer.get("title")||layer.get("name"),title:layer.get("title")||layer.get("name"),click:setVisibility,unselectable:'on',style:{userSelect:'none'},parent:d}).addEventListener('selectstart',function(){return false;});if(this.reordering){if((i<layers.length-1&&(layer.get("allwaysOnTop")||!layers[i+1].get("allwaysOnTop")))||(i>0&&(!layer.get("allwaysOnTop")||layers[i-1].get("allwaysOnTop")))){ol.ext.element.create('DIV',{className:'layerup',title:this.tip.up,on:{'mousedown touchstart':function(e){self.dragOrdering_(e)}},parent:layer_buttons});}}
if(layer.getLayers){var nb=0;layer.getLayers().forEach(function(l){if(self.displayInLayerSwitcher(l))nb++;});if(nb){ol.ext.element.create('DIV',{className:layer.get("openInLayerSwitcher")?"collapse-layers":"expend-layers",title:this.tip.plus,click:function(){var l=self._getLayerForLI(this.parentNode.parentNode);l.set("openInLayerSwitcher",!l.get("openInLayerSwitcher"))},parent:layer_buttons});}}
if(this.oninfo){ol.ext.element.create('DIV',{className:'layerInfo',title:this.tip.info,click:onInfo,parent:layer_buttons});}
if(this.hastrash&&!layer.get("noSwitcherDelete")){ol.ext.element.create('DIV',{className:'layerTrash',title:this.tip.trash,click:removeLayer,parent:layer_buttons});}
if(this.hasextent&&layers[i].getExtent()){var ex=layers[i].getExtent();if(ex.length==4&&ex[0]<ex[2]&&ex[1]<ex[3]){ol.ext.element.create('DIV',{className:'layerExtent',title:this.tip.extent,click:zoomExtent,parent:layer_buttons});}}
if(this.show_progress&&layer instanceof ol.layer.Tile){var p=ol.ext.element.create('DIV',{className:'layerswitcher-progress',parent:d});this.setprogress_(layer);layer.layerswitcher_progress=ol.ext.element.create('DIV',{parent:p});}
var opacity=ol.ext.element.create('DIV',{className:'layerswitcher-opacity',click:function(e){if(e.target!==this)return;e.stopPropagation();e.preventDefault();var op=Math.max(0,Math.min(1,e.offsetX/ol.ext.element.getStyle(this,'width')));self._getLayerForLI(this.parentNode.parentNode).setOpacity(op);},parent:d});ol.ext.element.create('DIV',{className:'layerswitcher-opacity-cursor',style:{left:(layer.getOpacity()*100)+"%"},on:{'mousedown touchstart':function(e){self.dragOpacity_(e);}},parent:opacity});ol.ext.element.create('DIV',{className:'layerswitcher-opacity-label',html:Math.round(layer.getOpacity()*100),parent:d});if(layer.getLayers){li.classList.add('ol-layer-group');if(layer.get("openInLayerSwitcher")===true){var ul2=ol.ext.element.create('UL',{parent:li});this.drawList(ul2,layer.getLayers());}}
else if(layer instanceof ol.layer.Vector)li.classList.add('ol-layer-vector');else if(layer instanceof ol.layer.VectorTile)li.classList.add('ol-layer-vector');else if(layer instanceof ol.layer.Tile)li.classList.add('ol-layer-tile');else if(layer instanceof ol.layer.Image)li.classList.add('ol-layer-image');else if(layer instanceof ol.layer.Heatmap)li.classList.add('ol-layer-heatmap');this.dispatchEvent({type:'drawlist',layer:layer,li:li});}
this.viewChange();if(ul===this.panel_)this.overflow();};ol.control.LayerSwitcher.prototype.setprogress_=function(layer){if(!layer.layerswitcher_progress){var loaded=0;var loading=0;var draw=function(){if(loading===loaded){loading=loaded=0;ol.ext.element.setStyle(layer.layerswitcher_progress,{width:0});}else{ol.ext.element.setStyle(layer.layerswitcher_progress,{width:(loaded/loading*100).toFixed(1)+'%'});}}
layer.getSource().on('tileloadstart',function(){loading++;draw();});layer.getSource().on('tileloadend',function(){loaded++;draw();});layer.getSource().on('tileloaderror',function(){loaded++;draw();});}};ol.control.Bar=function(options){if(!options)options={};var element=document.createElement("div");element.classList.add('ol-unselectable','ol-control','ol-bar');if(options.className){var classes=options.className.split(' ').filter(function(className){return className.length>0;});element.classList.add.apply(element.classList,classes)}
if(options.group)element.classList.add('ol-group');ol.control.Control.call(this,{element:element,target:options.target});this.set('toggleOne',options.toggleOne);this.set('autoDeactivate',options.autoDeactivate);this.controls_=[];if(options.controls instanceof Array){for(var i=0;i<options.controls.length;i++){this.addControl(options.controls[i]);}}};ol.ext.inherits(ol.control.Bar,ol.control.Control);ol.control.Bar.prototype.setVisible=function(val){if(val)this.element.style.display='';else this.element.style.display='none';}
ol.control.Bar.prototype.getVisible=function(){return this.element.style.display!='none';}
ol.control.Bar.prototype.setMap=function(map){ol.control.Control.prototype.setMap.call(this,map);for(var i=0;i<this.controls_.length;i++){var c=this.controls_[i];c.setMap(map);}};ol.control.Bar.prototype.getControls=function(){return this.controls_;};ol.control.Bar.prototype.setPosition=function(pos){this.element.classList.remove('ol-left','ol-top','ol-bottom','ol-right');pos=pos.split('-');for(var i=0;i<pos.length;i++){switch(pos[i]){case'top':case'left':case'bottom':case'right':this.element.classList.add("ol-"+pos[i]);break;default:break;}}};ol.control.Bar.prototype.addControl=function(c){this.controls_.push(c);c.setTarget(this.element);if(this.getMap()){this.getMap().addControl(c);}
c.on('change:active',function(e){this.onActivateControl_(e,c);}.bind(this));if(c.getActive){this.onActivateControl_({target:c,active:c.getActive()},c);}};ol.control.Bar.prototype.deactivateControls=function(except){for(var i=0;i<this.controls_.length;i++){if(this.controls_[i]!==except&&this.controls_[i].setActive){this.controls_[i].setActive(false);}}};ol.control.Bar.prototype.getActiveControls=function(){var active=[];for(var i=0,c;c=this.controls_[i];i++){if(c.getActive&&c.getActive())active.push(c);}
return active;}
ol.control.Bar.prototype.setActive=function(b){if(!b&&this.get("autoDeactivate")){this.deactivateControls();}
if(b){var ctrls=this.getControls();for(var i=0,sb;(sb=ctrls[i]);i++){if(sb.get("autoActivate"))sb.setActive(true);}}}
ol.control.Bar.prototype.onActivateControl_=function(e,ctrl){if(this.get('toggleOne')){if(e.active){var n;for(n=0;n<this.controls_.length;n++){if(this.controls_[n]===ctrl)break;}
if(n==this.controls_.length)return;this.deactivateControls(this.controls_[n]);}else{if(!this.getActiveControls().length){for(var i=0,c;c=this.controls_[i];i++){if(c.get("autoActivate")){c.setActive(true);break;}}}}}};ol.control.Bar.prototype.getControlsByName=function(name){var controls=this.getControls();return controls.filter(function(control){return(control.get('name')===name);});};ol.control.Button=function(options){options=options||{};var element=document.createElement("div");element.className=(options.className||'')+" ol-button ol-unselectable ol-control";var self=this;var bt=this.button_=document.createElement(/ol-text-button/.test(options.className)?"div":"button");bt.type="button";if(options.title)bt.title=options.title;if(options.html instanceof Element)bt.appendChild(options.html)
else bt.innerHTML=options.html||"";var evtFunction=function(e){if(e&&e.preventDefault){e.preventDefault();e.stopPropagation();}
if(options.handleClick){options.handleClick.call(self,e);}};bt.addEventListener("click",evtFunction);bt.addEventListener("touchstart",evtFunction);element.appendChild(bt);if(!options.title&&bt.firstElementChild){bt.title=bt.firstElementChild.title;}
ol.control.Control.call(this,{element:element,target:options.target});if(options.title){this.set("title",options.title);}
if(options.title)this.set("title",options.title);if(options.name)this.set("name",options.name);};ol.ext.inherits(ol.control.Button,ol.control.Control);ol.control.Button.prototype.setVisible=function(val){if(val)ol.ext.element.show(this.element);else ol.ext.element.hide(this.element);};ol.control.Button.prototype.setTitle=function(title){this.button_.setAttribute('title',title);};ol.control.Button.prototype.setHtml=function(html){ol.ext.element.setHTML(this.button_,html);};ol.control.Button.prototype.getButtonElement=function(){return this.button_;};ol.control.CanvasAttribution=function(options){if(!options)options={};ol.control.Attribution.call(this,options);this.setCanvas(!!options.canvas);if(!options)options={};if(!options.style)options.style=new ol.style.Style();this.setStyle(options.style);}
ol.ext.inherits(ol.control.CanvasAttribution,ol.control.Attribution);ol.control.CanvasAttribution.prototype.setCanvas=function(b){this.isCanvas_=b;if(b)this.setCollapsed(false);this.element.style.visibility=b?"hidden":"visible";if(this.map_)this.map_.renderSync();};ol.control.CanvasAttribution.prototype.getContext=ol.control.CanvasBase.prototype.getContext;ol.control.CanvasAttribution.prototype.setStyle=function(style){var text=style.getText();this.font_=text?text.getFont():"10px sans-serif";var stroke=text?text.getStroke():null;var fill=text?text.getFill():null;this.fontStrokeStyle_=stroke?ol.color.asString(stroke.getColor()):"#fff";this.fontFillStyle_=fill?ol.color.asString(fill.getColor()):"#000";this.fontStrokeWidth_=stroke?stroke.getWidth():3;if(this.getMap())this.getMap().render();};ol.control.CanvasAttribution.prototype.setMap=function(map){ol.control.CanvasBase.prototype.getCanvas.call(this,map);var oldmap=this.getMap();if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.control.ScaleLine.prototype.setMap.call(this,map);if(oldmap)oldmap.renderSync();if(map){this._listener=map.on('postcompose',this.drawAttribution_.bind(this));}
this.map_=map;this.setCanvas(this.isCanvas_);};ol.control.CanvasAttribution.prototype.drawAttribution_=function(e){if(!this.isCanvas_)return;var ctx=this.getContext(e);if(!ctx)return;var text="";Array.prototype.slice.call(this.element.querySelectorAll('li')).filter(function(el){return el.style.display!=="none";}).map(function(el){text+=(text?" - ":"")+el.textContent;});var ratio=e.frameState.pixelRatio;ctx.save();ctx.scale(ratio,ratio);var eltRect=this.element.getBoundingClientRect();var mapRect=this.getMap().getViewport().getBoundingClientRect();var sc=this.getMap().getSize()[0]/mapRect.width;ctx.translate((eltRect.left-mapRect.left)*sc,(eltRect.top-mapRect.top)*sc);var h=this.element.clientHeight;var w=this.element.clientWidth;var left=w/2+this.element.querySelectorAll('button')[0].clientWidth;ctx.beginPath();ctx.strokeStyle=this.fontStrokeStyle_;ctx.fillStyle=this.fontFillStyle_;ctx.lineWidth=this.fontStrokeWidth_;ctx.textAlign="center";ctx.textBaseline="middle";ctx.font=this.font_;ctx.strokeText(text,left,h/2);ctx.fillText(text,left,h/2);ctx.closePath();ctx.restore();};ol.control.CanvasScaleLine=function(options)
{ol.control.ScaleLine.call(this,options);this.scaleHeight_=6;if(!options)options={};if(!options.style)options.style=new ol.style.Style();this.setStyle(options.style);}
ol.ext.inherits(ol.control.CanvasScaleLine,ol.control.ScaleLine);ol.control.CanvasScaleLine.prototype.getContext=ol.control.CanvasBase.prototype.getContext;ol.control.CanvasScaleLine.prototype.setMap=function(map)
{ol.control.CanvasBase.prototype.getCanvas.call(this,map);var oldmap=this.getMap();if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.control.ScaleLine.prototype.setMap.call(this,map);if(oldmap)oldmap.renderSync();if(map){this._listener=map.on('postcompose',this.drawScale_.bind(this));}
this.element.style.visibility='hidden';this.olscale=this.element.querySelector(".ol-scale-line-inner");}
ol.control.CanvasScaleLine.prototype.setStyle=function(style)
{var stroke=style.getStroke();this.strokeStyle_=stroke?ol.color.asString(stroke.getColor()):"#000";this.strokeWidth_=stroke?stroke.getWidth():2;var fill=style.getFill();this.fillStyle_=fill?ol.color.asString(fill.getColor()):"#fff";var text=style.getText();this.font_=text?text.getFont():"10px Arial";stroke=text?text.getStroke():null;fill=text?text.getFill():null;this.fontStrokeStyle_=stroke?ol.color.asString(stroke.getColor()):this.fillStyle_;this.fontStrokeWidth_=stroke?stroke.getWidth():3;this.fontFillStyle_=fill?ol.color.asString(fill.getColor()):this.strokeStyle_;if(this.getMap())this.getMap().render();}
ol.control.CanvasScaleLine.prototype.drawScale_=function(e)
{if(this.element.style.visibility!=="hidden")return;var ctx=this.getContext(e);if(!ctx)return;var scalewidth=parseInt(this.olscale.style.width);if(!scalewidth)return;var text=this.olscale.textContent;var position={left:this.element.offsetLeft,top:this.element.offsetTop};var ratio=e.frameState.pixelRatio;ctx.save();ctx.scale(ratio,ratio);position.top+=this.element.clientHeight-this.scaleHeight_;ctx.beginPath();ctx.strokeStyle=this.fontStrokeStyle_;ctx.fillStyle=this.fontFillStyle_;ctx.lineWidth=this.fontStrokeWidth_;ctx.textAlign="center";ctx.textBaseline="bottom";ctx.font=this.font_;ctx.strokeText(text,position.left+scalewidth/2,position.top);ctx.fillText(text,position.left+scalewidth/2,position.top);ctx.closePath();position.top+=2;ctx.lineWidth=this.strokeWidth_;ctx.strokeStyle=this.strokeStyle_;var max=4;var n=parseInt(text);while(n%10===0)n/=10;if(n%5===0)max=5;for(var i=0;i<max;i++)
{ctx.beginPath();ctx.fillStyle=i%2?this.fillStyle_:this.strokeStyle_;ctx.rect(position.left+i*scalewidth/max,position.top,scalewidth/max,this.scaleHeight_);ctx.stroke();ctx.fill();ctx.closePath();}
ctx.restore();}
ol.control.CanvasTitle=function(options){if(!options)options={};var elt=ol.ext.element.create('DIV',{className:(options.className||'')+' ol-control-title ol-unselectable',style:{display:'block',visibility:'hidden'}});ol.control.CanvasBase.call(this,{element:elt,style:options.style});this.setTitle(options.title||'Title');this.element.style.font=this.getTextFont();};ol.ext.inherits(ol.control.CanvasTitle,ol.control.CanvasBase);ol.control.CanvasTitle.prototype.setStyle=function(style){ol.control.CanvasBase.prototype.setStyle.call(this,style);if(this.element){this.element.style.font=this.getTextFont();}
if(this.getMap())this.getMap().render();};ol.control.CanvasTitle.prototype.setTitle=function(title){this.element.textContent=title;this.set('title',title);if(this.getMap())this.getMap().renderSync();};ol.control.CanvasTitle.prototype.getTitle=function(){return this.get('title');};ol.control.CanvasTitle.prototype.setVisible=function(b){this.element.style.display=(b?'block':'none');if(this.getMap())this.getMap().renderSync();};ol.control.CanvasTitle.prototype.getVisible=function(){return this.element.style.display!=='none';};ol.control.CanvasTitle.prototype._draw=function(e){if(!this.getVisible())return;var ctx=this.getContext(e);if(!ctx)return;var ratio=e.frameState.pixelRatio;ctx.save();ctx.scale(ratio,ratio);var eltRect=this.element.getBoundingClientRect();var mapRect=this.getMap().getViewport().getBoundingClientRect();var sc=this.getMap().getSize()[0]/mapRect.width;ctx.translate((eltRect.left-mapRect.left)*sc,(eltRect.top-mapRect.top)*sc);var h=this.element.clientHeight;var w=this.element.clientWidth;var left=w/2;ctx.beginPath();ctx.fillStyle=ol.color.asString(this.getFill().getColor());ctx.rect(0,0,w,h);ctx.fill();ctx.closePath();ctx.beginPath();ctx.fillStyle=ol.color.asString(this.getTextFill().getColor());ctx.strokeStyle=ol.color.asString(this.getTextStroke().getColor());ctx.lineWidth=this.getTextStroke().getWidth();ctx.textAlign='center';ctx.textBaseline='middle';ctx.font=this.getTextFont();if(ctx.lineWidth)ctx.strokeText(this.getTitle(),left,h/2);ctx.fillText(this.getTitle(),left,h/2);ctx.closePath();ctx.restore();};ol.control.CenterPosition=function(options){if(!options)options={};var elt=ol.ext.element.create('DIV',{className:(options.className||'')+' ol-center-position ol-unselectable',style:{display:'block',visibility:'hidden'}});ol.control.CanvasBase.call(this,{element:elt,style:options.style});this.element.style.font=this.getTextFont();this.set('projection',options.projection);this.setCanvas(options.canvas);this._format=(typeof options.coordinateFormat==='function')?options.coordinateFormat:ol.coordinate.toStringXY;};ol.ext.inherits(ol.control.CenterPosition,ol.control.CanvasBase);ol.control.CenterPosition.prototype.setStyle=function(style){ol.control.CanvasBase.prototype.setStyle.call(this,style);if(this.element){this.element.style.font=this.getTextFont();}
if(this.getMap())this.getMap().render();};ol.control.CenterPosition.prototype.setCanvas=function(b){this.set('canvas',b);this.element.style.visibility=b?"hidden":"visible";if(this.getMap())this.getMap().renderSync();};ol.control.CenterPosition.prototype.setVisible=function(b){this.element.style.display=(b?'':'none');if(this.getMap())this.getMap().renderSync();};ol.control.CenterPosition.prototype.getVisible=function(){return this.element.style.display!=='none';};ol.control.CenterPosition.prototype._draw=function(e){if(!this.getVisible()||!this.getMap())return;var coord=this.getMap().getView().getCenter();if(this.get('projection'))coord=ol.proj.transform(coord,this.getMap().getView().getProjection(),this.get('projection'));coord=this._format(coord);this.element.textContent=coord;if(!this.get('canvas'))return;var ctx=this.getContext(e);if(!ctx)return;var ratio=e.frameState.pixelRatio;ctx.save();ctx.scale(ratio,ratio);var eltRect=this.element.getBoundingClientRect();var mapRect=this.getMap().getViewport().getBoundingClientRect();var sc=this.getMap().getSize()[0]/mapRect.width;ctx.translate((eltRect.left-mapRect.left)*sc,(eltRect.top-mapRect.top)*sc);var h=this.element.clientHeight;var w=this.element.clientWidth;ctx.beginPath();ctx.fillStyle=ol.color.asString(this.getTextFill().getColor());ctx.strokeStyle=ol.color.asString(this.getTextStroke().getColor());ctx.lineWidth=this.getTextStroke().getWidth();ctx.textAlign='center';ctx.textBaseline='middle';ctx.font=this.getTextFont();if(ctx.lineWidth)ctx.strokeText(coord,w/2,h/2);ctx.fillText(coord,w/2,h/2);ctx.closePath();ctx.restore();};ol.control.Compass=function(options){var self=this;if(!options)options={};var elt=document.createElement("div");elt.className="ol-compassctrl ol-unselectable ol-hidden"+(options.className?" "+options.className:"");elt.style.position="absolute";elt.style.visibility="hidden";var style=(options.style instanceof ol.style.Stroke)?new ol.style.Style({stroke:options.style}):options.style;if(!options.style){style=new ol.style.Style({stroke:new ol.style.Stroke({width:0})});}
ol.control.CanvasBase.call(this,{element:elt,style:style});this.set('rotateVithView',options.rotateWithView!==false);if(options.image){this.img_=options.image;}
else if(options.src){this.img_=new Image();this.img_.onload=function(){if(self.getMap())self.getMap().renderSync();}
this.img_.src=options.src;}else{this.img_=this.defaultCompass_(this.element.clientWidth,this.getStroke().getColor());}
this.da_=[];for(var i=0;i<8;i++)this.da_[i]=[Math.cos(Math.PI*i/8),Math.sin(Math.PI*i/8)];};ol.ext.inherits(ol.control.Compass,ol.control.CanvasBase);ol.control.Compass.prototype.defaultCompass_=function(s,color){var canvas=document.createElement('canvas');var ctx=canvas.getContext("2d");s=canvas.width=canvas.height=s||150;var r=s/2;var r2=0.22*r;function draw(r,r2){ctx.fillStyle=color||"#963";ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(r,0);ctx.lineTo(r2,r2);ctx.moveTo(0,0);ctx.lineTo(-r,0);ctx.lineTo(-r2,-r2);ctx.moveTo(0,0);ctx.lineTo(0,r);ctx.lineTo(-r2,r2);ctx.moveTo(0,0);ctx.lineTo(0,-r);ctx.lineTo(r2,-r2);ctx.moveTo(0,0);ctx.fill();ctx.stroke();}
function draw2(r,r2){ctx.globalCompositeOperation="destination-out";ctx.fillStyle="#fff";ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(r,0);ctx.lineTo(r2,-r2);ctx.moveTo(0,0);ctx.lineTo(-r,0);ctx.lineTo(-r2,r2);ctx.moveTo(0,0);ctx.lineTo(0,r);ctx.lineTo(r2,r2);ctx.moveTo(0,0);ctx.lineTo(0,-r);ctx.lineTo(-r2,-r2);ctx.moveTo(0,0);ctx.fill();ctx.globalCompositeOperation="source-over";ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(r,0);ctx.lineTo(r2,-r2);ctx.moveTo(0,0);ctx.lineTo(-r,0);ctx.lineTo(-r2,r2);ctx.moveTo(0,0);ctx.lineTo(0,r);ctx.lineTo(r2,r2);ctx.moveTo(0,0);ctx.lineTo(0,-r);ctx.lineTo(-r2,-r2);ctx.moveTo(0,0);ctx.stroke();}
ctx.translate(r,r);ctx.strokeStyle=color||"#963";ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(0,0,s*0.41,0,2*Math.PI);ctx.arc(0,0,s*0.44,0,2*Math.PI);ctx.stroke();ctx.rotate(Math.PI/4)
draw(r*0.9,r2*0.8);draw2(r*0.9,r2*0.8);ctx.rotate(-Math.PI/4)
draw(r,r2);draw2(r,r2);return canvas;};ol.control.Compass.prototype._draw=function(e){var ctx=this.getContext(e);if(!ctx)return;var canvas=ctx.canvas;var ratio=e.frameState.pixelRatio;ctx.save();ctx.scale(ratio,ratio);var w=this.element.clientWidth;var h=this.element.clientHeight;var pos={left:this.element.offsetLeft,top:this.element.offsetTop};var compass=this.img_;var rot=e.frameState.viewState.rotation;ctx.beginPath();ctx.translate(pos.left+w/2,pos.top+h/2);if(this.get('rotateVithView'))ctx.rotate(rot);if(this.getStroke().getWidth()){ctx.beginPath();ctx.strokeStyle=this.getStroke().getColor();ctx.lineWidth=this.getStroke().getWidth();var m=Math.max(canvas.width,canvas.height);for(var i=0;i<8;i++){ctx.moveTo(-this.da_[i][0]*m,-this.da_[i][1]*m);ctx.lineTo(this.da_[i][0]*m,this.da_[i][1]*m);}
ctx.stroke();}
if(compass.width){ctx.drawImage(compass,-w/2,-h/2,w,h);}
ctx.closePath();ctx.restore();};ol.control.Dialog=function(options){options=options||{};var element=ol.ext.element.create('DIV',{className:((options.className||'')+(options.zoom?' ol-zoom':'')+' ol-ext-dialog').trim(),click:function(){if(this.get('hideOnClick'))this.close();}.bind(this)});var form=ol.ext.element.create('FORM',{on:{submit:this._onButton('submit')},parent:element});ol.ext.element.create('H2',{parent:form});ol.ext.element.create('DIV',{className:'ol-closebox',click:this._onButton('cancel'),parent:form});ol.ext.element.create('DIV',{className:'ol-content',parent:form});ol.ext.element.create('DIV',{className:'ol-buttons',parent:form});ol.control.Control.call(this,{element:element,target:options.target});this.set('closeBox',options.closeBox);this.set('zoom',options.zoom);this.set('hideOnClick',options.hideOnClick);this.set('className',options.className);};ol.ext.inherits(ol.control.Dialog,ol.control.Control);ol.control.Dialog.prototype.show=function(options){if(options instanceof Element||typeof(options)==='string'){options={content:options};}
this.setContent(options);this.element.classList.add('ol-visible');this.dispatchEvent({type:'show'});};ol.control.Dialog.prototype.open=function(){this.show();};ol.control.Dialog.prototype.setContent=function(options){if(!options)return;this.element.className='ol-ext-dialog'+(this.get('zoom')?' ol-zoom':'');if(options.className){this.element.classList.add(options.className);}else if(this.get('className')){this.element.classList.add(this.get('className'));}
var form=this.element.querySelector('form');ol.ext.element.setHTML(form.querySelector('.ol-content'),options.content||'');form.querySelector('h2').innerText=options.title||'';if(options.title){form.classList.add('ol-title');}else{form.classList.remove('ol-title');}
if(options.closeBox||(this.get('closeBox')&&options.closeBox!==false)){form.classList.add('ol-closebox');}else{form.classList.remove('ol-closebox');}
var buttons=this.element.querySelector('.ol-buttons');buttons.innerHTML='';if(options.buttons){form.classList.add('ol-button');for(var i in options.buttons){ol.ext.element.create('INPUT',{type:(i==='submit'?'submit':'button'),value:options.buttons[i],click:this._onButton(i),parent:buttons});}}else{form.classList.remove('ol-button');}};ol.control.Dialog.prototype._onButton=function(button){var fn=function(e){e.preventDefault();this.hide();var inputs={};this.element.querySelectorAll('form input').forEach(function(input){if(input.className)inputs[input.className]=input;});this.dispatchEvent({type:'button',button:button,inputs:inputs});}.bind(this);return fn;};ol.control.Dialog.prototype.hide=function(){this.element.classList.remove('ol-visible');this.dispatchEvent({type:'hide'});};ol.control.Dialog.prototype.close=ol.control.Dialog.prototype.hide;ol.control.Dialog.prototype.isOpen=function(){return(this.element.classList.contains('ol-visible'));};ol.control.Disable=function(options)
{options=options||{};var element=document.createElement("div");element.className=(options.className||""+' ol-disable ol-unselectable ol-control').trim();var stylesOptions={top:"0px",left:"0px",right:"0px",bottom:"0px","zIndex":10000,background:"none",display:"none"};Object.keys(stylesOptions).forEach(function(styleKey){element.style[styleKey]=stylesOptions[styleKey];});ol.control.Control.call(this,{element:element});}
ol.ext.inherits(ol.control.Disable,ol.control.Control);ol.control.Disable.prototype.isOn=function()
{return this.element.classList.contains("ol-disable");}
ol.control.Disable.prototype.disableMap=function(b)
{if(b)
{this.element.classList.add("ol-enable").show();}
else
{this.element.classList.remove("ol-enable").hide();}}
ol.control.EditBar=function(options){options=options||{};options.interactions=options.interactions||{};ol.control.Bar.call(this,{className:(options.className?options.className+' ':'')+'ol-editbar',toggleOne:true,target:options.target});this._source=options.source;this._interactions={};this._setSelectInteraction(options);if(options.edition!==false)this._setEditInteraction(options);this._setModifyInteraction(options);};ol.ext.inherits(ol.control.EditBar,ol.control.Bar);ol.control.EditBar.prototype.setMap=function(map){if(this.getMap()){if(this._interactions.Delete)this.getMap().removeInteraction(this._interactions.Delete);if(this._interactions.ModifySelect)this.getMap().removeInteraction(this._interactions.ModifySelect);}
ol.control.Bar.prototype.setMap.call(this,map);if(this.getMap()){if(this._interactions.Delete)this.getMap().addInteraction(this._interactions.Delete);if(this._interactions.ModifySelect)this.getMap().addInteraction(this._interactions.ModifySelect);}};ol.control.EditBar.prototype.getInteraction=function(name){return this._interactions[name];};ol.control.EditBar.prototype._getTitle=function(option){return(option&&option.title)?option.title:option;};ol.control.EditBar.prototype._setSelectInteraction=function(options){var self=this;var sbar=new ol.control.Bar();var selectCtrl;if(options.interactions.Delete!==false){if(options.interactions.Delete instanceof ol.interaction.Delete){this._interactions.Delete=options.interactions.Delete;}else{this._interactions.Delete=new ol.interaction.Delete();}
var del=this._interactions.Delete;del.setActive(false);if(this.getMap())this.getMap().addInteraction(del);sbar.addControl(new ol.control.Button({className:'ol-delete',title:this._getTitle(options.interactions.Delete)||"Delete",handleClick:function(e){del.delete(selectCtrl.getInteraction().getFeatures());console.log('del')
var evt={type:'select',selected:[],deselected:selectCtrl.getInteraction().getFeatures().getArray().slice(),mapBrowserEvent:e.mapBrowserEvent};selectCtrl.getInteraction().getFeatures().clear();selectCtrl.getInteraction().dispatchEvent(evt);}}));}
if(options.interactions.Info!==false){sbar.addControl(new ol.control.Button({className:'ol-info',title:this._getTitle(options.interactions.Info)||"Show informations",handleClick:function(){self.dispatchEvent({type:'info',features:selectCtrl.getInteraction().getFeatures()});}}));}
if(options.interactions.Select!==false){if(options.interactions.Select instanceof ol.interaction.Select){this._interactions.Select=options.interactions.Select}else{this._interactions.Select=new ol.interaction.Select({condition:ol.events.condition.click});}
var sel=this._interactions.Select;selectCtrl=new ol.control.Toggle({className:'ol-selection',title:this._getTitle(options.interactions.Select)||"Select",interaction:sel,bar:sbar.getControls().length?sbar:undefined,autoActivate:true,active:true});this.addControl(selectCtrl);sel.on('change:active',function(){sel.getFeatures().clear();});}};ol.control.EditBar.prototype._setEditInteraction=function(options){if(options.interactions.DrawPoint!==false){if(options.interactions.DrawPoint instanceof ol.interaction.Draw){this._interactions.DrawPoint=options.interactions.DrawPoint;}else{this._interactions.DrawPoint=new ol.interaction.Draw({type:'Point',source:this._source});}
var pedit=new ol.control.Toggle({className:'ol-drawpoint',title:this._getTitle(options.interactions.DrawPoint)||'Point',interaction:this._interactions.DrawPoint});this.addControl(pedit);}
if(options.interactions.DrawLine!==false){if(options.interactions.DrawLine instanceof ol.interaction.Draw){this._interactions.DrawLine=options.interactions.DrawLine}else{this._interactions.DrawLine=new ol.interaction.Draw({type:'LineString',source:this._source,geometryFunction:function(coordinates,geometry){if(geometry)geometry.setCoordinates(coordinates);else geometry=new ol.geom.LineString(coordinates);this.nbpts=geometry.getCoordinates().length;return geometry;}});}
var ledit=new ol.control.Toggle({className:'ol-drawline',title:this._getTitle(options.interactions.DrawLine)||'LineString',interaction:this._interactions.DrawLine,bar:new ol.control.Bar({controls:[new ol.control.TextButton({html:this._getTitle(options.interactions.UndoDraw)||'undo',title:this._getTitle(options.interactions.UndoDraw)||"delete last point",handleClick:function(){if(ledit.getInteraction().nbpts>1)ledit.getInteraction().removeLastPoint();}}),new ol.control.TextButton({html:this._getTitle(options.interactions.FinishDraw)||'finish',title:this._getTitle(options.interactions.FinishDraw)||"finish",handleClick:function(){if(ledit.getInteraction().nbpts>2)ledit.getInteraction().finishDrawing();}})]})});this.addControl(ledit);}
if(options.interactions.DrawPolygon!==false){if(options.interactions.DrawPolygon instanceof ol.interaction.Draw){this._interactions.DrawPolygon=options.interactions.DrawPolygon}else{this._interactions.DrawPolygon=new ol.interaction.Draw({type:'Polygon',source:this._source,geometryFunction:function(coordinates,geometry){this.nbpts=coordinates[0].length;if(geometry)geometry.setCoordinates([coordinates[0].concat([coordinates[0][0]])]);else geometry=new ol.geom.Polygon(coordinates);return geometry;}});}
this._setDrawPolygon('ol-drawpolygon',this._interactions.DrawPolygon,this._getTitle(options.interactions.DrawPolygon)||'Polygon',options);}
if(options.interactions.DrawHole!==false){if(options.interactions.DrawHole instanceof ol.interaction.DrawHole){this._interactions.DrawHole=options.interactions.DrawHole;}else{this._interactions.DrawHole=new ol.interaction.DrawHole();}
this._setDrawPolygon('ol-drawhole',this._interactions.DrawHole,this._getTitle(options.interactions.DrawHole)||'Hole',options);}
if(options.interactions.DrawRegular!==false){if(options.interactions.DrawRegular instanceof ol.interaction.DrawRegular){this._interactions.DrawRegular=options.interactions.DrawRegular}else{this._interactions.DrawRegular=new ol.interaction.DrawRegular({source:this._source,sides:4});}
var regular=this._interactions.DrawRegular;var div=document.createElement('DIV');var down=ol.ext.element.create('DIV',{parent:div});ol.ext.element.addListener(down,['click','touchstart'],function(){var sides=regular.getSides()-1;if(sides<2)sides=2;regular.setSides(sides);text.textContent=sides>2?sides+' pts':'circle';}.bind(this));var text=ol.ext.element.create('TEXT',{html:'4 pts',parent:div});var up=ol.ext.element.create('DIV',{parent:div});ol.ext.element.addListener(up,['click','touchstart'],function(){var sides=regular.getSides()+1;if(sides<3)sides=3;regular.setSides(sides);text.textContent=sides+' pts';}.bind(this));var ctrl=new ol.control.Toggle({className:'ol-drawregular',title:this._getTitle(options.interactions.DrawRegular)||'Regular',interaction:this._interactions.DrawRegular,bar:new ol.control.Bar({controls:[new ol.control.TextButton({html:div})]})});this.addControl(ctrl);}};ol.control.EditBar.prototype._setDrawPolygon=function(className,interaction,title,options){var fedit=new ol.control.Toggle({className:className,title:title,interaction:interaction,bar:new ol.control.Bar({controls:[new ol.control.TextButton({html:this._getTitle(options.interactions.UndoDraw)||'undo',title:this._getTitle(options.interactions.UndoDraw)||'undo last point',handleClick:function(){if(fedit.getInteraction().nbpts>1)fedit.getInteraction().removeLastPoint();}}),new ol.control.TextButton({html:this._getTitle(options.interactions.FinishDraw)||'finish',title:this._getTitle(options.interactions.FinishDraw)||'finish',handleClick:function(){if(fedit.getInteraction().nbpts>3)fedit.getInteraction().finishDrawing();}})]})});this.addControl(fedit);};ol.control.EditBar.prototype._setModifyInteraction=function(options){if(options.interactions.ModifySelect!==false&&options.interactions.Select!==false){if(options.interactions.ModifySelect instanceof ol.interaction.ModifyFeature){this._interactions.ModifySelect=options.interactions.ModifySelect;}else{this._interactions.ModifySelect=new ol.interaction.ModifyFeature({features:this.getInteraction('Select').getFeatures()});}
if(this.getMap())this.getMap().addInteraction(this._interactions.ModifySelect);this._interactions.ModifySelect.setActive(this._interactions.Select.getActive());this._interactions.Select.on('change:active',function(){this._interactions.ModifySelect.setActive(this._interactions.Select.getActive());}.bind(this));}
if(options.interactions.Transform!==false){if(options.interactions.Transform instanceof ol.interaction.Transform){this._interactions.Transform=options.interactions.Transform;}else{this._interactions.Transform=new ol.interaction.Transform({addCondition:ol.events.condition.shiftKeyOnly});}
var transform=new ol.control.Toggle({html:'<i></i>',className:'ol-transform',title:this._getTitle(options.interactions.Transform)||'Transform',interaction:this._interactions.Transform});this.addControl(transform);}
if(options.interactions.Split!==false){if(options.interactions.Split instanceof ol.interaction.Split){this._interactions.Split=options.interactions.Split;}else{this._interactions.Split=new ol.interaction.Split({sources:this._source});}
var split=new ol.control.Toggle({className:'ol-split',title:this._getTitle(options.interactions.Split)||'Split',interaction:this._interactions.Split});this.addControl(split);}
if(options.interactions.Offset!==false){if(options.interactions.Offset instanceof ol.interaction.Offset){this._interactions.Offset=options.interactions.Offset;}else{this._interactions.Offset=new ol.interaction.Offset({source:this._source});}
var offset=new ol.control.Toggle({html:'<i></i>',className:'ol-offset',title:this._getTitle(options.interactions.Offset)||'Offset',interaction:this._interactions.Offset});this.addControl(offset);}};ol.control.Gauge=function(options)
{options=options||{};var element=document.createElement("div");element.className=((options.className||"")+' ol-gauge ol-unselectable ol-control').trim();this.title_=document.createElement("span");element.appendChild(this.title_);this.gauge_=document.createElement("button");this.gauge_.setAttribute('type','button');element.appendChild(document.createElement("div").appendChild(this.gauge_))
this.gauge_.style.width='0px';ol.control.Control.call(this,{element:element,target:options.target});this.setTitle(options.title);this.val(options.val);this.set("max",options.max||100);};ol.ext.inherits(ol.control.Gauge,ol.control.Control);ol.control.Gauge.prototype.setTitle=function(title)
{this.title_.innerHTML=title||"";if(!title)this.title_.display='none';else this.title_.display='';};ol.control.Gauge.prototype.val=function(v)
{if(v!==undefined)
{this.val_=v;this.gauge_.style.width=(v/this.get('max')*100)+"%";}
return this.val_;};ol.control.GeoBookmark=function(options){options=options||{};var self=this;var element=document.createElement('div');if(options.target){element.className=options.className||"ol-bookmark";}else{element.className=(options.className||"ol-bookmark")+" ol-unselectable ol-control ol-collapsed";element.addEventListener("mouseleave",function(){if(input!==document.activeElement){menu.style.display='none';}});this.button=document.createElement('button');this.button.setAttribute('type','button');this.button.addEventListener('click',function(){menu.style.display=(menu.style.display===''||menu.style.display==='none'?'block':'none');});element.appendChild(this.button);}
var menu=document.createElement('div');element.appendChild(menu);var ul=document.createElement('ul');menu.appendChild(ul);var input=document.createElement('input');input.setAttribute("placeholder",options.placeholder||"Add a new geomark...")
input.addEventListener("change",function(){var title=this.value;if(title){self.addBookmark(title);this.value='';self.dispatchEvent({type:"add",name:title});}
menu.style.display='none';});input.addEventListener("blur",function(){menu.style.display='none';});menu.appendChild(input);ol.control.Control.call(this,{element:element,target:options.target});this.on("propertychange",function(e){if(e.key==='editable'){element.className=element.className.replace(" ol-editable","");if(this.get('editable')){element.className+=" ol-editable";}}}.bind(this));this.set("namespace",options.namespace||'ol');this.set("editable",options.editable!==false);this.setBookmarks(localStorage[this.get('namespace')+"@bookmark"]?null:options.marks);};ol.ext.inherits(ol.control.GeoBookmark,ol.control.Control);ol.control.GeoBookmark.prototype.setBookmarks=function(bmark){if(!bmark)bmark=JSON.parse(localStorage[this.get('namespace')+"@bookmark"]||"{}");var modify=this.get("editable");var ul=this.element.querySelector("ul");var menu=this.element.querySelector("div");var self=this;ul.innerHTML='';for(var b in bmark){var li=document.createElement('li');li.textContent=b;li.setAttribute('data-bookmark',JSON.stringify(bmark[b]));li.addEventListener('click',function(){var bm=JSON.parse(this.getAttribute("data-bookmark"));self.getMap().getView().setCenter(bm.pos);self.getMap().getView().setZoom(bm.zoom);menu.style.display='none';});ul.appendChild(li);if(modify&&!bmark[b].permanent){var button=document.createElement('button');button.setAttribute('data-name',b);button.setAttribute("title","Suppr.");button.addEventListener('click',function(e){self.removeBookmark(this.getAttribute("data-name"));self.dispatchEvent({type:"remove",name:this.getAttribute("data-name")});e.stopPropagation();});li.appendChild(button);}}
localStorage[this.get('namespace')+"@bookmark"]=JSON.stringify(bmark);};ol.control.GeoBookmark.prototype.getBookmarks=function(){return JSON.parse(localStorage[this.get('namespace')+"@bookmark"]||"{}");};ol.control.GeoBookmark.prototype.removeBookmark=function(name){if(!name){return;}
var bmark=this.getBookmarks();delete bmark[name];this.setBookmarks(bmark);};ol.control.GeoBookmark.prototype.addBookmark=function(name,position,zoom,permanent)
{if(!name)return;var bmark=this.getBookmarks();if(bmark[name]&&bmark[name].permanent)return;bmark[name]={pos:position||this.getMap().getView().getCenter(),zoom:zoom||this.getMap().getView().getZoom(),permanent:!!permanent};this.setBookmarks(bmark);};ol.control.GeolocationBar=function(options){if(!options)options={};options.className=options.className||'ol-geobar';ol.control.Bar.call(this,options);this.setPosition(options.position||'bottom-right');var element=this.element;var interaction=new ol.interaction.GeolocationDraw({source:options.source,zoom:options.zoom,followTrack:options.followTrack,minAccuracy:options.minAccuracy||10000});this._geolocBt=new ol.control.Toggle({className:'geolocBt',interaction:interaction,onToggle:function(){interaction.pause(true);interaction.setFollowTrack(options.followTrack);element.classList.remove('pauseTrack');}});this.addControl(this._geolocBt);this._geolocBt.setActive(false);var bar=new ol.control.Bar();this.addControl(bar);var centerBt=new ol.control.TextButton({className:'centerBt',html:options.centerLabel||'center',handleClick:function(){interaction.setFollowTrack('auto');}});bar.addControl(centerBt);var startBt=new ol.control.Button({className:'startBt',handleClick:function(){interaction.pause(false);interaction.setFollowTrack('auto');element.classList.add('pauseTrack');}});bar.addControl(startBt);var pauseBt=new ol.control.Button({className:'pauseBt',handleClick:function(){interaction.pause(true);interaction.setFollowTrack('auto');element.classList.remove('pauseTrack');}});bar.addControl(pauseBt);interaction.on('follow',function(e){if(e.following){element.classList.remove('centerTrack');}else{element.classList.add('centerTrack');}});this._geolocBt.on('change:active',function(e){if(e.active){element.classList.add('ol-active');}else{element.classList.remove('ol-active');}});};ol.ext.inherits(ol.control.GeolocationBar,ol.control.Bar);ol.control.GeolocationBar.prototype.getInteraction=function(){return this._geolocBt.getInteraction();};ol.control.Globe=function(opt_options)
{var options=opt_options||{};var self=this;var element;if(options.target)
{element=document.createElement("div");this.panel_=options.target;}
else
{element=document.createElement("div");element.classList.add('ol-globe','ol-unselectable','ol-control');if(/top/.test(options.align))element.classList.add('ol-control-top');if(/right/.test(options.align))element.classList.add('ol-control-right');this.panel_=document.createElement("div");this.panel_.classList.add("panel")
element.appendChild(this.panel_);this.pointer_=document.createElement("div");this.pointer_.classList.add("ol-pointer");element.appendChild(this.pointer_);}
ol.control.Control.call(this,{element:element,target:options.target});this.ovmap_=new ol.Map({controls:new ol.Collection(),interactions:new ol.Collection(),target:this.panel_,view:new ol.View
({zoom:0,center:[0,0]}),layers:options.layers});setTimeout(function()
{self.ovmap_.updateSize();},0);this.set('follow',options.follow||false);this.extentLayer=new ol.layer.Vector({name:'Cache extent',source:new ol.source.Vector(),style:options.style||[new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:'rgba(255,0,0, 1)'}),stroke:new ol.style.Stroke({width:7,color:'rgba(255,0,0, 0.8)'}),radius:5})})]})
this.ovmap_.addLayer(this.extentLayer);};ol.ext.inherits(ol.control.Globe,ol.control.Control);ol.control.Globe.prototype.setMap=function(map){if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.control.Control.prototype.setMap.call(this,map);if(map)
{this._listener=map.getView().on('propertychange',this.setView.bind(this));this.setView();}};ol.control.Globe.prototype.setView=function()
{if(this.getMap()&&this.get('follow'))
{this.setCenter(this.getMap().getView().getCenter());}}
ol.control.Globe.prototype.getGlobe=function()
{return this.ovmap_;}
ol.control.Globe.prototype.show=function(b)
{if(b!==false)this.element.classList.remove("ol-collapsed");else this.element.classList.add("ol-collapsed");this.ovmap_.updateSize();}
ol.control.Globe.prototype.setPosition=function(align)
{if(/top/.test(align))this.element.classList.add("ol-control-top");else this.element.classList.remove("ol-control-top");if(/right/.test(align))this.element.classList.add("ol-control-right");else this.element.classList.remove("ol-control-right");}
ol.control.Globe.prototype.setCenter=function(center,show)
{var self=this;this.pointer_.classList.add("hidden");if(center)
{var map=this.ovmap_;var p=map.getPixelFromCoordinate(center);if(p){if(show!==false){var h=this.element.clientHeight;setTimeout(function(){self.pointer_.style.top=String(Math.min(Math.max(p[1],0),h))+'px';self.pointer_.style.left="50%";self.pointer_.classList.remove("hidden");},800);}
map.getView().animate({center:[center[0],0]});}}};ol.control.Graticule=function(options){if(!options)options={};var elt=document.createElement("div");elt.className="ol-graticule ol-unselectable ol-hidden";ol.control.CanvasBase.call(this,{element:elt});this.set('projection',options.projection||'EPSG:4326');var p=new ol.proj.Projection({code:this.get('projection')});var m=p.getMetersPerUnit();this.fac=1;while(m/this.fac>10){this.fac*=10;}
this.fac=10000/this.fac;this.set('maxResolution',options.maxResolution||Infinity);this.set('step',options.step||0.1);this.set('stepCoord',options.stepCoord||1);this.set('spacing',options.spacing||40);this.set('margin',options.margin||0);this.set('borderWidth',options.borderWidth||5);this.set('stroke',options.stroke!==false);this.formatCoord=options.formatCoord||function(c){return c;};if(options.style instanceof ol.style.Style){this.setStyle(options.style);}
else{this.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:"#000",width:1}),fill:new ol.style.Fill({color:"#fff"}),text:new ol.style.Text({stroke:new ol.style.Stroke({color:"#fff",width:2}),fill:new ol.style.Fill({color:"#000"}),})}));}};ol.ext.inherits(ol.control.Graticule,ol.control.CanvasBase);ol.control.Graticule.prototype.setStyle=function(style){this._style=style;};ol.control.Graticule.prototype._draw=function(e){if(this.get('maxResolution')<e.frameState.viewState.resolution)return;var ctx=this.getContext(e);var canvas=ctx.canvas;var ratio=e.frameState.pixelRatio;var w=canvas.width/ratio;var h=canvas.height/ratio;var proj=this.get('projection');var map=this.getMap();var bbox=[map.getCoordinateFromPixel([0,0]),map.getCoordinateFromPixel([w,0]),map.getCoordinateFromPixel([w,h]),map.getCoordinateFromPixel([0,h])];var xmax=-Infinity;var xmin=Infinity;var ymax=-Infinity;var ymin=Infinity;for(var i=0,c;c=bbox[i];i++)
{bbox[i]=ol.proj.transform(c,map.getView().getProjection(),proj);xmax=Math.max(xmax,bbox[i][0]);xmin=Math.min(xmin,bbox[i][0]);ymax=Math.max(ymax,bbox[i][1]);ymin=Math.min(ymin,bbox[i][1]);}
var spacing=this.get('spacing');var step=this.get('step');var step2=this.get('stepCoord');var borderWidth=this.get('borderWidth');var margin=this.get('margin');var ds=(xmax-xmin)/step*spacing;if(ds>w)
{var dt=Math.round((xmax-xmin)/w*spacing/step);step*=dt;if(step>this.fac)step=Math.round(step/this.fac)*this.fac;}
xmin=(Math.floor(xmin/step))*step-step;ymin=(Math.floor(ymin/step))*step-step;xmax=(Math.floor(xmax/step))*step+2*step;ymax=(Math.floor(ymax/step))*step+2*step;var extent=ol.proj.get(proj).getExtent();if(extent)
{if(xmin<extent[0])xmin=extent[0];if(ymin<extent[1])ymin=extent[1];if(xmax>extent[2])xmax=extent[2]+step;if(ymax>extent[3])ymax=extent[3]+step;}
var hasLines=this.getStyle().getStroke()&&this.get("stroke");var hasText=this.getStyle().getText();var hasBorder=this.getStyle().getFill();ctx.save();ctx.scale(ratio,ratio);ctx.beginPath();ctx.rect(margin,margin,w-2*margin,h-2*margin);ctx.clip();ctx.beginPath();var txt={top:[],left:[],bottom:[],right:[]};var x,y,p,p0,p1;for(x=xmin;x<xmax;x+=step)
{p0=ol.proj.transform([x,ymin],proj,map.getView().getProjection());p0=map.getPixelFromCoordinate(p0);if(hasLines)ctx.moveTo(p0[0],p0[1]);p=p0;for(y=ymin+step;y<=ymax;y+=step)
{p1=ol.proj.transform([x,y],proj,map.getView().getProjection());p1=map.getPixelFromCoordinate(p1);if(hasLines)ctx.lineTo(p1[0],p1[1]);if(p[1]>0&&p1[1]<0)txt.top.push([x,p]);if(p[1]>h&&p1[1]<h)txt.bottom.push([x,p]);p=p1;}}
for(y=ymin;y<ymax;y+=step)
{p0=ol.proj.transform([xmin,y],proj,map.getView().getProjection());p0=map.getPixelFromCoordinate(p0);if(hasLines)ctx.moveTo(p0[0],p0[1]);p=p0;for(x=xmin+step;x<=xmax;x+=step)
{p1=ol.proj.transform([x,y],proj,map.getView().getProjection());p1=map.getPixelFromCoordinate(p1);if(hasLines)ctx.lineTo(p1[0],p1[1]);if(p[0]<0&&p1[0]>0)txt.left.push([y,p]);if(p[0]<w&&p1[0]>w)txt.right.push([y,p]);p=p1;}}
if(hasLines)
{ctx.strokeStyle=this.getStyle().getStroke().getColor();ctx.lineWidth=this.getStyle().getStroke().getWidth();ctx.stroke();}
if(hasText)
{ctx.fillStyle=this.getStyle().getText().getFill().getColor();ctx.strokeStyle=this.getStyle().getText().getStroke().getColor();ctx.lineWidth=this.getStyle().getText().getStroke().getWidth();ctx.textAlign='center';ctx.textBaseline='hanging';var t,tf;var offset=(hasBorder?borderWidth:0)+margin+2;for(i=0;t=txt.top[i];i++)if(!(Math.round(t[0]/this.get('step'))%step2))
{tf=this.formatCoord(t[0]);ctx.strokeText(tf,t[1][0],offset);ctx.fillText(tf,t[1][0],offset);}
ctx.textBaseline='alphabetic';for(i=0;t=txt.bottom[i];i++)if(!(Math.round(t[0]/this.get('step'))%step2))
{tf=this.formatCoord(t[0]);ctx.strokeText(tf,t[1][0],h-offset);ctx.fillText(tf,t[1][0],h-offset);}
ctx.textBaseline='middle';ctx.textAlign='left';for(i=0;t=txt.left[i];i++)if(!(Math.round(t[0]/this.get('step'))%step2))
{tf=this.formatCoord(t[0]);ctx.strokeText(tf,offset,t[1][1]);ctx.fillText(tf,offset,t[1][1]);}
ctx.textAlign='right';for(i=0;t=txt.right[i];i++)if(!(Math.round(t[0]/this.get('step'))%step2))
{tf=this.formatCoord(t[0]);ctx.strokeText(tf,w-offset,t[1][1]);ctx.fillText(tf,w-offset,t[1][1]);}}
if(hasBorder)
{var fillColor=this.getStyle().getFill().getColor();var color,stroke;if(stroke=this.getStyle().getStroke())
{color=this.getStyle().getStroke().getColor();}
else
{color=fillColor;fillColor="#fff";}
ctx.strokeStyle=color;ctx.lineWidth=stroke?stroke.getWidth():1;for(i=1;i<txt.top.length;i++)
{ctx.beginPath();ctx.rect(txt.top[i-1][1][0],margin,txt.top[i][1][0]-txt.top[i-1][1][0],borderWidth);ctx.fillStyle=Math.round(txt.top[i][0]/step)%2?color:fillColor;ctx.fill();ctx.stroke();}
for(i=1;i<txt.bottom.length;i++)
{ctx.beginPath();ctx.rect(txt.bottom[i-1][1][0],h-borderWidth-margin,txt.bottom[i][1][0]-txt.bottom[i-1][1][0],borderWidth);ctx.fillStyle=Math.round(txt.bottom[i][0]/step)%2?color:fillColor;ctx.fill();ctx.stroke();}
for(i=1;i<txt.left.length;i++)
{ctx.beginPath();ctx.rect(margin,txt.left[i-1][1][1],borderWidth,txt.left[i][1][1]-txt.left[i-1][1][1]);ctx.fillStyle=Math.round(txt.left[i][0]/step)%2?color:fillColor;ctx.fill();ctx.stroke();}
for(i=1;i<txt.right.length;i++)
{ctx.beginPath();ctx.rect(w-borderWidth-margin,txt.right[i-1][1][1],borderWidth,txt.right[i][1][1]-txt.right[i-1][1][1]);ctx.fillStyle=Math.round(txt.right[i][0]/step)%2?color:fillColor;ctx.fill();ctx.stroke();}
ctx.beginPath();ctx.fillStyle=color;ctx.rect(margin,margin,borderWidth,borderWidth);ctx.rect(margin,h-borderWidth-margin,borderWidth,borderWidth);ctx.rect(w-borderWidth-margin,margin,borderWidth,borderWidth);ctx.rect(w-borderWidth-margin,h-borderWidth-margin,borderWidth,borderWidth);ctx.fill();}
ctx.restore();};ol.control.GridReference=function(options){if(!options)options={};var elt=document.createElement("div");elt.className=(!options.target?"ol-control ":"")+"ol-gridreference ol-unselectable "+(options.className||"");options.style=options.style||new ol.style.Style({stroke:new ol.style.Stroke({color:"#000",width:1}),text:new ol.style.Text({font:"bold 14px Arial",stroke:new ol.style.Stroke({color:"#fff",width:2}),fill:new ol.style.Fill({color:"#000"}),})});ol.control.CanvasBase.call(this,{element:elt,target:options.target,style:options.style});if(typeof(options.property)=='function')this.getFeatureName=options.property;if(typeof(options.sortFeatures)=='function')this.sortFeatures=options.sortFeatures;if(typeof(options.indexTitle)=='function')this.indexTitle=options.indexTitle;this.source_=options.source;if(options.source){this.setIndex(options.source.getFeatures(),options);options.source.once('change',function(){if(options.source.getState()==='ready'){this.setIndex(options.source.getFeatures(),options);}}.bind(this));}
this.set('maxResolution',options.maxResolution||Infinity);this.set('extent',options.extent);this.set('size',options.size);this.set('margin',options.margin||0);this.set('property',options.property||'name');this.set('filterLabel',options.filterLabel||'filter');};ol.ext.inherits(ol.control.GridReference,ol.control.CanvasBase);ol.control.GridReference.prototype.getFeatureName=function(f){return f.get(this.get('property')||'name');};ol.control.GridReference.prototype.sortFeatures=function(a,b){return(this.getFeatureName(a)==this.getFeatureName(b))?0:(this.getFeatureName(a)<this.getFeatureName(b))?-1:1;};ol.control.GridReference.prototype.indexTitle=function(f){return this.getFeatureName(f).charAt(0);};ol.control.GridReference.prototype.setIndex=function(features){if(!this.getMap())return;var self=this;if(features.getArray)features=features.getArray();features.sort(function(a,b){return self.sortFeatures(a,b);});this.element.innerHTML="";var elt=this.element;var search=document.createElement("input");search.setAttribute('type','search');search.setAttribute('placeholder',this.get('filterLabel')||'filter');var searchKeyupFunction=function(){var v=this.value.replace(/^\*/,'');var r=new RegExp(v,'i');ul.querySelectorAll('li').forEach(function(li){if(li.classList.contains('ol-title')){li.style.display='';}else{if(r.test(li.querySelector('.ol-name').textContent))li.style.display='';else li.style.display='none';}});ul.querySelectorAll("li.ol-title").forEach(function(li){var nextAll=false;nextAll=[].filter.call(li.parentNode.children,function(htmlElement){return(htmlElement.previousElementSibling===li)?nextAll=true:nextAll;});console.log(nextAll);var nextVisible=nextAll[0];if(nextVisible.length&&!nextVisible.classList.contains('ol-title'))li.style.display='';else li.style.display='none';});};search.addEventListener('search',searchKeyupFunction);search.addEventListener('keyup',searchKeyupFunction);elt.appendChild(search);var ul=document.createElement("ul");elt.appendChild(ul);var r,title;for(var i=0,f;f=features[i];i++){(function(feat){r=self.getReference(feat.getGeometry().getFirstCoordinate());if(r){var name=self.getFeatureName(feat);var c=self.indexTitle(feat);if(c!=title){var li_title=document.createElement("li");li_title.classList.add('ol-title');li_title.textContent=c;ul.appendChild(li_title);}
title=c;var li_ref_name=document.createElement("li");var span_name=document.createElement("span");span_name.classList.add("ol-name");span_name.textContent=name;li_ref_name.appendChild(span_name);var span_ref=document.createElement("span");span_ref.classList.add("ol-ref");span_ref.textContent=r;li_ref_name.appendChild(span_ref);var feature=feat;li_ref_name.addEventListener("click",function(){self.dispatchEvent({type:"select",feature:feature});});ul.appendChild(li_ref_name);}})(f);}};ol.control.GridReference.prototype.getReference=function(coords){if(!this.getMap())return;var extent=this.get('extent');var size=this.get('size');var dx=Math.floor((coords[0]-extent[0])/(extent[2]-extent[0])*size[0]);if(dx<0||dx>=size[0])return"";var dy=Math.floor((extent[3]-coords[1])/(extent[3]-extent[1])*size[1]);if(dy<0||dy>=size[1])return"";return String.fromCharCode(65+dx)+dy;};ol.control.GridReference.prototype._draw=function(e){if(this.get('maxResolution')<e.frameState.viewState.resolution)return;var ctx=this.getContext(e);var canvas=ctx.canvas;var ratio=e.frameState.pixelRatio;var w=canvas.width/ratio;var h=canvas.height/ratio;var extent=this.get('extent');var size=this.get('size');var map=this.getMap();var ex=ol.extent.boundingExtent([map.getPixelFromCoordinate([extent[0],extent[1]]),map.getPixelFromCoordinate([extent[2],extent[3]])]);var p0=[ex[0],ex[1]];var p1=[ex[2],ex[3]];var dx=(p1[0]-p0[0])/size[0];var dy=(p1[1]-p0[1])/size[1];ctx.save();var margin=this.get('margin');ctx.scale(ratio,ratio);ctx.strokeStyle=this.getStroke().getColor();ctx.lineWidth=this.getStroke().getWidth();ctx.beginPath();var i;for(i=0;i<=size[0];i++){ctx.moveTo(p0[0]+i*dx,p0[1]);ctx.lineTo(p0[0]+i*dx,p1[1]);}
for(i=0;i<=size[1];i++){ctx.moveTo(p0[0],p0[1]+i*dy);ctx.lineTo(p1[0],p0[1]+i*dy);}
ctx.stroke();ctx.font=this.getTextFont();ctx.fillStyle=this.getTextFill().getColor();ctx.strokeStyle=this.getTextStroke().getColor();var lw=ctx.lineWidth=this.getTextStroke().getWidth();var spacing=margin+lw;ctx.textAlign='center';var letter,x,y;for(i=0;i<size[0];i++){letter=String.fromCharCode(65+i);x=p0[0]+i*dx+dx/2;y=p0[1]-spacing;if(y<0){y=spacing;ctx.textBaseline='hanging';}
else ctx.textBaseline='alphabetic';ctx.strokeText(letter,x,y);ctx.fillText(letter,x,y);y=p1[1]+spacing;if(y>h){y=h-spacing;ctx.textBaseline='alphabetic';}
else ctx.textBaseline='hanging';ctx.strokeText(letter,x,y);ctx.fillText(letter,x,y);}
ctx.textBaseline='middle';for(i=0;i<size[1];i++){y=p0[1]+i*dy+dy/2;ctx.textAlign='right';x=p0[0]-spacing;if(x<0){x=spacing;ctx.textAlign='left';}
else ctx.textAlign='right';ctx.strokeText(i,x,y);ctx.fillText(i,x,y);x=p1[0]+spacing;if(x>w){x=w-spacing;ctx.textAlign='right';}
else ctx.textAlign='left';ctx.strokeText(i,x,y);ctx.fillText(i,x,y);}
ctx.restore();};ol.control.Imageline=function(options){var element=ol.ext.element.create('DIV',{className:(options.className||'')+' ol-imageline'
+(options.target?'':' ol-unselectable ol-control')
+(options.collapsed&&options.collapsible?'ol-collapsed':'')
+('ontouchstart'in window?' ol-touch':'')});if(!options.target&&options.collapsible){ol.ext.element.create('BUTTON',{type:'button',click:function(){this.toggle();}.bind(this),parent:element});}
this._source=options.source;ol.control.Control.call(this,{element:element,target:options.target});this._setScrolling();this._scrolldiv.addEventListener("scroll",function(){if(this.getMap())this.getMap().render();}.bind(this));if(typeof(options.getImage)==='function')this._getImage=options.getImage;if(typeof(options.getTitle)==='function')this._getTitle=options.getTitle;this.set('maxFeatures',options.maxFeatures||100);this.set('linkColor',options.linkColor||false);this.set('hover',options.hover||false);this.set('useExtent',options.useExtent||false);this.refresh();};ol.ext.inherits(ol.control.Imageline,ol.control.Control);ol.control.Imageline.prototype.setMap=function(map){if(this._listener){this._listener.forEach(function(l){ol.Observable.unByKey(l);}.bind(this));}
this._listener=null;ol.control.Control.prototype.setMap.call(this,map);if(map){this._listener=[map.on('postcompose',this._drawLink.bind(this)),map.on('moveend',function(){if(this.get('useExtent'))this.refresh();}.bind(this))]}};ol.control.Imageline.prototype.useExtent=function(b){this.set('useExtent',b);this.refresh();};ol.control.Imageline.prototype.isCollapsed=function(){return this.element.classList.contains('ol-collapsed');};ol.control.Imageline.prototype.collapse=function(b){if(b)this.element.classList.add('ol-collapsed');else this.element.classList.remove('ol-collapsed');if(this.getMap()){setTimeout(function(){this.getMap().render();}.bind(this),this.isCollapsed()?0:250);}
this.dispatchEvent({type:'collapse',collapsed:this.isCollapsed()});};ol.control.Imageline.prototype.toggle=function(){this.element.classList.toggle('ol-collapsed');if(this.getMap()){setTimeout(function(){this.getMap().render();}.bind(this),this.isCollapsed()?0:250);}
this.dispatchEvent({type:'collapse',collapsed:this.isCollapsed()});};ol.control.Imageline.prototype._getImage=function(f){return f.get('img');};ol.control.Imageline.prototype._getTitle=function(){return'';};ol.control.Imageline.prototype.getFeatures=function(){var map=this.getMap();if(!this.get('useExtent')||!map){return this._source.getFeatures();}else{var extent=map.getView().calculateExtent(map.getSize());return this._source.getFeaturesInExtent(extent);}};ol.control.Imageline.prototype._setScrolling=function(){var elt=this._scrolldiv=ol.ext.element.create('DIV',{parent:this.element});ol.ext.element.scrollDiv(elt,{onmove:function(b){this._moving=b;}.bind(this)});};ol.control.Imageline.prototype.refresh=function(){this._scrolldiv.innerHTML='';var features=this.getFeatures();var current=this._select?this._select.feature:null;if(this._select)this._select.elt=null;this._iline=[];if(this.getMap())this.getMap().render();var addImage=function(f){if(this._getImage(f)){var img=ol.ext.element.create('DIV',{className:'ol-image',parent:this._scrolldiv});ol.ext.element.create('IMG',{src:this._getImage(f),parent:img}).addEventListener('load',function(){this.classList.add('ol-loaded');});ol.ext.element.create('SPAN',{html:this._getTitle(f),parent:img});var sel={elt:img,feature:f};img.addEventListener('click',function(){if(!this._moving){this.dispatchEvent({type:'select',feature:f});this._scrolldiv.scrollLeft=img.offsetLeft
+ol.ext.element.getStyle(img,'width')/2
-ol.ext.element.getStyle(this.element,'width')/2;if(this._select)this._select.elt.classList.remove('select');this._select=sel;this._select.elt.classList.add('select');}}.bind(this));img.addEventListener('mouseover',function(e){if(this.get('hover')){if(this._select)this._select.elt.classList.remove('select');this._select=sel;this._select.elt.classList.add('select');this.getMap().render();e.stopPropagation();}}.bind(this));img.addEventListener('mouseout',function(e){if(this.get('hover')){if(this._select)this._select.elt.classList.remove('select');this._select=false;this.getMap().render();e.stopPropagation();}}.bind(this));img.ondragstart=function(){return false;};this._iline.push(sel);if(current===f){this._select=sel;sel.elt.classList.add('select');}}}.bind(this);var nb=this.get('maxFeatures');for(var i=0,f;f=features[i];i++){if(nb--<0)break;addImage(f);}
if(this._select&&this._select.feature&&!this._select.elt){addImage(this._select.feature);}};ol.control.Imageline.prototype.select=function(feature,scroll){this._select=false;this._iline.forEach(function(f){if(f.feature===feature){f.elt.classList.add('select');this._select=f;if(scroll!==false){this._scrolldiv.scrollLeft=f.elt.offsetLeft
+ol.ext.element.getStyle(f.elt,'width')/2
-ol.ext.element.getStyle(this.element,'width')/2;}}else{f.elt.classList.remove('select');}}.bind(this));};ol.control.Imageline.prototype._drawLink=function(e){if(!this.get('linkColor')|this.isCollapsed())return;var map=this.getMap();if(map&&this._select&&this._select.elt){var ctx=e.context||ol.ext.getMapCanvas(this.getMap()).getContext('2d');var ratio=e.frameState.pixelRatio;var pt=[this._select.elt.offsetLeft
-this._scrolldiv.scrollLeft
+ol.ext.element.getStyle(this._select.elt,'width')/2,parseFloat(ol.ext.element.getStyle(this.element,'top'))||this.getMap().getSize()[1]];var geom=this._select.feature.getGeometry().getFirstCoordinate();geom=this.getMap().getPixelFromCoordinate(geom);ctx.save();ctx.fillStyle=this.get('linkColor');ctx.beginPath();if(geom[0]>pt[0]){ctx.moveTo((pt[0]-5)*ratio,pt[1]*ratio);ctx.lineTo((pt[0]+5)*ratio,(pt[1]+5)*ratio);}else{ctx.moveTo((pt[0]-5)*ratio,(pt[1]+5)*ratio);ctx.lineTo((pt[0]+5)*ratio,pt[1]*ratio);}
ctx.lineTo(geom[0]*ratio,geom[1]*ratio);ctx.fill();ctx.restore();}};ol.control.IsochroneGeoportail=function(options){var self=this;if(!options)options={};if(options.typing==undefined)options.typing=300;var classNames=(options.className?options.className:'')+' ol-isochrone ol-routing';if(!options.target)classNames+=' ol-unselectable ol-control';var element=ol.ext.element.create('DIV',{className:classNames})
if(!options.target){var bt=ol.ext.element.create('BUTTON',{parent:element})
bt.addEventListener('click',function(){element.classList.toggle('ol-collapsed');});}
ol.control.Control.call(this,{element:element,target:options.target});this.set('iter',1);var content=ol.ext.element.create('DIV',{className:'content',parent:element})
this._addSearchCtrl(content,options);ol.ext.element.create('BUTTON',{className:'ol-button ol-method-time selected',title:'isochrone',parent:content}).addEventListener('click',function(){this.setMethod('time');}.bind(this));ol.ext.element.create('I',{className:'ol-button ol-method-distance',title:'isodistance',parent:content}).addEventListener('click',function(){this.setMethod('distance');}.bind(this));ol.ext.element.create('I',{className:'ol-button ol-car selected',title:'by car',parent:content}).addEventListener('click',function(){this.setMode('car');}.bind(this));ol.ext.element.create('I',{className:'ol-button ol-pedestrian',title:'by foot',parent:content}).addEventListener('click',function(){this.setMode('pedestrian');}.bind(this));ol.ext.element.create('I',{className:'ol-button ol-direction-direct selected',title:'direct',parent:content}).addEventListener('click',function(){this.setDirection('direct');}.bind(this));ol.ext.element.create('I',{className:'ol-button ol-direction-reverse',title:'reverse',parent:content}).addEventListener('click',function(){this.setDirection('reverse');}.bind(this));var div=ol.ext.element.create('DIV',{className:'ol-time',parent:content})
ol.ext.element.create('DIV',{html:'isochrone:',parent:div});ol.ext.element.create('INPUT',{type:'number',parent:div,min:0}).addEventListener('change',function(){self.set('hour',Number(this.value));});ol.ext.element.create('TEXT',{parent:div,html:'h'});ol.ext.element.create('INPUT',{type:'number',parent:div,min:0}).addEventListener('change',function(){self.set('minute',Number(this.value));});ol.ext.element.create('TEXT',{parent:div,html:'mn'});div=ol.ext.element.create('DIV',{className:'ol-distance',parent:content});ol.ext.element.create('DIV',{html:'isodistance:',parent:div});ol.ext.element.create('INPUT',{type:'number',step:'any',parent:div,min:0}).addEventListener('change',function(){self.set('distance',Number(this.value));});ol.ext.element.create('TEXT',{parent:div,html:'km'});div=ol.ext.element.create('DIV',{className:'ol-iter',parent:content})
ol.ext.element.create('DIV',{html:'Iteration:',parent:div});ol.ext.element.create('INPUT',{type:'number',parent:div,value:1,min:1}).addEventListener('change',function(){self.set('iter',Number(this.value));});ol.ext.element.create('I',{className:'ol-ok',html:'ok',parent:content}).addEventListener('click',function(){var val=0;switch(this.get('method')){case'distance':{val=this.get('distance')*1000;break;}
default:{val=(this.get('hour')||0)*3600+(this.get('minute')||0)*60;break;}}
if(val&&this.get('coordinate')){this.search(this.get('coordinate'),val);}}.bind(this));this.set('url','https://wxs.ign.fr/'+options.apiKey+'/isochrone/isochrone.json');this._ajax=new ol.ext.Ajax({dataType:'JSON',auth:options.auth});this._ajax.on('success',this._success.bind(this));this._ajax.on('error',this._error.bind(this));this._ajax.on('loadstart',function(){this.element.classList.add('ol-searching');}.bind(this));this._ajax.on('loadend',function(){this.element.classList.remove('ol-searching');}.bind(this));this.setMethod(options.method);};ol.ext.inherits(ol.control.IsochroneGeoportail,ol.control.Control);ol.control.IsochroneGeoportail.prototype.setMap=function(map){ol.control.Control.prototype.setMap.call(this,map);this._search.setMap(map);};ol.control.IsochroneGeoportail.prototype._addSearchCtrl=function(element,options){var div=ol.ext.element.create("DIV",{parent:element});var search=this._search=new ol.control.SearchGeoportail({className:'IGNF ol-collapsed',apiKey:options.apiKey,target:div});search.on('select',function(e){search.setInput(e.search.fulltext);this.set('coordinate',e.coordinate);}.bind(this));search.on('change:input',function(){this.set('coordinate',false);}.bind(this));};ol.control.IsochroneGeoportail.prototype.setMethod=function(method){7
method=(/distance/.test(method)?'distance':'time');this.element.querySelector(".ol-method-time").classList.remove("selected");this.element.querySelector(".ol-method-distance").classList.remove("selected");this.element.querySelector(".ol-method-"+method).classList.add("selected");this.element.querySelector("div.ol-time").classList.remove("selected");this.element.querySelector("div.ol-distance").classList.remove("selected");this.element.querySelector("div.ol-"+method).classList.add("selected");this.set('method',method);};ol.control.IsochroneGeoportail.prototype.setMode=function(mode){this.set('mode',mode);this.element.querySelector(".ol-car").classList.remove("selected");this.element.querySelector(".ol-pedestrian").classList.remove("selected");this.element.querySelector(".ol-"+mode).classList.add("selected");};ol.control.IsochroneGeoportail.prototype.setDirection=function(direction){this.set('direction',direction);this.element.querySelector(".ol-direction-direct").classList.remove("selected");this.element.querySelector(".ol-direction-reverse").classList.remove("selected");this.element.querySelector(".ol-direction-"+direction).classList.add("selected");};ol.control.IsochroneGeoportail.prototype.search=function(coord,option,iter){var proj=this.getMap()?this.getMap().getView().getProjection():'EPSG:3857';var method=/distance/.test(this.get('method'))?'distance':'time';if(typeof(option)==='string'){var unit=option.replace(/([0-9|.]*)([a-z]*)$/,'$2');method='time';option=parseFloat(option);switch(unit){case'mn':{option=option*60;break;}
case'h':{option=option*3600;break;}
case'm':{method='distance';break;}
case'km':{method='distance';option=option*1000;break;}}}
var dt=Math.round(option*(this.get('iter')-(iter||0))/this.get('iter'));if(typeof option==='number'){var data={'gp-access-lib':'2.1.0',location:ol.proj.toLonLat(coord,proj),graphName:(this.get('mode')==='pedestrian'?'Pieton':'Voiture'),exclusions:this.get('exclusions')||undefined,method:method,time:method==='time'?dt:undefined,distance:method==='distance'?dt:undefined,reverse:(this.get('direction')==='reverse'),smoothing:this.get('smoothing')||true,holes:this.get('holes')||false};this._ajax.send(this.get('url'),data,{coord:coord,option:option,iteration:(iter||0)+1});}};ol.control.IsochroneGeoportail.prototype._success=function(e){var proj=this.getMap()?this.getMap().getView().getProjection():'EPSG:3857';var format=new ol.format.WKT();var evt=e.response;evt.feature=format.readFeature(evt.wktGeometry,{dataProjection:'EPSG:4326',featureProjection:proj});delete evt.wktGeometry;evt.type='isochrone';evt.iteration=e.options.iteration-1;this.dispatchEvent(evt);if(e.options.iteration<this.get('iter')){this.search(e.options.coord,e.options.option,e.options.iteration);}};ol.control.IsochroneGeoportail.prototype._error=function(){this.dispatchEvent({type:'error'});};ol.control.LayerPopup=function(options){options=options||{};options.switcherClass="ol-layerswitcher-popup";if(options.mouseover!==false)options.mouseover=true;ol.control.LayerSwitcher.call(this,options);};ol.ext.inherits(ol.control.LayerPopup,ol.control.LayerSwitcher);ol.control.LayerPopup.prototype.overflow=function(){};ol.control.LayerPopup.prototype.drawList=function(ul,layers){var self=this;var setVisibility=function(e){e.preventDefault();var l=self._getLayerForLI(this);self.switchLayerVisibility(l,layers);if(e.type=="touchstart")self.element.classList.add("ol-collapsed");};layers.forEach(function(layer){if(self.displayInLayerSwitcher(layer)){var d=ol.ext.element.create('LI',{html:layer.get("title")||layer.get("name"),on:{'click touchstart':setVisibility},parent:ul});self._setLayerForLI(d,layer);if(self.testLayerVisibility(layer))d.classList.add("ol-layer-hidden");if(layer.getVisible())d.classList.add("select");}});};ol.control.LayerSwitcherImage=function(options){options=options||{};options.switcherClass="ol-layerswitcher-image";if(options.mouseover!==false)options.mouseover=true;ol.control.LayerSwitcher.call(this,options);};ol.ext.inherits(ol.control.LayerSwitcherImage,ol.control.LayerSwitcher);ol.control.LayerSwitcherImage.prototype.drawList=function(ul,layers){var self=this;var setVisibility=function(e){e.preventDefault();var l=self._getLayerForLI(this);self.switchLayerVisibility(l,layers);if(e.type=="touchstart")self.element.classList.add("ol-collapsed");};ol.ext.element.setStyle(ul,{height:'auto'});layers.forEach(function(layer){if(self.displayInLayerSwitcher(layer)){var preview=layer.getPreview?layer.getPreview():["none"];var d=ol.ext.element.create('LI',{className:'ol-imgcontainer'+(layer.getVisible()?' select':''),on:{'touchstart click':setVisibility},parent:ul});self._setLayerForLI(d,layer);preview.forEach(function(img){ol.ext.element.create('IMG',{src:img,parent:d})});ol.ext.element.create('p',{html:layer.get("title")||layer.get("name"),parent:d});if(self.testLayerVisibility(layer))d.classList.add('ol-layer-hidden');}});};ol.control.LayerSwitcherImage.prototype.overflow=function(){};ol.control.Legend=function(options){options=options||{};var element=document.createElement('div');if(options.target){element.className=options.className||"ol-legend";}else{element.className=(options.className||"ol-legend")
+" ol-unselectable ol-control ol-collapsed"
+(options.collapsible===false?' ol-uncollapsible':'');var button=document.createElement('button');button.setAttribute('type','button');button.addEventListener('click',function(){element.classList.toggle('ol-collapsed');});element.appendChild(button);button=document.createElement('button');button.setAttribute('type','button');button.className='ol-closebox';button.addEventListener('click',function(){element.classList.toggle('ol-collapsed');});element.appendChild(button);}
this._imgElement=document.createElement('div');this._imgElement.className='ol-legendImg';element.appendChild(this._imgElement);this._tableElement=document.createElement('ul');element.appendChild(this._tableElement);this._legendFooter=document.createElement('div');this._legendFooter.className='ol-legend-footer';element.appendChild(this._legendFooter);ol.control.Control.call(this,{element:element,target:options.target});this._rows=[];this.set('size',options.size||[40,25]);this.set('margin',options.margin===0?0:options.margin||10);this.set('title',options.title||'');this._style=options.style;if(options.collapsed===false)this.show();this.refresh();};ol.ext.inherits(ol.control.Legend,ol.control.Control);ol.control.Legend.prototype.setStyle=function(style){this._style=style;this.refresh();};ol.control.Legend.prototype.addRow=function(row){this._rows.push(row||{});this.refresh();};ol.control.Legend.prototype.removeRow=function(index){this._rows.splice(index,1);this.refresh();};ol.control.Legend.prototype.getRow=function(index){return this._rows[index];};ol.control.Legend.prototype.getLength=function(){return this._rows.length;};ol.control.Legend.prototype.refresh=function(){var self=this;var table=this._tableElement
table.innerHTML='';var width=this.get('size')[0]+2*this.get('margin');var height=this.get('size')[1]+2*this.get('margin');function addRow(str,title,r,i){var row=document.createElement('li');row.style.height=height+'px';row.addEventListener('click',function(){self.dispatchEvent({type:'select',title:str,row:r,index:i});});var col=document.createElement('div');row.appendChild(col);col.style.height=height+'px';col=document.createElement('div');if(title){row.className='ol-title';}else{col.style.paddingLeft=width+'px';}
col.innerHTML=str||'';row.appendChild(col);table.appendChild(row);}
if(this.get('title')){addRow(this.get('title'),true,{},-1);}
var canvas=document.createElement('canvas');canvas.width=5*width;canvas.height=(this._rows.length+1)*height*ol.has.DEVICE_PIXEL_RATIO;this._imgElement.innerHTML='';this._imgElement.append(canvas);this._imgElement.style.height=(this._rows.length+1)*height+'px';for(var i=0,r;r=this._rows[i];i++){addRow(r.title,false,r,i);canvas=this.getStyleImage(r,canvas,i+(this.get('title')?1:0));}};ol.control.Legend.prototype.show=function(){this.element.classList.remove('ol-collapsed');};ol.control.Legend.prototype.hide=function(){this.element.classList.add('ol-collapsed');};ol.control.Legend.prototype.toggle=function(){this.element.classList.toggle('ol-collapsed');};ol.control.Legend.prototype.getStyleImage=function(options,theCanvas,row){options=options||{};var size=this.get('size');var width=size[0]+2*this.get('margin');var height=size[1]+2*this.get('margin');var canvas=theCanvas;var ratio=ol.has.DEVICE_PIXEL_RATIO;if(!canvas){canvas=document.createElement('canvas');canvas.width=width*ratio;canvas.height=height*ratio;}
var ctx=canvas.getContext('2d');ctx.save();var vectorContext=ol.render.toContext(ctx);var typeGeom=options.typeGeom;var style;var feature=options.feature;if(!feature&&options.properties&&typeGeom){if(/Point/.test(typeGeom))feature=new ol.Feature(new ol.geom.Point([0,0]));else if(/LineString/.test(typeGeom))feature=new ol.Feature(new ol.geom.LineString([0,0]));else feature=new ol.Feature(new ol.geom.Polygon([[0,0]]));feature.setProperties(options.properties);}
if(feature){style=feature.getStyle();if(typeof(style)==='function')style=style(feature);if(!style){style=typeof(this._style)==='function'?this._style(feature):this._style||[];}
typeGeom=feature.getGeometry().getType();}else{style=options.style;}
if(!(style instanceof Array))style=[style];var cx=width/2;var cy=height/2;var sx=size[0]/2;var sy=size[1]/2;var i,s;if(typeGeom==='Point'){var extent=null;for(i=0;s=style[i];i++){var img=s.getImage();if(img&&img.getAnchor){var anchor=img.getAnchor();var si=img.getSize();var dx=anchor[0]-si[0];var dy=anchor[1]-si[1];if(!extent){extent=[dx,dy,dx+si[0],dy+si[1]];}else{ol.extent.extend(extent,[dx,dy,dx+si[0],dy+si[1]]);}}}
if(extent){cx=cx+(extent[2]+extent[0])/2;cy=cy+(extent[3]+extent[1])/2;}}
cy+=(theCanvas?row*height:0);for(i=0;s=style[i];i++){vectorContext.setStyle(s);switch(typeGeom){case ol.geom.Point:case'Point':vectorContext.drawGeometry(new ol.geom.Point([cx,cy]));break;case ol.geom.LineString:case'LineString':ctx.save();ctx.rect(this.get('margin')*ratio,0,size[0]*ratio,canvas.height);ctx.clip();vectorContext.drawGeometry(new ol.geom.LineString([[cx-sx,cy],[cx+sx,cy]]));ctx.restore();break;case ol.geom.Polygon:case'Polygon':vectorContext.drawGeometry(new ol.geom.Polygon([[[cx-sx,cy-sy],[cx+sx,cy-sy],[cx+sx,cy+sy],[cx-sx,cy+sy],[cx-sx,cy-sy]]]));break;}}
ctx.restore();return canvas;};ol.control.MapZone=function(options){if(!options)options={};var element=document.createElement("div");if(options.target){element=ol.ext.element.create('DIV',{className:options.className||"ol-mapzone"});}else{element=ol.ext.element.create('DIV',{className:(options.className||"ol-mapzone")+' ol-unselectable ol-control ol-collapsed'});var bt=ol.ext.element.create('BUTTON',{type:'button',on:{'click':function(){element.classList.toggle("ol-collapsed");maps.forEach(function(m){m.updateSize();});}.bind(this)},parent:element});ol.ext.element.create('I',{parent:bt});}
ol.control.Control.call(this,{element:element,target:options.target});var maps=[];options.zones.forEach(function(z){var view=new ol.View({zoom:6,center:[0,0],projection:options.projection});var extent=ol.proj.transformExtent(z.extent,'EPSG:4326',view.getProjection());console.log(extent,z.extent)
var div=ol.ext.element.create('DIV',{className:'ol-mapzonezone',parent:element,click:function(){this.dispatchEvent({type:'select',coordinate:ol.extent.getCenter(extent),extent:extent});if(options.centerOnClick!==false){this.getMap().getView().fit(extent);}
this.setVisible(false);}.bind(this)});var layer=new options.layer.constructor({source:options.layer.getSource()});var map=new ol.Map({target:div,view:view,controls:[],interactions:[],layers:[layer]});maps.push(map);view.fit(extent);ol.ext.element.create('P',{html:z.title,parent:div});}.bind(this));setTimeout(function(){maps.forEach(function(m){m.updateSize();});});};ol.ext.inherits(ol.control.MapZone,ol.control.Control);ol.control.MapZone.prototype.setVisible=function(b){if(b)this.element.classList.remove('ol-collapsed');else this.element.classList.add('ol-collapsed');};ol.control.MapZone.zones={};ol.control.MapZone.zones.DOM=[{"title":"Guadeloupe","extent":[-61.898594315312444,15.75623038647845,-60.957887532935324,16.575317670979473]},{"title":"Guyane","extent":[-54.72525931072715,2.1603763430019,-51.528236062921344,5.7984307809552575]},{"title":"Martinique","extent":[-61.257556528564756,14.387506317407514,-60.76934912110432,14.895067461729951]},{"title":"Mayotte","extent":[44.959844536967815,-13.01674138212816,45.35328866510648,-12.65521942207829]},{"title":"La réunion","extent":[55.17059012967656,-21.407680069231688,55.88195702001797,-20.85560221637526]}];ol.control.MapZone.zones.TOM=[{"title":"Polynésie Française","extent":[206.23664226630862,-22.189040615809787,221.85920743981987,-10.835039595040698]},{"title":"Nouvelle Calédonie","extent":[163.76420580160925,-22.581641092751838,167.66984709498706,-19.816411635668445]},{"title":"St-Pierre et Miquelon","extent":[-56.453698765748676,46.74449858188555,-56.0980198121544,47.14669874229787]},{"title":"Wallis et Futuna","extent":[181.7588623143665,-14.7341169873267,183.95612353301715,-13.134720799175085]},{"title":"St-Martin St-Barthélemy","extent":[-63.1726389501678,17.806097291313506,-62.7606535945649,18.13267688837938]}];ol.control.MapZone.zones.DOMTOM=[{title:'Métropole',extent:[-5.318421740712579,41.16082274292913,9.73284186155716,51.21957336557702]}].concat(ol.control.MapZone.zones.DOM,ol.control.MapZone.zones.TOM);ol.control.Notification=function(options){options=options||{};var element=document.createElement("DIV");this.contentElement=document.createElement("DIV");element.appendChild(this.contentElement);var classNames=(options.className||"")+" ol-notification";if(!options.target){classNames+=" ol-unselectable ol-control ol-collapsed";}
element.setAttribute('class',classNames);ol.control.Control.call(this,{element:element,target:options.target});};ol.ext.inherits(ol.control.Notification,ol.control.Control);ol.control.Notification.prototype.show=function(what,duration){var self=this;var elt=this.element;if(what){if(what instanceof Node){this.contentElement.innerHTML='';this.contentElement.appendChild(what);}else{this.contentElement.innerHTML=what;}}
if(this._listener){clearTimeout(this._listener);this._listener=null;}
elt.classList.add('ol-collapsed');this._listener=setTimeout(function(){elt.classList.remove('ol-collapsed');if(!duration||duration>=0){self._listener=setTimeout(function(){elt.classList.add('ol-collapsed');self._listener=null;},duration||3000);}else{self._listener=null;}},100);};ol.control.Notification.prototype.hide=function(){if(this._listener){clearTimeout(this._listener);this._listener=null;}
this.element.classList.add('ol-collapsed');};ol.control.Notification.prototype.toggle=function(duration){if(this.element.classList.contains('ol-collapsed')){this.show(null,duration);}else{this.hide();}};ol.control.Overlay=function(options){if(!options)options={};var element=ol.ext.element.create('DIV',{className:'ol-unselectable ol-overlay '+(options.className||''),html:options.content});ol.control.Control.call(this,{element:element,target:options.target});var self=this;if(options.hideOnClick)element.addEventListener("click",function(){self.hide();});this.set("closeBox",options.closeBox);this._timeout=false;this.setContent(options.content);};ol.ext.inherits(ol.control.Overlay,ol.control.Control);ol.control.Overlay.prototype.setContent=function(html){var self=this;if(html){var elt=this.element;if(html instanceof Element){elt.innerHTML='';elt.appendChild(html)}
else if(html!==undefined)elt.innerHTML=html;if(this.get("closeBox")){var cb=document.createElement("div");cb.classList.add("ol-closebox");cb.addEventListener("click",function(){self.hide();});elt.insertBefore(cb,elt.firstChild);}}};ol.control.Overlay.prototype.show=function(html,coord){var self=this;var elt=this.element;elt.style.display='block';if(coord){this.center_=this.getMap().getPixelFromCoordinate(coord);elt.style.top=this.center_[1]+'px';elt.style.left=this.center_[0]+'px';}else{this.center_=false;elt.style.top="";elt.style.left="";}
if(html)this.setContent(html);if(this._timeout)clearTimeout(this._timeout);this._timeout=setTimeout(function(){elt.classList.add("ol-visible")
elt.style.top="";elt.style.left="";self.dispatchEvent({type:'change:visible',visible:true,element:self.element});},10);};ol.control.Overlay.prototype.showImage=function(src,options){options=options||{};var content=ol.ext.element.create('DIV',{className:'ol-fullscreen-image'});ol.ext.element.create('IMG',{src:src,parent:content});if(options.title){content.classList.add('ol-has-title');ol.ext.element.create('P',{html:options.title,parent:content});}
this.show(content,options.coordinate);};ol.control.Overlay.prototype.hide=function(){var elt=this.element;this.element.classList.remove("ol-visible");if(this.center_){elt.style.top=this.center_[1]+'px';elt.style.left=this.center_[0]+'px';this.center_=false;}
if(this._timeout)clearTimeout(this._timeout);this._timeout=setTimeout(function(){elt.style.display='none';},500);this.dispatchEvent({type:'change:visible',visible:false,element:this.element});};ol.control.Overlay.prototype.toggle=function(){if(this.getVisible())this.hide();else this.show();}
ol.control.Overlay.prototype.getVisible=function(){return ol.ext.element.getStyle(this.element,'display')!=='none';};ol.control.Overlay.prototype.setClass=function(className){var vis=this.element.classList.contains('ol-visible');this.element.className=('ol-unselectable ol-overlay '+(vis?'ol-visible ':'')+className).trim();};ol.control.Overview=function(options)
{options=options||{};var self=this;this.minZoom=options.minZoom||0;this.maxZoom=options.maxZoom||18;this.rotation=options.rotation;var element;if(options.target){element=document.createElement("div");this.panel_=options.target;}else{element=document.createElement("div");element.classList.add('ol-overview','ol-unselectable','ol-control','ol-collapsed');if(/top/.test(options.align))element.classList.add('ol-control-top');if(/right/.test(options.align))element.classList.add('ol-control-right');var button=document.createElement("button");button.setAttribute('type','button');button.addEventListener("touchstart",function(e){self.toggleMap();e.preventDefault();});button.addEventListener("click",function(){self.toggleMap()});element.appendChild(button);this.panel_=document.createElement("div");this.panel_.classList.add("panel");element.appendChild(this.panel_);}
ol.control.Control.call(this,{element:element,target:options.target});this.ovmap_=new ol.Map({controls:new ol.Collection(),interactions:new ol.Collection(),target:this.panel_,view:new ol.View({zoom:2,center:[0,0],projection:options.projection}),layers:options.layers});this.oview_=this.ovmap_.getView();this.extentLayer=new ol.layer.Vector({name:'Cache extent',source:new ol.source.Vector(),style:options.style||[new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:'rgba(255,0,0, 1)'}),stroke:new ol.style.Stroke({width:7,color:'rgba(255,0,0, 0.8)'}),radius:5}),stroke:new ol.style.Stroke({width:5,color:"rgba(255,0,0,0.8)"})})]})
this.ovmap_.addLayer(this.extentLayer);var elasticFn=function(bounce,amplitude){var a=3*bounce*Math.PI/2;var b=amplitude>0?-1/amplitude:-100;var c=Math.cos(a)*Math.pow(2,b);return function(t){t=1-Math.cos(t*Math.PI/2);return 1-Math.cos(a*t)*Math.pow(2,b*t)+c*t;}}
this.ovmap_.addInteraction(new ol.interaction.Pointer({handleDownEvent:function(evt){if(options.panAnimation!==false){if(options.panAnimation=="elastic"||options.elasticPan){self.getMap().getView().animate({center:evt.coordinate,easing:elasticFn(2,0.3),duration:1000});}else{self.getMap().getView().animate({center:evt.coordinate,duration:300});}}
else self.getMap().getView().setCenter(evt.coordinate);return false;}}));};ol.ext.inherits(ol.control.Overview,ol.control.Control);ol.control.Overview.prototype.getOverviewMap=function(){return this.ovmap_;};ol.control.Overview.prototype.toggleMap=function(){this.element.classList.toggle("ol-collapsed");this.ovmap_.updateSize();this.setView();};ol.control.Overview.prototype.setPosition=function(align){if(/top/.test(align))this.element.classList.add("ol-control-top");else this.element.classList.remove("ol-control-top");if(/right/.test(align))this.element.classList.add("ol-control-right");else this.element.classList.remove("ol-control-right");};ol.control.Overview.prototype.setMap=function(map){if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.control.Control.prototype.setMap.call(this,map);if(map){this._listener=map.getView().on('propertychange',this.setView.bind(this));this.setView();}};ol.control.Overview.prototype.calcExtent_=function(extent){var map=this.getMap();if(!map)return;var source=this.extentLayer.getSource();source.clear();var f=new ol.Feature();var size=map.getSize();var resolution=map.getView().getResolution();var rotation=map.getView().getRotation();var center=map.getView().getCenter();if(!resolution)return;var dx=resolution*size[0]/2;var dy=resolution*size[1]/2;var res2=this.oview_.getResolution();if(dx/res2>5||dy/res2>5){var cos=Math.cos(rotation);var sin=Math.sin(rotation);var i,x,y;extent=[[-dx,-dy],[-dx,dy],[dx,dy],[dx,-dy]];for(i=0;i<4;++i){x=extent[i][0];y=extent[i][1];extent[i][0]=center[0]+x*cos-y*sin;extent[i][1]=center[1]+x*sin+y*cos;}
f.setGeometry(new ol.geom.Polygon([extent]));}else{f.setGeometry(new ol.geom.Point(center));}
source.addFeature(f);};ol.control.Overview.prototype.setView=function(e){if(!e){this.setView({key:'rotation'});this.setView({key:'resolution'});this.setView({key:'center'});return;}
switch(e.key){case'rotation':{if(this.rotation)this.oview_.setRotation(this.getMap().getView().getRotation());else if(this.oview_.getRotation())this.oview_.setRotation(0);break;}
case'center':{var mapExtent=this.getMap().getView().calculateExtent(this.getMap().getSize());var extent=this.oview_.calculateExtent(this.ovmap_.getSize());if(mapExtent[0]<extent[0]||mapExtent[1]<extent[1]||mapExtent[2]>extent[2]||mapExtent[3]>extent[3]){this.oview_.setCenter(this.getMap().getView().getCenter());}
break;}
case'resolution':{var z=Math.round(this.oview_.getZoomForResolution(this.getMap().getView().getResolution())/2)*2-4;z=Math.min(this.maxZoom,Math.max(this.minZoom,z));this.oview_.setZoom(z);break;}
default:break;}
this.calcExtent_();};ol.control.Permalink=function(opt_options){var options=opt_options||{};var self=this;var button=document.createElement('button');this.replaceState_=(options.urlReplace!==false);this.fixed_=options.fixed||6;this.hash_=options.anchor?"#":"?";this._localStorage=options.localStorage;if(!this._localStorage)localStorage.removeItem('ol@parmalink');function linkto(){if(typeof(options.onclick)=='function')options.onclick(self.getLink());else self.setUrlReplace(!self.replaceState_);}
button.addEventListener('click',linkto,false);button.addEventListener('touchstart',linkto,false);var element=document.createElement('div');element.className=(options.className||"ol-permalink")+" ol-unselectable ol-control";element.appendChild(button);if(options.hidden)ol.ext.element.hide(element);ol.control.Control.call(this,{element:element,target:options.target});this.on('change',this.viewChange_.bind(this));this.search_={};var hash=this.replaceState_?document.location.hash||document.location.search:'';console.log('hash',hash)
if(!hash&&this._localStorage){hash=localStorage['ol@parmalink'];}
if(hash){hash=hash.replace(/(^#|^\?)/,"").split("&");for(var i=0;i<hash.length;i++){var t=hash[i].split("=");switch(t[0]){case'lon':case'lat':case'z':case'r':case'l':break;default:this.search_[t[0]]=t[1];}}}
this.setPosition();};ol.ext.inherits(ol.control.Permalink,ol.control.Control);ol.control.Permalink.prototype.setMap=function(map){if(this._listener){ol.Observable.unByKey(this._listener.change);ol.Observable.unByKey(this._listener.moveend);}
this._listener=null;ol.control.Control.prototype.setMap.call(this,map);if(map){this._listener={change:map.getLayerGroup().on('change',this.layerChange_.bind(this)),moveend:map.on('moveend',this.viewChange_.bind(this))};this.setPosition();}};ol.control.Permalink.prototype.getLayerByLink=function(id,layers){if(!layers&&this.getMap())layers=this.getMap().getLayers().getArray();for(var i=0;i<layers.length;i++){if(layers[i].get('permalink')==id)return layers[i];if(layers[i].getLayers){var li=this.getLayerByLink(id,layers[i].getLayers().getArray());if(li)return li;}}
return false;};ol.control.Permalink.prototype.setPosition=function(){var map=this.getMap();if(!map)return;var hash=this.replaceState_?document.location.hash||document.location.search:'';if(!hash&&this._localStorage){hash=localStorage['ol@parmalink'];}
if(!hash)return;var i,t,param={};hash=hash.replace(/(^#|^\?)/,"").split("&");for(i=0;i<hash.length;i++){t=hash[i].split("=");param[t[0]]=t[1];}
var c=ol.proj.transform([Number(param.lon),Number(param.lat)],'EPSG:4326',map.getView().getProjection());if(c[0]&&c[1])map.getView().setCenter(c);if(param.z)map.getView().setZoom(Number(param.z));if(param.r)map.getView().setRotation(Number(param.r));function resetLayers(layers){if(!layers)layers=map.getLayers().getArray();for(var i=0;i<layers.length;i++){if(layers[i].get('permalink')){layers[i].setVisible(false);}
if(layers[i].getLayers){resetLayers(layers[i].getLayers().getArray());}}}
if(param.l){resetLayers();var l=param.l.split("|");for(i=0;i<l.length;i++){t=l[i].split(":");var li=this.getLayerByLink(t[0]);var op=Number(t[1]);if(li){li.setOpacity(op);li.setVisible(true);}}}};ol.control.Permalink.prototype.getUrlParams=function(){return this.search_;};ol.control.Permalink.prototype.setUrlParam=function(key,value){if(key){if(value===undefined||value==='')delete(this.search_[encodeURIComponent(key)])
else this.search_[encodeURIComponent(key)]=encodeURIComponent(value);}
this.viewChange_();};ol.control.Permalink.prototype.getUrlParam=function(key){return decodeURIComponent(this.search_[encodeURIComponent(key)]||'');};ol.control.Permalink.prototype.hasUrlParam=function(key){return this.search_.hasOwnProperty(encodeURIComponent(key));};ol.control.Permalink.prototype.getLink=function(param){var map=this.getMap();var c=ol.proj.transform(map.getView().getCenter(),map.getView().getProjection(),'EPSG:4326');var z=map.getView().getZoom();var r=map.getView().getRotation();var l=this.layerStr_;var anchor="lon="+c[0].toFixed(this.fixed_)+"&lat="+c[1].toFixed(this.fixed_)+"&z="+z+(r?"&r="+(Math.round(r*10000)/10000):"")+(l?"&l="+l:"");for(var i in this.search_)anchor+="&"+i+"="+this.search_[i];if(param)return anchor;return document.location.protocol+"//"+document.location.host+document.location.pathname+this.hash_+anchor;};ol.control.Permalink.prototype.setUrlReplace=function(replace){try{this.replaceState_=replace;if(!replace){var s="";for(var i in this.search_){s+=(s==""?"?":"&")+i+"="+this.search_[i];}
window.history.replaceState(null,null,document.location.origin+document.location.pathname+s);}
else window.history.replaceState(null,null,this.getLink());}catch(e){}};ol.control.Permalink.prototype.viewChange_=function(){try{if(this.replaceState_)window.history.replaceState(null,null,this.getLink());}catch(e){}
if(this._localStorage){localStorage['ol@parmalink']=this.getLink(true);}};ol.control.Permalink.prototype.layerChange_=function(){var l="";function getLayers(layers){for(var i=0;i<layers.length;i++){if(layers[i].getVisible()&&layers[i].get("permalink")){if(l)l+="|";l+=layers[i].get("permalink")+":"+layers[i].get("opacity");}
if(layers[i].getLayers)getLayers(layers[i].getLayers().getArray());}}
getLayers(this.getMap().getLayers().getArray());this.layerStr_=l;this.viewChange_();};ol.control.Print=function(options){if(!options)options={};var element=ol.ext.element.create('DIV',{className:(options.className||'ol-print')});if(!options.target){element.classList.add('ol-unselectable','ol-control');ol.ext.element.create('BUTTON',{type:'button',click:function(){this.print();}.bind(this),parent:element});}
ol.control.Control.call(this,{element:element,target:options.target});this.set('imageType',options.imageType||'image/jpeg');this.set('quality',options.quality||.8);this.set('orientation',options.orientation);};ol.ext.inherits(ol.control.Print,ol.control.Control);ol.control.Print.prototype.print=function(options){options=options||{};var imageType=options.imageType||this.get('imageType');var quality=options.quality||this.get('quality');if(this.getMap()){if(options.immediate!=='silent'){this.dispatchEvent(Object.assign({type:'printing',},options));}
if(!options.immediate){setTimeout(function(){options=Object.assign({},options);options.immediate='silent';this.print(options);}.bind(this),200);return;}
this.getMap().once('rendercomplete',function(event){var canvas,ctx;if(event.context){canvas=event.context.canvas;}else{this.getMap().getViewport().querySelectorAll('.ol-layer canvas, canvas.ol-fixedoverlay').forEach(function(c){if(c.width){if(!canvas){canvas=document.createElement('canvas');var size=this.getMap().getSize();canvas.width=size[0];canvas.height=size[1];ctx=canvas.getContext('2d');if(/jp.*g$/.test(imageType)){ctx.fillStyle=this.get('bgColor')||'white';ctx.fillRect(0,0,canvas.width,canvas.height);}}
ctx.save();ctx.globalAlpha=c.style.opacity||1;var tr=ol.ext.element.getStyle(c,'transform')||ol.ext.element.getStyle(c,'-webkit-transform');if(/^matrix/.test(tr)){tr=tr.replace(/^matrix\(|\)$/g,'').split(',');tr.forEach(function(t,i){tr[i]=parseFloat(t);});ctx.transform(tr[0],tr[1],tr[2],tr[3],tr[4],tr[5]);ctx.drawImage(c,0,0);}else{ctx.drawImage(c,0,0,ol.ext.element.getStyle(c,'width'),ol.ext.element.getStyle(c,'height'));}
ctx.restore();}}.bind(this));}
var size=[210,297],format='a4';var w,h,position;var orient=options.orient||this.get('orientation');var margin=options.margin||10;if(canvas){if(orient!=='landscape'&&orient!=='portrait'){orient=(canvas.width>canvas.height)?'landscape':'portrait';}
if(orient==='landscape')size=[size[1],size[0]];var sc=Math.min((size[0]-2*margin)/canvas.width,(size[1]-2*margin)/canvas.height);w=sc*canvas.width;h=sc*canvas.height;position=[(size[0]-w)/2,(size[1]-h)/2];}
var image;try{image=canvas?canvas.toDataURL(imageType,quality):null;}catch(e){this.dispatchEvent({type:'error',canvas:canvas});return;}
var e=Object.assign({type:'print',print:{format:format,orientation:orient,unit:'mm',size:size,position:position,imageWidth:w,imageHeight:h},image:image,imageType:imageType,canvas:canvas},options);this.dispatchEvent(e);}.bind(this));this.getMap().render();}};ol.control.Profil=function(opt_options)
{var options=opt_options||{};this.info=options.info||ol.control.Profil.prototype.info;var self=this;var element;if(options.target)
{element=document.createElement("div");element.classList.add(options.className||"ol-profil");}
else
{element=document.createElement("div");element.className=((options.className||'ol-profil')+' ol-unselectable ol-control ol-collapsed').trim();this.button=document.createElement("button");this.button.setAttribute('type','button');var click_touchstart_function=function(e)
{self.toggle();e.preventDefault();};this.button.addEventListener("click",click_touchstart_function);this.button.addEventListener("touchstart",click_touchstart_function);element.appendChild(this.button);}
var div_inner=document.createElement("div");div_inner.classList.add("ol-inner");element.appendChild(div_inner);var div=document.createElement("div");div.style.position="relative";div_inner.appendChild(div);var ratio=this.ratio=2;this.canvas_=document.createElement('canvas');this.canvas_.width=(options.width||300)*ratio;this.canvas_.height=(options.height||150)*ratio;var styles={"msTransform":"scale(0.5,0.5)","msTransformOrigin":"0 0","webkitTransform":"scale(0.5,0.5)","webkitTransformOrigin":"0 0","mozTransform":"scale(0.5,0.5)","mozTransformOrigin":"0 0","transform":"scale(0.5,0.5)","transformOrigin":"0 0"};Object.keys(styles).forEach(function(style){if(style in self.canvas_.style){self.canvas_.style[style]=styles[style];}});var div_to_canvas=document.createElement("div");div.appendChild(div_to_canvas);div_to_canvas.style.width=this.canvas_.width/ratio+"px";div_to_canvas.style.height=this.canvas_.height/ratio+"px";div_to_canvas.appendChild(this.canvas_);div_to_canvas.addEventListener("click",function(e){self.onMove(e);});div_to_canvas.addEventListener("mousemove",function(e){self.onMove(e);});ol.control.Control.call(this,{element:element,target:options.target});this.margin_={top:10*ratio,left:40*ratio,bottom:30*ratio,right:10*ratio};if(!this.info.ytitle)this.margin_.left-=20*ratio;if(!this.info.xtitle)this.margin_.bottom-=20*ratio;this.bar_=document.createElement("div");this.bar_.classList.add("ol-profilbar");this.bar_.style.top=(this.margin_.top/ratio)+"px";this.bar_.style.height=(this.canvas_.height-this.margin_.top-this.margin_.bottom)/ratio+"px";div.appendChild(this.bar_);this.cursor_=document.createElement("div");this.cursor_.classList.add("ol-profilcursor");div.appendChild(this.cursor_);this.popup_=document.createElement("div");this.popup_.classList.add("ol-profilpopup");this.cursor_.appendChild(this.popup_);var t=document.createElement("table");t.cellPadding='0';t.cellSpacing='0';t.style.clientWidth=this.canvas_.width/ratio+"px";div.appendChild(t);var secondTr=document.createElement("tr");secondTr.classList.add("point-info")
t.appendChild(secondTr);var div_altitude=document.createElement("td");div_altitude.innerHTML=(this.info.altitude||"Altitude")+': <span class="z">';secondTr.appendChild(div_altitude);var div_distance2=document.createElement("td");div_distance2.innerHTML=(this.info.distance||"Distance")+': <span class="dist">';secondTr.appendChild(div_distance2);var div_slope=document.createElement("td");div_slope.innerHTML=(this.info.slope||"Slope")+' <span class="slope">';secondTr.appendChild(div_slope);this.tab_=[];if(options.feature)
{this.setGeometry(options.feature);}};ol.ext.inherits(ol.control.Profil,ol.control.Control);ol.control.Profil.prototype.info={"zmin":"Zmin","zmax":"Zmax","ytitle":"Altitude (m)","xtitle":"Distance (km)","slope":"Slope","altitude":"Altitude","distance":"Distance","altitudeUnits":"m","distanceUnitsM":"m","distanceUnitsKM":"km",};ol.control.Profil.prototype.popup=function(info)
{this.popup_.innerHTML=info;}
ol.control.Profil.prototype.onMove=function(e)
{if(!this.tab_.length)return;var box_canvas=this.canvas_.getBoundingClientRect();var pos={top:box_canvas.top+window.pageYOffset-document.documentElement.clientTop,left:box_canvas.left+window.pageXOffset-document.documentElement.clientLeft};var dx=e.pageX-pos.left;var dy=e.pageY-pos.top;var ratio=this.ratio;if(dx>this.margin_.left/ratio&&dx<(this.canvas_.width-this.margin_.right)/ratio&&dy>this.margin_.top/ratio&&dy<(this.canvas_.height-this.margin_.bottom)/ratio)
{this.bar_.style.left=dx+"px";this.bar_.style.display="block";var d=(dx*ratio-this.margin_.left)/this.scale_[0];var p0=this.tab_[0];for(var i=1,p;p=this.tab_[i];i++)
{if(p[0]>=d)
{if(d<(p[0]+p0[0])/2)p=p0;break;}}
if(p){this.cursor_.style.left=dx+"px";this.cursor_.style.top=(this.canvas_.height-this.margin_.bottom+p[1]*this.scale_[1]+this.dy_)/ratio+"px";this.cursor_.style.display="block";}
else{this.cursor_.style.display="none";}
this.bar_.parentElement.classList.add("over");this.element.querySelector(".point-info .z").textContent=p[1]+this.info.altitudeUnits;this.element.querySelector(".point-info .dist").textContent=(p[0]/1000).toFixed(1)+this.info.distanceUnitsKM;this.element.querySelector(".point-info .slope").textContent=p[2];if(dx>this.canvas_.width/ratio/2)this.popup_.classList.add('ol-left');else this.popup_.classList.remove('ol-left');this.dispatchEvent({type:'over',click:e.type=="click",coord:p[3],slope:p[2],distance:p[0]});}
else
{if(this.bar_.parentElement.classList.contains("over"))
{this.bar_.style.display='none';this.cursor_.style.display='none';this.bar_.parentElement.classList.remove("over");this.dispatchEvent({type:'out'});}}}
ol.control.Profil.prototype.show=function()
{this.element.classList.remove("ol-collapsed");this.dispatchEvent({type:'show',show:true});}
ol.control.Profil.prototype.hide=function()
{this.element.classList.add("ol-collapsed");this.dispatchEvent({type:'show',show:false});}
ol.control.Profil.prototype.toggle=function()
{this.element.classList.toggle("ol-collapsed");var b=this.element.classList.contains("ol-collapsed");this.dispatchEvent({type:'show',show:!b});}
ol.control.Profil.prototype.isShown=function()
{return(!this.element.classList.contains("ol-collapsed"));}
ol.control.Profil.prototype.setGeometry=function(g,options)
{if(!options)options={};if(g instanceof ol.Feature)g=g.getGeometry();var canvas=this.canvas_;var ctx=canvas.getContext('2d');var w=canvas.width;var h=canvas.height;ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,w,h);if(!/Z/.test(g.getLayout()))return;if(/M/.test(g.getLayout()))
this.element.querySelector(".slope").parentElement.style.display='block';else
this.element.querySelector(".slope").parentElement.style.display='block';var c=g.getCoordinates();switch(g.getType())
{case"LineString":break;case"MultiLineString":c=c[0];break;default:return;}
var proj=options.projection||this.getMap().getView().getProjection();function dist2d(p1,p2)
{return ol.sphere.getDistance(ol.proj.transform(p1,proj,'EPSG:4326'),ol.proj.transform(p2,proj,'EPSG:4326'));}
function getTime(t0,t1)
{if(!t0||!t1)return"-"
var dt=(t1-t0)/60;var ti=Math.trunc(dt/60);var mn=Math.trunc(dt-ti*60);return ti+"h"+(mn<10?"0":"")+mn+"mn";}
function getSlope(p1,p2){var h=parseFloat(p2[2])-parseFloat(p1[2]);var d=ol.sphere.getDistance(ol.proj.transform(p1,proj,'EPSG:4326'),ol.proj.transform(p2,proj,'EPSG:4326'));var slope=(h/parseFloat(d))*100;return slope;}
ctx.setTransform(1,0,0,1,this.margin_.left,h-this.margin_.bottom);var ratio=this.ratio;w-=this.margin_.right+this.margin_.left;h-=this.margin_.top+this.margin_.bottom;ctx.strokeStyle="#000";ctx.lineWidth=0.5*ratio;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,-h);ctx.moveTo(0,0);ctx.lineTo(w,0);ctx.stroke();var zmin=Infinity,zmax=-Infinity;var i,p,d,z,sl,t=this.tab_=[];for(i=0,p;p=c[i];i++)
{z=p[2];if(z<zmin)zmin=z;if(z>zmax)zmax=z;if(i==0)
d=0;else
d+=dist2d(c[i-1],p);if(i==0)
sl=0;else
sl=Math.abs(getSlope(c[i-1],p)).toFixed(2);t.push([d,z,sl,p]);}
var grad=options.graduation||100;while(true)
{zmax=Math.ceil(zmax/grad)*grad;zmin=Math.floor(zmin/grad)*grad;var nbgrad=(zmax-zmin)/grad;if(h/nbgrad<15*ratio)
{grad*=2;}
else break;}
if(typeof(options.zmin)=='number'&&zmin>options.zmin)zmin=options.zmin;if(typeof(options.zmax)=='number'&&zmax<options.zmax)zmax=options.zmax;var amplitude=options.amplitude;if(amplitude)
{zmax=Math.max(zmin+amplitude,zmax);}
var scx=w/d;var scy=-h/(zmax-zmin);var dy=this.dy_=-zmin*scy;this.scale_=[scx,scy];ctx.font=(10*ratio)+"px arial";ctx.textAlign="right";ctx.textBaseline="middle";ctx.fillStyle="#000";ctx.beginPath();for(i=zmin;i<=zmax;i+=grad)
{if(options.zunit!="km")ctx.fillText(i,-4*ratio,i*scy+dy);else ctx.fillText((i/1000).toFixed(1),-4*ratio,i*scy+dy);ctx.moveTo(-2*ratio,i*scy+dy);if(i!=0)ctx.lineTo(d*scx,i*scy+dy);else ctx.lineTo(0,i*scy+dy);}
ctx.textAlign="center";ctx.textBaseline="top";ctx.setLineDash([ratio,3*ratio]);var unit=options.unit||"km";var step;if(d>1000)
{step=Math.round(d/1000)*100;if(step>1000)step=Math.ceil(step/1000)*1000;}
else
{unit="m";if(d>100)step=Math.round(d/100)*10;else if(d>10)step=Math.round(d/10);else if(d>1)step=Math.round(d)/10;else step=d;}
for(i=0;i<=d;i+=step)
{var txt=(unit=="m")?i:(i/1000);ctx.fillText(Math.round(txt*10)/10,i*scx,4*ratio);ctx.moveTo(i*scx,2*ratio);ctx.lineTo(i*scx,0);}
ctx.font=(12*ratio)+"px arial";ctx.fillText(this.info.xtitle.replace("(km)","("+unit+")"),w/2,18*ratio);ctx.save();ctx.rotate(-Math.PI/2);ctx.fillText(this.info.ytitle,h/2,-this.margin_.left);ctx.restore();ctx.stroke();ctx.strokeStyle="#f15511";ctx.lineWidth=4;ctx.setLineDash([]);ctx.beginPath();for(i=0;p=t[i];i++)
{if(i==0)ctx.moveTo(p[0]*scx,p[1]*scy+dy);else ctx.lineTo(p[0]*scx,p[1]*scy+dy);}
ctx.stroke();};ol.control.Profil.prototype.getImage=function(type,encoderOptions)
{if(type==="canvas")return this.canvas_;return this.canvas_.toDataURL(type,encoderOptions);}
ol.control.RoutingGeoportail=function(options){var self=this;if(!options)options={};if(options.typing==undefined)options.typing=300;this._classname=options.className||'search';var element=document.createElement("DIV");var classNames=(options.className||"")+" ol-routing";if(!options.target){classNames+=" ol-unselectable ol-control";}
element.setAttribute('class',classNames);if(!options.target){var bt=ol.ext.element.create('BUTTON',{parent:element})
bt.addEventListener('click',function(){element.classList.toggle('ol-collapsed');});}
ol.control.Control.call(this,{element:element,target:options.target});this.set('url','https://wxs.ign.fr/'+options.apiKey+'/itineraire/rest/route.json');this._search=[];var content=ol.ext.element.create('DIV',{className:'content',parent:element})
var listElt=ol.ext.element.create('DIV',{className:'search-input',parent:content});this._search=[];this.addSearch(listElt,options);this.addSearch(listElt,options);ol.ext.element.create('I',{className:'ol-car',title:options.carlabel||'by car',parent:content}).addEventListener("click",function(){self.setMode('car');});ol.ext.element.create('I',{className:'ol-pedestrian',title:options.pedlabel||'pedestrian',parent:content}).addEventListener("click",function(){self.setMode('pedestrian');});ol.ext.element.create('I',{className:'ol-ok',title:options.runlabel||'search',html:'OK',parent:content}).addEventListener("click",function(){self.calculate();});ol.ext.element.create('I',{className:'ol-cancel',html:'cancel',parent:content}).addEventListener("click",function(){this.resultElement.innerHTML='';}.bind(this));this.resultElement=document.createElement("DIV");this.resultElement.setAttribute('class','ol-result');element.appendChild(this.resultElement);this.setMode(options.mode||'car');};ol.ext.inherits(ol.control.RoutingGeoportail,ol.control.Control);ol.control.RoutingGeoportail.prototype.setMode=function(mode){this.set('mode',mode);this.element.querySelector(".ol-car").classList.remove("selected");this.element.querySelector(".ol-pedestrian").classList.remove("selected");this.element.querySelector(".ol-"+mode).classList.add("selected");this.calculate();};ol.control.RoutingGeoportail.prototype.addButton=function(className,title,info){var bt=document.createElement("I");bt.setAttribute("class",className);bt.setAttribute("type","button");bt.setAttribute("title",title);bt.innerHTML=info||'';this.element.appendChild(bt);return bt;};ol.control.RoutingGeoportail.prototype.removeSearch=function(element,options,after){element.removeChild(after);if(this.getMap())this.getMap().removeControl(after.olsearch);this._search=[];element.querySelectorAll('div').forEach(function(d){if(d.olsearch)this._search.push(d.olsearch);}.bind(this));};ol.control.RoutingGeoportail.prototype.addSearch=function(element,options,after){var self=this;var div=ol.ext.element.create('DIV');if(after)element.insertBefore(div,after.nextSibling);else element.appendChild(div);ol.ext.element.create('BUTTON',{title:options.startlabel||"add/remove",parent:div}).addEventListener('click',function(e){if(e.ctrlKey){if(this._search.length>2)this.removeSearch(element,options,div);}else if(e.shiftKey){this.addSearch(element,options,div);}}.bind(this));var search=div.olsearch=new ol.control.SearchGeoportail({className:'IGNF ol-collapsed',apiKey:options.apiKey,target:div,reverse:true});this._search=[];element.querySelectorAll('div').forEach(function(d){if(d.olsearch)this._search.push(d.olsearch);}.bind(this));search.on('select',function(e){search.setInput(e.search.fulltext);search.set('selection',e.search);});search.element.querySelector('input').addEventListener('change',function(){search.set('selection',null);self.resultElement.innerHTML='';});if(this.getMap())this.getMap().addControl(search);};ol.control.RoutingGeoportail.prototype.setMap=function(map){ol.control.Control.prototype.setMap.call(this,map);for(var i=0;i<this._search.length;i++){var c=this._search[i];c.setMap(map);}};ol.control.RoutingGeoportail.prototype.requestData=function(steps){var start=steps[0];var end=steps[steps.length-1];var waypoints='';for(var i=1;i<steps.length-1;i++){waypoints+=(waypoints?';':'')+steps[i].x+','+steps[i].y;}
return{'gp-access-lib':'1.1.0',origin:start.x+','+start.y,destination:end.x+','+end.y,method:'time',graphName:this.get('mode')==='pedestrian'?'Pieton':'Voiture',waypoints:waypoints,format:'STANDARDEXT'};};ol.control.RoutingGeoportail.prototype.listRouting=function(routing){var time=routing.duration/60;this.resultElement.innerHTML='';var t='';if(time<60){t+=time.toFixed(0)+' min';}else{t+=(time/60).toFixed(0)+' h '+(time%60).toFixed(0)+' min';}
var dist=routing.distance;if(dist<1000){t+=' ('+dist.toFixed(0)+' m)';}else{t+=' ('+(dist/1000).toFixed(2)+' km)';}
var iElement=document.createElement('i');iElement.textContent=t;this.resultElement.appendChild(iElement)
var ul=document.createElement('ul');this.resultElement.appendChild(ul);var info={'none':'Prendre sur ','R':'Tourner à droite sur ','FR':'Tourner légèrement à droite sur ','L':'Tourner à gauche sur ','FL':'Tourner légèrement à gauche sur ','F':'Continuer tout droit sur ',}
for(var i=0,f;f=routing.features[i];i++){var d=f.get('distance');d=(d<1000)?d.toFixed(0)+' m':(d/1000).toFixed(2)+' km';t=f.get('durationT')/60;console.log(f.get('duration'),t)
t=(f.get('duration')<40)?'':(t<60)?t.toFixed(0)+' min':(t/60).toFixed(0)+' h '+(t%60).toFixed(0)+' min';var li=document.createElement('li');li.classList.add(f.get('instruction'));li.innerHTML=(info[f.get('instruction')||'none']||'#')
+' '+f.get('name')
+'<i>'+d+(t?' - '+t:'')+'</i>'
ul.appendChild(li);}};ol.control.RoutingGeoportail.prototype.handleResponse=function(data,start,end){var routing={type:'routing'};routing.features=[];var distance=0;var duration=0;var f,route=[];for(var i=0,l;l=data.legs[i];i++){for(var j=0,s;s=l.steps[j];j++){var geom=[];for(var k=0,p;p=s.points[k];k++){p=p.split(',');geom.push([parseFloat(p[0]),parseFloat(p[1])]);if(i===0||k!==0)route.push(geom[k]);}
geom=new ol.geom.LineString(geom);var options={geometry:geom.transform('EPSG:4326',this.getMap().getView().getProjection()),name:s.name,instruction:s.navInstruction,distance:parseFloat(s.distanceMeters),duration:parseFloat(s.durationSeconds)}
distance+=options.distance;duration+=options.duration;options.distanceT=distance;options.durationT=duration;f=new ol.Feature(options);routing.features.push(f);}}
routing.distance=parseFloat(data.distanceMeters);routing.duration=parseFloat(data.durationSeconds);route=new ol.geom.LineString(route);routing.feature=new ol.Feature({geometry:route.transform('EPSG:4326',this.getMap().getView().getProjection()),start:this._search[0].getTitle(start),end:this._search[0].getTitle(end),distance:routing.distance,duration:routing.duration});this.dispatchEvent(routing);this.path=routing;return routing;};ol.control.RoutingGeoportail.prototype.calculate=function(){console.log('calculate')
this.resultElement.innerHTML='';var steps=[]
for(var i=0;i<this._search.length;i++){if(this._search[i].get('selection'))steps.push(this._search[i].get('selection'));}
if(steps.length<2)return;var start=steps[0];var end=steps[steps.length-1];var data=this.requestData(steps);var url=encodeURI(this.get('url'));var parameters='';for(var index in data){parameters+=(parameters)?'&':'?';if(data.hasOwnProperty(index))parameters+=index+'='+data[index];}
var self=this;this.ajax(url+parameters,function(resp){if(resp.status>=200&&resp.status<400){self.listRouting(self.handleResponse(JSON.parse(resp.response),start,end));}else{console.log(url+parameters,arguments);}},function(){console.log(url+parameters,arguments);});};ol.control.RoutingGeoportail.prototype.ajax=function(url,onsuccess,onerror){var self=this;if(this._request){this._request.abort();}
var ajax=this._request=new XMLHttpRequest();ajax.open('GET',url,true);if(this._auth){ajax.setRequestHeader("Authorization","Basic "+this._auth);}
this.element.classList.add('ol-searching');ajax.onload=function(){self._request=null;self.element.classList.remove('ol-searching');onsuccess.call(self,this);};ajax.onerror=function(){self._request=null;self.element.classList.remove('ol-searching');if(onerror)onerror.call(self);};ajax.send();};ol.control.Scale=function(options){if(!options)options={};if(options.typing==undefined)options.typing=300;var element=document.createElement("DIV");var classNames=(options.className||"")+" ol-scale";if(!options.target){classNames+=" ol-unselectable ol-control";}
this._input=document.createElement("INPUT");this._input.value='-';element.setAttribute('class',classNames);if(options.editable===false)this._input.readOnly=true;element.appendChild(this._input);ol.control.Control.call(this,{element:element,target:options.target});this._input.addEventListener("change",this.setScale.bind(this));this.set('ppi',options.ppi||96)};ol.ext.inherits(ol.control.Scale,ol.control.Control);ol.control.Scale.prototype.setMap=function(map){if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.control.Control.prototype.setMap.call(this,map);if(map){this._listener=map.on('moveend',this._showScale.bind(this));}};ol.control.Scale.prototype._showScale=function(){var map=this.getMap();if(map){var view=map.getView();var proj=view.getProjection();var center=view.getCenter();var px=map.getPixelFromCoordinate(center);px[1]+=1;var coord=map.getCoordinateFromPixel(px);var d=ol.sphere.getDistance(ol.proj.transform(center,proj,'EPSG:4326'),ol.proj.transform(coord,proj,'EPSG:4326'));d*=this.get('ppi')/.0254
this._input.value=this.formatScale(d);}};ol.control.Scale.prototype.formatScale=function(d){if(d>100)d=Math.round(d/100)*100;else d=Math.round(d);return'1 / '+d.toLocaleString();};ol.control.Scale.prototype.setScale=function(value){var map=this.getMap();if(map&&value){if(value.target)value=value.target.value;var fac=value;if(typeof(value)==='string'){fac=value.split('/')[1];if(!fac)fac=value;fac=fac.replace(/[^\d]/g,'');fac=parseInt(fac);}
var view=map.getView();var proj=view.getProjection();var center=view.getCenter();var px=map.getPixelFromCoordinate(center);px[1]+=1;var coord=map.getCoordinateFromPixel(px);var d=ol.sphere.getDistance(ol.proj.transform(center,proj,'EPSG:4326'),ol.proj.transform(coord,proj,'EPSG:4326'));d*=this.get('ppi')/.0254
view.setResolution(view.getResolution()*fac/d);}
this._showScale();};ol.control.SearchBAN=function(options){options=options||{};options.typing=options.typing||500;options.url=options.url||'https://api-adresse.data.gouv.fr/search/';options.className=options.className||'BAN';options.copy='<a href="https://adresse.data.gouv.fr/" target="new">&copy; BAN-data.gouv.fr</a>';ol.control.SearchPhoton.call(this,options);};ol.ext.inherits(ol.control.SearchBAN,ol.control.SearchPhoton);ol.control.SearchBAN.prototype.getTitle=function(f){var p=f.properties;return(p.label);};ol.control.SearchBAN.prototype.select=function(f){var c=f.geometry.coordinates;try{c=ol.proj.transform(f.geometry.coordinates,'EPSG:4326',this.getMap().getView().getProjection());}catch(e){}
this.dispatchEvent({type:"select",search:f,coordinate:c});};ol.control.SearchDFCI=function(options){if(!options)options={};options.className=options.className||'dfci';options.placeholder=options.placeholder||'Code DFCI';ol.control.Search.call(this,options);};ol.ext.inherits(ol.control.SearchDFCI,ol.control.Search);ol.control.SearchDFCI.prototype.autocomplete=function(s){s=s.toUpperCase();s=s.replace(/[^0-9,^A-H,^K-N]/g,'');if(s.length<2){this.setInput(s);return[];}
var i;var proj=this.getMap().getView().getProjection();var result=[];var c=ol.coordinate.fromDFCI(s,proj);var level=Math.floor(s.length/2)-1;var dfci=ol.coordinate.toDFCI(c,level,proj);dfci=dfci.replace(/[^0-9,^A-H,^K-N]/g,'');if(!/NaN/.test(dfci)&&dfci){console.log('ok',dfci)
this.setInput(dfci+s.substring(dfci.length,s.length));result.push({coordinate:ol.coordinate.fromDFCI(dfci,proj),name:dfci});if(s.length===5){c=ol.coordinate.fromDFCI(s+0,proj);dfci=(ol.coordinate.toDFCI(c,level+1,proj)).substring(0,5);for(i=0;i<10;i++){result.push({coordinate:ol.coordinate.fromDFCI(dfci+i,proj),name:dfci+i});}}
if(level===2){for(i=0;i<6;i++){result.push({coordinate:ol.coordinate.fromDFCI(dfci+'.'+i,proj),name:dfci+'.'+i});}}}
return result;};ol.control.SearchFeature=function(options){if(!options)options={};options.className=options.className||'feature';ol.control.Search.call(this,options);if(typeof(options.getSearchString)=="function")this.getSearchString=options.getSearchString;this.set('property',options.property||'name');this.source_=options.source;};ol.ext.inherits(ol.control.SearchFeature,ol.control.Search);ol.control.SearchFeature.prototype.restoreHistory=function(){this.set('history',[]);};ol.control.SearchFeature.prototype.saveHistory=function(){localStorage.removeItem("ol@search-"+this._classname);}
ol.control.SearchFeature.prototype.getTitle=function(f){return f.get(this.get('property')||'name');};ol.control.SearchFeature.prototype.getSearchString=function(f){return this.getTitle(f);};ol.control.SearchFeature.prototype.getSource=function(){return this.source_;}
ol.control.SearchFeature.prototype.setSource=function(source){this.source_=source;};ol.control.SearchFeature.prototype.autocomplete=function(s){var result=[];if(this.source_){s=s.replace(/^\*/,'');var rex=new RegExp(s,'i');var features=this.source_.getFeatures();var max=this.get('maxItems')
for(var i=0,f;f=features[i];i++){var att=this.getSearchString(f);if(att!==undefined&&rex.test(att)){result.push(f);if((--max)<=0)break;}}}
return result;};ol.control.SearchGPS=function(options){if(!options)options={};options.className=(options.className||'')+' ol-searchgps';options.placeholder=options.placeholder||'lon,lat';ol.control.Search.call(this,options);this.geolocation=new ol.Geolocation({projection:"EPSG:4326",trackingOptions:{maximumAge:10000,enableHighAccuracy:true,timeout:600000}});ol.ext.element.create('BUTTON',{className:'ol-geoloc',title:'Locate with GPS',parent:this.element,click:function(){this.geolocation.setTracking(true);}.bind(this)})
var dms=ol.ext.element.create('LABEL',{className:'ol-switch',parent:this.element});ol.ext.element.create('TEXT',{html:'decimal',parent:dms});ol.ext.element.create('INPUT',{type:'checkbox',parent:dms,on:{'change':function(e){if(e.target.checked)this.element.classList.add('ol-dms');else this.element.classList.remove('ol-dms');}.bind(this)}});ol.ext.element.create('SPAN',{parent:dms});ol.ext.element.create('TEXT',{html:'DMS',parent:dms});this._createForm();var ul=this.element.querySelector("ul.autocomplete");this.element.appendChild(ul);};ol.ext.inherits(ol.control.SearchGPS,ol.control.Search);ol.control.SearchGPS.prototype._createForm=function(){var onchange=function(e){if(e.target.classList.contains('ol-dms')){lon.value=(lond.value<0?-1:1)*Number(lond.value)+Number(lonm.value)/60+Number(lons.value)/3600;lon.value=(lond.value<0?-1:1)*Math.round(lon.value*10000000)/10000000;lat.value=(latd.value<0?-1:1)*Number(latd.value)+Number(latm.value)/60+Number(lats.value)/3600;lat.value=(latd.value<0?-1:1)*Math.round(lat.value*10000000)/10000000;}
if(lon.value||lat.value){this._input.value=lon.value+','+lat.value;}else{this._input.value='';}
if(!e.target.classList.contains('ol-dms')){var s=ol.coordinate.toStringHDMS([Number(lon.value),Number(lat.value)]);var c=s.replace(/(N|S|E|W)/g,'').split('″');c[1]=c[1].trim().split(' ');lond.value=(/W/.test(s)?-1:1)*parseInt(c[1][0]);lonm.value=parseInt(c[1][1]);lons.value=parseInt(c[1][2]);c[0]=c[0].trim().split(' ');latd.value=(/W/.test(s)?-1:1)*parseInt(c[0][0]);latm.value=parseInt(c[0][1]);lats.value=parseInt(c[0][2]);}
this.search();}.bind(this);function createInput(className,unit){var input=ol.ext.element.create('INPUT',{className:className,type:'number',step:'any',lang:'en',parent:div,on:{'change keyup':onchange}});if(unit){ol.ext.element.create('SPAN',{className:'ol-dms',html:unit,parent:div,});}
return input;}
var div=ol.ext.element.create('DIV',{className:'ol-longitude',parent:this.element});ol.ext.element.create('LABEL',{html:'Longitude',parent:div});var lon=createInput('ol-decimal');var lond=createInput('ol-dms','°');var lonm=createInput('ol-dms','\'');var lons=createInput('ol-dms','"');div=ol.ext.element.create('DIV',{className:'ol-latitude',parent:this.element})
ol.ext.element.create('LABEL',{html:'Latitude',parent:div});var lat=createInput('ol-decimal');var latd=createInput('ol-dms','°');var latm=createInput('ol-dms','\'');var lats=createInput('ol-dms','"');this.button.addEventListener("click",function(){lon.focus();});this.on('select',function(e){lon.value=e.search.gps[0];lat.value=e.search.gps[1];}.bind(this));this.geolocation.on('change',function(){this.geolocation.setTracking(false);var coord=this.geolocation.getPosition();lon.value=coord[0];lat.value=coord[1];this._triggerCustomEvent('keyup',lon);}.bind(this));};ol.control.SearchGPS.prototype.autocomplete=function(s){var result=[];var c=s.split(',');c[0]=Number(c[0]);c[1]=Number(c[1]);s=ol.coordinate.toStringHDMS(c)
if(s)s=s.replace(/(°|′|″) /g,'$1');var coord=ol.proj.transform([c[0],c[1]],'EPSG:4326',this.getMap().getView().getProjection());result.push({gps:c,coordinate:coord,name:s});return result;};ol.control.SearchGeoportailParcelle=function(options){var self=this;options.type="Commune";options.className=(options.className?options.className:"")+" IGNF-parcelle ol-collapsed-list ol-collapsed-num";options.inputLabel="Commune";options.noCollapse=true;options.placeholder=options.placeholder||"Choisissez une commune...";ol.control.SearchGeoportail.call(this,options);this.set('copy',null);var element=this.element;var div=document.createElement("DIV");element.appendChild(div);var label=document.createElement("LABEL");label.innerText='Préfixe'
div.appendChild(label);label=document.createElement("LABEL");label.innerText='Section'
div.appendChild(label);label=document.createElement("LABEL");label.innerText='Numéro'
div.appendChild(label);div.appendChild(document.createElement("BR"));this._inputParcelle={prefix:document.createElement("INPUT"),section:document.createElement("INPUT"),numero:document.createElement("INPUT")};this._inputParcelle.prefix.setAttribute('maxlength',3);this._inputParcelle.section.setAttribute('maxlength',2);this._inputParcelle.numero.setAttribute('maxlength',4);var tout;var doSearch=function(){if(tout)clearTimeout(tout);tout=setTimeout(function(){self.autocompleteParcelle();},options.typing||0);}
for(var i in this._inputParcelle){div.appendChild(this._inputParcelle[i]);this._inputParcelle[i].addEventListener("keyup",doSearch);this._inputParcelle[i].addEventListener('blur',function(){tout=setTimeout(function(){element.classList.add('ol-collapsed-num');},200);});this._inputParcelle[i].addEventListener('focus',function(){clearTimeout(tout);element.classList.remove('ol-collapsed-num');});}
this.activateParcelle(false);var auto=document.createElement('DIV');auto.className='autocomplete-parcelle';element.appendChild(auto);var ul=document.createElement('UL');ul.classList.add('autocomplete-parcelle');auto.appendChild(ul);ul=document.createElement('UL');ul.classList.add('autocomplete-page');auto.appendChild(ul);this._input.addEventListener('blur',function(){setTimeout(function(){element.classList.add('ol-collapsed-list')},200);});this._input.addEventListener('focus',function(){element.classList.remove('ol-collapsed-list');self._listParcelle([]);if(self._commune){self._commune=null;self._input.value='';self.drawList_();}
self.activateParcelle(false);});this.on('select',this.selectCommune.bind(this));this.set('pageSize',options.pageSize||5);};ol.ext.inherits(ol.control.SearchGeoportailParcelle,ol.control.SearchGeoportail);ol.control.SearchGeoportailParcelle.prototype.selectCommune=function(e){this._commune=e.search.insee;this._input.value=e.search.insee+' - '+e.search.fulltext;this.activateParcelle(true);this._inputParcelle.numero.focus();this.autocompleteParcelle();};ol.control.SearchGeoportailParcelle.prototype.setParcelle=function(p,search){this._inputParcelle.prefix.value=(p.Commune||'')+(p.CommuneAbsorbee||'');this._inputParcelle.section.value=p.Section||'';this._inputParcelle.numero.value=p.Numero||'';if(search)this._triggerCustomEvent("keyup",this._inputParcelle.prefix);};ol.control.SearchGeoportailParcelle.prototype.activateParcelle=function(b){for(var i in this._inputParcelle){this._inputParcelle[i].readOnly=!b;}
if(b){this._inputParcelle.section.parentElement.classList.add('ol-active');}else{this._inputParcelle.section.parentElement.classList.remove('ol-active');}};ol.control.SearchGeoportailParcelle.prototype.autocompleteParcelle=function(){function complete(s,n,c){if(!s)return s;c=c||"0";while(s.length<n)s=c+s;return s.replace(/\*/g,'_');}
var commune=this._commune;var prefix=complete(this._inputParcelle.prefix.value,3);if(prefix==='000'){prefix='___';}
var section=complete(this._inputParcelle.section.value,2);var numero=complete(this._inputParcelle.numero.value,4,"0");var search=commune+(prefix||'___')+(section||"__")+(numero?numero:section?"____":"0001");this.searchParcelle(search,function(jsonResp){this._listParcelle(jsonResp);}.bind(this),function(){console.log('oops')})};ol.control.SearchGeoportailParcelle.prototype.searchParcelle=function(search,success){var request='<?xml version="1.0" encoding="UTF-8"?>'
+'<XLS xmlns:xls="http://www.opengis.net/xls" xmlns:gml="http://www.opengis.net/gml" xmlns="http://www.opengis.net/xls" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.2" xsi:schemaLocation="http://www.opengis.net/xls http://schemas.opengis.net/ols/1.2/olsAll.xsd">'
+'<RequestHeader/>'
+'<Request requestID="1" version="1.2" methodName="LocationUtilityService">'
+'<GeocodeRequest returnFreeForm="false">'
+'<Address countryCode="CadastralParcel">'
+'<freeFormAddress>'+search+'+</freeFormAddress>'
+'</Address>'
+'</GeocodeRequest>'
+'</Request>'
+'</XLS>'
this.ajax(this.get('url').replace('ols/apis/completion','geoportail/ols'),{xls:request},function(xml){var parser=new DOMParser();var xmlDoc=parser.parseFromString(xml,"text/xml");var parcelles=xmlDoc.getElementsByTagName('GeocodedAddress');var jsonResp=[]
for(var i=0,parc;parc=parcelles[i];i++){var node=parc.getElementsByTagName('gml:pos')[0]||parc.getElementsByTagName('pos')[0];var p=node.childNodes[0].nodeValue.split(' ');var att=parc.getElementsByTagName('Place');var json={lon:Number(p[1]),lat:Number(p[0])};for(var k=0,a;a=att[k];k++){json[a.attributes.type.value]=a.childNodes[0].nodeValue;}
jsonResp.push(json);}
success(jsonResp);},{dataType:'XML'});};ol.control.SearchGeoportailParcelle.prototype._listParcelle=function(resp){var self=this;var ul=this.element.querySelector("ul.autocomplete-parcelle");ul.innerHTML='';var page=this.element.querySelector("ul.autocomplete-page");page.innerHTML='';this._listParc=[];function showPage(i){var l=ul.children;var visible="ol-list-"+i;var k;for(k=0;k<l.length;k++){l[k].style.display=(l[k].className===visible)?'':'none';}
l=page.children;for(k=0;k<l.length;k++){l[k].className=(l[k].innerText==i)?'selected':'';}
page.style.display=l.length>1?'':'none';}
resp.sort(function(a,b){var na=a.INSEE+a.CommuneAbsorbee+a.Section+a.Numero;var nb=b.INSEE+b.CommuneAbsorbee+b.Section+b.Numero;return na===nb?0:na<nb?-1:1;});var n=this.get('pageSize');for(var i=0,r;r=resp[i];i++){var li=document.createElement("LI");li.setAttribute("data-search",i);if(n>0)li.classList.add("ol-list-"+Math.floor(i/n));this._listParc.push(r);li.addEventListener("click",function(e){self._handleParcelle(self._listParc[e.currentTarget.getAttribute("data-search")]);});li.innerHTML=r.INSEE+r.CommuneAbsorbee+r.Section+r.Numero;ul.appendChild(li);if(n>0&&!(i%n)){li=document.createElement("LI");li.innerText=Math.floor(i/n);li.addEventListener("click",function(e){showPage(e.currentTarget.innerText);});page.appendChild(li);}}
if(n>0)showPage(0);};ol.control.SearchGeoportailParcelle.prototype._handleParcelle=function(parc){this.dispatchEvent({type:"parcelle",search:parc,coordinate:ol.proj.fromLonLat([parc.lon,parc.lat],this.getMap().getView().getProjection())});};ol.control.SearchNominatim=function(options){options=options||{};options.className=options.className||'nominatim';options.typing=options.typing||500;options.url=options.url||'https://nominatim.openstreetmap.org/search';options.copy='<a href="http://www.openstreetmap.org/copyright" target="new">&copy; OpenStreetMap contributors</a>';ol.control.SearchJSON.call(this,options);this.set('polygon',options.polygon);this.set('viewbox',options.viewbox);this.set('bounded',options.bounded);};ol.ext.inherits(ol.control.SearchNominatim,ol.control.SearchJSON);ol.control.SearchNominatim.prototype.getTitle=function(f){var info=[];if(f.class)info.push(f.class);if(f.type)info.push(f.type);var title=f.display_name+(info.length?"<i>"+info.join(' - ')+"</i>":'');if(f.icon)title="<img src='"+f.icon+"' />"+title;return(title);};ol.control.SearchNominatim.prototype.requestData=function(s){var data={format:"json",addressdetails:1,q:s,polygon_geojson:this.get('polygon')?1:0,bounded:this.get('bounded')?1:0,limit:this.get('maxItems')};if(this.get('viewbox'))data.viewbox=this.get('viewbox');return data;};ol.control.SearchNominatim.prototype.select=function(f){var c=[Number(f.lon),Number(f.lat)];try{c=ol.proj.transform(c,'EPSG:4326',this.getMap().getView().getProjection());}catch(e){}
this.dispatchEvent({type:"select",search:f,coordinate:c});};ol.control.SearchNominatim.prototype.reverseGeocode=function(coord,cback){var lonlat=ol.proj.transform(coord,this.getMap().getView().getProjection(),'EPSG:4326');this.ajax(this.get('url').replace('search','reverse'),{lon:lonlat[0],lat:lonlat[1],format:'json'},function(resp){if(cback){cback.call(this,[resp]);}else{this._handleSelect(resp,true);}}.bind(this));};ol.control.SearchWikipedia=function(options){options=options||{};options.lang=options.lang||'en';options.className=options.className||'ol-search-wikipedia';options.url='https://'+options.lang+'.wikipedia.org/w/api.php';options.placeholder=options.placeholder||'search string, File:filename';options.copy='<a href="https://'+options.lang+'.wikipedia.org/" target="new">Wikipedia&reg; - CC-By-SA</a>';ol.control.SearchJSON.call(this,options);this.set('lang',options.lang);};ol.ext.inherits(ol.control.SearchWikipedia,ol.control.SearchJSON);ol.control.SearchWikipedia.prototype.getTitle=function(f){return ol.ext.element.create('DIV',{html:f.title,title:f.desc});};ol.control.SearchWikipedia.prototype.setLang=function(lang){this.set('lang',lang)
this.set('url','https://'+lang+'.wikipedia.org/w/api.php');};ol.control.SearchWikipedia.prototype.requestData=function(s){var data={action:'opensearch',search:s,lang:this.get('lang'),format:'json',origin:'*',limit:this.get('maxItems')}
return data;};ol.control.SearchWikipedia.prototype.handleResponse=function(response){var features=[];for(var i=0;i<response[1].length;i++){features.push({title:response[1][i],desc:response[2][i],uri:response[3][i]})}
return features;};ol.control.SearchWikipedia.prototype.select=function(f){var title=decodeURIComponent(f.uri.split('/').pop()).replace(/'/,'%27');ol.ext.Ajax.get({url:f.uri.split('wiki/')[0]+'w/api.php',data:{action:'query',prop:'pageimages|coordinates|extracts',exintro:1,explaintext:1,piprop:'original',origin:'*',format:'json',redirects:1,titles:title},options:{encode:false},success:function(e){var page=e.query.pages[Object.keys(e.query.pages).pop()];console.log(page);var feature={title:f.title,desc:page.extract||f.desc,url:f.uri,img:page.original?page.original.source:undefined,pageid:page.pageid}
var c;if(page.coordinates){feature.lon=page.coordinates[0].lon;feature.lat=page.coordinates[0].lat;c=[feature.lon,feature.lat];c=ol.proj.transform(c,'EPSG:4326',this.getMap().getView().getProjection());}
this.dispatchEvent({type:"select",search:feature,coordinate:c});}.bind(this)})};ol.control.Select=function(options){var self=this;if(!options)options={};var div=options.content=document.createElement("div");this._ul=ol.ext.element.create('UL',{parent:div});this._all=ol.ext.element.create('INPUT',{type:'checkbox',checked:true});var label_match_all=ol.ext.element.create('LABEL',{html:this._all,parent:div});ol.ext.element.appendText(label_match_all,options.allLabel||'match all');this._useCase=ol.ext.element.create('INPUT',{type:'checkbox'});var label_case_sensitive=ol.ext.element.create('LABEL',{html:this._useCase,parent:div});ol.ext.element.appendText(label_case_sensitive,options.caseLabel||'case sensitive');ol.control.SelectBase.call(this,options);ol.ext.element.create('BUTTON',{className:'ol-append',html:options.addLabel||'add rule',click:function(){self.addCondition();},parent:div});this._conditions=[];this.set('attrPlaceHolder',options.attrPlaceHolder||'attribute');this.set('valuePlaceHolder',options.valuePlaceHolder||'value');this.addCondition();};ol.ext.inherits(ol.control.Select,ol.control.SelectBase);ol.control.Select.prototype.addCondition=function(options){options=options||{};this._conditions.push({attr:options.attr||'',op:options.op||'=',val:options.val||''});this._drawlist();};ol.control.Select.prototype.getConditions=function(){return{usecase:this._useCase.checked,all:this._all.checked,conditions:this._conditions}};ol.control.Select.prototype.setConditions=function(cond){this._useCase.checked=cond.usecase;this._all.checked=cond.all;this._conditions=cond.conditions;this._drawlist();};ol.control.Select.prototype.getConditionsString=function(cond){var st='';for(var i=0,c;c=cond.conditions[i];i++){if(c.attr){st+=(st?(cond.all?' AND ':' OR '):'')
+c.attr
+this.operationsList[c.op]
+c.val;}}
return st};ol.control.Select.prototype._drawlist=function(){this._ul.innerHTML='';for(var i=0;i<this._conditions.length;i++){this._ul.appendChild(this._getLiCondition(i));}};ol.control.Select.prototype._autocomplete=function(val,ul){ul.classList.remove('ol-hidden');ul.innerHTML='';var attributes={};var sources=this.get('source');for(var i=0,s;s=sources[i];i++){var features=s.getFeatures();for(var j=0,f;f=features[j];j++){Object.assign(attributes,f.getProperties());if(j>100)break;}}
var rex=new RegExp(val,'i');for(var a in attributes){if(a==='geometry')continue;if(rex.test(a)){var li=document.createElement('li');li.textContent=a;li.addEventListener("click",function(){ul.previousElementSibling.value=this.textContent;var event=document.createEvent('HTMLEvents');event.initEvent('change',true,false);ul.previousElementSibling.dispatchEvent(event);ul.classList.add('ol-hidden');});ul.appendChild(li);}}};ol.control.Select.prototype._getLiCondition=function(i){var self=this;var li=document.createElement('li');var autocomplete=document.createElement('div');autocomplete.classList.add('ol-autocomplete');autocomplete.addEventListener("mouseleave",function(){this.querySelector('ul').classList.add('ol-hidden');});li.appendChild(autocomplete);var input_attr=document.createElement('input');input_attr.classList.add('ol-attr');input_attr.setAttribute('type','text');input_attr.setAttribute('placeholder',this.get('attrPlaceHolder'));input_attr.addEventListener('keyup',function(){self._autocomplete(this.value,this.nextElementSibling);})
input_attr.addEventListener('click',function(){self._autocomplete(this.value,this.nextElementSibling);this.nextElementSibling.classList.remove('ol-hidden')})
input_attr.addEventListener('change',function(){self._conditions[i].attr=this.value;})
input_attr.value=self._conditions[i].attr;autocomplete.appendChild(input_attr);var ul_autocomplete=document.createElement('ul');ul_autocomplete.classList.add('ol-hidden')
autocomplete.appendChild(ul_autocomplete);var select=document.createElement('select');li.appendChild(select);for(var k in this.operationsList){var option=document.createElement('option');option.value=k;option.textContent=this.operationsList[k];select.appendChild(option);}
select.value=self._conditions[i].op;select.addEventListener('change',function(){self._conditions[i].op=this.value;});var input_value=document.createElement('input');input_value.setAttribute('type','text');input_value.setAttribute('placeholder',this.get('valuePlaceHolder'));input_value.addEventListener('change',function(){self._conditions[i].val=this.value;})
input_value.value=self._conditions[i].val;li.appendChild(input_value);if(this._conditions.length>1){var div_delete=document.createElement('div');div_delete.classList.add('ol-delete');div_delete.addEventListener("click",function(){self.removeCondition(i);})
li.appendChild(div_delete);}
return li;};ol.control.Select.prototype.removeCondition=function(i){this._conditions.splice(i,1);this._drawlist();};ol.control.Select.prototype.doSelect=function(options){options=options||{};options.useCase=options.useCase||this._useCase.checked;options.matchAll=options.matchAll||this._all.checked;options.conditions=options.conditions||this._conditions
return ol.control.SelectBase.prototype.doSelect.call(this,options);};ol.control.SelectCheck=function(options){if(!options)options={};var div=options.content=ol.ext.element.create('DIV');if(options.label){ol.ext.element.create('LABEL',{html:options.label,parent:div});}
this._input=ol.ext.element.create('DIV',{parent:div});options.className=options.className||'ol-select-check';ol.control.SelectBase.call(this,options);this.set('property',options.property||'name');this.set('max',options.max||10000);this.set('defaultLabel',options.defaultLabel);this.set('type',options.type);this._selectAll=options.selectAll;this._onchoice=options.onchoice;this.setValues();};ol.ext.inherits(ol.control.SelectCheck,ol.control.SelectBase);ol.control.SelectCheck.prototype.setMap=function(map){ol.control.SelectBase.prototype.setMap.call(this,map);this.setValues();};ol.control.SelectCheck.prototype.doSelect=function(options){options=options||{};var conditions=[];this._checks.forEach(function(c){if(c.checked){if(c.value){conditions.push({attr:this.get('property'),op:'=',val:c.value});}}}.bind(this));if(!conditions.length){return ol.control.SelectBase.prototype.doSelect.call(this,{features:options.features,matchAll:this._selectAll});}else{return ol.control.SelectBase.prototype.doSelect.call(this,{features:options.features,conditions:conditions})}};ol.control.SelectCheck.prototype.setValues=function(options){options=options||{};console.log(options)
var values,vals;if(options.values){if(options.values instanceof Array){vals={};options.values.forEach(function(v){vals[v]=v;});}else{vals=options.values;}}else{vals={};var prop=this.get('property');this.getSources().forEach(function(s){var features=s.getFeatures();var max=Math.min(features.length,this.get('max'))
for(var i=0;i<max;i++){var p=features[i].get(prop);if(p)vals[p]=p;}}.bind(this));}
if(!Object.keys(vals).length)return;if(options.sort){values={};Object.keys(vals).sort().forEach(function(key){values[key]=vals[key];});}else{values=vals;}
ol.ext.element.setHTML(this._input,'');this._checks=[];var id='radio_'+(new Date().getTime());var addCheck=function(val,info){var label=ol.ext.element.create('LABEL',{className:(this.get('type')==='radio'?'ol-radio':'ol-checkbox'),parent:this._input});this._checks.push(ol.ext.element.create('INPUT',{name:id,type:(this.get('type')==='radio'?'radio':'checkbox'),value:val,change:function(){if(this._onchoice)this._onchoice()
else this.doSelect();}.bind(this),parent:label}));ol.ext.element.create('DIV',{html:info,parent:label});}.bind(this);if(this.get('defaultLabel')&&this.get('type')==='radio')addCheck('',this.get('defaultLabel'));for(var k in values)addCheck(k,values[k]);};ol.control.SelectCondition=function(options){if(!options)options={};var div=options.content=ol.ext.element.create('DIV');var label=ol.ext.element.create('LABEL',{parent:div});this._check=ol.ext.element.create('INPUT',{type:'checkbox',change:function(){if(this._onchoice)this._onchoice()
else this.doSelect();}.bind(this),parent:label});ol.ext.element.create('DIV',{html:options.label||'condition',parent:label});this._input=ol.ext.element.create('DIV',{parent:div});options.className=options.className||'ol-select-condition';ol.control.SelectBase.call(this,options);this.setCondition(options.condition);this._selectAll=options.selectAll;this._onchoice=options.onchoice;};ol.ext.inherits(ol.control.SelectCondition,ol.control.SelectBase);ol.control.SelectCondition.prototype.setCondition=function(condition){if(!condition)this._conditions=[];else this._conditions=(condition instanceof Array?condition:[condition]);};ol.control.SelectCondition.prototype.addCondition=function(condition){this._conditions.push(condition);};ol.control.SelectCondition.prototype.doSelect=function(options){options=options||{};var conditions=this._conditions;if(!this._check.checked){return ol.control.SelectBase.prototype.doSelect.call(this,{features:options.features,matchAll:this._selectAll});}else{return ol.control.SelectBase.prototype.doSelect.call(this,{features:options.features,conditions:conditions})}};ol.control.SelectFulltext=function(options){if(!options)options={};var div=options.content=ol.ext.element.create('DIV');if(options.label){ol.ext.element.create('LABEL',{html:options.label,parent:div});}
this._input=ol.ext.element.create('INPUT',{placeHolder:options.placeHolder||'search...',change:function(){if(this._onchoice)this._onchoice();}.bind(this),parent:div});ol.control.SelectBase.call(this,options);this._onchoice=options.onchoice;this.set('property',options.property||'name');};ol.ext.inherits(ol.control.SelectFulltext,ol.control.SelectBase);ol.control.SelectFulltext.prototype.doSelect=function(options){options=options||{};return ol.control.SelectBase.prototype.doSelect.call(this,{features:options.features,useCase:false,conditions:[{attr:this.get('property'),op:'contain',val:this._input.value}]});}
ol.control.SelectMulti=function(options){if(!options)options={};options.content=ol.ext.element.create('DIV');this._container=ol.ext.element.create('UL',{parent:options.content});options.className=options.className||'ol-select-multi';ol.control.SelectBase.call(this,options);this._controls=[];options.controls.forEach(this.addControl.bind(this));};ol.ext.inherits(ol.control.SelectMulti,ol.control.SelectBase);ol.control.SelectMulti.prototype.setMap=function(map){if(this.getMap()){this._controls.forEach(function(c){this.getMap().remveControl(c);}.bind(this));}
ol.control.SelectBase.prototype.setMap.call(this,map);if(this.getMap()){this._controls.forEach(function(c){this.getMap().addControl(c);}.bind(this));}};ol.control.SelectMulti.prototype.addControl=function(c){if(c instanceof ol.control.SelectBase){this._controls.push(c);c.setTarget(ol.ext.element.create('LI',{parent:this._container}));c._selectAll=true;c._onchoice=this.doSelect.bind(this);if(this.getMap()){this.getMap().addControl(c);}}};ol.control.SelectMulti.prototype.getControls=function(){return this._controls;};ol.control.SelectMulti.prototype.doSelect=function(){var features=[];this.getSources().forEach(function(s){features=features.concat(s.getFeatures());});this._controls.forEach(function(c){features=c.doSelect({features:features});});this.dispatchEvent({type:"select",features:features});return features;};ol.control.SelectPopup=function(options){if(!options)options={};var div=options.content=ol.ext.element.create('DIV');if(options.label){ol.ext.element.create('LABEL',{html:options.label,parent:div});}
this._input=ol.ext.element.create('SELECT',{on:{change:function(){if(this._onchoice)this._onchoice();else this.doSelect();}.bind(this)},parent:div});options.className=options.className||'ol-select-popup';ol.control.SelectBase.call(this,options);this.set('property',options.property||'name');this.set('max',options.max||10000);this.set('defaultLabel',options.defaultLabel);this._selectAll=options.selectAll;this._onchoice=options.onchoice;this.setValues();};ol.ext.inherits(ol.control.SelectPopup,ol.control.SelectBase);ol.control.SelectPopup.prototype.setMap=function(map){ol.control.SelectBase.prototype.setMap.call(this,map);this.setValues();};ol.control.SelectPopup.prototype.doSelect=function(options){options=options||{};if(!this._input.value){return ol.control.SelectBase.prototype.doSelect.call(this,{features:options.features,matchAll:this._selectAll});}else{return ol.control.SelectBase.prototype.doSelect.call(this,{features:options.features,conditions:[{attr:this.get('property'),op:'=',val:this._input.value}]})}};ol.control.SelectPopup.prototype.setValues=function(options){options=options||{};var values,vals;if(options.values){if(options.values instanceof Array){vals={};options.values.forEach(function(v){vals[v]=v;});}else{vals=options.values;}}else{vals={};var prop=this.get('property');this.getSources().forEach(function(s){var features=s.getFeatures();var max=Math.min(features.length,this.get('max'))
for(var i=0;i<max;i++){var p=features[i].get(prop);if(p)vals[p]=p;}}.bind(this));}
if(options.sort){values={};Object.keys(vals).sort().forEach(function(key){values[key]=vals[key];});}else{values=vals;}
ol.ext.element.setHTML(this._input,'');ol.ext.element.create('OPTION',{className:'ol-default',html:this.get('defaultLabel')||'',value:'',parent:this._input});for(var k in values){ol.ext.element.create('OPTION',{html:values[k],value:k,parent:this._input});}};ol.control.Status=function(options){options=options||{};var element=ol.ext.element.create('DIV',{className:(options.className||'')+' ol-status'
+(options.target?'':' ol-unselectable ol-control')});ol.control.Control.call(this,{element:element,target:options.target});if(options.position)this.setPosition(options.position);this.status(options.status||'');};ol.ext.inherits(ol.control.Status,ol.control.Control);ol.control.Status.prototype.status=function(html){var s=html||'';if(s){ol.ext.element.show(this.element);if(typeof(s)==='object'&&!(s instanceof String)){s='';for(var i in html){s+='<label>'+i+':</label> '+html[i]+'<br/>';}}
ol.ext.element.setHTML(this.element,s);}else{ol.ext.element.hide(this.element);}};ol.control.Status.prototype.setPosition=function(position){this.element.classList.remove('ol-left');this.element.classList.remove('ol-right');this.element.classList.remove('ol-bottom');this.element.classList.remove('ol-center');if(/^left$|^right$|^bottom$|^center$/.test(position)){this.element.classList.add('ol-'+position);}};ol.control.Status.prototype.show=function(show){if(show===false)ol.ext.element.hide(this.element);else ol.ext.element.show(this.element);};ol.control.Status.prototype.hide=function(){ol.ext.element.hide(this.element);};ol.control.Status.prototype.toggle=function(){ol.ext.element.toggle(this.element);};ol.control.Status.prototype.isShown=function(){return this.element.style.display==='none';};ol.control.Storymap=function(options){if(options.target){if(!options.html){options.html=options.target.innerHTML;}else if(options.html instanceof Element){options.html=options.html.innerHTML;}
options.target.innerHTML='';}
var element=ol.ext.element.create('DIV',{className:(options.className||'')+' ol-storymap'
+(options.target?'':' ol-unselectable ol-control')
+('ontouchstart'in window?' ol-touch':''),html:options.html});element.querySelectorAll('.chapter').forEach(function(c){c.addEventListener('click',function(e){if(!this.element.classList.contains('ol-move')){if(!c.classList.contains('ol-select')){this.element.scrollTop=c.offsetTop-30;e.preventDefault();}else{if(e.target.tagName==='IMG'&&e.target.dataset.title){this.dispatchEvent({coordinate:this.getMap()?this.getMap().getCoordinateFromPixel([e.layerX,e.layerY]):null,type:'clickimage',img:e.target,title:e.target.dataset.title,element:c,name:c.getAttribute('name'),originalEvent:e});}}}}.bind(this));}.bind(this));ol.control.Control.call(this,{element:element,target:options.target});ol.ext.element.scrollDiv(this.element,{vertical:true,mousewheel:true});var sc=this.element.querySelectorAll('.ol-scroll-next');sc.forEach(function(s){s.addEventListener('click',function(e){if(s.parentElement.classList.contains('ol-select')){var chapter=this.element.querySelectorAll('.chapter');var scrollto=s.offsetTop;for(var i=0,c;c=chapter[i];i++){if(c.offsetTop>scrollto){scrollto=c.offsetTop;break;}}
this.element.scrollTop=scrollto-30;e.stopPropagation();e.preventDefault();}}.bind(this));}.bind(this));sc=this.element.querySelectorAll('.ol-scroll-top');sc.forEach(function(i){i.addEventListener('click',function(e){this.element.scrollTop=0;e.stopPropagation();e.preventDefault();}.bind(this));}.bind(this));var getEvent=function(currentDiv){var lonlat=[parseFloat(currentDiv.getAttribute('data-lon')),parseFloat(currentDiv.getAttribute('data-lat'))];var coord=ol.proj.fromLonLat(lonlat,this.getMap().getView().getProjection());var zoom=parseFloat(currentDiv.getAttribute('data-zoom'));return{type:'scrollto',element:currentDiv,name:currentDiv.getAttribute('name'),coordinate:coord,lon:lonlat,zoom:zoom};}.bind(this);var currentDiv=this.element.querySelectorAll('.chapter')[0];setTimeout(function(){currentDiv.classList.add('ol-select');this.dispatchEvent(getEvent(currentDiv));}.bind(this));this.element.addEventListener('scroll',function(){var current,chapter=this.element.querySelectorAll('.chapter');var height=ol.ext.element.getStyle(this.element,'height');if(!this.element.scrollTop){current=chapter[0];}else{for(var i=0,s;s=chapter[i];i++){var p=s.offsetTop-this.element.scrollTop;if(p>height/3)break;current=s;}}
if(current&&current!==currentDiv){if(currentDiv)currentDiv.classList.remove('ol-select');currentDiv=current;currentDiv.classList.add('ol-select');var e=getEvent(currentDiv);var view=this.getMap().getView();view.cancelAnimations();switch(currentDiv.getAttribute('data-animation')){case'flyto':{var duration=2000;view.animate({center:e.coordinate,duration:duration});view.animate({zoom:Math.min(view.getZoom(),e.zoom)-1,duration:duration/2},{zoom:e.zoom,duration:duration/2});break;}
default:break;}
this.dispatchEvent(e);}}.bind(this));};ol.ext.inherits(ol.control.Storymap,ol.control.Control);ol.control.Storymap.prototype.setChapter=function(name){var chapter=this.element.querySelectorAll('.chapter');for(var i=0,s;s=chapter[i];i++){if(s.getAttribute('name')===name){this.element.scrollTop=s.offsetTop-30;}}};ol.control.Swipe=function(options){options=options||{};var button=document.createElement('button');var element=document.createElement('div');element.className=(options.className||"ol-swipe")+" ol-unselectable ol-control";element.appendChild(button);element.addEventListener("mousedown",this.move.bind(this));element.addEventListener("touchstart",this.move.bind(this));ol.control.Control.call(this,{element:element});this.precomposeRight_=this.precomposeRight.bind(this);this.precomposeLeft_=this.precomposeLeft.bind(this);this.postcompose_=this.postcompose.bind(this);this.layers=[];if(options.layers)this.addLayer(options.layers,false);if(options.rightLayers)this.addLayer(options.rightLayers,true);this.on('propertychange',function(){if(this.getMap())this.getMap().renderSync();if(this.get('orientation')==="horizontal"){this.element.style.top=this.get('position')*100+"%";this.element.style.left="";}else{if(this.get('orientation')!=="vertical")this.set('orientation',"vertical");this.element.style.left=this.get('position')*100+"%";this.element.style.top="";}
this.element.classList.remove("horizontal","vertical");this.element.classList.add(this.get('orientation'));}.bind(this));this.set('position',options.position||0.5);this.set('orientation',options.orientation||'vertical');};ol.ext.inherits(ol.control.Swipe,ol.control.Control);ol.control.Swipe.prototype.setMap=function(map){var i;var l;if(this.getMap()){for(i=0;i<this.layers.length;i++){l=this.layers[i];if(l.right)l.layer.un(['precompose','prerender'],this.precomposeRight_);else l.layer.un(['precompose','prerender'],this.precomposeLeft_);l.layer.un(['postcompose','postrender'],this.postcompose_);}
this.getMap().renderSync();}
ol.control.Control.prototype.setMap.call(this,map);if(map){this._listener=[];for(i=0;i<this.layers.length;i++){l=this.layers[i];if(l.right)l.layer.on(['precompose','prerender'],this.precomposeRight_);else l.layer.on(['precompose','prerender'],this.precomposeLeft_);l.layer.on(['postcompose','postrender'],this.postcompose_);}
map.renderSync();}};ol.control.Swipe.prototype.isLayer_=function(layer){for(var k=0;k<this.layers.length;k++){if(this.layers[k].layer===layer)return k;}
return-1;};ol.control.Swipe.prototype.addLayer=function(layers,right){if(!(layers instanceof Array))layers=[layers];for(var i=0;i<layers.length;i++){var l=layers[i];if(this.isLayer_(l)<0){this.layers.push({layer:l,right:right});if(this.getMap()){if(right)l.on(['precompose','prerender'],this.precomposeRight_);else l.on(['precompose','prerender'],this.precomposeLeft_);l.on(['postcompose','postrender'],this.postcompose_);this.getMap().renderSync();}}}};ol.control.Swipe.prototype.removeLayer=function(layers){if(!(layers instanceof Array))layers=[layers];for(var i=0;i<layers.length;i++){var k=this.isLayer_(layers[i]);if(k>=0&&this.getMap()){if(this.layers[k].right)layers[i].un(['precompose','prerender'],this.precomposeRight_);else layers[i].un(['precompose','prerender'],this.precomposeLeft_);layers[i].un(['postcompose','postrender'],this.postcompose_);this.layers.splice(k,1);this.getMap().renderSync();}}};ol.control.Swipe.prototype.move=function(e){var self=this;var l;switch(e.type){case'touchcancel':case'touchend':case'mouseup':{self.isMoving=false;["mouseup","mousemove","touchend","touchcancel","touchmove"].forEach(function(eventName){document.removeEventListener(eventName,self.move);});break;}
case'mousedown':case'touchstart':{self.isMoving=true;["mouseup","mousemove","touchend","touchcancel","touchmove"].forEach(function(eventName){document.addEventListener(eventName,self.move.bind(self));});}
case'mousemove':case'touchmove':{if(self.isMoving){if(self.get('orientation')==="vertical"){var pageX=e.pageX||(e.touches&&e.touches.length&&e.touches[0].pageX)||(e.changedTouches&&e.changedTouches.length&&e.changedTouches[0].pageX);if(!pageX)break;pageX-=self.getMap().getTargetElement().getBoundingClientRect().left+
window.pageXOffset-document.documentElement.clientLeft;l=self.getMap().getSize()[0];l=Math.min(Math.max(0,1-(l-pageX)/l),1);self.set('position',l);}else{var pageY=e.pageY||(e.touches&&e.touches.length&&e.touches[0].pageY)||(e.changedTouches&&e.changedTouches.length&&e.changedTouches[0].pageY);if(!pageY)break;pageY-=self.getMap().getTargetElement().getBoundingClientRect().top+
window.pageYOffset-document.documentElement.clientTop;l=self.getMap().getSize()[1];l=Math.min(Math.max(0,1-(l-pageY)/l),1);self.set('position',l);}}
break;}
default:break;}};ol.control.Swipe.prototype.precomposeLeft=function(e){var ctx=e.context;var canvas=ctx.canvas;ctx.save();ctx.beginPath();if(this.get('orientation')==="vertical")ctx.rect(0,0,canvas.width*this.get('position'),canvas.height);else ctx.rect(0,0,canvas.width,canvas.height*this.get('position'));ctx.clip();};ol.control.Swipe.prototype.precomposeRight=function(e){var ctx=e.context;var canvas=ctx.canvas;ctx.save();ctx.beginPath();if(this.get('orientation')==="vertical")ctx.rect(canvas.width*this.get('position'),0,canvas.width,canvas.height);else ctx.rect(0,canvas.height*this.get('position'),canvas.width,canvas.height);ctx.clip();};ol.control.Swipe.prototype.postcompose=function(e){e.context.restore();};ol.control.Target=function(options){options=options||{};this.style=options.style||[new ol.style.Style({image:new ol.style.RegularShape({points:4,radius:11,radius1:0,radius2:0,snapToPixel:true,stroke:new ol.style.Stroke({color:"#fff",width:3})})}),new ol.style.Style({image:new ol.style.RegularShape({points:4,radius:11,radius1:0,radius2:0,snapToPixel:true,stroke:new ol.style.Stroke({color:"#000",width:1})})})];if(!(this.style instanceof Array))this.style=[this.style];this.composite=options.composite||'';var div=document.createElement('div');div.className="ol-target ol-unselectable ol-control";ol.control.CanvasBase.call(this,{element:div,target:options.target});this.setVisible(options.visible!==false);};ol.ext.inherits(ol.control.Target,ol.control.CanvasBase);ol.control.Target.prototype.setVisible=function(b){this.set("visible",b);if(this.getMap())this.getMap().renderSync();};ol.control.Target.prototype.getVisible=function(){return this.get("visible");};ol.control.Target.prototype._draw=function(e){var ctx=this.getContext(e);if(!ctx||!this.getMap()||!this.getVisible())return;var ratio=e.frameState.pixelRatio;ctx.save();ctx.scale(ratio,ratio);var cx=ctx.canvas.width/(2*ratio);var cy=ctx.canvas.height/(2*ratio);var geom=new ol.geom.Point(this.getMap().getCoordinateFromPixel([cx,cy]));if(this.composite)ctx.globalCompositeOperation=this.composite;for(var i=0;i<this.style.length;i++){var style=this.style[i];if(style instanceof ol.style.Style){var vectorContext=e.vectorContext;if(!vectorContext){var event={inversePixelTransform:[ratio,0,0,ratio,0,0],context:ctx,frameState:{pixelRatio:ratio,extent:e.frameState.extent,coordinateToPixelTransform:e.frameState.coordinateToPixelTransform,viewState:e.frameState.viewState}}
vectorContext=ol.render.getVectorContext(event);}
vectorContext.setStyle(style);vectorContext.drawGeometry(geom);}}
ctx.restore();};ol.control.TextButton=function(options)
{options=options||{};options.className=(options.className||"")+" ol-text-button";ol.control.Button.call(this,options);};ol.ext.inherits(ol.control.TextButton,ol.control.Button);ol.control.Timeline=function(options){var element=ol.ext.element.create('DIV',{className:(options.className||'')+' ol-timeline'
+(options.target?'':' ol-unselectable ol-control')
+(options.zoomButton?' ol-hasbutton':'')
+('ontouchstart'in window?' ol-touch':'')});ol.control.Control.call(this,{element:element,target:options.target});this._scrollDiv=ol.ext.element.create('DIV',{className:'ol-scroll',parent:this.element});this._buttons=ol.ext.element.create('DIV',{className:'ol-buttons',parent:this.element});if(options.zoomButton){this.addButton({className:'ol-zoom-in',handleClick:function(){var zoom=this.get('zoom');if(zoom>=1){zoom++;}else{zoom=Math.min(1,zoom+0.1);}
zoom=Math.round(zoom*100)/100;this.refresh(zoom);}.bind(this)});this.addButton({className:'ol-zoom-out',handleClick:function(){var zoom=this.get('zoom');if(zoom>1){zoom--;}else{zoom-=0.1;}
zoom=Math.round(zoom*100)/100;this.refresh(zoom);}.bind(this)});}
this._intervalDiv=ol.ext.element.create('DIV',{className:'ol-center-date',parent:this.element});this.element.addEventListener('mouseover',function(){if(this._select)this._select.elt.classList.remove('ol-select');}.bind(this));var scrollListener=null;this._scrollDiv.addEventListener('scroll',function(){if(scrollListener){clearTimeout(scrollListener);scrollListener=null;}
scrollListener=setTimeout(function(){this.dispatchEvent({type:'scroll',date:this.getDate(),dateStart:this.getDate('start'),dateEnd:this.getDate('end')});}.bind(this),options.scrollTimeout||15);}.bind(this));this._scrollDiv.addEventListener('gesturechange',function(){});ol.ext.element.scrollDiv(this._scrollDiv,{onmove:function(b){this._moving=b;}.bind(this)});this._tline=[];this.set('maxWidth',options.maxWidth||2000);this.set('minDate',options.minDate||Infinity);this.set('maxDate',options.maxDate||-Infinity);this.set('graduation',options.graduation);this.set('minZoom',options.minZoom||.2);this.set('maxZoom',options.maxZoom||4);this.setInterval(options.interval);if(options.getHTML)this._getHTML=options.getHTML;if(options.getFeatureDate)this._getFeatureDate=options.getFeatureDate;if(options.endFeatureDate)this._endFeatureDate=options.endFeatureDate;this.setFeatures(options.features||options.source,options.zoom);};ol.ext.inherits(ol.control.Timeline,ol.control.Control);ol.control.Timeline.prototype.setMap=function(map){ol.control.Control.prototype.setMap.call(this,map);this.refresh(this.get('zoom')||1,true);};ol.control.Timeline.prototype.addButton=function(button){this.element.classList.add('ol-hasbutton');ol.ext.element.create('BUTTON',{className:button.className||undefined,title:button.title,html:button.html,click:button.handleClick,parent:this._buttons})};ol.control.Timeline.prototype.setInterval=function(length){if(typeof(length)==='string'){if(/s$/.test(length)){length=parseFloat(length)*1000;}else if(/mn$/.test(length)){length=parseFloat(length)*1000*60;}else if(/h$/.test(length)){length=parseFloat(length)*1000*3600;}else if(/d$/.test(length)){length=parseFloat(length)*1000*3600*24;}else if(/y$/.test(length)){length=parseFloat(length)*1000*3600*24*365;}else{length=0;}}
this.set('interval',length||0);if(length)this.element.classList.add('ol-interval');else this.element.classList.remove('ol-interval');this.refresh(this.get('zoom'));}
ol.control.Timeline.prototype._getHTML=function(feature){return feature.get('name')||'';};ol.control.Timeline.prototype._getFeatureDate=function(feature){return(feature&&feature.get)?feature.get('date'):null;};ol.control.Timeline.prototype._endFeatureDate=function(){return undefined;};ol.control.Timeline.prototype.isCollapsed=function(){return this.element.classList.contains('ol-collapsed');};ol.control.Timeline.prototype.collapse=function(b){if(b)this.element.classList.add('ol-collapsed');else this.element.classList.remove('ol-collapsed');this.dispatchEvent({type:'collapse',collapsed:this.isCollapsed()});};ol.control.Timeline.prototype.toggle=function(){this.element.classList.toggle('ol-collapsed');this.dispatchEvent({type:'collapse',collapsed:this.isCollapsed()});};ol.control.Timeline.prototype.setFeatures=function(features,zoom){this._features=this._source=null;if(features instanceof ol.source.Vector)this._source=features;else if(features instanceof Array)this._features=features;else this._features=[];this.refresh(zoom);};ol.control.Timeline.prototype.getFeatures=function(){return this._features||this._source.getFeatures();}
ol.control.Timeline.prototype.refresh=function(zoom,first){if(!this.getMap())return;if(!zoom)zoom=this.get('zoom');zoom=Math.min(this.get('maxZoom'),Math.max(this.get('minZoom'),zoom||1));this.set('zoom',zoom);this._scrollDiv.innerHTML='';var features=this.getFeatures();var d,d2;var tline=this._tline=[];features.forEach(function(f){if(d=this._getFeatureDate(f)){if(!(d instanceof Date)){d=new Date(d)}
if(this._endFeatureDate){d2=this._endFeatureDate(f);if(!(d2 instanceof Date)){d2=new Date(d2)}}
if(!isNaN(d)){tline.push({date:d,end:isNaN(d2)?null:d2,feature:f});}}}.bind(this));tline.sort(function(a,b){return(a.date<b.date?-1:(a.date===b.date?0:1))});var div=ol.ext.element.create('DIV',{parent:this._scrollDiv});var min=this._minDate=Math.min(this.get('minDate'),tline.length?tline[0].date:Infinity);var max=this._maxDate=Math.max(this.get('maxDate'),tline.length?tline[tline.length-1].date:-Infinity);if(!isFinite(min))this._minDate=min=new Date();if(!isFinite(max))this._maxDate=max=new Date();var delta=(max-min);var maxWidth=this.get('maxWidth');var scale=this._scale=(delta>maxWidth?maxWidth/delta:1)*zoom;min=this._minDate=this._minDate-10/scale;delta=(max-min)*scale;ol.ext.element.setStyle(div,{width:delta,maxWidth:'unset'});this._drawTime(div,min,max,scale);if(this.get('interval')){ol.ext.element.setStyle(this._intervalDiv,{width:this.get('interval')*scale});}else{ol.ext.element.setStyle(this._intervalDiv,{width:''});}
var line=[];var lineHeight=ol.ext.element.getStyle(this._scrollDiv,'lineHeight');var fdiv=ol.ext.element.create('DIV',{className:'ol-features',parent:div});tline.forEach(function(f){var d=f.date;var t=f.elt=ol.ext.element.create('DIV',{className:'ol-feature',style:{left:Math.round((d-min)*scale),},html:this._getHTML(f.feature),parent:fdiv});var img=t.querySelectorAll('img');for(var i=0;i<img.length;i++){img[i].ondragstart=function(){return false;};}
if(f.end){ol.ext.element.setStyle(t,{minWidth:(f.end-d)*scale,width:(f.end-d)*scale,maxWidth:'unset'});}
var left=ol.ext.element.getStyle(t,'left');t.addEventListener('click',function(){if(!this._moving){this.dispatchEvent({type:'select',feature:f.feature});}}.bind(this));var pos,l;for(pos=0;l=line[pos];pos++){if(left>l){break;}}
line[pos]=left+ol.ext.element.getStyle(t,'width');ol.ext.element.setStyle(t,{top:pos*lineHeight});}.bind(this));this._nbline=line.length;if(first)this.setDate(this._minDate,{anim:false,position:'start'});this.dispatchEvent({type:'scroll',date:this.getDate(),dateStart:this.getDate('start'),dateEnd:this.getDate('end')});};ol.control.Timeline.prototype._drawTime=function(div,min,max,scale){var tdiv=ol.ext.element.create('DIV',{className:'ol-times',parent:div});var d,dt,month,dmonth;var dx=ol.ext.element.getStyle(tdiv,'left');var heigth=ol.ext.element.getStyle(tdiv,'height');var year=(new Date(this._minDate)).getFullYear();dt=((new Date(0)).setFullYear(String(year))-new Date(0).setFullYear(String(year-1)))*scale;var dyear=Math.round(2*heigth/dt)+1;while(true){d=new Date(0).setFullYear(year);if(d>this._maxDate)break;ol.ext.element.create('DIV',{className:'ol-time ol-year',style:{left:Math.round((d-this._minDate)*scale)-dx},html:year,parent:tdiv});year+=dyear;}
if(/day|month/.test(this.get('graduation'))){dt=((new Date(0)).setFullYear(String(year))-new Date(0).setFullYear(String(year-1)))*scale;dmonth=Math.max(1,Math.round(12/Math.round(dt/heigth/2)));if(dmonth<12){year=(new Date(this._minDate)).getFullYear();month=dmonth+1;while(true){d=new Date('0/01/01');d.setFullYear(year);d.setMonth(month-1);if(d>this._maxDate)break;ol.ext.element.create('DIV',{className:'ol-time ol-month',style:{left:Math.round((d-this._minDate)*scale)-dx},html:d.toLocaleDateString(undefined,{month:'short'}),parent:tdiv});month+=dmonth;if(month>12){year++;month=dmonth+1;}}}}
if(this.get('graduation')==='day'){dt=(new Date('2000/02/01')-new Date('2000/01/01'))*scale;var dday=Math.max(1,Math.round(31/Math.round(dt/heigth/2)));if(dday<31){year=(new Date(this._minDate)).getFullYear();month=0;var day=dday;while(true){d=new Date(0);d.setFullYear(year);d.setMonth(month);d.setDate(day);if(isNaN(d)){month++;if(month>12){month=1;year++;}
day=dday;}else{if(d>this._maxDate)break;ol.ext.element.create('DIV',{className:'ol-time ol-day',style:{left:Math.round((d-this._minDate)*scale)-dx},html:day,parent:tdiv});year=d.getFullYear();month=d.getMonth();day=d.getDate()+dday;if(day+dday/2>31){month++;day=dday;}}}}}};ol.control.Timeline.prototype.setDate=function(feature,options){var date;options=options||{};if(feature instanceof Date){date=feature;}else{if(this.getFeatures().indexOf(feature)>=0){date=this._getFeatureDate(feature);}
if(date&&!(date instanceof Date)){date=new Date(date);}
if(!date||isNaN(date)){date=new Date(String(feature));}}
if(!isNaN(date)){if(options.anim===false)this._scrollDiv.classList.add('ol-move');var scrollLeft=(date-this._minDate)*this._scale;if(options.position==='start'){scrollLeft+=ol.ext.element.outerWidth(this._scrollDiv)/2-ol.ext.element.getStyle(this._scrollDiv,'marginLeft')/2;}else if(options.position==='end'){scrollLeft-=ol.ext.element.outerWidth(this._scrollDiv)/2-ol.ext.element.getStyle(this._scrollDiv,'marginLeft')/2;}
this._scrollDiv.scrollLeft=scrollLeft;if(options.anim===false)this._scrollDiv.classList.remove('ol-move');if(feature){for(var i=0,f;f=this._tline[i];i++){if(f.feature===feature){f.elt.classList.add('ol-select');this._select=f;}else{f.elt.classList.remove('ol-select');}}}}};ol.control.Timeline.prototype.getDate=function(position){var pos;switch(position){case'start':{if(this.get('interval')){pos=-ol.ext.element.getStyle(this._intervalDiv,'width')/2+ol.ext.element.getStyle(this._scrollDiv,'marginLeft')/2;}else{pos=-ol.ext.element.outerWidth(this._scrollDiv)/2+ol.ext.element.getStyle(this._scrollDiv,'marginLeft')/2;}
break;}
case'end':{if(this.get('interval')){pos=ol.ext.element.getStyle(this._intervalDiv,'width')/2-ol.ext.element.getStyle(this._scrollDiv,'marginLeft')/2;}else{pos=ol.ext.element.outerWidth(this._scrollDiv)/2-ol.ext.element.getStyle(this._scrollDiv,'marginLeft')/2;}
break;}
default:{pos=0;break;}}
var d=(this._scrollDiv.scrollLeft+pos)/this._scale+this._minDate;return new Date(d);};ol.control.Timeline.prototype.getStartDate=function(){return new Date(this.get('minDate'));}
ol.control.Timeline.prototype.getEndDate=function(){return new Date(this.get('maxDate'));}
ol.control.Toggle=function(options){options=options||{};var self=this;this.interaction_=options.interaction;if(this.interaction_){this.interaction_.setActive(options.active);this.interaction_.on("change:active",function(){self.setActive(self.interaction_.getActive());});}
if(options.toggleFn)options.onToggle=options.toggleFn;options.handleClick=function(){self.toggle();if(options.onToggle)options.onToggle.call(self,self.getActive());};options.className=(options.className||"")+" ol-toggle";ol.control.Button.call(this,options);this.set("title",options.title);this.set("autoActivate",options.autoActivate);if(options.bar){this.subbar_=options.bar;this.subbar_.setTarget(this.element);this.subbar_.element.classList.add("ol-option-bar");}
this.setActive(options.active);this.setDisable(options.disable);};ol.ext.inherits(ol.control.Toggle,ol.control.Button);ol.control.Toggle.prototype.setMap=function(map){if(!map&&this.getMap()){if(this.interaction_){this.getMap().removeInteraction(this.interaction_);}
if(this.subbar_)this.getMap().removeControl(this.subbar_);}
ol.control.Control.prototype.setMap.call(this,map);if(map){if(this.interaction_)map.addInteraction(this.interaction_);if(this.subbar_)map.addControl(this.subbar_);}};ol.control.Toggle.prototype.getSubBar=function(){return this.subbar_;};ol.control.Toggle.prototype.getDisable=function(){var button=this.element.querySelector("button");return button&&button.disabled;};ol.control.Toggle.prototype.setDisable=function(b){if(this.getDisable()==b)return;this.element.querySelector("button").disabled=b;if(b&&this.getActive())this.setActive(false);this.dispatchEvent({type:'change:disable',key:'disable',oldValue:!b,disable:b});};ol.control.Toggle.prototype.getActive=function(){return this.element.classList.contains("ol-active");};ol.control.Toggle.prototype.toggle=function(){if(this.getActive())this.setActive(false);else this.setActive(true);};ol.control.Toggle.prototype.setActive=function(b){if(this.interaction_)this.interaction_.setActive(b);if(this.subbar_)this.subbar_.setActive(b);if(this.getActive()===b)return;if(b)this.element.classList.add("ol-active");else this.element.classList.remove("ol-active");this.dispatchEvent({type:'change:active',key:'active',oldValue:!b,active:b});};ol.control.Toggle.prototype.setInteraction=function(i){this.interaction_=i;};ol.control.Toggle.prototype.getInteraction=function(){return this.interaction_;};ol.featureAnimation=function(options){options=options||{};this.duration_=typeof(options.duration)=='number'?(options.duration>=0?options.duration:0):1000;this.fade_=typeof(options.fade)=='function'?options.fade:null;this.repeat_=Number(options.repeat);var easing=typeof(options.easing)=='function'?options.easing:ol.easing.linear;if(options.revers)this.easing_=function(t){return(1-easing(t));};else this.easing_=easing;this.hiddenStyle=options.hiddenStyle;ol.Object.call(this);};ol.ext.inherits(ol.featureAnimation,ol.Object);ol.featureAnimation.prototype.drawGeom_=function(e,geom,shadow){if(this.fade_){e.context.globalAlpha=this.fade_(1-e.elapsed);}
var style=e.style;for(var i=0;i<style.length;i++){try{var vectorContext=e.vectorContext||ol.render.getVectorContext(e);vectorContext.setStyle(style[i]);if(style[i].getZIndex()<0)vectorContext.drawGeometry(shadow||geom);else vectorContext.drawGeometry(geom);}catch(e){}}};ol.featureAnimation.prototype.animate=function(){return false;};ol.Map.prototype.animateFeature=function(feature,fanim){function animLayer(layers){for(var l,i=layers.length-1;l=layers[i];i--){if(l.getVisible()){if(l.getLayers){if(animLayer(l.getLayers().getArray()))return true;}else{l.animateFeature(feature,fanim);return true;}}}
return false;}
animLayer(this.getLayers().getArray());};ol.layer.Base.prototype.animateFeature=function(feature,fanim,useFilter){var self=this;var listenerKey;var style=feature.getStyle();var flashStyle=style||(this.getStyleFunction?this.getStyleFunction()(feature):null);if(!flashStyle)flashStyle=[];if(!(flashStyle instanceof Array))flashStyle=[flashStyle];var event={vectorContext:null,frameState:null,start:0,time:0,elapsed:0,extent:false,feature:feature,geom:feature.getGeometry(),typeGeom:feature.getGeometry().getType(),bbox:feature.getGeometry().getExtent(),coord:ol.extent.getCenter(feature.getGeometry().getExtent()),style:flashStyle};if(!(fanim instanceof Array))fanim=[fanim];for(var i=fanim.length-1;i>=0;i--){if(fanim[i].duration_===0)fanim.splice(i,1);}
var nb=0,step=0;var filters=(useFilter&&this.getFilters)?this.getFilters():[];function animate(e){event.type=e.type;try{event.vectorContext=e.vectorContext||ol.render.getVectorContext(e);}catch(e){}
event.frameState=e.frameState;if(!event.extent){event.extent=e.frameState.extent;event.start=e.frameState.time;event.context=e.context;}
event.time=e.frameState.time-event.start;event.elapsed=event.time/fanim[step].duration_;if(event.elapsed>1)event.elapsed=1;e.context.save();filters.forEach(function(f){if(f.get('active'))f.precompose(e);});if(this.getOpacity){e.context.globalAlpha=this.getOpacity();}
if(!fanim[step].animate(event)){nb++;if(nb<fanim[step].repeat_){event.extent=false;}else if(step<fanim.length-1){fanim[step].dispatchEvent({type:'animationend',feature:feature});step++;nb=0;event.extent=false;}else{stop();}}
filters.forEach(function(f){if(f.get('active'))f.postcompose(e);});e.context.restore();e.frameState.animate=true;}
function stop(options){ol.Observable.unByKey(listenerKey);listenerKey=null;feature.setStyle(style);var event={type:'animationend',feature:feature};if(options){for(var i in options)if(options.hasOwnProperty(i)){event[i]=options[i];}}
fanim[step].dispatchEvent(event);self.dispatchEvent(event);}
function start(options){if(fanim.length&&!listenerKey){listenerKey=self.on(['postcompose','postrender'],animate.bind(self));if(self.renderSync)self.renderSync();else self.changed();feature.setStyle(fanim[step].hiddenStyle||new ol.style.Style({image:new ol.style.Circle({})}));var event={type:'animationstart',feature:feature};if(options){for(var i in options)if(options.hasOwnProperty(i)){event[i]=options[i];}}
fanim[step].dispatchEvent(event);self.dispatchEvent(event);}}
start();return{start:start,stop:stop,isPlaying:function(){return(!!listenerKey);}};};ol.featureAnimation.Bounce=function(options)
{options=options||{};ol.featureAnimation.call(this,options);this.amplitude_=options.amplitude||40;this.bounce_=-Math.PI*(options.bounce||3);}
ol.ext.inherits(ol.featureAnimation.Bounce,ol.featureAnimation);ol.featureAnimation.Bounce.prototype.animate=function(e)
{var flashGeom=e.geom.clone();var t=Math.abs(Math.sin(this.bounce_*e.elapsed))*this.amplitude_*(1-this.easing_(e.elapsed))*e.frameState.viewState.resolution;flashGeom.translate(0,t);this.drawGeom_(e,flashGeom,e.geom);return(e.time<=this.duration_);}
ol.featureAnimation.Drop=function(options)
{options=options||{};this.speed_=options.speed||0;ol.featureAnimation.call(this,options);this.side_=options.side||'top';}
ol.ext.inherits(ol.featureAnimation.Drop,ol.featureAnimation);ol.featureAnimation.Drop.prototype.animate=function(e)
{if(!e.time)
{var angle=e.frameState.viewState.rotation;var s=e.frameState.size[1]*e.frameState.viewState.resolution;if(this.side_!='top')s*=-1;this.dx=-Math.sin(angle)*s;this.dy=Math.cos(angle)*s;if(this.speed_)
{this.duration_=s/this.speed_/e.frameState.viewState.resolution;}}
var flashGeom=e.geom.clone();flashGeom.translate(this.dx*(1-this.easing_(e.elapsed)),this.dy*(1-this.easing_(e.elapsed)));this.drawGeom_(e,flashGeom,e.geom);return(e.time<=this.duration_);}
ol.featureAnimation.Fade=function(options)
{options=options||{};this.speed_=options.speed||0;ol.featureAnimation.call(this,options);}
ol.ext.inherits(ol.featureAnimation.Fade,ol.featureAnimation);ol.featureAnimation.Fade.prototype.animate=function(e)
{e.context.globalAlpha=this.easing_(e.elapsed);this.drawGeom_(e,e.geom);return(e.time<=this.duration_);}
ol.featureAnimation.None=function(options)
{ol.featureAnimation.call(this,options);};ol.ext.inherits(ol.featureAnimation.None,ol.featureAnimation);ol.featureAnimation.None.prototype.animate=function(e)
{return(e.time<=this.duration_);};ol.featureAnimation.Null=function(){ol.featureAnimation.call(this,{duration:0});};ol.ext.inherits(ol.featureAnimation.Null,ol.featureAnimation);ol.featureAnimation.Path=function(options)
{options=options||{};ol.featureAnimation.call(this,options);this.speed_=options.speed||0;this.path_=options.path;switch(options.rotate){case true:case 0:this.rotate_=0;break;default:this.rotate_=options.rotate||false;break;}
if(this.path_&&this.path_.getGeometry)this.path_=this.path_.getGeometry();if(this.path_&&this.path_.getLineString)this.path_=this.path_.getLineString();if(this.path_.getLength)
{this.dist_=this.path_.getLength()
if(this.path_&&this.path_.getCoordinates)this.path_=this.path_.getCoordinates();}
else this.dist_=0;if(this.speed_>0)this.duration_=this.dist_/this.speed_;}
ol.ext.inherits(ol.featureAnimation.Path,ol.featureAnimation);ol.featureAnimation.Path.prototype.animate=function(e)
{if(!e.time)
{if(!this.dist_)return false;}
var dmax=this.dist_*this.easing_(e.elapsed);var p0,p,s,dx,dy,dl,d=0;p=this.path_[0];for(var i=1;i<this.path_.length;i++)
{p0=p;p=this.path_[i];dx=p[0]-p0[0];dy=p[1]-p0[1];dl=Math.sqrt(dx*dx+dy*dy);if(dl&&d+dl>=dmax)
{s=(dmax-d)/dl;p=[p0[0]+(p[0]-p0[0])*s,p0[1]+(p[1]-p0[1])*s];break;}
d+=dl;}
if(this.rotate_!==false){var angle=this.rotate_-Math.atan2(p0[1]-p[1],p0[0]-p[0]);for(var k=0;s=e.style[k];k++){if(s.getImage()){s.getImage().setRotation(angle)}}}
e.geom.setCoordinates(p);this.drawGeom_(e,e.geom);return(e.time<=this.duration_);}
ol.featureAnimation.Shake=function(options)
{options=options||{};ol.featureAnimation.call(this,options);this.amplitude_=options.amplitude||40;this.bounce_=-Math.PI*(options.bounce||6);this.horizontal_=options.horizontal;}
ol.ext.inherits(ol.featureAnimation.Shake,ol.featureAnimation);ol.featureAnimation.Shake.prototype.animate=function(e)
{var flashGeom=e.geom.clone();var shadow=e.geom.clone();var t=this.easing_(e.elapsed)
t=Math.sin(this.bounce_*t)*this.amplitude_*(1-t)*e.frameState.viewState.resolution;if(this.horizontal_)
{flashGeom.translate(t,0);shadow.translate(t,0);}
else flashGeom.translate(0,t);this.drawGeom_(e,flashGeom,shadow);return(e.time<=this.duration_);}
ol.featureAnimation.Show=function(options)
{ol.featureAnimation.call(this,options);}
ol.ext.inherits(ol.featureAnimation.Show,ol.featureAnimation);ol.featureAnimation.Show.prototype.animate=function(e)
{this.drawGeom_(e,e.geom);return(e.time<=this.duration_);}
ol.featureAnimation.Slide=function(options)
{options=options||{};this.speed_=options.speed||0;ol.featureAnimation.call(this,options);this.side_=options.side||'left';}
ol.ext.inherits(ol.featureAnimation.Slide,ol.featureAnimation);ol.featureAnimation.Slide.prototype.animate=function(e)
{if(!e.time)
{if(this.side_=='left')this.dx=(e.extent[0]-e.bbox[2])
else this.dx=(e.extent[2]-e.bbox[0])
if(this.speed_)this.duration_=Math.abs(this.dx)/this.speed_/e.frameState.viewState.resolution;}
var flashGeom=e.geom.clone();flashGeom.translate(this.dx*(1-this.easing_(e.elapsed)),0);this.drawGeom_(e,flashGeom);return(e.time<=this.duration_);}
ol.featureAnimation.Teleport=function(options)
{ol.featureAnimation.call(this,options);}
ol.ext.inherits(ol.featureAnimation.Teleport,ol.featureAnimation);ol.featureAnimation.Teleport.prototype.animate=function(e)
{var sc=this.easing_(e.elapsed);if(sc)
{e.context.save()
var ratio=e.frameState.pixelRatio;e.context.globalAlpha=sc;e.context.scale(sc,1/sc);var m=e.frameState.coordinateToPixelTransform;var dx=(1/sc-1)*ratio*(m[0]*e.coord[0]+m[1]*e.coord[1]+m[4]);var dy=(sc-1)*ratio*(m[2]*e.coord[0]+m[3]*e.coord[1]+m[5]);e.context.translate(dx,dy);this.drawGeom_(e,e.geom);e.context.restore()}
return(e.time<=this.duration_);}
ol.featureAnimation.Throw=function(options)
{options=options||{};ol.featureAnimation.call(this,options);this.speed_=options.speed||0;this.side_=options.side||'left';}
ol.ext.inherits(ol.featureAnimation.Throw,ol.featureAnimation);ol.featureAnimation.Throw.prototype.animate=function(e)
{if(!e.time&&this.speed_)
{var dx,dy;if(this.side_=='left')
{dx=this.dx=e.extent[0]-e.bbox[2];dy=this.dy=e.extent[3]-e.bbox[1];}
else
{dx=this.dx=e.extent[2]-e.bbox[0];dy=this.dy=e.extent[3]-e.bbox[1];}
this.duration_=Math.sqrt(dx*dx+dy*dy)/this.speed_/e.frameState.viewState.resolution;}
var flashGeom=e.geom.clone();var shadow=e.geom.clone();flashGeom.translate(this.dx*(1-this.easing_(e.elapsed)),this.dy*Math.cos(Math.PI/2*this.easing_(e.elapsed)));shadow.translate(this.dx*(1-this.easing_(e.elapsed)),0);this.drawGeom_(e,flashGeom,shadow);return(e.time<=this.duration_);}
ol.featureAnimation.Zoom=function(options){options=options||{};ol.featureAnimation.call(this,options);this.set('zoomout',options.zoomOut);}
ol.ext.inherits(ol.featureAnimation.Zoom,ol.featureAnimation);ol.featureAnimation.ZoomOut=function(options){options=options||{};options.zoomOut=true;ol.featureAnimation.Zoom.call(this,options);}
ol.ext.inherits(ol.featureAnimation.ZoomOut,ol.featureAnimation.Zoom);ol.featureAnimation.Zoom.prototype.animate=function(e){var fac=this.easing_(e.elapsed);if(fac){if(this.get('zoomout'))fac=1/fac;var style=e.style;var i,imgs,sc=[]
for(i=0;i<style.length;i++){imgs=style[i].getImage();if(imgs){sc[i]=imgs.getScale();if(e.type==='postrender')imgs.setScale(sc[i]*fac/e.frameState.pixelRatio);else imgs.setScale(sc[i]*fac);}}
this.drawGeom_(e,e.geom);for(i=0;i<style.length;i++){imgs=style[i].getImage();if(imgs)imgs.setScale(sc[i]);}}
return(e.time<=this.duration_);}
ol.filter={};ol.filter.Base=function(options){ol.Object.call(this);this._listener=[];if(options&&options.active===false)this.set('active',false);else this.set('active',true);};ol.ext.inherits(ol.filter.Base,ol.Object);ol.filter.Base.prototype.setActive=function(b){this.set('active',b===true);};ol.filter.Base.prototype.getActive=function(){return this.get('active');};(function(){function precompose_(e){if(this.get('active')&&e.context)this.precompose(e);}
function postcompose_(e){if(this.get('active')&&e.context)this.postcompose(e);}
function filterRedraw_(){if(this.renderSync)this.renderSync();else this.changed();}
function addFilter_(filter){if(!this.filters_)this.filters_=[];this.filters_.push(filter);if(filter.precompose)filter._listener.push({listener:this.on(['precompose','prerender'],precompose_.bind(filter)),target:this});if(filter.postcompose)filter._listener.push({listener:this.on(['postcompose','postrender'],postcompose_.bind(filter)),target:this});filter._listener.push({listener:filter.on('propertychange',filterRedraw_.bind(this)),target:this});filterRedraw_.call(this);}
function removeFilter_(filter){var i
if(!this.filters_)this.filters_=[];for(i=this.filters_.length-1;i>=0;i--){if(this.filters_[i]===filter)this.filters_.splice(i,1);}
for(i=filter._listener.length-1;i>=0;i--){if(filter._listener[i].target===this){ol.Observable.unByKey(filter._listener[i].listener);filter._listener.splice(i,1);}}
filterRedraw_.call(this);}
ol.Map.prototype.addFilter=function(filter){console.warn('[OL-EXT] addFilter deprecated on map.')
addFilter_.call(this,filter);};ol.Map.prototype.removeFilter=function(filter){removeFilter_.call(this,filter);};ol.Map.prototype.getFilters=function(){return this.filters_||[];};ol.layer.Base.prototype.addFilter=function(filter){addFilter_.call(this,filter);};ol.layer.Base.prototype.removeFilter=function(filter){removeFilter_.call(this,filter);};ol.layer.Base.prototype.getFilters=function(){return this.filters_||[];};})();ol.filter.Mask=function(options){options=options||{};ol.filter.Base.call(this,options);if(options.feature){switch(options.feature.getGeometry().getType()){case'Polygon':case'MultiPolygon':this.feature_=options.feature;break;default:break;}}
this.set('inner',options.inner);this.fillColor_=options.fill?ol.color.asString(options.fill.getColor())||"rgba(0,0,0,0.2)":"rgba(0,0,0,0.2)";}
ol.ext.inherits(ol.filter.Mask,ol.filter.Base);ol.filter.Mask.prototype.drawFeaturePath_=function(e,out){var ctx=e.context;var canvas=ctx.canvas;var ratio=e.frameState.pixelRatio;console.log(ratio)
if(/render$/.test(e.type))ratio=1;var m=e.frameState.coordinateToPixelTransform;var tr=function(pt){return[(pt[0]*m[0]+pt[1]*m[1]+m[4])*ratio,(pt[0]*m[2]+pt[1]*m[3]+m[5])*ratio];}
if(!m){m=e.frameState.coordinateToPixelMatrix;tr=function(pt){return[(pt[0]*m[0]+pt[1]*m[1]+m[12])*ratio,(pt[0]*m[4]+pt[1]*m[5]+m[13])*ratio];}}
var ll=this.feature_.getGeometry().getCoordinates();if(this.feature_.getGeometry().getType()=="Polygon")ll=[ll];ctx.beginPath();if(out){ctx.moveTo(0,0);ctx.lineTo(canvas.width,0);ctx.lineTo(canvas.width,canvas.height);ctx.lineTo(0,canvas.height);ctx.lineTo(0,0);}
for(var l=0;l<ll.length;l++){var c=ll[l];for(var i=0;i<c.length;i++){var pt=tr(c[i][0]);ctx.moveTo(pt[0],pt[1]);for(var j=1;j<c[i].length;j++){pt=tr(c[i][j]);ctx.lineTo(pt[0],pt[1]);}}}}
ol.filter.Mask.prototype.postcompose=function(e){if(!this.feature_)return;var ctx=e.context;ctx.save();this.drawFeaturePath_(e,!this.get("inner"));ctx.fillStyle=this.fillColor_;ctx.fill("evenodd");ctx.restore();}
ol.filter.Clip=function(options)
{options=options||{};ol.filter.Base.call(this,options);this.set("coords",options.coords);this.set("units",options.units);this.set("keepAspectRatio",options.keepAspectRatio);this.set("extent",options.extent||[0,0,1,1]);this.set("color",options.color);if(!options.extent&&options.units!="%"&&options.coords)
{var xmin=Infinity;var ymin=Infinity;var xmax=-Infinity;var ymax=-Infinity;for(var i=0,p;p=options.coords[i];i++)
{if(xmin>p[0])xmin=p[0];if(xmax<p[0])xmax=p[0];if(ymin>p[1])ymin=p[1];if(ymax<p[1])ymax=p[1];}
options.extent=[xmin,ymin,xmax,ymax];}}
ol.ext.inherits(ol.filter.Clip,ol.filter.Base);ol.filter.Clip.prototype.clipPath_=function(e)
{var ctx=e.context;var canvas=ctx.canvas;var coords=this.get("coords");if(!coords)return;var ex=this.get('extent');var scx=1,scy=1;if(this.get("units")=="%")
{scx=canvas.width/(ex[2]-ex[0]);scy=canvas.height/(ex[3]-ex[1]);}
if(this.get("keepAspectRatio"))
{scx=scy=Math.min(scx,scy);}
var pos=this.get('position');var dx=0,dy=0;if(/left/.test(pos))
{dx=-ex[0]*scx;}
else if(/center/.test(pos))
{dx=canvas.width/2-(ex[2]-ex[0])*scx/2;}
else if(/right/.test(pos))
{dx=canvas.width-(ex[2]-ex[0])*scx;}
var fx=function(x){return x*scx+dx};if(/top/.test(pos))
{dy=-ex[1]*scy;}
else if(/middle/.test(pos))
{dy=canvas.height/2-(ex[3]-ex[1])*scy/2;}
else if(/bottom/.test(pos))
{dy=canvas.height-(ex[3]-ex[1])*scy;}
var fy=function(y){return y*scy+dy;};ctx.moveTo(fx(coords[0][0]),fy(coords[0][1]));for(var i=1,p;p=coords[i];i++)
{ctx.lineTo(fx(p[0]),fy(p[1]));}
ctx.lineTo(fx(coords[0][0]),fy(coords[0][1]));};ol.filter.Clip.prototype.precompose=function(e)
{if(!this.get("color"))
{e.context.save();e.context.beginPath();this.clipPath_(e);e.context.clip();}}
ol.filter.Clip.prototype.postcompose=function(e)
{if(this.get("color"))
{var ctx=e.context;var canvas=e.context.canvas;ctx.save();ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,canvas.height);ctx.lineTo(canvas.width,canvas.height);ctx.lineTo(canvas.width,canvas.height);ctx.lineTo(canvas.width,0);ctx.lineTo(0,0);this.clipPath_(e);ctx.fillStyle=this.get("color");ctx.fill("evenodd");}
e.context.restore();}
ol.filter.Colorize=function(options)
{ol.filter.Base.call(this,options);this.setFilter(options);}
ol.ext.inherits(ol.filter.Colorize,ol.filter.Base);ol.filter.Colorize.prototype.setFilter=function(options)
{options=options||{};switch(options)
{case"grayscale":options={operation:'hue',red:0,green:0,blue:0,value:1};break;case"invert":options={operation:'difference',red:255,green:255,blue:255,value:1};break;case"sepia":options={operation:'color',red:153,green:102,blue:51,value:0.6};break;default:break;}
var color=options.color?ol.color.asArray(options.color):[options.red,options.green,options.blue,options.value];this.set('color',ol.color.asString(color))
this.set('value',color[3]||1);var v;switch(options.operation)
{case'color':case'hue':case'difference':case'color-dodge':case'enhance':this.set('operation',options.operation);break;case'saturation':v=255*(options.value||0);this.set('color',ol.color.asString([0,0,v,v||1]));this.set('operation',options.operation);break;case'luminosity':v=255*(options.value||0);this.set('color',ol.color.asString([v,v,v,255]));this.set('operation','hard-light');break;case'contrast':v=255*(options.value||0);this.set('color',ol.color.asString([v,v,v,255]));this.set('operation','soft-light');break;default:this.set('operation','color');break;}}
ol.filter.Colorize.prototype.setValue=function(v)
{this.set('value',v);var c=ol.color.asArray(this.get("color"));c[3]=v;this.set("color",ol.color.asString(c));}
ol.filter.Colorize.prototype.setColor=function(c)
{c=ol.color.asArray(c);if(c)
{c[3]=this.get("value");this.set("color",ol.color.asString(c));}}
ol.filter.Colorize.prototype.precompose=function(){}
ol.filter.Colorize.prototype.postcompose=function(e){var ctx=e.context;var canvas=ctx.canvas;ctx.save();if(this.get('operation')=='enhance')
{var v=this.get('value');if(v)
{var w=canvas.width;var h=canvas.height;ctx.globalCompositeOperation='color-burn'
ctx.globalAlpha=v;ctx.drawImage(canvas,0,0,w,h);ctx.drawImage(canvas,0,0,w,h);ctx.drawImage(canvas,0,0,w,h);}}
else
{ctx.globalCompositeOperation=this.get('operation');ctx.fillStyle=this.get('color');ctx.fillRect(0,0,canvas.width,canvas.height);}
ctx.restore();}
ol.filter.Composite=function(options)
{ol.filter.Base.call(this,options);this.set("operation",options.operation||"source-over");}
ol.ext.inherits(ol.filter.Composite,ol.filter.Base);ol.filter.Composite.prototype.setOperation=function(operation)
{this.set('operation',operation||"source-over");}
ol.filter.Composite.prototype.precompose=function(e)
{var ctx=e.context;ctx.save();ctx.globalCompositeOperation=this.get('operation');}
ol.filter.Composite.prototype.postcompose=function(e)
{e.context.restore();}
ol.filter.Crop=function(options){options=options||{};ol.filter.Mask.call(this,options);}
ol.ext.inherits(ol.filter.Crop,ol.filter.Mask);ol.filter.Crop.prototype.precompose=function(e){if(this.feature_){var ctx=e.context;ctx.save();this.drawFeaturePath_(e,this.get("inner"));ctx.clip("evenodd");}}
ol.filter.Crop.prototype.postcompose=function(e){if(this.feature_)e.context.restore();}
ol.filter.Fold=function(options){options=options||{};ol.filter.Base.call(this,options);this.set('fold',options.fold||[8,4]);this.set('margin',options.margin||8);this.set('padding',options.padding||8);if(typeof options.fsize=='number')options.fsize=[options.fsize,options.fsize];this.set('fsize',options.fsize||[8,10]);this.set('fill',options.fill);this.set('shadow',options.shadow!==false);};ol.ext.inherits(ol.filter.Fold,ol.filter.Base);ol.filter.Fold.prototype.drawLine_=function(ctx,d,m){var canvas=ctx.canvas;var fold=this.get("fold");var w=canvas.width;var h=canvas.height;var x,y,i;ctx.beginPath();ctx.moveTo(m,m);for(i=1;i<=fold[0];i++){x=i*w/fold[0]-(i==fold[0]?m:0);y=d[1]*(i%2)+m;ctx.lineTo(x,y);}
for(i=1;i<=fold[1];i++){x=w-d[0]*(i%2)-m;y=i*h/fold[1]-(i==fold[1]?d[0]*(fold[0]%2)+m:0);ctx.lineTo(x,y);}
for(i=fold[0];i>0;i--){x=i*w/fold[0]-(i==fold[0]?d[0]*(fold[1]%2)+m:0);y=h-d[1]*(i%2)-m;ctx.lineTo(x,y);}
for(i=fold[1];i>0;i--){x=d[0]*(i%2)+m;y=i*h/fold[1]-(i==fold[1]?m:0);ctx.lineTo(x,y);}
ctx.closePath();};ol.filter.Fold.prototype.precompose=function(e){var ctx=e.context;ctx.save();ctx.shadowColor="rgba(0,0,0,0.3)";ctx.shadowBlur=8;ctx.shadowOffsetX=2;ctx.shadowOffsetY=3;this.drawLine_(ctx,this.get("fsize"),this.get("margin"));ctx.fillStyle="#fff";if(this.get('fill'))ctx.fill();ctx.strokeStyle="rgba(0,0,0,0.1)";ctx.stroke();ctx.restore();ctx.save();this.drawLine_(ctx,this.get("fsize"),this.get("margin")+this.get("padding"));ctx.clip();};ol.filter.Fold.prototype.postcompose=function(e){var ctx=e.context;var canvas=ctx.canvas;ctx.restore();ctx.save();this.drawLine_(ctx,this.get("fsize"),this.get("margin"));ctx.clip();if(this.get('shadow')){var fold=this.get("fold");var w=canvas.width/fold[0];var h=canvas.height/fold[1];var grd=ctx.createRadialGradient(5*w/8,5*w/8,w/4,w/2,w/2,w);grd.addColorStop(0,"transparent");grd.addColorStop(1,"rgba(0,0,0,0.2)");ctx.fillStyle=grd;ctx.scale(1,h/w);for(var i=0;i<fold[0];i++)for(var j=0;j<fold[1];j++){ctx.save()
ctx.translate(i*w,j*w);ctx.fillRect(0,0,w,w);ctx.restore()}}
ctx.restore();};ol.filter.Lego=function(options){if(!options)options={};ol.filter.Base.call(this,options);var img=new Image();img.src=this.img[options.img]||this.img.ol3;img.crossOrigin=options.crossOrigin||null;this.pattern={canvas:document.createElement('canvas')};this.setBrick(options.brickSize,img);this.internal_=document.createElement('canvas');}
ol.ext.inherits(ol.filter.Lego,ol.filter.Base);ol.filter.Lego.prototype.img={brick:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAQAAAAAYLlVAAAAAnNCSVQICFXsRgQAAAAJcEhZcwAAD10AAA9dAah0GUAAAAAZdEVYdFNvZnR3YXJlAHd3dy5pbmtzY2FwZS5vcmeb7jwaAAAGAElEQVRo3sWZy4tkVx3HP+fcc29Vd1dP17TdTcbJPDKPMGR0kVEZkuBCF0EE9Z8QXLhxMUsRF4oLwYWQTSCgSxUXroQhoiEuskgEUUQh+BhHOpkZO11dr3vvefxc3FPlNHNvPbrD1Dl016XoqvM539/znFbcZo3VjbFmxcMA3Mg2fSoAiQJDov7/B1o9+aEgkycv4PBSPU9eHeDEixNwOAFXPYvFia0+rcnQEeBr218cfLIwCqW1UWillEYphUKpCmCCIQAiCEhAJIggTiSISBAfggTvJZTifQghWO+89cOQexuOXN8Pwz/9ff9X/xF0uEA7AmTsjLp/2xZQCgXHlj0OEBEAeRwGkep3qN6pfibDB3DBixMnvdCXt8J3FZowNYFSjgv71RtPaehjD0alalVOqCtHU3qlAGrVAGbidCtUYLUAiV6dCUx8XV4BhUKjY0AJgUB4LE8sA7CkCRSalFYnE72WiBrLSCKCp6TALZNRDEDCwgAKQ/vyRidN9c32K1sbqlCP/C+P9kXJI597PA7HkGJRCLNUGCY767udF9e+9dz1S5ueoRzIEZa1OxcK9td+/fAHvYH0LY6MkgHFIuYwS0ifXe1+qXvn1vk99QfzCwokToUylPrre1/de/vMnf9+5MsSg2HMELegAsl86duvnP3e8y/f1r83v8Li1RO7k/9c2t/avHnt27xpyhRDguEIuxDA3OXXX93+8a0rz6ZvcKgadqUEL73wx+9sb5//WWKTGCOHsxEWM0H71e2ffmF3lPyEkZppVyVYefCw/9a5f3epSvsWh7MMsUgeaL20/dpLu4fJXZUvFCgi46/8i5RNFCCc4bA5JuZ7f/Kp7g9fuLSdvLnY8lEHxz8ItOPcaN7gPAB1tvPl7udupT9nvGSmLLlHSosWLdbJTgpgLna+eVv9hiO1ZIpFOGBEFmejBnrO/tc/0znXTf+sHMuPwD0MrSnETID6/SXPrH/junp3Xiw3atCjxJCRktKu10DHzrZ+pOvpc5cP/6T8CWtt4BATZ4tkBoCvTz8tbTb8TnHiYi/0pgCmPufMUkB1ss9vtU7Trgt9EgyGhIS0zgjRB6RukaSdfHpLPly2xTg2chQJmgRN2qiAa3DBtu5kYXgqAIFYEzTJDAVCnQIqaA+O0wyFjj8q1oY6AB/qd5nLw9JvcpqOOcFMT5dqlg/UAoy5exS2TgGg6DxhkHofqHVCGYf3ho/S904DcHZ6jpZ6lWMY1iogCDxsn8oDduP3BEI9QvSBWgU8YRDeGezsyEk1SNlD8HF51wjQoEAgHNkffXBw+XfJiZbXXCTBT2fZaAJfn4iEEt+z73bTk92jZTxPwOFxVCeGRif0tt4HCtxB+f0P7l//rTlBAN6gjcNicThcfU2NCnjf0NU43L59vf2XZf1A8wzX8JRTgLw+Ckx17SahIZGOyMri7dHalXf6DJdYfovPAgVlRLAzAXwI0gCQU5La8m6SXeH9pi+pWf5lUooIUFKSN6V0A1AE39RyeAYYEpvYNjf4OwP8XNuf50UycnKKKURjSTMALkjzzgpyEhI0LW7ygHvYRh00G7zARQL5dBYU9JtLWvQB52e0VX0MOl5anmOP+3yIjZldpteZijZXuIbBxZ1PAEbkc05GVspZtnX04hlHEDKucpUePYbklCgyNjjDLp9AERhjKSNAQc6IwSzPMQClt37OIeOQ7vQWxJPSZSf2OZMyK1h8jHsbNSgY0Z/tNRWA2HmuVXLIZsxnliw2mROAyR2Rjwmn8vyC0XynrUwQ3PzGs6QX06rDRgD9GIDEjF9pUFLSXyRsowLFIp2/44icDpZ02umq6S3ZxDwupp3hYs1cVMAu1noLBZaMNbJoAD3tl6prOodnTF5feBoBRmGweO8fyClISMlIowkkApRYyqbeZ5YJQrHc4UNieeGYArL8NeUkFcvgJKc/AU56ajxejod+/DT/W/IkQC4P3GoBwoGsFKAf9v2qAGIxej9MU8rTGdNjWtVsJv315aL3YwDYqG5MTDxAPMvTNkJS3ReY6AmtlTrhKsf/AHgAA6ezGE+FAAAAAElFTkSuQmCC",ol3:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAQAAAAAYLlVAAAAAnNCSVQICFXsRgQAAAAJcEhZcwAAD10AAA9dAah0GUAAAAAZdEVYdFNvZnR3YXJlAHd3dy5pbmtzY2FwZS5vcmeb7jwaAAAHtUlEQVRo3sWZTWxcVxXHf/d9zIztcTz+pE6cOHXiyLJJadKgKE2oCBLlQwIWSCxYI0WiGxZZIYRAArFAYoEEi0hIsGBBURd0g4iK2lJAaWlaojZVKkU0H26cxB8Zz/f7uPeweHdebDLPnqlQ5l2N5/mN7tz/+Z//OffcM4rPUKCPl0eBAqqfAEAt5Ia1LwCuAg93CyCnAzgj7TstEKMluW+/x0AsWmKBmFggTu4lIpYome2Qw0kA8I2xL9T2Bp5COY6ncJRSDkopFEolANowBEAEATGIGBEkFjEiYkQbI0ZrMaFobYwxkY51pOumpSNTiau6bm7oZX1NP4Ai+ylYADkmGqUPxwSUQsG2ZbcDsBAA2QoGkeSvSZ4kr/alDcRGSyyxbJqqvG5+pHAwbRegVMz+leTBY7qcbTee8vsmQycRmnL6CkD1G4DXFl0fGegvANfpnws8+947AwqFg2MDSjAYzJY80QuAHl2gcPDJF3PiDLiimtIQC0ETEhD3klE8AJeuASg8CgeHir7vLBVOjwypQK3plyoromRNtzSamJg6QbcgvJ7C0J0YnCweG/jek/Ozw5q6bEiFiIHz+wNWBv68+rPNmlQjYnKE1Ai6cYfXA/W5Q6Uvl84f3zel3vH+SIDYoVAeofOdqa9PvbHn/PoDHYZ4eDSpE3fJgLs79YXToz858uxJ5+/en4jQ6hHr5OPZlZHhpcM/4BUv9PFw8agQdQVg1+UHnx/75fG5Gf83lFWGVUrQsmmu/HBsbN8f3Mi1MVLeGUJ3Lig8P/a7s5MN97c01I5+VUIk91err0/fLqFwgBHKOzmimzyQPzX2q1OTZfeianUVKCLNr93EZxiFIOyhnB0Tu6vf/XTp54uzY+4r3S1veYj5CEPBjqFsA3cDoEaLXy199rj/Is0eM2XILXzy5MkzSO6TAvAOFF84qf5KRfWYYhE2aJCzI5MDbxf7B58pTpf89x8qX1yWGKXKFaUBZIF1tWo/KzJPiYi3VAgYbrFEnpiYiBzBTgx0ts99YvDcvHr7YSBJka/Q4k1u3jz5eQ/EYebkXvL241NUeZN/31gkDwibhHjk8PGzTh+OrWw7X/6g/+TB8nuJrQCc4Z/KU08rb+1f/1gCSqy9NUNoP72txtXRb40dfJ+nkgMEZTw78riZLhDRndNP3vGG9GBKnRzhrppmilfhmcWoRYkxyuxv86euUaT24h4W2WN53WQmheB1ygc7MaCKuc+N5LeW6wfOXeUorwFQZIV5RlnbNqcGjBMyaAFUcfHwcHHxOznBakA6JQq34B4dkXtt+8QjvnCQa/Z/jxpFCmdbpPSJI7NyhMVzK/j2UQuFi4OLkz57FECcIcGCU8yZeirQvdxjjuvpTKGAem2EcjpjkjnUC5cvfIm/bRG3Y4e7AwOmEwPKOJotfhvlPj61dGaBEChtAdD88Yeq9et1LqWOUTj2lYzOItSmcxi2ZDXUw+k0n0bqDoXDJBsMM8rHKeIKFbxgIV9nL3cSFlPpZQBoa6AjgCYXK2YkndbckkxmWWfu2D00ozzYNinOlagwbRct/k92zNJARxFK01yur/mX2wDWGE0jfuHyNfa+Y6hQYNsmJQ45hqwwFaPpOVo6s2zDsCMDgsBq2sBR9xj8ZvX70+LJc9w+scA1Sjz49rjMy7zMywE5IY64PMcNDlkHKCbt9xhMZwhOooGODGhMzVyqTUxIm4Pll9797ixnWFZ3WORdSqz//hI+Pv7LT5dXOcNZltUa49y3qplC0Hb5uBMAbwcGDKYS/eLu6YMfrSZCUhWY+QCfGZ7iZYRbarSdYMfd0bvXazh8ii/yF2vcAVwitB1hZirWnROREFLYjN4uLQ5QTZ/WmeA2VwDUHbBks351HRxK3OaqtTTHEQwxmpjkxJApQh111kBAvBH+9O7y/KveFsfcYyNj82qywqZdxmWBAjEREbHdkrNEqNE6o6qJiVeiC4UPHuqg20PvExxGE6YAWp2jwEvabmIyqpoGuTB4ozEwd6lKvYflRzgBBIQWQrQjAG2MZABoEeJH4UU3N8f1rC/psPyz+AQWQEhIK6s09wACk+EC0NTwcCM3KrDAf6ihd6ui2ccxcrRoEaQg6lnQPYDYSLZlAS1cXBzyLHGfW0SZPDgMscgBDK10BARUs48mVgNxtl2GKh6ObVpOM8Uy94hsZpe0nakoMMdhPGJreRtAg9YuJ6NIwp18G7OJsilVyHGIQ2yySZ0WIYocQ+xhknEUhiYRoQUQ0KJBbSfleAChjvQuh4wypbQLovEpMWHrnPY2K0RoG/eR5SCgQXVn1SQAJNpNWiFlhm0+i8jZIrMNoN0j0jbhJMoPaOwu2sQFJt69oRKyadNqTGQBOFsAiM34CQchIdVuwtYyEOgu4jumQosiEX5a6aq0S9Z2T2zTThfdkS0MRN21lISAiBwD5KwDnLReStp0MZomrc4bTyaAhql131gztAhw8cnhWxeIBRASEWbVPju5wAS9/VYgdnthGwPSe5uynYqlpun9EuCTzHt0O67r5uP8teRRAC25H/cXgNmQvgKomhXdLwB2M7pu0pTyeK70mJYUm251sLfo/T8AGEoKes8eIGZ43E5wk36BBwhO2mbqgwZa9C0CAP4LFLGzNDDzmrAAAAAASUVORK5CYII=",lego:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD8AAAA/CAQAAAD9VthUAAAAAnNCSVQICFXsRgQAAAAJcEhZcwAADzoAAA86AZc528IAAAAZdEVYdFNvZnR3YXJlAHd3dy5pbmtzY2FwZS5vcmeb7jwaAAAHvElEQVRYw8WZWWxcVxnHf+fec2fGu+M4qbPH2EmTLk4FApqQNrgiVYyKeClIwBsvPCAQkZAQPND2gRekCoGQEItYHhBLurCksoTKA6QNJW0CBZLWCc3qEBvHy3hsz93O+XiYMxM7nhmPGxGf++Dre2fO7/v+5/u+s4zigzSxVq3osaZNAwzkuq1nPeUrAE9p99JTAKWn5WYEwErpv9TdGbECRlKMgBEjRlIgsqlAKBBaSKUokAjgkcFz+Ce6BvM9sVbKU55WKKWUh1IeoJQCFhsgIIIgIohYEWwq1ooVK9ZasdbG1hhrjUmMsYlZsJEJzYIpmLwZs/8xZ9JpaGYHOYfPyvrChrdbpAxbjFRltCqhnQ2yxBTKf0WQUgNrwYqIFStGUkkllqIU5E/2aQBbEV8pz/ZM3Or8/95UmeUB+J63RiHoAWi1ZHTvNl6pNfXe99Taeq/W1HvuYOzvKG5c4q1afIWHj4eHBwgWwWCQ1aWvBvC8VXngE5DbmO3UxrOeqEhmTFEcPiIiadwEfVttWxmd623tyu7Mfnrjru5cM0Th+Nyp2Z/MztvJNDLkSImZJ27MhNWIr8j1tn+g9at7+/ubivaSHYkmjPF1f+sj7Uc3Xc29VPjm1JSJEzJkCZkjaVT8hvzubDvQ8cz9AwPeG/rHFD3BZkoeTqLwCuqzrQf7nw9+UJhOidEEFAhX0sCJr1fyXm/uPLr5849n/u1/j3mMWtqtYEFm5v/2pXUHdhzNjgaxzunQQzNX3wDdWIT0dT3bP3Qo8wIXSVWNDpWQys2xmW/3fbn1WpAWXUrWNaARvN+/7lu7jzysf8q4siuEh5A8fX5/+8XepLyEs8zfCd7raP/K9scf1T9iQjUUzU+JynOR3TQBgpAS1a16dVtusONTH8kc42ZjcFFKEApcJyBHjizt+O8Wr3e2P7Uv+3curyT7InhJ8nFCMmTJkqWlVlnzVsj0psc69vbrV1SyKnjJgCsEZMiQoanWINcfe39v6xfv808Suu6f5EVlQA7QAcC/1DXp42GmuazOiaJbjjDFSTUNCLOEZMiQEJAjrZYB9b0PmoPe7fpNZQAkYFb1A9CphtWwGlbNkmX/R59TpzhPAAwdf37XKWac1JZJAnc1VSfp0ufSqtK3NT/Y3DJVKZ5tYbHiwfvJAjc5dO7Pw4cZOb4vc51ccvZjh7ZfubaTC8y4evgeAjQaTYCpgZfq06TXpD++Rd6hHHTdZ8JKDs8yAsAD92/gjxSfGNvYzp7Wt3nj6sS2D5NxtXAeHNwnIFpOqSe+bg+2d6ejFXzXS8WlJUSyhBiKoAqj1yFuYQLQZCvFOMLDx8evPFuOF7HV0sqzXmsuP1mJ5tbfVirYc++VITnItvyN8rhJjqIrL7qS50KCX1mWeLXFr5Z02nqiJ2+lXOasIQHJkD75C6DjtQ8dH6Eg99FHyD+LBRclaomnqgL3lo++w4utWsBVbNYtr1htYZFBZgm2299Z5rmXl4+ZtwaPjDlt9CJ0gIeqXNXFN7WKDtMLnW1y+9e6Txc5z2le25Te0BTVic89ovf3yIXE1QeP4FbJbmCla21V723evjklncued/0mZA6AcEABfH/6rXzb2IM5fJD1zLvIB02zm3ak+iK0hK8mvmBnzA/Hoy3LJoyW4XIITn5daAbaX0w3XBnIIsCBL7zDpFNvPWoRvBY+larBZ5Gb6eX20xXxf/2QDMkgmc+sl8MyJH2cf/Seka3yGFv+kR7Ok/1riwxhvruJUYffhGCxWKS0IqqReFXFN5g583qaNokC0aSf/JUaVn95ufNrJ9SwGlapMkkUXuPMAy/E24CJbQVeVWeIXDAFbEYwWCymes3XAMZW9d5gC8k3Rn++79hJjErvvcBB0P53/sBBAOa5knmdnWwlywlQZ7mHfQivOsd6yVDEkGIwxDVrfo2yY4nJ5tMTLe9rkYKSkUtcEqXk9/DKok9d5nLlfpzxyn0Tu7Gk7jLVNx8eQFw98oUi6Vz07NiZ3c/4y+bz+i1gHxliEhJnQFKn6MbVu01ISRaSX2b8vk/4q4D77GErCTGxM2EBW1P8pLr4YJkjiKORhZ91hR1qpsG9m89O9pASOXxMXF6wrCb0ACIidBJe8ZNdjHID24DsA/RhCImInAnztQqr897UeI1lDp3ToU8TO2jiat39q0cLD7GJlNBdERFhLd8dPjamtldx98K8dhNGD91cZ6zKPl6hyNJPP5rYIcsGFGprVva+Nl4GF455lVzI0UcvU0ySX7R5aKabHnrwMRSJlhiQr7fT1QCprYPnmKHgzjQtliwZNrIZHyHBkHHLSMG4KI+JK6Lna+9wFuETUzecLAUHN6QkBARofHwCFImr6Mbld+Lw0Upwhy/acKWUMswS07YI77tllHJTqsW4t4lLtcLKBwyl0JN05YQSiqS0knW+a7eGu4W3rrgmJMwRNpCkLvRsaBoqKAkzZGgi66S/HV+Sf4GQxvor4xPbYDkVIuLS2RZ6CV4wRMQkNNpXGb9go1V8BSElJXRrWIXCupM9We2hvMPPG1bbaqxf3sWhamTzhjVpHsCc/a9dQ3xo82uJL9jRNRLfTTnnBO+u/pTkLT5c8fPNd9nt5tLmRbsVynbsXR704Bbeq775v0uht3btfyZT7OA5knjdAAAAAElFTkSuQmCC"};ol.filter.Lego.prototype.set=function(key,val){ol.filter.Base.prototype.set.call(this,key,val);if(key=="brickSize"&&this.pattern.canvas.width!=val){this.setBrick(val);}}
ol.filter.Lego.prototype.setBrick=function(width,img,crossOrigin){width=Number(width)||30;if(typeof(img)==='string'){var i=new Image;i.src=this.img[img]||this.img.ol3;i.crossOrigin=crossOrigin||null;img=i;}
if(img)this.pattern.img=img;if(!this.pattern.img.width){var self=this;this.pattern.img.onload=function(){self.setBrick(width,img);}
return;}
this.pattern.canvas.width=this.pattern.canvas.height=width;this.pattern.ctx=this.pattern.canvas.getContext("2d");this.pattern.ctx.fillStyle=this.pattern.ctx.createPattern(this.pattern.img,'repeat');this.set("brickSize",width);this.set("img",img.src);};ol.filter.Lego.prototype.getPattern=function(offsetX,offsetY){if(!this.pattern.ctx)return"transparent";var c=this.pattern.canvas;var ctx=this.pattern.ctx;var sc=c.width/this.pattern.img.width;ctx.save();ctx.clearRect(0,0,c.width,c.height);ctx.scale(sc,sc);offsetX/=sc;offsetY/=sc;ctx.translate(offsetX,offsetY);ctx.beginPath();ctx.clearRect(-2*c.width,-2*c.height,4*c.width,4*c.height);ctx.rect(-offsetX,-offsetY,2*c.width/sc,2*c.height/sc);ctx.fill();ctx.restore();return ctx.createPattern(c,'repeat');};ol.filter.Lego.prototype.postcompose=function(e){var ctx=e.context;var canvas=ctx.canvas;var ratio=e.frameState.pixelRatio;if(e.type==='postrender'){ratio=1;}
ctx.save();var step=this.pattern.canvas.width*ratio;var p=e.frameState.extent;var res=e.frameState.viewState.resolution/ratio;var offset=[-Math.round((p[0]/res)%step),Math.round((p[1]/res)%step)];var ctx2=this.internal_.getContext("2d");var w=this.internal_.width=canvas.width;var h=this.internal_.height=canvas.height;ctx2.webkitImageSmoothingEnabled=ctx2.mozImageSmoothingEnabled=ctx2.msImageSmoothingEnabled=ctx2.imageSmoothingEnabled=false;var w2=Math.floor((w-offset[0])/step);var h2=Math.floor((h-offset[1])/step);ctx2.drawImage(canvas,offset[0],offset[1],w2*step,h2*step,0,0,w2,h2);ctx.webkitImageSmoothingEnabled=ctx.mozImageSmoothingEnabled=ctx.msImageSmoothingEnabled=ctx.imageSmoothingEnabled=false;ctx.clearRect(0,0,w,h);ctx.drawImage(this.internal_,0,0,w2,h2,offset[0],offset[1],w2*step,h2*step);ctx.scale(ratio,ratio);ctx.fillStyle=this.getPattern(offset[0]/ratio,offset[1]/ratio);ctx.rect(0,0,w,h);ctx.fill();ctx.restore();};ol.filter.Texture=function(options)
{ol.filter.Base.call(this,options);this.setFilter(options);}
ol.ext.inherits(ol.filter.Texture,ol.filter.Base);ol.filter.Texture.prototype.setFilter=function(options)
{var img;options=options||{};if(options.img)img=options.img;else
{img=new Image();if(options.src){if(ol.filter.Texture.Image&&ol.filter.Texture.Image[options.src]){img.src=ol.filter.Texture.Image[options.src];}
else{if(!img.src)img.src=options.src;}}
img.crossOrigin=options.crossOrigin||null;}
this.set('rotateWithView',options.rotateWithView!==false);this.set('opacity',typeof(options.opacity)=='number'?options.opacity:1);this.set('ready',false);var self=this;function setPattern(img)
{self.pattern={};self.pattern.scale=options.scale||1;self.pattern.canvas=document.createElement('canvas');self.pattern.canvas.width=img.width*self.pattern.scale;self.pattern.canvas.height=img.height*self.pattern.scale;self.pattern.canvas.width=img.width;self.pattern.canvas.height=img.height;self.pattern.ctx=self.pattern.canvas.getContext("2d");self.pattern.ctx.fillStyle=self.pattern.ctx.createPattern(img,'repeat');self.set('ready',true);}
if(img.width)
{setPattern(img);}
else
{img.onload=function()
{setPattern(img);}}}
ol.filter.Texture.prototype.getPattern=function(offsetX,offsetY)
{var c=this.pattern.canvas;var ctx=this.pattern.ctx;ctx.save();ctx.translate(-offsetX,offsetY);ctx.beginPath();ctx.rect(offsetX,-offsetY,c.width,c.height);ctx.fill();ctx.restore();return ctx.createPattern(c,'repeat');}
ol.filter.Texture.prototype.postcompose=function(e)
{if(!this.pattern)return;var ctx=e.context;var canvas=ctx.canvas;var m=1.5*Math.max(canvas.width,canvas.height);var mt=e.frameState.pixelToCoordinateTransform;if(!mt)
{mt=e.frameState.pixelToCoordinateMatrix,mt[2]=mt[4];mt[3]=mt[5];mt[4]=mt[12];mt[5]=mt[13];}
var ratio=e.frameState.pixelRatio;var res=e.frameState.viewState.resolution;var w=canvas.width/2,h=canvas.height/2;ctx.save();ctx.globalCompositeOperation="multiply";ctx.globalAlpha=this.get('opacity');ctx.scale(ratio*this.pattern.scale,ratio*this.pattern.scale);if(this.get('rotateWithView'))
{res*=this.pattern.scale
ctx.fillStyle=this.getPattern((w*mt[0]+h*mt[1]+mt[4])/res,(w*mt[2]+h*mt[3]+mt[5])/res);ctx.translate(w/this.pattern.scale,h/this.pattern.scale);ctx.rotate(e.frameState.viewState.rotation);ctx.beginPath();ctx.rect(-w-m,-h-m,2*m,2*m);ctx.fill();}
else
{var dx=-(w*mt[0]+h*mt[1]+mt[4])/res;var dy=(w*mt[2]+h*mt[3]+mt[5])/res;var cos=Math.cos(e.frameState.viewState.rotation);var sin=Math.sin(e.frameState.viewState.rotation);var offsetX=(dx*cos-dy*sin)/this.pattern.scale;var offsetY=(dx*sin+dy*cos)/this.pattern.scale;ctx.translate(offsetX,offsetY);ctx.beginPath();ctx.fillStyle=this.pattern.ctx.fillStyle;ctx.rect(-offsetX-m,-offsetY-m,2*m,2*m);ctx.fill();}
ctx.restore();}
ol.format.GeoRSS=function(options){options=options||{};ol.Object.call(this,options);};ol.ext.inherits(ol.format.GeoRSS,ol.Object);ol.format.GeoRSS.prototype.readFeature=function(source,options){options=options||{};var att,atts=source.children;var f=new ol.Feature();for(var j=0;att=atts[j];j++){f.set(att.tagName,att.innerHTML);}
var temp,g,coord=[];if(f.get('geo:long')){g=new ol.geom.Point([f.get('geo:long'),f.get('geo:lat')]);f.unset('geo:long');f.unset('geo:lat');}else if(f.get('georss:point')){coord=f.get('georss:point').trim().split(' ');g=new ol.geom.Point([parseFloat(coord[1]),parseFloat(coord[0])]);f.unset('georss:point');}else if(f.get('georss:polygon')){temp=f.get('georss:polygon').trim().split(' ');for(var i=0;i<temp.length;i+=2){coord.push([parseFloat(temp[i+1]),parseFloat(temp[i])])}
g=new ol.geom.Polygon([coord]);console.log(temp,coord)
f.unset('georss:polygon');}else if(f.get('georss:where')){console.warn('[GeoRSS] GML format not implemented')
f.unset('georss:where');return null;}else{console.warn('[GeoRSS] unknown geometry')
return null;}
if(options.featureProjection||this.get('featureProjection')){g.transform(options.dataProjection||this.get('dataProjection')||'EPSG:4326',options.featureProjection||this.get('featureProjection'));}
f.setGeometry(g);return f;};ol.format.GeoRSS.prototype.readFeatures=function(source,options){var items;if(typeof(source)==='string'){var parser=new DOMParser();var xmlDoc=parser.parseFromString(source,"text/xml");items=xmlDoc.getElementsByTagName('item');}else if(source instanceof Document){items=source.getElementsByTagName('item');}else if(source instanceof Node){items=source;}else{return[];}
var features=[]
for(var i=0,item;item=items[i];i++){var f=this.readFeature(item,options);if(f)features.push(f);}
return features;};ol.interaction.CenterTouch=function(options)
{options=options||{};this._listener={};var rex=/^pointermove$|^pointerup$/;this.targetStyle=options.targetStyle||[new ol.style.Style({image:new ol.style.RegularShape({points:4,radius:11,radius1:0,radius2:0,snapToPixel:true,stroke:new ol.style.Stroke({color:"#fff",width:3})})}),new ol.style.Style({image:new ol.style.RegularShape({points:4,radius:11,radius1:0,radius2:0,snapToPixel:true,stroke:new ol.style.Stroke({color:"#000",width:1})})})];if(!(this.targetStyle instanceof Array))this.targetStyle=[this.targetStyle];this.composite=options.composite||'';this.ctouch=new ol.interaction.Interaction({handleEvent:function(e)
{if(rex.test(e.type)&&this.getMap())
{e.coordinate=this.getMap().getView().getCenter();e.pixel=this.getMap().getSize();e.pixel=[e.pixel[0]/2,e.pixel[1]/2];}
return true;}});this._target=new ol.control.Target();ol.interaction.Interaction.call(this,{handleEvent:function(e)
{if(rex.test(e.type))this.pos_=e.coordinate;if(options.handleEvent)return options.handleEvent.call(this,e);return true;}});};ol.ext.inherits(ol.interaction.CenterTouch,ol.interaction.Interaction);ol.interaction.CenterTouch.prototype.setMap=function(map)
{if(this.getMap())
{this.getMap().removeInteraction(this.ctouch);this.getMap().removeInteraction(this._target);}
ol.interaction.Interaction.prototype.setMap.call(this,map);if(this.getMap())
{if(this.getActive()){this.getMap().addInteraction(this.ctouch);this.getMap().addControl(this._target);}}};ol.interaction.CenterTouch.prototype.setActive=function(b)
{ol.interaction.Interaction.prototype.setActive.call(this,b);this.pos_=null;if(this.getMap())
{if(this.getActive())
{this.getMap().addInteraction(this.ctouch);this.getMap().addControl(this._target);}
else{this.getMap().removeInteraction(this.ctouch);this.getMap().removeControl(this._target);}}};ol.interaction.CenterTouch.prototype.getPosition=function()
{if(!this.pos_)
{var px=this.getMap().getSize();px=[px[0]/2,px[1]/2];this.pos_=this.getMap().getCoordinateFromPixel(px);}
return this.pos_;};ol.interaction.Clip=function(options){this.layers_=[];ol.interaction.Pointer.call(this,{handleDownEvent:this.setPosition,handleMoveEvent:this.setPosition});this.precomposeBind_=this.precompose_.bind(this);this.postcomposeBind_=this.postcompose_.bind(this);options=options||{};this.pos=false;this.radius=(options.radius||100);if(options.layers)this.addLayer(options.layers);};ol.ext.inherits(ol.interaction.Clip,ol.interaction.Pointer);ol.interaction.Clip.prototype.setMap=function(map){var i;if(this.getMap()){for(i=0;i<this.layers_.length;i++){this.layers_[i].un(['precompose','prerender'],this.precomposeBind_);this.layers_[i].un(['postcompose','postrender'],this.postcomposeBind_);}
this.getMap().renderSync();}
ol.interaction.Pointer.prototype.setMap.call(this,map);if(map){for(i=0;i<this.layers_.length;i++){this.layers_[i].on(['precompose','prerender'],this.precomposeBind_);this.layers_[i].on(['postcompose','postrender'],this.postcomposeBind_);}
map.renderSync();}}
ol.interaction.Clip.prototype.setRadius=function(radius){this.radius=radius;if(this.getMap())this.getMap().renderSync();}
ol.interaction.Clip.prototype.addLayer=function(layers){if(!(layers instanceof Array))layers=[layers];for(var i=0;i<layers.length;i++){if(this.getMap()){layers[i].on(['precompose','prerender'],this.precomposeBind_);layers[i].on(['postcompose','postrender'],this.postcomposeBind_);this.getMap().renderSync();}
this.layers_.push(layers[i]);}};ol.interaction.Clip.prototype.removeLayer=function(layers){if(!(layers instanceof Array))layers=[layers];for(var i=0;i<layers.length;i++){var k;for(k=0;k<this.layers_.length;k++){if(this.layers_[k]===layers[i]){break;}}
if(k!=this.layers_.length&&this.getMap()){this.layers_[k].un(['precompose','prerender'],this.precomposeBind_);this.layers_[k].un(['postcompose','postrender'],this.postcomposeBind_);this.layers_.splice(k,1);this.getMap().renderSync();}}};ol.interaction.Clip.prototype.setPosition=function(e){if(e.pixel)this.pos=e.pixel;else{if(e&&e instanceof Array)this.pos=e;else e=[-10000000,-10000000];}
if(this.getMap())this.getMap().renderSync();};ol.interaction.Clip.prototype.precompose_=function(e){var ctx=e.context;var ratio=e.frameState.pixelRatio;ctx.save();ctx.beginPath();ctx.arc(this.pos[0]*ratio,this.pos[1]*ratio,this.radius*ratio,0,2*Math.PI);ctx.clip();};ol.interaction.Clip.prototype.postcompose_=function(e){e.context.restore();};ol.interaction.Clip.prototype.setActive=function(b){if(b===this.getActive())return;ol.interaction.Pointer.prototype.setActive.call(this,b);var i;if(b){for(i=0;i<this.layers_.length;i++){this.layers_[i].on(['precompose','prerender'],this.precomposeBind_);this.layers_[i].on(['postcompose','postrender'],this.postcomposeBind_);}}else{for(i=0;i<this.layers_.length;i++){this.layers_[i].un(['precompose','prerender'],this.precomposeBind_);this.layers_[i].un(['postcompose','postrender'],this.postcomposeBind_);}}
if(this.getMap())this.getMap().renderSync();};ol.interaction.CopyPaste=function(options){options=options||{};this.features=[];this._cloneFeature=true;var condition=options.condition;if(typeof(condition)!=='function'){condition=function(e){if(e.originalEvent.ctrlKey){if(/^c$/i.test(e.originalEvent.key))return'copy';if(/^x$/i.test(e.originalEvent.key))return'cut';if(/^v$/i.test(e.originalEvent.key))return'paste';}
return false;}}
this._featuresSource=options.features||new ol.Collection();this.setSources(options.sources);this.setDestination(options.destination);ol.interaction.Interaction.call(this,{handleEvent:function(e){if(e.type==='keydown'&&!/INPUT|TEXTAREA|SELECT/.test(document.activeElement.tagName)){switch(condition(e)){case'copy':{this.copy({silent:false});break;}
case'cut':{this.copy({cut:true,silent:false});break;}
case'paste':{this.paste({silent:false});break;}
default:break;}}
return true;}.bind(this)});};ol.ext.inherits(ol.interaction.CopyPaste,ol.interaction.Interaction);ol.interaction.CopyPaste.prototype.setSources=function(sources){if(sources){this._source=[];this._source=sources instanceof Array?sources:[sources];}else{this._source=null;}};ol.interaction.CopyPaste.prototype.getSources=function(){return this._source;};ol.interaction.CopyPaste.prototype.setDestination=function(destination){this._destination=destination;};ol.interaction.CopyPaste.prototype.getDestination=function(){return this._destination;};ol.interaction.CopyPaste.prototype.getFeatures=function(){return this.features;};ol.interaction.CopyPaste.prototype.copy=function(options){options=options||{};var features=options.features||this._featuresSource.getArray();if(options.cut){var sources=this._source||[this._destination];features.forEach(function(f){sources.forEach(function(source){try{source.removeFeature(f);}catch(e){}});});}
if(this._cloneFeature){this.features=[];features.forEach(function(f){this.features.push(f.clone());}.bind(this));}else{this.features=features;}
if(options.silent===false)this.dispatchEvent({type:options.cut?'cut':'copy',time:(new Date).getTime()});};ol.interaction.CopyPaste.prototype.paste=function(options){options=options||{};var features=options.features||this.features;if(features){var destination=options.destination||this._destination;if(destination){destination.addFeatures(this.features);if(this._cloneFeature)this.copy({features:this.features});}}
if(options.silent===false)this.dispatchEvent({type:'paste',features:features,time:(new Date).getTime()});};ol.interaction.Delete=function(options){ol.interaction.Select.call(this,options);this.on('select',function(e){this.getFeatures().clear();this.delete(e.selected);}.bind(this));};ol.ext.inherits(ol.interaction.Delete,ol.interaction.Select);ol.interaction.Delete.prototype._getSources=function(layers){if(!this.getMap())return[];if(!layers)layers=this.getMap().getLayers();var sources=[];layers.forEach(function(l){if(l.getLayers){sources=sources.concat(this._getSources(l.getLayers()));}else{if(l.getSource&&l.getSource()instanceof ol.source.Vector){sources.push(l.getSource());}}}.bind(this));return sources;};ol.interaction.Delete.prototype.delete=function(features){if(features&&(features.length||features.getLength())){this.dispatchEvent({type:'deletestart',features:features});var delFeatures=[];this._getSources().forEach(function(source){try{features.forEach(function(f){source.removeFeature(f);delFeatures.push(f);});}catch(e){}})
this.dispatchEvent({type:'deleteend',features:delFeatures});}};ol.interaction.DragOverlay=function(options){if(!options)options={};ol.interaction.Pointer.call(this,{handleDownEvent:function(evt){if(/^(BUTTON|A)$/.test(evt.originalEvent.target.tagName)){this._dragging=false;return true;}
if(this._dragging){this._dragging.setPosition(evt.coordinate);this.dispatchEvent({type:'dragstart',overlay:this._dragging,coordinate:evt.coordinate});return true;}
return false;},handleDragEvent:function(evt){if(this._dragging){this._dragging.setPosition(evt.coordinate);this.dispatchEvent({type:'dragging',overlay:this._dragging,coordinate:evt.coordinate});}},handleUpEvent:function(evt){if(this._dragging){this.dispatchEvent({type:'dragend',overlay:this._dragging,coordinate:evt.coordinate});}
return(this._dragging=false);}});this._overlays=[];if(!(options.overlays instanceof Array))options.overlays=[options.overlays];options.overlays.forEach(this.addOverlay.bind(this));};ol.ext.inherits(ol.interaction.DragOverlay,ol.interaction.Pointer);ol.interaction.DragOverlay.prototype.addOverlay=function(ov){for(var i=0,o;o=this._overlays[i];i++){if(o===ov)return;}
if(ov.element.parentElement&&ov.element.parentElement.classList.contains('ol-overlaycontainer-stopevent')){console.warn('[DragOverlay.addOverlay] overlay must be created with stopEvent set to false!');return;}
var handler=function(){if(this.getMap()===ov.getMap())this._dragging=ov;}.bind(this);this._overlays.push({overlay:ov,listener:handler});ov.element.addEventListener('pointerdown',handler);};ol.interaction.DragOverlay.prototype.removeOverlay=function(ov){for(var i=0,o;o=this._overlays[i];i++){if(o.overlay===ov){var l=this._overlays.splice(i,1)[0];ov.element.removeEventListener('pointerdown',l.listener);break;}}};ol.interaction.DrawHole=function(options){if(!options)options={};var self=this;this._select=new ol.interaction.Select({style:options.style});this._select.setActive(false);var geometryFn,geomFn=options.geometryFunction;if(geomFn){geometryFn=function(c,g){g=self._geometryFn(c,g);return geomFn(c,g);}}else{geometryFn=function(c,g){return self._geometryFn(c,g);}}
options.type="Polygon";options.geometryFunction=geometryFn;ol.interaction.Draw.call(this,options);if(options.layers){if(typeof(options.layers)==='function'){this.layers_=options.layers;}else if(options.layers.indexOf){this.layers_=function(l){return(options.layers.indexOf(l)>=0);};}}
this.on('drawstart',this._startDrawing.bind(this));this.on('drawend',this._finishDrawing.bind(this));};ol.ext.inherits(ol.interaction.DrawHole,ol.interaction.Draw);ol.interaction.DrawHole.prototype.setMap=function(map){if(this.getMap())this.getMap().removeInteraction(this._select);if(map)map.addInteraction(this._select);ol.interaction.Draw.prototype.setMap.call(this,map);};ol.interaction.DrawHole.prototype.setActive=function(b){this._select.getFeatures().clear();ol.interaction.Draw.prototype.setActive.call(this,b);};ol.interaction.DrawHole.prototype.removeLastPoint=function(){if(this._feature&&this._feature.getGeometry().getCoordinates()[0].length>2){ol.interaction.Draw.prototype.removeLastPoint.call(this);}};ol.interaction.DrawHole.prototype.getPolygon=function(){return this._polygon;};ol.interaction.DrawHole.prototype._startDrawing=function(e){var map=this.getMap();var layersFilter=this.layers_;this._feature=e.feature;var coord=e.feature.getGeometry().getCoordinates()[0][0];var features=map.getFeaturesAtPixel(map.getPixelFromCoordinate(coord),{layerFilter:layersFilter});this._current=null;if(features){for(var k=0;k<features.length;k++){var poly=features[k].getGeometry();if(poly.getType()==="Polygon"&&poly.intersectsCoordinate(coord)){this._polygonIndex=false;this._polygon=poly;this._current=features[k];}
else if(poly.getType()==="MultiPolygon"&&poly.intersectsCoordinate(coord)){for(var i=0,p;p=poly.getPolygon(i);i++){if(p.intersectsCoordinate(coord)){this._polygonIndex=i;this._polygon=p;this._current=features[k];break;}}}
if(this._current)break;}}
this._select.getFeatures().clear();if(!this._current){this.setActive(false);this.setActive(true);}else{this._select.getFeatures().push(this._current);}};ol.interaction.DrawHole.prototype._finishDrawing=function(e){e.hole=e.feature;e.feature=this._select.getFeatures().item(0);this.dispatchEvent({type:'modifystart',features:[this._current]});var c=e.hole.getGeometry().getCoordinates()[0];if(c.length>3){if(this._polygonIndex!==false){var geom=e.feature.getGeometry();var newGeom=new ol.geom.MultiPolygon([]);for(var i=0,pi;pi=geom.getPolygon(i);i++){if(i===this._polygonIndex){pi.appendLinearRing(new ol.geom.LinearRing(c));newGeom.appendPolygon(pi);}else{newGeom.appendPolygon(pi);}}
e.feature.setGeometry(newGeom);}else{this.getPolygon().appendLinearRing(new ol.geom.LinearRing(c));}}
this.dispatchEvent({type:'modifyend',features:[this._current]});this._feature=null;this._select.getFeatures().clear();};ol.interaction.DrawHole.prototype._geometryFn=function(coordinates,geometry){var coord=coordinates[0].pop();if(!this.getPolygon()||this.getPolygon().intersectsCoordinate(coord)){this.lastOKCoord=[coord[0],coord[1]];}
coordinates[0].push([this.lastOKCoord[0],this.lastOKCoord[1]]);if(geometry){geometry.setCoordinates([coordinates[0].concat([coordinates[0][0]])]);}else{geometry=new ol.geom.Polygon(coordinates);}
return geometry;};ol.interaction.DrawRegular=function(options){if(!options)options={};this.squaredClickTolerance_=options.clickTolerance?options.clickTolerance*options.clickTolerance:36;this.maxCircleCoordinates_=options.maxCircleCoordinates||100;this.features_=options.features;this.source_=options.source;this.squareFn_=options.squareCondition;this.centeredFn_=options.centerCondition;this.canRotate_=(options.canRotate!==false);this.geometryName_=options.geometryName
this.setSides(options.sides);var white=[255,255,255,1];var blue=[0,153,255,1];var width=3;var defaultStyle=[new ol.style.Style({stroke:new ol.style.Stroke({color:white,width:width+2})}),new ol.style.Style({image:new ol.style.Circle({radius:width*2,fill:new ol.style.Fill({color:blue}),stroke:new ol.style.Stroke({color:white,width:width/2})}),stroke:new ol.style.Stroke({color:blue,width:width}),fill:new ol.style.Fill({color:[255,255,255,0.5]})})];this.sketch_=new ol.Collection();this.overlayLayer_=new ol.layer.Vector({source:new ol.source.Vector({features:this.sketch_,useSpatialIndex:false}),name:'DrawRegular overlay',displayInLayerSwitcher:false,style:options.style||defaultStyle});ol.interaction.Interaction.call(this,{handleEvent:this.handleEvent_});};ol.ext.inherits(ol.interaction.DrawRegular,ol.interaction.Interaction);ol.interaction.DrawRegular.prototype.setMap=function(map){if(this.getMap())this.getMap().removeLayer(this.overlayLayer_);ol.interaction.Interaction.prototype.setMap.call(this,map);this.overlayLayer_.setMap(map);};ol.interaction.DrawRegular.prototype.setActive=function(b){this.reset();ol.interaction.Interaction.prototype.setActive.call(this,b);}
ol.interaction.DrawRegular.prototype.reset=function(){this.overlayLayer_.getSource().clear();this.started_=false;}
ol.interaction.DrawRegular.prototype.setSides=function(nb){nb=parseInt(nb);this.sides_=nb>2?nb:0;}
ol.interaction.DrawRegular.prototype.canRotate=function(b){if(b===true||b===false)this.canRotate_=b;return this.canRotate_;}
ol.interaction.DrawRegular.prototype.getSides=function(){return this.sides_;}
ol.interaction.DrawRegular.prototype.startAngle={'default':Math.PI/2,3:-Math.PI/2,4:Math.PI/4};ol.interaction.DrawRegular.prototype.getGeom_=function(){this.overlayLayer_.getSource().clear();if(!this.center_)return false;var g;if(this.coord_){var center=this.center_;var coord=this.coord_;var d,dmax,r,circle,centerPx;if(!this.sides_&&this.square_&&!this.centered_){center=[(coord[0]+center[0])/2,(coord[1]+center[1])/2];d=[coord[0]-center[0],coord[1]-center[1]];r=Math.sqrt(d[0]*d[0]+d[1]*d[1]);circle=new ol.geom.Circle(center,r,'XY');centerPx=this.getMap().getPixelFromCoordinate(center);dmax=Math.max(100,Math.abs(centerPx[0]-this.coordPx_[0]),Math.abs(centerPx[1]-this.coordPx_[1]));dmax=Math.min(this.maxCircleCoordinates_,Math.round(dmax/3));return ol.geom.Polygon.fromCircle(circle,dmax,0);}else{var hasrotation=this.canRotate_&&this.centered_&&this.square_;d=[coord[0]-center[0],coord[1]-center[1]];if(this.square_&&!hasrotation){var dm=Math.max(Math.abs(d[0]),Math.abs(d[1]));coord=[center[0]+(d[0]>0?dm:-dm),center[1]+(d[1]>0?dm:-dm)];}
r=Math.sqrt(d[0]*d[0]+d[1]*d[1]);if(r>0){circle=new ol.geom.Circle(center,r,'XY');var a;if(hasrotation)a=Math.atan2(d[1],d[0]);else a=this.startAngle[this.sides_]||this.startAngle['default'];if(this.sides_){g=ol.geom.Polygon.fromCircle(circle,this.sides_,a);}else{centerPx=this.getMap().getPixelFromCoordinate(this.center_);dmax=Math.max(100,Math.abs(centerPx[0]-this.coordPx_[0]),Math.abs(centerPx[1]-this.coordPx_[1]));dmax=Math.min(this.maxCircleCoordinates_,Math.round(dmax/(this.centered_?3:5)));g=ol.geom.Polygon.fromCircle(circle,dmax,0);}
if(hasrotation)return g;var ext=g.getExtent();if(!this.centered_)center=this.center_;else center=[2*this.center_[0]-this.coord_[0],2*this.center_[1]-this.coord_[1]];var scx=(center[0]-coord[0])/(ext[0]-ext[2]);var scy=(center[1]-coord[1])/(ext[1]-ext[3]);if(this.square_){var sc=Math.min(Math.abs(scx),Math.abs(scy));scx=Math.sign(scx)*sc;scy=Math.sign(scy)*sc;}
var t=[center[0]-ext[0]*scx,center[1]-ext[1]*scy];g.applyTransform(function(g1,g2,dim){for(var i=0;i<g1.length;i+=dim){g2[i]=g1[i]*scx+t[0];g2[i+1]=g1[i+1]*scy+t[1];}
return g2;});return g;}}}
return new ol.geom.Point(this.center_);};ol.interaction.DrawRegular.prototype.drawSketch_=function(evt){this.overlayLayer_.getSource().clear();if(evt){this.square_=this.squareFn_?this.squareFn_(evt):evt.originalEvent.shiftKey;this.centered_=this.centeredFn_?this.centeredFn_(evt):evt.originalEvent.metaKey||evt.originalEvent.ctrlKey;var g=this.getGeom_();if(g){var f=this.feature_;if(this.geometryName_)f.setGeometryName(this.geometryName_)
if(g.getType()==='Polygon')f.getGeometry().setCoordinates(g.getCoordinates());this.overlayLayer_.getSource().addFeature(f);if(this.coord_&&this.square_&&((this.canRotate_&&this.centered_&&this.coord_)||(!this.sides_&&!this.centered_))){this.overlayLayer_.getSource().addFeature(new ol.Feature(new ol.geom.LineString([this.center_,this.coord_])));}
return f;}}};ol.interaction.DrawRegular.prototype.drawPoint_=function(pt,noclear){if(!noclear)this.overlayLayer_.getSource().clear();this.overlayLayer_.getSource().addFeature(new ol.Feature(new ol.geom.Point(pt)));};ol.interaction.DrawRegular.prototype.handleEvent_=function(evt){var dx,dy;this._eventTime=new Date();switch(evt.type){case"pointerdown":{this.downPx_=evt.pixel;this.start_(evt);var dt=500;this._longTouch=false;setTimeout(function(){this._longTouch=(new Date()-this._eventTime>.9*dt);if(this._longTouch)this.handleMoveEvent_(evt);}.bind(this),dt);break;}
case"pointerup":{if(this.started_&&this.coord_){dx=this.downPx_[0]-evt.pixel[0];dy=this.downPx_[1]-evt.pixel[1];if(dx*dx+dy*dy<=this.squaredClickTolerance_){if(this.lastEvent=="pointermove"||this.lastEvent=="keydown"){this.end_(evt);}
else{dx=this.upPx_[0]-evt.pixel[0];dy=this.upPx_[1]-evt.pixel[1];if(dx*dx+dy*dy<=this.squaredClickTolerance_){this.end_(evt);}else{this.handleMoveEvent_(evt);this.drawPoint_(evt.coordinate,true);}}}}
this.upPx_=evt.pixel;break;}
case"pointerdrag":{if(this.started_){var centerPx=this.getMap().getPixelFromCoordinate(this.center_);dx=centerPx[0]-evt.pixel[0];dy=centerPx[1]-evt.pixel[1];if(dx*dx+dy*dy<=this.squaredClickTolerance_){this.reset();}}
return!this._longTouch;}
case"pointermove":{if(this.started_){dx=this.downPx_[0]-evt.pixel[0];dy=this.downPx_[1]-evt.pixel[1];if(dx*dx+dy*dy>this.squaredClickTolerance_){this.handleMoveEvent_(evt);this.lastEvent=evt.type;}}
break;}
default:{this.lastEvent=evt.type;if(this.started_&&evt.type==='dblclick'){return false;}
break;}}
return true;}
ol.interaction.DrawRegular.prototype.finishDrawing=function(){if(this.started_&&this.coord_){this.end_({pixel:this.upPx_,coordinate:this.coord_});}};ol.interaction.DrawRegular.prototype.handleMoveEvent_=function(evt){if(this.started_){this.coord_=evt.coordinate;this.coordPx_=evt.pixel;var f=this.drawSketch_(evt);this.dispatchEvent({type:'drawing',feature:f,pixel:evt.pixel,startCoordinate:this.center_,coordinate:evt.coordinate,square:this.square_,centered:this.centered_});}else{this.drawPoint_(evt.coordinate);}};ol.interaction.DrawRegular.prototype.start_=function(evt){if(!this.started_){this.started_=true;this.center_=evt.coordinate;this.coord_=null;var geom=new ol.geom.Polygon([[evt.coordinate,evt.coordinate,evt.coordinate]]);var f=this.feature_=new ol.Feature(geom);this.drawSketch_(evt);this.dispatchEvent({type:'drawstart',feature:f,pixel:evt.pixel,coordinate:evt.coordinate});}else{this.coord_=evt.coordinate;}};ol.interaction.DrawRegular.prototype.end_=function(evt){this.coord_=evt.coordinate;this.started_=false;if(this.coord_&&this.center_[0]!=this.coord_[0]&&this.center_[1]!=this.coord_[1]){var f=this.feature_;if(this.geometryName_)f.setGeometryName(this.geometryName_)
f.setGeometry(this.getGeom_());if(this.source_)this.source_.addFeature(f);else if(this.features_)this.features_.push(f);this.dispatchEvent({type:'drawend',feature:f,pixel:evt.pixel,coordinate:evt.coordinate,square:this.square_,centered:this.centered_});}else{this.dispatchEvent({type:'drawcancel',feature:null,pixel:evt.pixel,coordinate:evt.coordinate,square:this.square_,centered:this.centered_});}
this.center_=this.coord_=null;this.drawSketch_();};ol.interaction.DrawTouch=function(options){options=options||{};options.handleEvent=function(e){if(this.get("tap")){switch(e.type){case"singleclick":{this.addPoint();break;}
case"dblclick":{this.addPoint();this.finishDrawing();return false;}
default:break;}}
return true;}
ol.interaction.CenterTouch.call(this,options);this.typeGeom_=options.type;this.source_=options.source;this.set("tap",(options.tap!==false));var white=[255,255,255,1];var blue=[0,153,255,1];var width=3;var defaultStyle=[new ol.style.Style({stroke:new ol.style.Stroke({color:white,width:width+2})}),new ol.style.Style({image:new ol.style.Circle({radius:width*2,fill:new ol.style.Fill({color:blue}),stroke:new ol.style.Stroke({color:white,width:width/2})}),stroke:new ol.style.Stroke({color:blue,width:width}),fill:new ol.style.Fill({color:[255,255,255,0.5]})})];this.overlay_=new ol.layer.Vector({source:new ol.source.Vector({useSpatialIndex:false}),style:defaultStyle});this.geom_=[];};ol.ext.inherits(ol.interaction.DrawTouch,ol.interaction.CenterTouch);ol.interaction.DrawTouch.prototype.setMap=function(map){if(this._listener.drawSketch)ol.Observable.unByKey(this._listener.drawSketch);this._listener.drawSketch=null;ol.interaction.CenterTouch.prototype.setMap.call(this,map);this.overlay_.setMap(map);if(this.getMap()){this._listener.drawSketch=this.getMap().on("postcompose",this.drawSketchLink_.bind(this));}};ol.interaction.DrawTouch.prototype.getGeometryType=function(){return this.typeGeom_;};ol.interaction.DrawTouch.prototype.finishDrawing=function(){if(!this.getMap())return;var valid=true;if(this._feature){switch(this.typeGeom_){case"LineString":{if(this.geom_.length>1){this._feature.setGeometry(new ol.geom.LineString(this.geom_));}else{valid=false;}
break;}
case"Polygon":{if(this.geom_[this.geom_.length-1]!=this.geom_[0]){this.geom_.push(this.geom_[0]);}
if(this.geom_.length>3){this._feature.setGeometry(new ol.geom.Polygon([this.geom_]));}else{valid=false;}
break;}
default:break;}
if(this._feature)this.source_.addFeature(this._feature);this.dispatchEvent({type:'drawend',feature:this._feature,valid:valid});}
this.geom_=[];this.drawSketch_();this._feature=null;};ol.interaction.DrawTouch.prototype.addPoint=function(){if(!this.getMap())return;this.geom_.push(this.getPosition());var start=false;if(!this._feature){this._feature=new ol.Feature();start=true;}
switch(this.typeGeom_){case"Point":this._feature.setGeometry(new ol.geom.Point(this.geom_.pop()));break;case"LineString":case"Polygon":this.drawSketch_();break;default:break;}
if(start){this.dispatchEvent({type:'drawstart',feature:this._feature});}
if(this.typeGeom_==='Point'){this.finishDrawing();}};ol.interaction.DrawTouch.prototype.removeLastPoint=function(){if(!this.getMap())return;this.geom_.pop();this.drawSketch_();};ol.interaction.DrawTouch.prototype.drawSketch_=function(){if(!this.overlay_)return;this.overlay_.getSource().clear();if(this.geom_.length){var geom=new ol.geom.LineString(this.geom_);if(this.typeGeom_=="Polygon"){if(!this._feature.getGeometry()){this._feature.setGeometry(new ol.geom.Polygon([this.geom_]));}else{this._feature.getGeometry().setCoordinates([this.geom_]);}
this.overlay_.getSource().addFeature(new ol.Feature(geom));}else{if(!this._feature.getGeometry()){this._feature.setGeometry(new ol.geom.LineString(this.geom_));}else{this._feature.getGeometry().setCoordinates(this.geom_);}}
this.overlay_.getSource().addFeature(this._feature);var f=new ol.Feature(new ol.geom.Point(this.geom_.slice(-1).pop()));this.overlay_.getSource().addFeature(f);}};ol.interaction.DrawTouch.prototype.drawSketchLink_=function(e){if(!this.getActive()||!this.getPosition())return;var ctx=e.context||ol.ext.getMapCanvas(this.getMap()).getContext('2d');ctx.save();var p,pt=this.getMap().getPixelFromCoordinate(this.getPosition());var ratio=e.frameState.pixelRatio||1;ctx.scale(ratio,ratio);ctx.strokeStyle="rgba(0, 153, 255, 1)";ctx.lineWidth=1;ctx.beginPath();ctx.arc(pt[0],pt[1],5,0,2*Math.PI);ctx.stroke();if(this.geom_.length){p=this.getMap().getPixelFromCoordinate(this.geom_[this.geom_.length-1]);ctx.beginPath();ctx.moveTo(p[0],p[1]);ctx.lineTo(pt[0],pt[1]);if(this.typeGeom_=="Polygon"){p=this.getMap().getPixelFromCoordinate(this.geom_[0]);ctx.lineTo(p[0],p[1]);}
ctx.stroke();}
ctx.restore();};ol.interaction.DrawTouch.prototype.setActive=function(b){ol.interaction.CenterTouch.prototype.setActive.call(this,b);if(!b)this.geom_=[];this.drawSketch_();};ol.interaction.DropFile=function(options)
{options=options||{};ol.interaction.DragAndDrop.call(this,{});var zone=options.zone||document;zone.addEventListener('dragenter',this.onstop);zone.addEventListener('dragover',this.onstop);zone.addEventListener('dragleave',this.onstop);this.formatConstructors_=options.formatConstructors||[ol.format.GPX,ol.format.GeoJSON,ol.format.IGC,ol.format.KML,ol.format.TopoJSON];this.projection_=options.projection;this.accept_=options.accept||["gpx","json","geojson","igc","kml","topojson"];var self=this;zone.addEventListener('drop',function(e){return self.ondrop(e);});};ol.ext.inherits(ol.interaction.DropFile,ol.interaction.DragAndDrop);ol.interaction.DropFile.prototype.setMap=function(map)
{ol.interaction.Interaction.prototype.setMap.call(this,map);};ol.interaction.DropFile.prototype.onstop=function(e)
{e.preventDefault();e.stopPropagation();return false;}
ol.interaction.DropFile.prototype.ondrop=function(e)
{e.preventDefault();if(e.dataTransfer&&e.dataTransfer.files.length)
{var self=this;var files=e.dataTransfer.files;var file;var pat=/\.([0-9a-z]+)(?=[?#])|(\.)(?:[\w]+)$/;for(var i=0;file=files[i];i++)
{var ex=file.name.match(pat)[0];self.dispatchEvent({type:'loadstart',file:file,filesize:file.size,filetype:file.type,fileextension:ex,projection:projection,target:self});var reader=new FileReader();var projection=this.projection_||this.getMap().getView().getProjection();var formatConstructors=this.formatConstructors_
if(!projection)return;var tryReadFeatures=function(format,result,options)
{try
{return format.readFeatures(result,options);}catch(e){}}
var theFile=file;reader.onload=function(e)
{var result=e.target.result;var features=[];var i,ii;for(i=0,ii=formatConstructors.length;i<ii;++i)
{var formatConstructor=formatConstructors[i];var format=new formatConstructor();features=tryReadFeatures(format,result,{featureProjection:projection});if(features&&features.length>0)
{self.dispatchEvent({type:'addfeatures',features:features,file:theFile,projection:projection,target:self});self.dispatchEvent({type:'loadend',features:features,file:theFile,projection:projection,target:self});return;}}
self.dispatchEvent({type:'loadend',file:theFile,target:self});};reader.readAsText(file);}}
return false;};ol.interaction.FillAttribute=function(options,properties){options=options||{};if(!options.condition)options.condition=ol.events.condition.click;ol.interaction.Select.call(this,options);this.setActive(options.active!==false)
this._attributes=properties;this.on('select',function(e){this.getFeatures().clear();this.fill(e.selected,this._attributes);}.bind(this));if(options.cursor!==false){var canvas=document.createElement('CANVAS');canvas.width=canvas.height=32;var ctx=canvas.getContext("2d");ctx.beginPath();ctx.moveTo(9,3);ctx.lineTo(2,9);ctx.lineTo(10,17);ctx.lineTo(17,11);ctx.closePath();ctx.fillStyle="#fff";ctx.fill();ctx.stroke();ctx.beginPath();ctx.moveTo(6,4);ctx.lineTo(0,8);ctx.lineTo(0,13);ctx.lineTo(3,17);ctx.lineTo(3,8);ctx.closePath();ctx.fillStyle="#000";ctx.fill();ctx.stroke();ctx.moveTo(8,8);ctx.lineTo(10,0);ctx.lineTo(11,0);ctx.lineTo(13,3);ctx.lineTo(13,7);ctx.stroke();this._cursor='url('+canvas.toDataURL()+') 0 13, auto';}};ol.ext.inherits(ol.interaction.FillAttribute,ol.interaction.Select);ol.interaction.FillAttribute.prototype.setActive=function(active){if(active===this.getActive())return;ol.interaction.Select.prototype.setActive.call(this,active);if(this.getMap()&&this._cursor){if(active){this._previousCursor=this.getMap().getTargetElement().style.cursor;this.getMap().getTargetElement().style.cursor=this._cursor;}else{this.getMap().getTargetElement().style.cursor=this._previousCursor;this._previousCursor=undefined;}}};ol.interaction.FillAttribute.prototype.setAttributes=function(properties){this._attributes=properties;};ol.interaction.FillAttribute.prototype.setAttribute=function(key,val){this._attributes[key]=val;};ol.interaction.FillAttribute.prototype.getAttributes=function(){return this._attributes;};ol.interaction.FillAttribute.prototype.getAttribute=function(key){return this._attributes[key];};ol.interaction.FillAttribute.prototype.fill=function(features,properties){if(features.length&&properties){this.dispatchEvent({type:'setattributestart',features:features,properties:properties});features.forEach(function(f){for(var p in properties){f.set(p,properties[p]);}});this.dispatchEvent({type:'setattributeend',features:features,properties:properties});}};ol.interaction.Flashlight=function(options){ol.interaction.Pointer.call(this,{handleDownEvent:this.setPosition,handleMoveEvent:this.setPosition});options=options||{};this.pos=false;this.radius=(options.radius||100);this.setColor(options);};ol.ext.inherits(ol.interaction.Flashlight,ol.interaction.Pointer);ol.interaction.Flashlight.prototype.setMap=function(map){if(this.getMap()){this.getMap().render();}
if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.interaction.Pointer.prototype.setMap.call(this,map);if(map){this._listener=map.on('postcompose',this.postcompose_.bind(this));}}
ol.interaction.Flashlight.prototype.setRadius=function(radius)
{this.radius=radius
if(this.getMap())this.getMap().renderSync();}
ol.interaction.Flashlight.prototype.setColor=function(options)
{var color=(options.fill?options.fill:[0,0,0,0.8]);var c=ol.color.asArray(color);this.startColor=ol.color.asString(c);if(options.color){c=this.endColor=ol.color.asString(ol.color.asArray(options.color)||options.color);}
else
{c[3]=0
this.endColor=ol.color.asString(c);}
c[3]=0.1;this.midColor=ol.color.asString(c);if(this.getMap())this.getMap().renderSync();}
ol.interaction.Flashlight.prototype.setPosition=function(e)
{if(e.pixel)this.pos=e.pixel;else this.pos=e;if(this.getMap())
{this.getMap().renderSync();}}
ol.interaction.Flashlight.prototype.postcompose_=function(e)
{var ctx=e.context;var ratio=e.frameState.pixelRatio;var w=ctx.canvas.width;var h=ctx.canvas.height;ctx.save();ctx.scale(ratio,ratio);if(!this.pos)
{ctx.fillStyle=this.startColor;ctx.fillRect(0,0,w,h);}
else
{var d=Math.max(w,h);var radGrd=ctx.createRadialGradient(this.pos[0],this.pos[1],w*this.radius/d,this.pos[0],this.pos[1],h*this.radius/d);radGrd.addColorStop(0,this.startColor);radGrd.addColorStop(0.8,this.midColor);radGrd.addColorStop(1,this.endColor);ctx.fillStyle=radGrd;ctx.fillRect(this.pos[0]-d,this.pos[1]-d,2*d,2*d);}
ctx.restore();};ol.interaction.FocusMap=function(){ol.interaction.Interaction.call(this,{});this.focusBt=ol.ext.element.create('BUTTON',{on:{focus:function(){this.dispatchEvent({type:'focus'});}.bind(this)},style:{position:'absolute',zIndex:-1,top:0,opacity:0}});};ol.ext.inherits(ol.interaction.FocusMap,ol.interaction.Interaction);ol.interaction.FocusMap.prototype.setMap=function(map){if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;if(this.getMap()){this.getMap().getViewport().removeChild(this.focusBt);}
ol.interaction.Interaction.prototype.setMap.call(this,map);if(this.getMap()){this._listener=this.getMap().on('pointerdown',function(){if(this.getActive())this.focusBt.focus();}.bind(this));this.getMap().getViewport().appendChild(this.focusBt);}};ol.interaction.GeolocationDraw=function(options){if(!options)options={};this.geolocation=new ol.Geolocation(({projection:"EPSG:4326",trackingOptions:{maximumAge:10000,enableHighAccuracy:true,timeout:600000}}));this.geolocation.on('change',this.draw_.bind(this));this.path_=[];this.lastPosition_=false;var white=[255,255,255,1];var blue=[0,153,255,1];var width=3;var circle=new ol.style.Circle({radius:width*2,fill:new ol.style.Fill({color:blue}),stroke:new ol.style.Stroke({color:white,width:width/2})});var style=[new ol.style.Style({stroke:new ol.style.Stroke({color:white,width:width+2})}),new ol.style.Style({stroke:new ol.style.Stroke({color:blue,width:width}),fill:new ol.style.Fill({color:[255,255,255,0.5]})})];var triangle=new ol.style.RegularShape({radius:width*3.5,points:3,rotation:0,fill:new ol.style.Fill({color:blue}),stroke:new ol.style.Stroke({color:white,width:width/2})});var c=triangle.getImage();var ctx=c.getContext("2d");var c2=document.createElement('canvas');c2.width=c2.height=c.width;c2.getContext("2d").drawImage(c,0,0);ctx.clearRect(0,0,c.width,c.height);ctx.drawImage(c2,0,0,c.width,c.height,width,0,c.width-2*width,c.height);var defaultStyle=function(f){if(f.get('heading')===undefined){style[1].setImage(circle);}else{style[1].setImage(triangle);triangle.setRotation(f.get('heading')||0);}
return style;}
this.locStyle={error:new ol.style.Style({fill:new ol.style.Fill({color:[255,0,0,0.2]})}),warn:new ol.style.Style({fill:new ol.style.Fill({color:[255,192,0,0.2]})}),ok:new ol.style.Style({fill:new ol.style.Fill({color:[0,255,0,0.2]})}),};this.overlayLayer_=new ol.layer.Vector({source:new ol.source.Vector(),name:'GeolocationDraw overlay',style:options.style||defaultStyle});this.sketch_=[new ol.Feature(),new ol.Feature(),new ol.Feature()];this.overlayLayer_.getSource().addFeatures(this.sketch_);this.features_=options.features;this.source_=options.source;this.condition_=options.condition||function(loc){return loc.getAccuracy()<this.get("minAccuracy")};ol.interaction.Interaction.call(this,{handleEvent:function(){return(!this.get('followTrack')||this.get('followTrack')=='auto');}});this.set("type",options.type||"LineString");this.set("attributes",options.attributes||{});this.set("minAccuracy",options.minAccuracy||20);this.set("tolerance",options.tolerance||5);this.set("zoom",options.zoom);this.setFollowTrack(options.followTrack===undefined?true:options.followTrack);this.setActive(false);};ol.ext.inherits(ol.interaction.GeolocationDraw,ol.interaction.Interaction);ol.interaction.GeolocationDraw.prototype.setMap=function(map){if(this.getMap())this.getMap().removeLayer(this.overlayLayer_);ol.interaction.Pointer.prototype.setMap.call(this,map);this.overlayLayer_.setMap(map);if(map)this.geolocation.setProjection(map.getView().getProjection());};ol.interaction.GeolocationDraw.prototype.setActive=function(active){if(active===this.getActive())return;ol.interaction.Interaction.prototype.setActive.call(this,active);this.overlayLayer_.setVisible(active);if(this.getMap()){this.geolocation.setTracking(active);this.getMap().renderSync();}
this.pause(!active);if(active){this.reset();this.dispatchEvent({type:'drawstart',feature:this.sketch_[1]});}else{var f=this.sketch_[1].clone();if(f.getGeometry()){if(this.features_)this.features_.push(f);if(this.source_)this.source_.addFeature(f);this.dispatchEvent({type:'drawend',feature:f});}}};ol.interaction.GeolocationDraw.prototype.reset=function(){this.sketch_[1].setGeometry();this.path_=[];this.lastPosition_=false;};ol.interaction.GeolocationDraw.prototype.start=function(){this.setActive(true);};ol.interaction.GeolocationDraw.prototype.stop=function(){this.setActive(false);};ol.interaction.GeolocationDraw.prototype.pause=function(b){this.pause_=b!==false;};ol.interaction.GeolocationDraw.prototype.isPaused=function(){return this.pause_;};ol.interaction.GeolocationDraw.prototype.setFollowTrack=function(follow){this.set('followTrack',follow);var map=this.getMap();if(follow!==false&&!this.lastPosition_&&map){var pos=this.path_[this.path_.length-1];if(pos){map.getView().animate({center:pos,zoom:(follow!="position"?this.get("zoom"):undefined)});}}
this.lastPosition_=false;this.dispatchEvent({type:'follow',following:follow!==false});};ol.interaction.GeolocationDraw.prototype.draw_=function(){var map=this.getMap();if(!map)return;var loc=this.geolocation;var accu=loc.getAccuracy();var pos=loc.getPosition();pos.push(Math.round((loc.getAltitude()||0)*100)/100);pos.push(Math.round((new Date()).getTime()/1000));var p=loc.getAccuracyGeometry();switch(this.get('followTrack')){case true:{if(this.get('followTrack')==true){map.getView().setZoom(this.get("zoom")||16);if(!ol.extent.containsExtent(map.getView().calculateExtent(map.getSize()),p.getExtent())){map.getView().fit(p.getExtent());}}
map.getView().setCenter(pos);break;}
case'position':{map.getView().setCenter(pos);break;}
case'auto':{if(this.lastPosition_){var center=map.getView().getCenter();if(center[0]!=this.lastPosition_[0]||center[1]!=this.lastPosition_[1]){this.setFollowTrack(false);}else{map.getView().setCenter(pos);this.lastPosition_=pos;}}else{map.getView().setCenter(pos);if(this.get("zoom"))map.getView().setZoom(this.get("zoom"));this.lastPosition_=pos;}
break;}
case'visible':{if(!ol.extent.containsCoordinate(map.getView().calculateExtent(map.getSize()),pos)){map.getView().setCenter(pos);}
break;}
default:break;}
var f=this.sketch_[0];f.setGeometry(p);if(accu<this.get("minAccuracy")/2)f.setStyle(this.locStyle.ok);else if(accu<this.get("minAccuracy"))f.setStyle(this.locStyle.warn);else f.setStyle(this.locStyle.error);var geo;if(!this.pause_&&this.condition_.call(this,loc)){f=this.sketch_[1];this.path_.push(pos);switch(this.get("type")){case"Point":this.path_=[pos];f.setGeometry(new ol.geom.Point(pos,'XYZM'));var attr=this.get('attributes');if(attr.heading)f.set("heading",loc.getHeading());if(attr.accuracy)f.set("accuracy",loc.getAccuracy());if(attr.altitudeAccuracy)f.set("altitudeAccuracy",loc.getAltitudeAccuracy());if(attr.speed)f.set("speed",loc.getSpeed());break;case"LineString":if(this.path_.length>1){geo=new ol.geom.LineString(this.path_,'XYZM');geo.simplify(this.get("tolerance"));f.setGeometry(geo);}else{f.setGeometry();}
break;case"Polygon":if(this.path_.length>2){geo=new ol.geom.Polygon([this.path_],'XYZM');geo.simplify(this.get("tolerance"));f.setGeometry(geo);}
else f.setGeometry();break;}
this.dispatchEvent({type:'drawing',feature:this.sketch_[1],geolocation:loc});}
this.sketch_[2].setGeometry(new ol.geom.Point(pos));this.sketch_[2].set("heading",loc.getHeading());this.dispatchEvent({type:'tracking',feature:this.sketch_[1],geolocation:loc});};ol.interaction.Hover=function(options)
{if(!options)options={};var self=this;ol.interaction.Interaction.call(this,{handleEvent:function(e)
{if(e.type=="pointermove"){self.handleMove_(e);}
if(options.handleEvent)return options.handleEvent(e);return true;}});this.setFeatureFilter(options.featureFilter);this.setLayerFilter(options.layerFilter);this.set('hitTolerance',options.hitTolerance)
this.setCursor(options.cursor);};ol.ext.inherits(ol.interaction.Hover,ol.interaction.Interaction);ol.interaction.Hover.prototype.setMap=function(map)
{if(this.previousCursor_!==undefined&&this.getMap())
{this.getMap().getTargetElement().style.cursor=this.previousCursor_;this.previousCursor_=undefined;}
ol.interaction.Interaction.prototype.setMap.call(this,map);};ol.interaction.Hover.prototype.setCursor=function(cursor)
{if(!cursor&&this.previousCursor_!==undefined&&this.getMap())
{this.getMap().getTargetElement().style.cursor=this.previousCursor_;this.previousCursor_=undefined;}
this.cursor_=cursor;};ol.interaction.Hover.prototype.setFeatureFilter=function(filter)
{if(typeof(filter)=='function')this.featureFilter_=filter;else this.featureFilter_=function(){return true;};};ol.interaction.Hover.prototype.setLayerFilter=function(filter)
{if(typeof(filter)=='function')this.layerFilter_=filter;else this.layerFilter_=function(){return true;};};ol.interaction.Hover.prototype.handleMove_=function(e)
{var map=this.getMap();if(map)
{var feature,layer;var self=this;var b=map.forEachFeatureAtPixel(e.pixel,function(f,l)
{if(self.layerFilter_.call(null,l)&&self.featureFilter_.call(null,f,l))
{feature=f;layer=l;return true;}
else
{feature=layer=null;return false;}},{hitTolerance:this.get('hitTolerance')});if(b)this.dispatchEvent({type:"hover",feature:feature,layer:layer,coordinate:e.coordinate,pixel:e.pixel,map:e.map,dragging:e.dragging});if(this.feature_===feature&&this.layer_===layer)
{}
else
{this.feature_=feature;this.layer_=layer;if(feature)this.dispatchEvent({type:"enter",feature:feature,layer:layer,coordinate:e.coordinate,pixel:e.pixel,map:e.map,dragging:e.dragging});else this.dispatchEvent({type:"leave",coordinate:e.coordinate,pixel:e.pixel,map:e.map,dragging:e.dragging});}
if(this.cursor_)
{var style=map.getTargetElement().style;if(b)
{if(style.cursor!=this.cursor_)
{this.previousCursor_=style.cursor;style.cursor=this.cursor_;}}
else if(this.previousCursor_!==undefined)
{style.cursor=this.previousCursor_;this.previousCursor_=undefined;}}}};ol.interaction.LongTouch=function(options)
{if(!options)options={};this.delay_=options.delay||1000;var ltouch=options.handleLongTouchEvent||function(){};var _timeout=null;ol.interaction.Interaction.call(this,{handleEvent:function(e)
{if(this.getActive())
{switch(e.type)
{case'pointerdown':if(_timeout)clearTimeout(_timeout);_timeout=setTimeout(function()
{e.type="longtouch";ltouch(e)},this.delay_);break;case'pointerdrag':case'pointerup':if(_timeout)
{clearTimeout(_timeout);_timeout=null;}
break;default:break;}}
else
{if(_timeout)
{clearTimeout(_timeout);_timeout=null;}}
return true;}});};ol.ext.inherits(ol.interaction.LongTouch,ol.interaction.Interaction);ol.interaction.Modify.prototype.getModifiedFeatures=function(){var featuresById={};this.dragSegments_.forEach(function(s){var feature=s[0].feature;if(window.ol&&window.ol.util)featuresById[ol.util.getUid(feature)]=feature;else featuresById[ol.getUid(feature)]=feature;});var features=[];for(var i in featuresById)features.push(featuresById[i]);return features;};ol.interaction.ModifyFeature=function(options){if(!options)options={};var dragging,modifying;ol.interaction.Pointer.call(this,{handleEvent:function(e){switch(e.type){case'pointerdown':{dragging=this.handleDownEvent(e);modifying=dragging||this._deleteCondition(e);return!dragging;}
case'pointerup':{dragging=false;return this.handleUpEvent(e);}
case'pointerdrag':{if(dragging)return this.handleDragEvent(e);else return true;}
case'pointermove':{if(!dragging)return this.handleMoveEvent(e);else return true;}
case'singleclick':case'click':{return!modifying;}
default:return true;}}});this.snapDistance_=options.pixelTolerance||10;this.tolerance_=1e-10;this.cursor_=options.cursor;this.sources_=options.sources?(options.sources instanceof Array)?options.sources:[options.sources]:[];if(options.features){this.sources_.push(new ol.source.Vector({features:options.features}));}
this.filterSplit_=options.filter||function(){return true;};this._condition=options.condition||ol.events.condition.primaryAction;this._deleteCondition=options.deleteCondition||ol.events.condition.altKeyOnly;this._insertVertexCondition=options.insertVertexCondition||ol.events.condition.always;var sketchStyle=function(){return[new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:[0,153,255,1]}),stroke:new ol.style.Stroke({color:'#FFF',width:1.25})})})];}
if(options.style){if(typeof(options.style)==='function'){sketchStyle=options.style}else{sketchStyle=function(){return options.style;}}}
this.overlayLayer_=new ol.layer.Vector({source:new ol.source.Vector({useSpatialIndex:false}),name:'Modify overlay',displayInLayerSwitcher:false,style:sketchStyle});};ol.ext.inherits(ol.interaction.ModifyFeature,ol.interaction.Pointer);ol.interaction.ModifyFeature.prototype.setMap=function(map){if(this.getMap())this.getMap().removeLayer(this.overlayLayer_);ol.interaction.Interaction.prototype.setMap.call(this,map);this.overlayLayer_.setMap(map);};ol.interaction.ModifyFeature.prototype.setActive=function(active){ol.interaction.Interaction.prototype.setActive.call(this,active);if(this.overlayLayer_)this.overlayLayer_.getSource().clear();};ol.interaction.ModifyFeature.prototype.getClosestFeature=function(e){var f,c,d=this.snapDistance_+1;for(var i=0;i<this.sources_.length;i++){var source=this.sources_[i];f=source.getClosestFeatureToCoordinate(e.coordinate);if(f&&this.filterSplit_(f)){var ci=f.getGeometry().getClosestPoint(e.coordinate);var di=ol.coordinate.dist2d(e.coordinate,ci)/e.frameState.viewState.resolution;if(di<d){d=di;c=ci;}
break;}}
if(d>this.snapDistance_){return false;}else{var coord=this.getNearestCoord(c,f.getGeometry());if(coord){coord=coord.coord;var p=this.getMap().getPixelFromCoordinate(coord);if(ol.coordinate.dist2d(e.pixel,p)<this.snapDistance_){c=coord;}
return{source:source,feature:f,coord:c};}}}
ol.interaction.ModifyFeature.prototype.getNearestCoord=function(pt,geom){var i,l,p,p0,dm;switch(geom.getType()){case'Point':{return{coord:geom.getCoordinates(),dist:ol.coordinate.dist2d(geom.getCoordinates(),pt)};}
case'MultiPoint':{return this.getNearestCoord(pt,new ol.geom.LineString(geom.getCoordinates()));}
case'LineString':case'LinearRing':{var d;dm=Number.MAX_VALUE;var coords=geom.getCoordinates();for(i=0;i<coords.length;i++){d=ol.coordinate.dist2d(pt,coords[i]);if(d<dm){dm=d;p0=coords[i];}}
return{coord:p0,dist:dm};}
case'MultiLineString':{var lstring=geom.getLineStrings();p0=false,dm=Number.MAX_VALUE;for(i=0;l=lstring[i];i++){p=this.getNearestCoord(pt,l);if(p&&p.dist<dm){p0=p;dm=p.dist;p0.ring=i;}}
return p0;}
case'Polygon':{var lring=geom.getLinearRings();p0=false;dm=Number.MAX_VALUE;for(i=0;l=lring[i];i++){p=this.getNearestCoord(pt,l);if(p&&p.dist<dm){p0=p;dm=p.dist;p0.ring=i;}}
return p0;}
case'MultiPolygon':{var poly=geom.getPolygons();p0=false;dm=Number.MAX_VALUE;for(i=0;l=poly[i];i++){p=this.getNearestCoord(pt,l);if(p&&p.dist<dm){p0=p;dm=p.dist;p0.poly=i;}}
return p0;}
case'GeometryCollection':{var g=geom.getGeometries();p0=false;dm=Number.MAX_VALUE;for(i=0;l=g[i];i++){p=this.getNearestCoord(pt,l);if(p&&p.dist<dm){p0=p;dm=p.dist;p0.geom=i;}}
return p0;}
default:return false;}};ol.interaction.ModifyFeature.prototype.getArcs=function(geom,coord){var arcs=false;var coords,i,s,l;switch(geom.getType()){case'Point':{if(ol.coordinate.equal(coord,geom.getCoordinates())){arcs={geom:geom,type:geom.getType(),coord1:[],coord2:[],node:true}}
break;}
case'MultiPoint':{coords=geom.getCoordinates();for(i=0;i<coords.length;i++){if(ol.coordinate.equal(coord,coords[i])){arcs={geom:geom,type:geom.getType(),index:i,coord1:[],coord2:[],node:true}
break;}}
break;}
case'LinearRing':case'LineString':{var p=geom.getClosestPoint(coord);if(ol.coordinate.dist2d(p,coord)<1.5*this.tolerance_){var split;if(geom.getType()==='LinearRing'){var g=new ol.geom.LineString(geom.getCoordinates());split=g.splitAt(coord,this.tolerance_);}else{split=geom.splitAt(coord,this.tolerance_);}
if(split.length>2){coords=split[1].getCoordinates();for(i=2;s=split[i];i++){var c=s.getCoordinates();c.shift();coords=coords.concat(c);}
split=[split[0],new ol.geom.LineString(coords)];}
if(split.length===2){var c0=split[0].getCoordinates();var c1=split[1].getCoordinates();var nbpt=c0.length+c1.length-1;c0.pop();c1.shift();arcs={geom:geom,type:geom.getType(),coord1:c0,coord2:c1,node:(geom.getCoordinates().length===nbpt),closed:false}}else if(split.length===1){s=split[0].getCoordinates();var start=ol.coordinate.equal(s[0],coord);var end=ol.coordinate.equal(s[s.length-1],coord);if(start){s.shift();if(end)s.pop();arcs={geom:geom,type:geom.getType(),coord1:[],coord2:s,node:true,closed:end}}else if(end){s.pop()
arcs={geom:geom,type:geom.getType(),coord1:s,coord2:[],node:true,closed:false}}}}
break;}
case'MultiLineString':{var lstring=geom.getLineStrings();for(i=0;l=lstring[i];i++){arcs=this.getArcs(l,coord);if(arcs){arcs.geom=geom;arcs.type=geom.getType();arcs.lstring=i;break;}}
break;}
case'Polygon':{var lring=geom.getLinearRings();for(i=0;l=lring[i];i++){arcs=this.getArcs(l,coord);if(arcs){arcs.geom=geom;arcs.type=geom.getType();arcs.index=i;break;}}
break;}
case'MultiPolygon':{var poly=geom.getPolygons();for(i=0;l=poly[i];i++){arcs=this.getArcs(l,coord);if(arcs){arcs.geom=geom;arcs.type=geom.getType();arcs.poly=i;break;}}
break;}
case'GeometryCollection':{for(i=0;l=g[i];i++){arcs=this.getArcs(l,coord);if(arcs){arcs.geom=geom;arcs.g=i;arcs.typeg=arcs.type;arcs.type=geom.getType();break;}}
break;}
default:{console.error('ol/interaction/ModifyFeature '+geom.getType()+' not supported!');break;}}
return arcs;};ol.interaction.ModifyFeature.prototype.handleDownEvent=function(evt){if(!this.getActive())return false;var current=this.getClosestFeature(evt);if(current&&(this._condition(evt)||this._deleteCondition(evt))){var features=[];this.arcs=[];this.sources_.forEach(function(s){var extent=ol.extent.buffer(ol.extent.boundingExtent([current.coord]),this.tolerance_);features=features.concat(features,s.getFeaturesInExtent(extent));}.bind(this));this._modifiedFeatures=[];features.forEach(function(f){var a=this.getArcs(f.getGeometry(),current.coord);if(a){if(this._insertVertexCondition(evt)||a.node){a.feature=f;this._modifiedFeatures.push(f);this.arcs.push(a);}}}.bind(this));if(this._modifiedFeatures.length){if(this._deleteCondition(evt)){return!this._removePoint(current,evt);}else{this.dispatchEvent({type:'modifystart',coordinate:current.coord,originalEvent:evt.originalEvent,features:this._modifiedFeatures});this.handleDragEvent({coordinate:current.coord})
return true;}}else{return true;}}else{return false;}};ol.interaction.ModifyFeature.prototype.getModifiedFeatures=function(){return this._modifiedFeatures||[];};ol.interaction.ModifyFeature.prototype.removePoint=function(){this._removePoint({},{});};ol.interaction.ModifyFeature.prototype._getModification=function(a){var coords=a.coord1.concat(a.coord2);switch(a.type){case'LineString':{if(a.closed)coords.push(coords[0]);if(coords.length>1){if(a.geom.getCoordinates().length!=coords.length){a.coords=coords;return true;}}
break;}
case'MultiLineString':{if(a.closed)coords.push(coords[0]);if(coords.length>1){var c=a.geom.getCoordinates();if(c[a.lstring].length!=coords.length){c[a.lstring]=coords;a.coords=c;return true;}}
break;}
case'Polygon':{if(a.closed)coords.push(coords[0]);if(coords.length>3){c=a.geom.getCoordinates();if(c[a.index].length!=coords.length){c[a.index]=coords;a.coords=c;return true;}}
break;}
case'MultiPolygon':{if(a.closed)coords.push(coords[0]);if(coords.length>3){c=a.geom.getCoordinates();if(c[a.poly][a.index].length!=coords.length){c[a.poly][a.index]=coords;a.coords=c;return true;}}
break;}
case'GeometryCollection':{a.type=a.typeg;var geom=a.geom;var geoms=geom.getGeometries();a.geom=geoms[a.g];var found=this._getModification(a);geom.setGeometries(geoms);a.geom=geom;a.type='GeometryCollection';return found;}
default:{break;}}
return false;};ol.interaction.ModifyFeature.prototype._removePoint=function(current,evt){if(!this.arcs)return false;this.overlayLayer_.getSource().clear();var found=false;this.arcs.forEach(function(a){found=found||this._getModification(a);}.bind(this));if(found){this.dispatchEvent({type:'modifystart',coordinate:current.coord,originalEvent:evt.originalEvent,features:this._modifiedFeatures});this.arcs.forEach(function(a){if(a.geom.getType()==='GeometryCollection'){if(a.coords){var geoms=a.geom.getGeometries();geoms[a.g].setCoordinates(a.coords);a.geom.setGeometries(geoms);}}else{if(a.coords)a.geom.setCoordinates(a.coords);}}.bind(this));this.dispatchEvent({type:'modifyend',coordinate:current.coord,originalEvent:evt.originalEvent,features:this._modifiedFeatures});}
this.arcs=[];return found;};ol.interaction.ModifyFeature.prototype.handleUpEvent=function(e){if(!this.getActive())return false;if(!this.arcs||!this.arcs.length)return true;this.overlayLayer_.getSource().clear();this.dispatchEvent({type:'modifyend',coordinate:e.coordinate,originalEvent:e.originalEvent,features:this._modifiedFeatures});return true;};ol.interaction.ModifyFeature.prototype.setArcCoordinates=function(a,coords){var c;switch(a.type){case'Point':{a.geom.setCoordinates(coords[0]);break;}
case'MultiPoint':{c=a.geom.getCoordinates();c[a.index]=coords[0];a.geom.setCoordinates(c);break;}
case'LineString':{a.geom.setCoordinates(coords);break;}
case'MultiLineString':{c=a.geom.getCoordinates();c[a.lstring]=coords;a.geom.setCoordinates(c);break;}
case'Polygon':{c=a.geom.getCoordinates();c[a.index]=coords;a.geom.setCoordinates(c);break;}
case'MultiPolygon':{c=a.geom.getCoordinates();c[a.poly][a.index]=coords;a.geom.setCoordinates(c);break;}
case'GeometryCollection':{a.type=a.typeg;var geom=a.geom;var geoms=geom.getGeometries();a.geom=geoms[a.g];this.setArcCoordinates(a,coords);geom.setGeometries(geoms);a.geom=geom;a.type='GeometryCollection';break;}}};ol.interaction.ModifyFeature.prototype.handleDragEvent=function(e){if(!this.getActive())return false;if(!this.arcs)return true;this.overlayLayer_.getSource().clear();var p=new ol.Feature(new ol.geom.Point(e.coordinate));this.overlayLayer_.getSource().addFeature(p);if(!this.arcs.length)return true;this.arcs.forEach(function(a){var coords=a.coord1.concat([e.coordinate],a.coord2);if(a.closed)coords.push(e.coordinate);this.setArcCoordinates(a,coords);}.bind(this));this.dispatchEvent({type:'modifying',coordinate:e.coordinate,originalEvent:e.originalEvent,features:this._modifiedFeatures});return true;};ol.interaction.ModifyFeature.prototype.handleMoveEvent=function(e){if(!this.getActive())return false;this.overlayLayer_.getSource().clear();var current=this.getClosestFeature(e);if(current){var p=new ol.Feature(new ol.geom.Point(current.coord));this.overlayLayer_.getSource().addFeature(p);}
var element=e.map.getTargetElement();if(this.cursor_){if(current){if(element.style.cursor!=this.cursor_){this.previousCursor_=element.style.cursor;element.style.cursor=this.cursor_;}}else if(this.previousCursor_!==undefined){element.style.cursor=this.previousCursor_;this.previousCursor_=undefined;}}};ol.interaction.ModifyTouch=function(options){var self=this;if(!options)options={};this._popup=new ol.Overlay.Popup({popupClass:options.calssName||'modifytouch',positioning:'bottom-rigth',offsetBox:10});this._source=options.source;this._features=options.features;var a=document.createElement('a');a.appendChild(document.createTextNode(options.title||"remove point"));a.onclick=function(){self.removePoint();};this.setPopupContent(a);var pixelTolerance=options.pixelTolerance||0;var searchDist=pixelTolerance+5;options.condition=function(e){var features=this.getMap().getFeaturesAtPixel(e.pixel,{hitTolerance:searchDist});var p0,p1,found=false;if(features){var search=this._features;if(!search){p0=[e.pixel[0]-searchDist,e.pixel[1]-searchDist]
p1=[e.pixel[0]+searchDist,e.pixel[1]+searchDist]
p0=this.getMap().getCoordinateFromPixel(p0);p1=this.getMap().getCoordinateFromPixel(p1);var ext=ol.extent.boundingExtent([p0,p1]);search=this._source.getFeaturesInExtent(ext);}
if(search.getArray)search=search.getArray();for(var i=0,f;f=features[i];i++){if(search.indexOf(f)>=0)break;}
if(f){p0=e.pixel;p1=f.getGeometry().getClosestPoint(e.coordinate);p1=this.getMap().getPixelFromCoordinate(p1);var dx=p0[0]-p1[0];var dy=p0[1]-p1[1];found=(Math.sqrt(dx*dx+dy*dy)<searchDist);}}
this.showDeleteBt(found?{type:'show',feature:f,coordinate:e.coordinate}:{type:'hide'});e.preventDefault();e.stopPropagation();return true;};options.insertVertexCondition=function(){this.showDeleteBt({type:'hide'});return true;}
ol.interaction.Modify.call(this,options);this.on(['modifystart','modifyend'],function(){this.showDeleteBt({type:'hide',modifying:true});});this.set('usePopup',options.usePopup!==false);};ol.ext.inherits(ol.interaction.ModifyTouch,ol.interaction.Modify);ol.interaction.ModifyTouch.prototype.setMap=function(map){if(this.getMap()){this.getMap().removeOverlay(this._popup);}
ol.interaction.Modify.prototype.setMap.call(this,map);if(this.getMap()){this.getMap().addOverlay(this._popup);}};ol.interaction.ModifyTouch.prototype.setActive=function(b){ol.interaction.Modify.prototype.setActive.call(this,b);this.showDeleteBt({type:'hide'});};ol.interaction.ModifyTouch.prototype.removePoint=function(){if(new Date()-this._timeout<200)return;ol.interaction.Modify.prototype.removePoint.call(this);this.showDeleteBt({type:'hide'});}
ol.interaction.ModifyTouch.prototype.showDeleteBt=function(e){if(this.get('usePopup')&&e.type==='show'){this._popup.show(e.coordinate,this._menu);}else{this._popup.hide();}
e.type+='popup';this.dispatchEvent(e);this._timeout=new Date();};ol.interaction.ModifyTouch.prototype.setPopupContent=function(html){this._menu=html;}
ol.interaction.ModifyTouch.prototype.getPopupContent=function(){return this._menu;}
ol.interaction.Offset=function(options){if(!options)options={};ol.interaction.Pointer.call(this,{handleDownEvent:this.handleDownEvent_,handleDragEvent:this.handleDragEvent_,handleMoveEvent:this.handleMoveEvent_,handleUpEvent:this.handleUpEvent_});this.features_=options.features;this.layers_=options.layers?(options.layers instanceof Array)?options.layers:[options.layers]:null;this.set('duplicate',options.duplicate);this.source_=options.source;this.previousCursor_=false;};ol.ext.inherits(ol.interaction.Offset,ol.interaction.Pointer);ol.interaction.Offset.prototype.setMap=function(map){ol.interaction.Pointer.prototype.setMap.call(this,map);};ol.interaction.Offset.prototype.getFeatureAtPixel_=function(e){var self=this;return this.getMap().forEachFeatureAtPixel(e.pixel,function(feature,layer){var current;if(self.layers_){for(var i=0;i<self.layers_.length;i++){if(self.layers_[i]===layer){current=feature;break;}}}
else if(self.features_){self.features_.forEach(function(f){if(f===feature){current=feature}});}
else{current=feature;}
var typeGeom=current.getGeometry().getType();if(current&&/Polygon|LineString/.test(typeGeom)){if(typeGeom==='Polygon'&&current.getGeometry().getCoordinates().length>1)return false;var p=current.getGeometry().getClosestPoint(e.coordinate);var dx=p[0]-e.coordinate[0];var dy=p[1]-e.coordinate[1];var d=Math.sqrt(dx*dx+dy*dy)/e.frameState.viewState.resolution;if(d<5){return{feature:current,hit:p,coordinates:current.getGeometry().getCoordinates(),geom:current.getGeometry().clone(),geomType:typeGeom}}else{return false;}}else{return false;}},{hitTolerance:5});};ol.interaction.Offset.prototype.handleDownEvent_=function(e){this.current_=this.getFeatureAtPixel_(e);if(this.source_&&(this.get('duplicate')||e.originalEvent.ctrlKey)){this.current_.feature=this.current_.feature.clone();this.source_.addFeature(this.current_.feature);}else{if(this.current_){this.dispatchEvent({type:'modifystart',features:[this.current_.feature]});}}
if(this.current_){this.dispatchEvent({type:'offsetstart',feature:this.current_.feature,offset:0});return true;}else{return false;}};ol.interaction.Offset.prototype.handleDragEvent_=function(e){var p=this.current_.geom.getClosestPoint(e.coordinate);var d=ol.coordinate.dist2d(p,e.coordinate);var seg,v1,v2,offset;switch(this.current_.geomType){case'Polygon':{seg=ol.coordinate.findSegment(p,this.current_.coordinates[0]).segment;if(seg){v1=[seg[1][0]-seg[0][0],seg[1][1]-seg[0][1]];v2=[e.coordinate[0]-p[0],e.coordinate[1]-p[1]];if(v1[0]*v2[1]-v1[1]*v2[0]>0){d=-d;}
offset=[];for(var i=0;i<this.current_.coordinates.length;i++){offset.push(ol.coordinate.offsetCoords(this.current_.coordinates[i],i==0?d:-d));}
this.current_.feature.setGeometry(new ol.geom.Polygon(offset));}
break;}
case'LineString':{seg=ol.coordinate.findSegment(p,this.current_.coordinates).segment;if(seg){v1=[seg[1][0]-seg[0][0],seg[1][1]-seg[0][1]];v2=[e.coordinate[0]-p[0],e.coordinate[1]-p[1]];if(v1[0]*v2[1]-v1[1]*v2[0]>0){d=-d;}
offset=ol.coordinate.offsetCoords(this.current_.coordinates,d);this.current_.feature.setGeometry(new ol.geom.LineString(offset));}
break;}
default:{break;}}
this.dispatchEvent({type:'offsetting',feature:this.current_.feature,offset:d,segment:[p,e.coordinate],coordinate:e.coordinate});};ol.interaction.Offset.prototype.handleUpEvent_=function(e){this.dispatchEvent({type:'offsetend',feature:this.current_.feature,coordinate:e.coordinate});this.current_=false;};ol.interaction.Offset.prototype.handleMoveEvent_=function(e){var f=this.getFeatureAtPixel_(e);if(f){if(this.previousCursor_===false){this.previousCursor_=e.map.getTargetElement().style.cursor;}
e.map.getTargetElement().style.cursor='pointer';}else{e.map.getTargetElement().style.cursor=this.previousCursor_;this.previousCursor_=false;}};ol.interaction.Ripple=function(options){ol.interaction.Pointer.call(this,{handleDownEvent:this.rainDrop,handleMoveEvent:this.rainDrop});options=options||{};this.riprad=options.radius||3;this.ripplemap=[];this.last_map=[];this.rains(this.interval);options.layer.on(['postcompose','postrender'],this.postcompose_.bind(this));};ol.ext.inherits(ol.interaction.Ripple,ol.interaction.Pointer);ol.interaction.Ripple.prototype.rains=function(interval){if(this.onrain)clearTimeout(this.onrain);var self=this;var vdelay=(typeof(interval)=="number"?interval:1000)/2;var delay=3*vdelay/2;var rnd=Math.random;function rain(){if(self.width)self.rainDrop([rnd()*self.width,rnd()*self.height]);self.onrain=setTimeout(rain,rnd()*vdelay+delay);}
if(delay)rain();}
ol.interaction.Ripple.prototype.rainDrop=function(e){if(!this.width)return;var dx,dy;if(e.pixel){dx=e.pixel[0]*this.ratio;dy=e.pixel[1]*this.ratio;}else{dx=e[0]*this.ratio;dy=e[1]*this.ratio;}
dx<<=0;dy<<=0;for(var j=dy-this.riprad*this.ratio;j<dy+this.riprad*this.ratio;j++){for(var k=dx-this.riprad*this.ratio;k<dx+this.riprad*this.ratio;k++){this.ripplemap[this.oldind+(j*this.width)+k]+=128;}}}
ol.interaction.Ripple.prototype.postcompose_=function(e){var ctx=e.context;var canvas=ctx.canvas;if(this.width!=canvas.width||this.height!=canvas.height){this.width=canvas.width;this.height=canvas.height;this.ratio=e.frameState.pixelRatio;this.half_width=this.width>>1;this.half_height=this.height>>1;this.size=this.width*(this.height+2)*2;this.oldind=this.width;this.newind=this.width*(this.height+3);for(var i=0;i<this.size;i++){this.last_map[i]=this.ripplemap[i]=0;}}
this.texture=ctx.getImageData(0,0,this.width,this.height);this.ripple=ctx.getImageData(0,0,this.width,this.height);var a,b,data,cur_pixel,new_pixel;var t=this.oldind;this.oldind=this.newind;this.newind=t;i=0;var _rd=this.ripple.data,_td=this.texture.data;for(var y=0;y<this.height;y++){for(var x=0;x<this.width;x++){var _newind=this.newind+i,_mapind=this.oldind+i;data=(this.ripplemap[_mapind-this.width]+
this.ripplemap[_mapind+this.width]+
this.ripplemap[_mapind-1]+
this.ripplemap[_mapind+1])>>1;data-=this.ripplemap[_newind];data-=data>>5;this.ripplemap[_newind]=data;data=1024-data;if(this.last_map[i]!=data){this.last_map[i]=data;a=(((x-this.half_width)*data/1024)<<0)+this.half_width;b=(((y-this.half_height)*data/1024)<<0)+this.half_height;if(a>=this.width)a=this.width-1;if(a<0)a=0;if(b>=this.height)b=this.height-1;if(b<0)b=0;new_pixel=(a+(b*this.width))*4;cur_pixel=i*4;_rd[cur_pixel]=_td[new_pixel];_rd[cur_pixel+1]=_td[new_pixel+1];_rd[cur_pixel+2]=_td[new_pixel+2];}
++i;}}
ctx.putImageData(this.ripple,0,0);this.getMap().render();};ol.interaction.SelectCluster=function(options)
{options=options||{};var fn;this.pointRadius=options.pointRadius||12;this.circleMaxObjects=options.circleMaxObjects||10;this.maxObjects=options.maxObjects||60;this.spiral=(options.spiral!==false);this.animate=options.animate;this.animationDuration=options.animationDuration||500;this.selectCluster_=(options.selectCluster!==false);var overlay=this.overlayLayer_=new ol.layer.Vector({source:new ol.source.Vector({features:new ol.Collection(),wrapX:options.wrapX,useSpatialIndex:true}),name:'Cluster overlay',updateWhileAnimating:true,updateWhileInteracting:true,displayInLayerSwitcher:false,style:options.featureStyle});if(options.layers)
{if(typeof(options.layers)=="function")
{fn=options.layers;options.layers=function(layer)
{return(layer===overlay||fn(layer));};}
else if(options.layers.push)
{options.layers.push(this.overlayLayer_);}}
if(options.filter)
{fn=options.filter;options.filter=function(f,l)
{if(!l&&f.get("selectclusterlink"))return false;else return fn(f,l);};}
else options.filter=function(f,l)
{if(!l&&f.get("selectclusterlink"))return false;else return true;};this.filter_=options.filter;ol.interaction.Select.call(this,options);this.on("select",this.selectCluster.bind(this));};ol.ext.inherits(ol.interaction.SelectCluster,ol.interaction.Select);ol.interaction.SelectCluster.prototype.setMap=function(map){if(this.getMap()){this.getMap().removeLayer(this.overlayLayer_);}
if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.interaction.Select.prototype.setMap.call(this,map);this.overlayLayer_.setMap(map);if(map&&map.getView()){this._listener=map.getView().on('change:resolution',this.clear.bind(this));}};ol.interaction.SelectCluster.prototype.clear=function()
{this.getFeatures().clear();this.overlayLayer_.getSource().clear();};ol.interaction.SelectCluster.prototype.getLayer=function()
{return this.overlayLayer_;};ol.interaction.SelectCluster.prototype.selectCluster=function(e)
{if(!e.selected.length)
{this.clear();return;}
var feature=e.selected[0];if(feature.get('selectclusterfeature'))return;var source=this.overlayLayer_.getSource();source.clear();var cluster=feature.get('features');if(!cluster||cluster.length==1)return;if(!this.selectCluster_)this.getFeatures().clear();var center=feature.getGeometry().getCoordinates();var pix=this.getMap().getView().getResolution();var r=pix*this.pointRadius*(0.5+cluster.length/4);var a,i,max;var p,cf,lk;var features=[];if(!this.spiral||cluster.length<=this.circleMaxObjects)
{max=Math.min(cluster.length,this.circleMaxObjects);for(i=0;i<max;i++)
{a=2*Math.PI*i/max;if(max==2||max==4)a+=Math.PI/4;p=[center[0]+r*Math.sin(a),center[1]+r*Math.cos(a)];cf=new ol.Feature({'selectclusterfeature':true,'features':[cluster[i]],geometry:new ol.geom.Point(p)});cf.setStyle(cluster[i].getStyle());features.push(cf);lk=new ol.Feature({'selectclusterlink':true,geometry:new ol.geom.LineString([center,p])});features.push(lk);}}
else
{a=0;r;var d=2*this.pointRadius;max=Math.min(this.maxObjects,cluster.length);for(i=0;i<max;i++)
{r=d/2+d*a/(2*Math.PI);a=a+(d+0.1)/r;var dx=pix*r*Math.sin(a)
var dy=pix*r*Math.cos(a)
p=[center[0]+dx,center[1]+dy];cf=new ol.Feature({'selectclusterfeature':true,'features':[cluster[i]],geometry:new ol.geom.Point(p)});cf.setStyle(cluster[i].getStyle());features.push(cf);lk=new ol.Feature({'selectclusterlink':true,geometry:new ol.geom.LineString([center,p])});features.push(lk);}}
source.clear();if(this.animate){this.animateCluster_(center,features);}else{source.addFeatures(features);}};ol.interaction.SelectCluster.prototype.animateCluster_=function(center,features)
{if(this.listenerKey_){ol.Observable.unByKey(this.listenerKey_);}
if(!features.length)return;var style=this.overlayLayer_.getStyle();var stylefn=(typeof(style)=='function')?style:style.length?function(){return style;}:function(){return[style];};var duration=this.animationDuration||500;var start=new Date().getTime();function animate(event){var vectorContext=event.vectorContext||ol.render.getVectorContext(event);var ratio=event.frameState.pixelRatio;var res=this.getMap().getView().getResolution();var e=ol.easing.easeOut((event.frameState.time-start)/duration);for(var i=0,feature;feature=features[i];i++)if(feature.get('features'))
{var pt=feature.getGeometry().getCoordinates();pt[0]=center[0]+e*(pt[0]-center[0]);pt[1]=center[1]+e*(pt[1]-center[1]);var geo=new ol.geom.Point(pt);var st=stylefn(feature,res);for(var s=0;s<st.length;s++)
{var sc;var imgs=ol.Map.prototype.getFeaturesAtPixel?false:st[s].getImage();if(imgs)
{sc=imgs.getScale();imgs.setScale(ratio);}
if(vectorContext.setStyle)
{vectorContext.setStyle(st[s]);vectorContext.drawGeometry(geo);}
else
{vectorContext.setImageStyle(imgs);vectorContext.drawPointGeometry(geo);}
if(imgs)imgs.setScale(sc);}}
if(e>1.0){ol.Observable.unByKey(this.listenerKey_);this.overlayLayer_.getSource().addFeatures(features);this.overlayLayer_.changed();return;}
event.frameState.animate=true;}
this.listenerKey_=this.overlayLayer_.on(['postcompose','postrender'],animate.bind(this));var feature=new ol.Feature(new ol.geom.Point(this.getMap().getView().getCenter()));feature.setStyle(new ol.style.Style({image:new ol.style.Circle({})}));this.overlayLayer_.getSource().addFeature(feature);};ol.interaction.SnapGuides=function(options){if(!options)options={};function getIntersectionPoint(d1,d2)
{var d1x=d1[1][0]-d1[0][0];var d1y=d1[1][1]-d1[0][1];var d2x=d2[1][0]-d2[0][0];var d2y=d2[1][1]-d2[0][1];var det=d1x*d2y-d1y*d2x;if(det!=0)
{var k=(d1x*d1[0][1]-d1x*d2[0][1]-d1y*d1[0][0]+d1y*d2[0][0])/det;return[d2[0][0]+k*d2x,d2[0][1]+k*d2y];}
else return false;}
function dist2D(p1,p2)
{var dx=p1[0]-p2[0];var dy=p1[1]-p2[1];return Math.sqrt(dx*dx+dy*dy);}
this.snapDistance_=options.pixelTolerance||10;this.enableInitialGuides_=options.enableInitialGuides||false;var sketchStyle=[new ol.style.Style({stroke:new ol.style.Stroke({color:'#ffcc33',lineDash:[8,5],width:1.25})})];if(options.style)sketchStyle=options.style instanceof Array?options.style:[options.style];this.overlaySource_=new ol.source.Vector({features:new ol.Collection(),useSpatialIndex:false});this.overlayLayer_=new ol.layer.Vector({renderMode:'image',source:this.overlaySource_,style:function(){return sketchStyle;},name:'Snap overlay',displayInLayerSwitcher:false});ol.interaction.Interaction.call(this,{handleEvent:function(e){if(this.getActive()){var features=this.overlaySource_.getFeatures();var prev=null;var p=null;var res=e.frameState.viewState.resolution;for(var i=0,f;f=features[i];i++){var c=f.getGeometry().getClosestPoint(e.coordinate);if(dist2D(c,e.coordinate)/res<this.snapDistance_){if(prev){var c2=getIntersectionPoint(prev.getGeometry().getCoordinates(),f.getGeometry().getCoordinates());if(c2){if(dist2D(c2,e.coordinate)/res<this.snapDistance_){p=c2;}}}else{p=c;}
prev=f;}}
if(p)e.coordinate=p;}
return true;}});};ol.ext.inherits(ol.interaction.SnapGuides,ol.interaction.Interaction);ol.interaction.SnapGuides.prototype.setMap=function(map){if(this.getMap())this.getMap().removeLayer(this.overlayLayer_);ol.interaction.Interaction.prototype.setMap.call(this,map);this.overlayLayer_.setMap(map);if(map)this.projExtent_=map.getView().getProjection().getExtent();};ol.interaction.SnapGuides.prototype.setActive=function(active)
{this.overlayLayer_.setVisible(active);ol.interaction.Interaction.prototype.setActive.call(this,active);}
ol.interaction.SnapGuides.prototype.clearGuides=function(features)
{if(!features)this.overlaySource_.clear();else
{for(var i=0,f;f=features[i];i++)
{try{this.overlaySource_.removeFeature(f);}catch(e){}}}}
ol.interaction.SnapGuides.prototype.getGuides=function()
{return this.overlaySource_.getFeaturesCollection();}
ol.interaction.SnapGuides.prototype.addGuide=function(v,ortho){if(v)
{var map=this.getMap();var extent=map.getView().calculateExtent(map.getSize());var guideLength=Math.max(this.projExtent_[2]-this.projExtent_[0],this.projExtent_[3]-this.projExtent_[1]);extent=ol.extent.buffer(extent,guideLength*1.5);if(extent[0]<this.projExtent_[0])extent[0]=this.projExtent_[0];if(extent[1]<this.projExtent_[1])extent[1]=this.projExtent_[1];if(extent[2]>this.projExtent_[2])extent[2]=this.projExtent_[2];if(extent[3]>this.projExtent_[3])extent[3]=this.projExtent_[3];var dx=v[0][0]-v[1][0];var dy=v[0][1]-v[1][1];var d=1/Math.sqrt(dx*dx+dy*dy);var generateLine=function(loopDir){var p,g=[];var loopCond=guideLength*loopDir*2;for(var i=0;loopDir>0?i<loopCond:i>loopCond;i+=(guideLength*loopDir)/100){if(ortho)p=[v[0][0]+dy*d*i,v[0][1]-dx*d*i];else p=[v[0][0]+dx*d*i,v[0][1]+dy*d*i];if(ol.extent.containsCoordinate(extent,p))g.push(p);else break;}
return new ol.Feature(new ol.geom.LineString([g[0],g[g.length-1]]));}
var f0=generateLine(1);var f1=generateLine(-1);this.overlaySource_.addFeature(f0);this.overlaySource_.addFeature(f1);return[f0,f1];}};ol.interaction.SnapGuides.prototype.addOrthoGuide=function(v)
{return this.addGuide(v,true);};ol.interaction.SnapGuides.prototype.setDrawInteraction=function(drawi){var self=this;var nb=0;var features=[];function setGuides(e){var coord=e.target.getCoordinates();var s=2;switch(e.target.getType()){case'Point':return;case'Polygon':coord=coord[0].slice(0,-1);break;default:break;}
var l=coord.length;if(l===s&&self.enableInitialGuides_){var x=coord[0][0];var y=coord[0][1];coord=[[x,y],[x,y-1]];}
if(l!=nb&&(self.enableInitialGuides_?l>=s:l>s)){self.clearGuides(features);var p1=coord[l-s],p2=coord[l-s-1];if(l>s&&!(p1[0]===p2[0]&&p1[1]===p2[1])){features=self.addOrthoGuide([coord[l-s],coord[l-s-1]]);}
features=features.concat(self.addGuide([coord[0],coord[1]]));features=features.concat(self.addOrthoGuide([coord[0],coord[1]]));nb=l;}}
drawi.on("drawstart",function(e){e.feature.getGeometry().on("change",setGuides);});drawi.on(["drawend","change:active"],function(e){self.clearGuides(features);if(e.feature)e.feature.getGeometry().un("change",setGuides);nb=0;features=[];});};ol.interaction.SnapGuides.prototype.setModifyInteraction=function(modifyi){function mod(d,n){return((d%n)+n)%n;}
var self=this;var features=[];function computeGuides(e){var selectedVertex=e.target.vertexFeature_
if(!selectedVertex)return;var f=e.target.getModifiedFeatures()[0];var geom=f.getGeometry();var coord=geom.getCoordinates();switch(geom.getType()){case'Point':return;case'Polygon':coord=coord[0].slice(0,-1);break;default:break;}
var modifyVertex=selectedVertex.getGeometry().getCoordinates();var idx=coord.findIndex(function(c){return c[0]===modifyVertex[0]&&c[1]===modifyVertex[1]});var l=coord.length;self.clearGuides(features);features=self.addOrthoGuide([coord[mod(idx-1,l)],coord[mod(idx-2,l)]]);features=features.concat(self.addGuide([coord[mod(idx-1,l)],coord[mod(idx-2,l)]]));features=features.concat(self.addGuide([coord[mod(idx+1,l)],coord[mod(idx+2,l)]]));features=features.concat(self.addOrthoGuide([coord[mod(idx+1,l)],coord[mod(idx+2,l)]]));}
function setGuides(e){setTimeout(computeGuides,0,e);}
function drawEnd(){self.clearGuides(features);features=[];}
modifyi.on("modifystart",setGuides);modifyi.on("modifyend",drawEnd);};ol.interaction.Split=function(options){if(!options)options={};ol.interaction.Interaction.call(this,{handleEvent:function(e){switch(e.type){case"singleclick":return this.handleDownEvent(e);case"pointermove":return this.handleMoveEvent(e);default:return true;}}});this.snapDistance_=options.snapDistance||25;this.tolerance_=options.tolerance||1e-10;this.cursor_=options.cursor;this.sources_=options.sources?(options.sources instanceof Array)?options.sources:[options.sources]:[];if(options.features){this.sources_.push(new ol.source.Vector({features:options.features}));}
this.filterSplit_=options.filter||function(){return true;};var white=[255,255,255,1];var blue=[0,153,255,1];var width=3;var fill=new ol.style.Fill({color:'rgba(255,255,255,0.4)'});var stroke=new ol.style.Stroke({color:'#3399CC',width:1.25});var sketchStyle=[new ol.style.Style({image:new ol.style.Circle({fill:fill,stroke:stroke,radius:5}),fill:fill,stroke:stroke})];var featureStyle=[new ol.style.Style({stroke:new ol.style.Stroke({color:white,width:width+2})}),new ol.style.Style({image:new ol.style.Circle({radius:2*width,fill:new ol.style.Fill({color:blue}),stroke:new ol.style.Stroke({color:white,width:width/2})}),stroke:new ol.style.Stroke({color:blue,width:width})}),];if(options.sketchStyle)sketchStyle=options.sketchStyle instanceof Array?options.sketchStyle:[options.sketchStyle];if(options.featureStyle)featureStyle=options.featureStyle instanceof Array?options.featureStyle:[options.featureStyle];this.overlayLayer_=new ol.layer.Vector({source:new ol.source.Vector({useSpatialIndex:false}),name:'Split overlay',displayInLayerSwitcher:false,style:function(f){if(f._sketch_)return sketchStyle;else return featureStyle;}});};ol.ext.inherits(ol.interaction.Split,ol.interaction.Interaction);ol.interaction.Split.prototype.setMap=function(map){if(this.getMap())this.getMap().removeLayer(this.overlayLayer_);ol.interaction.Interaction.prototype.setMap.call(this,map);this.overlayLayer_.setMap(map);};ol.interaction.Split.prototype.getClosestFeature=function(e){var f,c,g,d=this.snapDistance_+1;for(var i=0;i<this.sources_.length;i++){var source=this.sources_[i];f=source.getClosestFeatureToCoordinate(e.coordinate);if(f&&f.getGeometry().splitAt){c=f.getGeometry().getClosestPoint(e.coordinate);g=new ol.geom.LineString([e.coordinate,c]);d=g.getLength()/e.frameState.viewState.resolution;break;}}
if(d>this.snapDistance_){return false;}else{var coord=this.getNearestCoord(c,f.getGeometry().getCoordinates());var p=this.getMap().getPixelFromCoordinate(coord);if(ol.coordinate.dist2d(e.pixel,p)<this.snapDistance_){c=coord;}
return{source:source,feature:f,coord:c,link:g};}}
ol.interaction.Split.prototype.getNearestCoord=function(pt,coords){var d,dm=Number.MAX_VALUE,p0;for(var i=0;i<coords.length;i++){d=ol.coordinate.dist2d(pt,coords[i]);if(d<dm){dm=d;p0=coords[i];}}
return p0;};ol.interaction.Split.prototype.handleDownEvent=function(evt){var current=this.getClosestFeature(evt);if(current){var self=this;self.overlayLayer_.getSource().clear();var split=current.feature.getGeometry().splitAt(current.coord,this.tolerance_);var i;if(split.length>1){var tosplit=[];for(i=0;i<split.length;i++){var f=current.feature.clone();f.setGeometry(split[i]);tosplit.push(f);}
self.dispatchEvent({type:'beforesplit',original:current.feature,features:tosplit});current.source.dispatchEvent({type:'beforesplit',original:current.feature,features:tosplit});current.source.removeFeature(current.feature);for(i=0;i<tosplit.length;i++){current.source.addFeature(tosplit[i]);}
self.dispatchEvent({type:'aftersplit',original:current.feature,features:tosplit});current.source.dispatchEvent({type:'aftersplit',original:current.feature,features:tosplit});}}
return false;};ol.interaction.Split.prototype.handleMoveEvent=function(e){var map=e.map;this.overlayLayer_.getSource().clear();var current=this.getClosestFeature(e);if(current&&this.filterSplit_(current.feature)){var p,l;this.overlayLayer_.getSource().addFeature(current.feature);p=new ol.Feature(new ol.geom.Point(current.coord));p._sketch_=true;this.overlayLayer_.getSource().addFeature(p);l=new ol.Feature(current.link);l._sketch_=true;this.overlayLayer_.getSource().addFeature(l);this.dispatchEvent({type:'pointermove',coordinate:e.coordinate,frameState:e.frameState,originalEvent:e.originalEvent,map:e.map,pixel:e.pixel,feature:current.feature,linkGeometry:current.link});}else{this.dispatchEvent(e);}
var element=map.getTargetElement();if(this.cursor_){if(current){if(element.style.cursor!=this.cursor_){this.previousCursor_=element.style.cursor;element.style.cursor=this.cursor_;}}else if(this.previousCursor_!==undefined){element.style.cursor=this.previousCursor_;this.previousCursor_=undefined;}}};ol.interaction.Splitter=function(options)
{if(!options)options={};ol.interaction.Interaction.call(this,{handleEvent:function(e)
{if(e.type!="pointermove"&&e.type!="pointerdrag")
{if(this.lastEvent_)
{this.splitSource(this.lastEvent_.feature);this.lastEvent_=null;}
this.moving_=false;}
else this.moving_=true;return true;},});this.added_=[];this.removed_=[];if(options.features)
{this.source_=new ol.source.Vector({features:options.features});}
else
{this.source_=options.source?options.source:new ol.source.Vector({features:new ol.Collection()});}
var trigger=this.triggerSource;if(options.triggerFeatures)
{trigger=new ol.source.Vector({features:options.triggerFeatures});}
if(trigger)
{trigger.on("addfeature",this.onAddFeature.bind(this));trigger.on("changefeature",this.onChangeFeature.bind(this));trigger.on("removefeature",this.onRemoveFeature.bind(this));}
else
{this.source_.on("addfeature",this.onAddFeature.bind(this));this.source_.on("changefeature",this.onChangeFeature.bind(this));this.source_.on("removefeature",this.onRemoveFeature.bind(this));}
this.tolerance_=options.tolerance||1e-10;this.filterSplit_=options.filter||function(){return true;};};ol.ext.inherits(ol.interaction.Splitter,ol.interaction.Interaction);ol.interaction.Splitter.prototype.intersectSegs=function(s1,s2)
{var tol=this.tolerance_;var x12=s1[0][0]-s1[1][0];var x34=s2[0][0]-s2[1][0];var y12=s1[0][1]-s1[1][1];var y34=s2[0][1]-s2[1][1];var det=x12*y34-y12*x34;if(Math.abs(det)<tol)
{return false;}
else
{var r1=((s1[0][0]-s2[1][0])*y34-(s1[0][1]-s2[1][1])*x34)/det;if(Math.abs(r1)<tol)return s1[0];if(Math.abs(1-r1)<tol)return s1[1];if(r1<0||r1>1)return false;var r2=((s1[0][1]-s2[1][1])*x12-(s1[0][0]-s2[1][0])*y12)/det;if(Math.abs(r2)<tol)return s2[1];if(Math.abs(1-r2)<tol)return s2[0];if(r2<0||r2>1)return false;var a=s1[0][0]*s1[1][1]-s1[0][1]*s1[1][0];var b=s2[0][0]*s2[1][1]-s2[0][1]*s2[1][0];var p=[(a*x34-b*x12)/det,(a*y34-b*y12)/det];return p;}};ol.interaction.Splitter.prototype.splitSource=function(feature)
{if(this.splitting)return;var self=this;var i,k,f2;this.source_.dispatchEvent({type:'beforesplit',feaure:feature,source:this.source_});this.splitting=true;this.added_=[];this.removed_=[];var c=feature.getGeometry().getCoordinates();var seg,split=[];function intersect(f)
{if(f!==feature)
{var c2=f.getGeometry().getCoordinates();for(var j=0;j<c2.length-1;j++)
{var p=this.intersectSegs(seg,[c2[j],c2[j+1]]);if(p)
{split.push(p);g=f.getGeometry().splitAt(p,this.tolerance_);if(g&&g.length>1)
{found=f;return true;}}}}
return false;}
for(i=0;i<c.length-1;i++)
{seg=[c[i],c[i+1]];var extent=ol.extent.buffer(ol.extent.boundingExtent(seg),this.tolerance_);var g;while(true)
{var found=false;this.source_.forEachFeatureIntersectingExtent(extent,intersect.bind(this));if(found)
{var f=found;this.source_.removeFeature(f);for(k=0;k<g.length;k++)
{f2=f.clone();f2.setGeometry(g[k]);this.source_.addFeature(f2);}}
else break;}}
for(i=0;i<c.length-2;i++)
{for(var j=i+1;j<c.length-1;j++)
{var p=this.intersectSegs([c[i],c[i+1]],[c[j],c[j+1]]);if(p&&p!=c[i+1])
{split.push(p);}}}
var splitOriginal=false;if(split.length)
{var result=feature.getGeometry().splitAt(split,this.tolerance_);if(result.length>1)
{for(k=0;k<result.length;k++)
{f2=feature.clone();f2.setGeometry(result[k]);this.source_.addFeature(f2);}
splitOriginal=true;}}
setTimeout(function()
{if(splitOriginal)self.source_.removeFeature(feature);self.source_.dispatchEvent({type:'aftersplit',featureAdded:self.added_,featureRemoved:self.removed_,source:this.source_});self.splitting=false;},0);};ol.interaction.Splitter.prototype.onAddFeature=function(e)
{this.splitSource(e.feature);if(this.splitting)
{this.added_.push(e.feature);}};ol.interaction.Splitter.prototype.onRemoveFeature=function(e)
{if(this.splitting)
{var n=this.added_.indexOf(e.feature);if(n==-1)
{this.removed_.push(e.feature);}
else
{this.added_.splice(n,1);}}};ol.interaction.Splitter.prototype.onChangeFeature=function(e)
{if(this.moving_)
{this.lastEvent_=e;}
else this.splitSource(e.feature);};ol.interaction.Synchronize=function(options)
{if(!options)options={};var self=this;ol.interaction.Interaction.call(this,{handleEvent:function(e)
{if(e.type=="pointermove"){self.handleMove_(e);}
return true;}});this.maps=options.maps;};ol.ext.inherits(ol.interaction.Synchronize,ol.interaction.Interaction);ol.interaction.Synchronize.prototype.setMap=function(map)
{if(this._listener){ol.Observable.unByKey(this._listener.center);ol.Observable.unByKey(this._listener.rotation);ol.Observable.unByKey(this._listener.resolution);this.getMap().getTargetElement().removeEventListener('mouseout',this._listener.mouseout);}
this._listener=null;ol.interaction.Interaction.prototype.setMap.call(this,map);if(map){this._listener={};this._listener.center=this.getMap().getView().on('change:center',this.syncMaps.bind(this));this._listener.rotation=this.getMap().getView().on('change:rotation',this.syncMaps.bind(this));this._listener.resolution=this.getMap().getView().on('change:resolution',this.syncMaps.bind(this));this._listener.mouseout=this.handleMouseOut_.bind(this);this.getMap().getTargetElement().addEventListener('mouseout',this._listener.mouseout);this.syncMaps();}};ol.interaction.Synchronize.prototype.syncMaps=function(e)
{var map=this.getMap();if(!e)e={type:'all'};if(map)
{for(var i=0;i<this.maps.length;i++)
{switch(e.type)
{case'change:rotation':if(this.maps[i].getView().getRotation()!=map.getView().getRotation())
this.maps[i].getView().setRotation(map.getView().getRotation());break;case'change:center':if(this.maps[i].getView().getCenter()!=map.getView().getCenter())
this.maps[i].getView().setCenter(map.getView().getCenter());break;case'change:resolution':if(this.maps[i].getView().getResolution()!=map.getView().getResolution())
{this.maps[i].getView().setResolution(map.getView().getResolution());}
break;default:this.maps[i].getView().setRotation(map.getView().getRotation());this.maps[i].getView().setCenter(map.getView().getCenter());this.maps[i].getView().setResolution(map.getView().getResolution());break;}}}};ol.interaction.Synchronize.prototype.handleMove_=function(e)
{for(var i=0;i<this.maps.length;i++)
{this.maps[i].showTarget(e.coordinate);}
this.getMap().showTarget();};ol.interaction.Synchronize.prototype.handleMouseOut_=function(){for(var i=0;i<this.maps.length;i++){this.maps[i].targetOverlay_.setPosition(undefined);}};ol.Map.prototype.showTarget=function(coord)
{if(!this.targetOverlay_)
{var elt=document.createElement("div");elt.classList.add("ol-target");this.targetOverlay_=new ol.Overlay({element:elt});this.targetOverlay_.setPositioning('center-center');this.addOverlay(this.targetOverlay_);elt.parentElement.classList.add("ol-target-overlay");this.targetOverlay_.setPosition([0,0]);}
this.targetOverlay_.setPosition(coord);};ol.Map.prototype.hideTarget=function()
{this.removeOverlay(this.targetOverlay_);this.targetOverlay_=undefined;};ol.interaction.TinkerBell=function(options){options=options||{};ol.interaction.Pointer.call(this,{handleDownEvent:this.onMove,handleMoveEvent:this.onMove});this.set('color',options.color?ol.color.asString(options.color):"#fff");this.sparkle=[0,0];this.sparkles=[];this.lastSparkle=this.time=new Date();var self=this;this.out_=function(){self.isout_=true;};this.isout_=true;};ol.ext.inherits(ol.interaction.TinkerBell,ol.interaction.Pointer);ol.interaction.TinkerBell.prototype.setMap=function(map){if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;if(this.getMap()){map.getViewport().removeEventListener('mouseout',this.out_,false);this.getMap().render();}
ol.interaction.Pointer.prototype.setMap.call(this,map);if(map){this._listener=map.on('postcompose',this.postcompose_.bind(this));map.getViewport().addEventListener('mouseout',this.out_,false);}};ol.interaction.TinkerBell.prototype.onMove=function(e){this.sparkle=e.pixel;this.isout_=false;this.getMap().render();};ol.interaction.TinkerBell.prototype.postcompose_=function(e){var delta=15;var ctx=e.context||ol.ext.getMapCanvas(this.getMap()).getContext('2d');var dt=e.frameState.time-this.time;this.time=e.frameState.time;if(e.frameState.time-this.lastSparkle>30&&!this.isout_){this.lastSparkle=e.frameState.time;this.sparkles.push({p:[this.sparkle[0]+Math.random()*delta-delta/2,this.sparkle[1]+Math.random()*delta],o:1});}
ctx.save();ctx.scale(e.frameState.pixelRatio,e.frameState.pixelRatio);ctx.fillStyle=this.get("color");for(var i=this.sparkles.length-1,p;p=this.sparkles[i];i--){if(p.o<0.2){this.sparkles.splice(0,i+1);break;}
ctx.globalAlpha=p.o;ctx.beginPath();ctx.arc(p.p[0],p.p[1],2.2,0,2*Math.PI,false);ctx.fill();p.o*=0.98;p.p[0]+=(Math.random()-0.5);p.p[1]+=dt*(1+Math.random())/30;}
ctx.restore();if(this.sparkles.length)this.getMap().render();};ol.interaction.TouchCompass=function(options){options=options||{};var opt={};opt.handleDownEvent=function(e)
{var s=this.getCenter_();var dx=e.pixel[0]-s[0];var dy=e.pixel[1]-s[1];this.start=e;return(Math.sqrt(dx*dx+dy*dy)<this.size/2);};opt.handleDragEvent=function(e)
{if(!this.pos)
{this.pos=this.start;this.getMap().renderSync();}
this.pos=e;};opt.handleUpEvent=function()
{this.pos=false;return true;};ol.interaction.Pointer.call(this,opt);this.ondrag_=options.onDrag;this.size=options.size||80;this.alpha=options.alpha||0.5;if(!ol.interaction.TouchCompass.prototype.compass)
{var canvas=ol.interaction.TouchCompass.prototype.compass=document.createElement('canvas');var ctx=canvas.getContext("2d");var s=canvas.width=canvas.height=this.size;var w=s/10;var r=s/2;var r2=0.22*r;ctx.translate(r,r);ctx.fillStyle="#999";ctx.strokeStyle="#ccc";ctx.lineWidth=w;ctx.beginPath();ctx.arc(0,0,s*0.42,0,2*Math.PI);ctx.fill();ctx.stroke();ctx.fillStyle="#99f";ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(r,0);ctx.lineTo(r2,r2);ctx.moveTo(0,0);ctx.lineTo(-r,0);ctx.lineTo(-r2,-r2);ctx.moveTo(0,0);ctx.lineTo(0,r);ctx.lineTo(-r2,r2);ctx.moveTo(0,0);ctx.lineTo(0,-r);ctx.lineTo(r2,-r2);ctx.moveTo(0,0);ctx.fill();ctx.fillStyle="#eee";ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(r,0);ctx.lineTo(r2,-r2);ctx.moveTo(0,0);ctx.lineTo(-r,0);ctx.lineTo(-r2,r2);ctx.moveTo(0,0);ctx.lineTo(0,r);ctx.lineTo(r2,r2);ctx.moveTo(0,0);ctx.lineTo(0,-r);ctx.lineTo(-r2,-r2);ctx.moveTo(0,0);ctx.fill();}};ol.ext.inherits(ol.interaction.TouchCompass,ol.interaction.Pointer);ol.interaction.TouchCompass.prototype.compass=null;ol.interaction.TouchCompass.prototype.setMap=function(map){if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.interaction.Pointer.prototype.setMap.call(this,map);if(map){this._listener=map.on('postcompose',this.drawCompass_.bind(this));ol.ext.getMapCanvas(map);}};ol.interaction.TouchCompass.prototype.setActive=function(b)
{ol.interaction.Pointer.prototype.setActive.call(this,b);if(this.getMap())this.getMap().renderSync();}
ol.interaction.TouchCompass.prototype.getCenter_=function()
{var margin=10;var s=this.size;var c=this.getMap().getSize();return[c[0]/2,c[1]-margin-s/2];}
ol.interaction.TouchCompass.prototype.drawCompass_=function(e)
{if(!this.getActive())return;var ctx=e.context||ol.ext.getMapCanvas(this.getMap()).getContext('2d');var ratio=e.frameState.pixelRatio;ctx.save();ctx.scale(ratio,ratio);ctx.globalAlpha=this.alpha;ctx.strokeStyle="#fff";ctx.lineWidth=5;var s=this.size;var c=this.getCenter_();ctx.drawImage(this.compass,0,0,this.compass.width,this.compass.height,c[0]-s/2,c[1]-s/2,s,s);if(this.pos)
{var dx=this.pos.pixel[0]-this.start.pixel[0];var dy=this.pos.pixel[1]-this.start.pixel[1];for(var i=1;i<=4;i++)
{ctx.beginPath();ctx.arc(c[0]+dx/4*i,c[1]+dy/4*i,s/2*(0.6+0.4*i/4),0,2*Math.PI);ctx.stroke();}}
ctx.restore();if(this.pos)
{if(this.ondrag_)
{var r=this.getMap().getView().getResolution();var delta={dpixel:[this.pos.pixel[0]-this.start.pixel[0],this.pos.pixel[1]-this.start.pixel[1]]}
delta.traction=[delta.dpixel[0]*r,-delta.dpixel[1]*r];this.ondrag_(delta,this.pos);}
e.frameState.animate=true;}};ol.interaction.Transform=function(options){if(!options)options={};var self=this;this.selection_=new ol.Collection();this.handles_=new ol.Collection();this.overlayLayer_=new ol.layer.Vector({source:new ol.source.Vector({features:this.handles_,useSpatialIndex:false,wrapX:false}),name:'Transform overlay',displayInLayerSwitcher:false,style:function(feature){return(self.style[(feature.get('handle')||'default')+(feature.get('constraint')||'')+(feature.get('option')||'')]);},});ol.interaction.Pointer.call(this,{handleDownEvent:this.handleDownEvent_,handleDragEvent:this.handleDragEvent_,handleMoveEvent:this.handleMoveEvent_,handleUpEvent:this.handleUpEvent_});this.features_=options.features;if(typeof(options.filter)==='function')this._filter=options.filter;this.layers_=options.layers?(options.layers instanceof Array)?options.layers:[options.layers]:null;this._handleEvent=options.condition||function(){return true;};this.addFn_=options.addCondition||function(){return false;};this.set('translateFeature',(options.translateFeature!==false));this.set('translate',(options.translate!==false));this.set('stretch',(options.stretch!==false));this.set('scale',(options.scale!==false));this.set('rotate',(options.rotate!==false));this.set('keepAspectRatio',(options.keepAspectRatio||function(e){return e.originalEvent.shiftKey}));this.set('modifyCenter',(options.modifyCenter||function(e){return e.originalEvent.metaKey||e.originalEvent.ctrlKey}));this.set('noFlip',(options.noFlip||false));this.set('selection',(options.selection!==false));this.set('hitTolerance',(options.hitTolerance||0));this.set('enableRotatedTransform',(options.enableRotatedTransform||false));this.on('propertychange',function(){this.drawSketch_();});this.setDefaultStyle();};ol.ext.inherits(ol.interaction.Transform,ol.interaction.Pointer);ol.interaction.Transform.prototype.Cursors={'default':'auto','select':'pointer','translate':'move','rotate':'move','rotate0':'move','scale':'nesw-resize','scale1':'nwse-resize','scale2':'nesw-resize','scale3':'nwse-resize','scalev':'ew-resize','scaleh1':'ns-resize','scalev2':'ew-resize','scaleh3':'ns-resize'};ol.interaction.Transform.prototype.setMap=function(map){if(this.getMap()){this.getMap().removeLayer(this.overlayLayer_);if(this.previousCursor_){this.getMap().getTargetElement().style.cursor=this.previousCursor_;this.previousCursor_=undefined;}}
ol.interaction.Pointer.prototype.setMap.call(this,map);this.overlayLayer_.setMap(map);if(map===null){this.select(null);}
if(map!==null){this.isTouch=/touch/.test(map.getViewport().className);this.setDefaultStyle();}};ol.interaction.Transform.prototype.setActive=function(b){this.select(null);this.overlayLayer_.setVisible(b);ol.interaction.Pointer.prototype.setActive.call(this,b);};ol.interaction.Transform.prototype.setDefaultStyle=function(){var stroke=new ol.style.Stroke({color:[255,0,0,1],width:1});var strokedash=new ol.style.Stroke({color:[255,0,0,1],width:1,lineDash:[4,4]});var fill0=new ol.style.Fill({color:[255,0,0,0.01]});var fill=new ol.style.Fill({color:[255,255,255,0.8]});var circle=new ol.style.RegularShape({fill:fill,stroke:stroke,radius:this.isTouch?12:6,points:15});circle.getAnchor()[0]=this.isTouch?-10:-5;var bigpt=new ol.style.RegularShape({fill:fill,stroke:stroke,radius:this.isTouch?16:8,points:4,angle:Math.PI/4});var smallpt=new ol.style.RegularShape({fill:fill,stroke:stroke,radius:this.isTouch?12:6,points:4,angle:Math.PI/4});function createStyle(img,stroke,fill){return[new ol.style.Style({image:img,stroke:stroke,fill:fill})];}
this.style={'default':createStyle(bigpt,strokedash,fill0),'translate':createStyle(bigpt,stroke,fill),'rotate':createStyle(circle,stroke,fill),'rotate0':createStyle(bigpt,stroke,fill),'scale':createStyle(bigpt,stroke,fill),'scale1':createStyle(bigpt,stroke,fill),'scale2':createStyle(bigpt,stroke,fill),'scale3':createStyle(bigpt,stroke,fill),'scalev':createStyle(smallpt,stroke,fill),'scaleh1':createStyle(smallpt,stroke,fill),'scalev2':createStyle(smallpt,stroke,fill),'scaleh3':createStyle(smallpt,stroke,fill),};this.drawSketch_();}
ol.interaction.Transform.prototype.setStyle=function(style,olstyle){if(!olstyle)return;if(olstyle instanceof Array)this.style[style]=olstyle;else this.style[style]=[olstyle];for(var i=0;i<this.style[style].length;i++){var im=this.style[style][i].getImage();if(im){if(style=='rotate')im.getAnchor()[0]=-5;if(this.isTouch)im.setScale(1.8);}
var tx=this.style[style][i].getText();if(tx){if(style=='rotate')tx.setOffsetX(this.isTouch?14:7);if(this.isTouch)tx.setScale(1.8);}}
this.drawSketch_();};ol.interaction.Transform.prototype.getFeatureAtPixel_=function(pixel){var self=this;return this.getMap().forEachFeatureAtPixel(pixel,function(feature,layer){var found=false;if(!layer){if(feature===self.bbox_)return false;self.handles_.forEach(function(f){if(f===feature)found=true;});if(found)return{feature:feature,handle:feature.get('handle'),constraint:feature.get('constraint'),option:feature.get('option')};}
if(!self.get('selection')){if(self.selection_.getArray().some(function(f){return feature===f;})){return{feature:feature};}
return null;}
if(self._filter){if(self._filter(feature,layer))return{feature:feature};else return null;}
else if(self.layers_){for(var i=0;i<self.layers_.length;i++){if(self.layers_[i]===layer)return{feature:feature};}
return null;}
else if(self.features_){self.features_.forEach(function(f){if(f===feature)found=true;});if(found)return{feature:feature};else return null;}
else return{feature:feature};},{hitTolerance:this.get('hitTolerance')})||{};}
ol.interaction.Transform.prototype.getGeometryRotateToZero_=function(f,clone){var origGeom=f.getGeometry();var viewRotation=this.getMap().getView().getRotation();if(viewRotation===0||!this.get('enableRotatedTransform')){return(clone)?origGeom.clone():origGeom;}
var rotGeom=origGeom.clone();rotGeom.rotate(viewRotation*-1,this.getMap().getView().getCenter());return rotGeom;}
ol.interaction.Transform.prototype.drawSketch_=function(center){var i,f,geom;this.overlayLayer_.getSource().clear();if(!this.selection_.getLength())return;var viewRotation=this.getMap().getView().getRotation();var ext=this.getGeometryRotateToZero_(this.selection_.item(0)).getExtent();ext=ol.extent.buffer(ext,0);this.selection_.forEach(function(f){var extendExt=this.getGeometryRotateToZero_(f).getExtent();ol.extent.extend(ext,extendExt);}.bind(this));if(center===true){if(!this.ispt_){this.overlayLayer_.getSource().addFeature(new ol.Feature({geometry:new ol.geom.Point(this.center_),handle:'rotate0'}));geom=ol.geom.Polygon.fromExtent(ext);if(this.get('enableRotatedTransform')&&viewRotation!==0){geom.rotate(viewRotation,this.getMap().getView().getCenter())}
f=this.bbox_=new ol.Feature(geom);this.overlayLayer_.getSource().addFeature(f);}}
else{if(this.ispt_){var p=this.getMap().getPixelFromCoordinate([ext[0],ext[1]]);ext=ol.extent.boundingExtent([this.getMap().getCoordinateFromPixel([p[0]-10,p[1]-10]),this.getMap().getCoordinateFromPixel([p[0]+10,p[1]+10])]);}
geom=ol.geom.Polygon.fromExtent(ext);if(this.get('enableRotatedTransform')&&viewRotation!==0){geom.rotate(viewRotation,this.getMap().getView().getCenter())}
f=this.bbox_=new ol.Feature(geom);var features=[];var g=geom.getCoordinates()[0];if(!this.ispt_){features.push(f);if(!this.iscircle_&&this.get('stretch')&&this.get('scale'))for(i=0;i<g.length-1;i++){f=new ol.Feature({geometry:new ol.geom.Point([(g[i][0]+g[i+1][0])/2,(g[i][1]+g[i+1][1])/2]),handle:'scale',constraint:i%2?"h":"v",option:i});features.push(f);}
if(this.get('scale'))for(i=0;i<g.length-1;i++){f=new ol.Feature({geometry:new ol.geom.Point(g[i]),handle:'scale',option:i});features.push(f);}
if(this.get('translate')&&!this.get('translateFeature')){f=new ol.Feature({geometry:new ol.geom.Point([(g[0][0]+g[2][0])/2,(g[0][1]+g[2][1])/2]),handle:'translate'});features.push(f);}}
if(!this.iscircle_&&this.get('rotate')){f=new ol.Feature({geometry:new ol.geom.Point(g[3]),handle:'rotate'});features.push(f);}
this.overlayLayer_.getSource().addFeatures(features);}};ol.interaction.Transform.prototype.select=function(feature,add){if(!feature){this.selection_.clear();this.drawSketch_();return;}
if(!feature.getGeometry||!feature.getGeometry())return;if(add){this.selection_.push(feature);}else{var index=this.selection_.getArray().indexOf(feature);this.selection_.removeAt(index);}
this.ispt_=(this.selection_.getLength()===1?(this.selection_.item(0).getGeometry().getType()=="Point"):false);this.iscircle_=(this.selection_.getLength()===1?(this.selection_.item(0).getGeometry().getType()=="Circle"):false);this.drawSketch_();this.watchFeatures_();this.dispatchEvent({type:'select',feature:feature,features:this.selection_});};ol.interaction.Transform.prototype.watchFeatures_=function(){if(this._featureListeners){this._featureListeners.forEach(function(l){ol.Observable.unByKey(l)});}
this._featureListeners=[];this.selection_.forEach(function(f){this._featureListeners.push(f.on('change',function(){this.drawSketch_();}.bind(this)));}.bind(this));};ol.interaction.Transform.prototype.handleDownEvent_=function(evt){if(!this._handleEvent(evt,this.selection_))return;var sel=this.getFeatureAtPixel_(evt.pixel);var feature=sel.feature;if(this.selection_.getLength()&&this.selection_.getArray().indexOf(feature)>=0&&((this.ispt_&&this.get('translate'))||this.get('translateFeature'))){sel.handle='translate';}
if(sel.handle){this.mode_=sel.handle;this.opt_=sel.option;this.constraint_=sel.constraint;var viewRotation=this.getMap().getView().getRotation();this.coordinate_=evt.coordinate;this.pixel_=evt.pixel;this.geoms_=[];this.rotatedGeoms_=[];var extent=ol.extent.createEmpty();var rotExtent=ol.extent.createEmpty();for(var i=0,f;f=this.selection_.item(i);i++){this.geoms_.push(f.getGeometry().clone());extent=ol.extent.extend(extent,f.getGeometry().getExtent());if(this.get('enableRotatedTransform')&&viewRotation!==0){var rotGeom=this.getGeometryRotateToZero_(f,true);this.rotatedGeoms_.push(rotGeom);rotExtent=ol.extent.extend(rotExtent,rotGeom.getExtent());}}
this.extent_=(ol.geom.Polygon.fromExtent(extent)).getCoordinates()[0];if(this.get('enableRotatedTransform')&&viewRotation!==0){this.rotatedExtent_=(ol.geom.Polygon.fromExtent(rotExtent)).getCoordinates()[0];}
if(this.mode_==='rotate'){this.center_=this.getCenter()||ol.extent.getCenter(extent);if(this.get('enableRotatedTransform')&&viewRotation!==0){this.rotatedCenter_=this.getCenter()||ol.extent.getCenter(rotExtent);}
var element=evt.map.getTargetElement();element.style.cursor=this.Cursors.rotate0;this.previousCursor_=element.style.cursor;}else{this.center_=ol.extent.getCenter(extent);if(this.get('enableRotatedTransform')&&viewRotation!==0){this.rotatedCenter_=ol.extent.getCenter(rotExtent);}}
this.angle_=Math.atan2(this.center_[1]-evt.coordinate[1],this.center_[0]-evt.coordinate[0]);if(this.get('enableRotatedTransform')&&viewRotation!==0){var downPoint=new ol.geom.Point(evt.coordinate);downPoint.rotate(viewRotation*-1,this.rotatedCenter_);this.rotatedCoordinate_=downPoint.getCoordinates();}
this.dispatchEvent({type:this.mode_+'start',feature:this.selection_.item(0),features:this.selection_,pixel:evt.pixel,coordinate:evt.coordinate});return true;}
else if(this.get('selection')){if(feature){if(!this.addFn_(evt))this.selection_.clear();var index=this.selection_.getArray().indexOf(feature);if(index<0)this.selection_.push(feature);else this.selection_.removeAt(index);}else{this.selection_.clear();}
this.ispt_=this.selection_.getLength()===1?(this.selection_.item(0).getGeometry().getType()=="Point"):false;this.iscircle_=(this.selection_.getLength()===1?(this.selection_.item(0).getGeometry().getType()=="Circle"):false);this.drawSketch_();this.watchFeatures_();this.dispatchEvent({type:'select',feature:feature,features:this.selection_,pixel:evt.pixel,coordinate:evt.coordinate});return false;}};ol.interaction.Transform.prototype.getFeatures=function(){return this.selection_;};ol.interaction.Transform.prototype.getCenter=function(){return this.get('center');};ol.interaction.Transform.prototype.setCenter=function(c){return this.set('center',c);}
ol.interaction.Transform.prototype.handleDragEvent_=function(evt){if(!this._handleEvent(evt,this.features_))return;var i,f,geometry;switch(this.mode_){case'rotate':{var a=Math.atan2(this.center_[1]-evt.coordinate[1],this.center_[0]-evt.coordinate[0]);if(!this.ispt){for(i=0,f;f=this.selection_.item(i);i++){geometry=this.geoms_[i].clone();geometry.rotate(a-this.angle_,this.center_);if(geometry.getType()=='Circle')geometry.setCenterAndRadius(geometry.getCenter(),geometry.getRadius());f.setGeometry(geometry);}}
this.drawSketch_(true);this.dispatchEvent({type:'rotating',feature:this.selection_.item(0),features:this.selection_,angle:a-this.angle_,pixel:evt.pixel,coordinate:evt.coordinate});break;}
case'translate':{var deltaX=evt.coordinate[0]-this.coordinate_[0];var deltaY=evt.coordinate[1]-this.coordinate_[1];for(i=0,f;f=this.selection_.item(i);i++){f.getGeometry().translate(deltaX,deltaY);}
this.handles_.forEach(function(f){f.getGeometry().translate(deltaX,deltaY);});this.coordinate_=evt.coordinate;this.dispatchEvent({type:'translating',feature:this.selection_.item(0),features:this.selection_,delta:[deltaX,deltaY],pixel:evt.pixel,coordinate:evt.coordinate});break;}
case'scale':{var viewRotation=this.getMap().getView().getRotation();var center=this.center_;var rotationCenter=this.center_;if(this.get('modifyCenter')(evt)){var extentCoordinates=this.extent_;if(this.get('enableRotatedTransform')&&viewRotation!==0){extentCoordinates=this.rotatedExtent_;}
center=extentCoordinates[(Number(this.opt_)+2)%4];}
var downCoordinate=this.coordinate_;if(this.get('enableRotatedTransform')&&viewRotation!==0){downCoordinate=this.rotatedCoordinate_;}
var dragCoordinate=evt.coordinate;if(this.get('enableRotatedTransform')&&viewRotation!==0){var dragPoint=new ol.geom.Point(evt.coordinate);dragPoint.rotate(viewRotation*-1,rotationCenter);dragCoordinate=dragPoint.getCoordinates();}
var scx=((dragCoordinate)[0]-(center)[0])/(downCoordinate[0]-(center)[0]);var scy=((dragCoordinate)[1]-(center)[1])/(downCoordinate[1]-(center)[1]);if(this.get('noFlip')){if(scx<0)scx=-scx;if(scy<0)scy=-scy;}
if(this.constraint_){if(this.constraint_=="h")scx=1;else scy=1;}else{if(this.get('keepAspectRatio')(evt)){scx=scy=Math.min(scx,scy);}}
for(i=0,f;f=this.selection_.item(i);i++){geometry=(viewRotation===0||!this.get('enableRotatedTransform'))?this.geoms_[i].clone():this.rotatedGeoms_[i].clone();geometry.applyTransform(function(g1,g2,dim){if(dim<2)return g2;for(var j=0;j<g1.length;j+=dim){if(scx!=1)g2[j]=center[0]+(g1[j]-center[0])*scx;if(scy!=1)g2[j+1]=center[1]+(g1[j+1]-center[1])*scy;}
if(geometry.getType()=='Circle')geometry.setCenterAndRadius(geometry.getCenter(),geometry.getRadius());return g2;});if(this.get('enableRotatedTransform')&&viewRotation!==0){geometry.rotate(viewRotation,this.getMap().getView().getCenter());}
f.setGeometry(geometry);}
this.drawSketch_();this.dispatchEvent({type:'scaling',feature:this.selection_.item(0),features:this.selection_,scale:[scx,scy],pixel:evt.pixel,coordinate:evt.coordinate});break;}
default:break;}};ol.interaction.Transform.prototype.handleMoveEvent_=function(evt){if(!this._handleEvent(evt,this.features_))return;if(!this.mode_){var sel=this.getFeatureAtPixel_(evt.pixel);var element=evt.map.getTargetElement();if(sel.feature){var c=sel.handle?this.Cursors[(sel.handle||'default')+(sel.constraint||'')+(sel.option||'')]:this.Cursors.select;if(this.previousCursor_===undefined){this.previousCursor_=element.style.cursor;}
element.style.cursor=c;}else{if(this.previousCursor_!==undefined)element.style.cursor=this.previousCursor_;this.previousCursor_=undefined;}}};ol.interaction.Transform.prototype.handleUpEvent_=function(evt){if(this.mode_==='rotate'){var element=evt.map.getTargetElement();element.style.cursor=this.Cursors.default;this.previousCursor_=undefined;}
this.dispatchEvent({type:this.mode_+'end',feature:this.selection_.item(0),features:this.selection_,oldgeom:this.geoms_[0],oldgeoms:this.geoms_});this.drawSketch_();this.mode_=null;return false;};ol.interaction.Transform.prototype.getFeatures=function(){return this.selection_;};ol.interaction.UndoRedo=function(options){if(!options)options={};ol.interaction.Interaction.call(this,{handleEvent:function(){return true;}});this._undoStack=[];this._redoStack=[];this._block=0;this._record=true;this._defs={};};ol.ext.inherits(ol.interaction.UndoRedo,ol.interaction.Interaction);ol.interaction.UndoRedo.prototype.define=function(action,undoFn,redoFn){this._defs['_'+action]={undo:undoFn,redo:redoFn};};ol.interaction.UndoRedo.prototype.push=function(action,prop){if(this._defs['_'+action]){this._undoStack.push({type:'_'+action,prop:prop});return true;}else{return false;}};ol.interaction.UndoRedo.prototype.setActive=function(active){ol.interaction.Interaction.prototype.setActive.call(this,active);this._record=active;};ol.interaction.UndoRedo.prototype.setMap=function(map){ol.interaction.Interaction.prototype.setMap.call(this,map);this._watchSources();this._watchInteractions();};ol.interaction.UndoRedo.prototype._watchSources=function(){var map=this.getMap();if(this._sourceListener){this._sourceListener.forEach(function(l){ol.Observable.unByKey(l);})}
this._sourceListener=[];function getVectorLayers(layers,init){if(!init)init=[];layers.forEach(function(l){if(l instanceof ol.layer.Vector){init.push(l);}else if(l.getLayers){getVectorLayers(l.getLayers(),init);}});return init;}
if(map){var vectors=getVectorLayers(map.getLayers());vectors.forEach((function(l){var s=l.getSource();this._sourceListener.push(s.on(['addfeature','removefeature'],this._onAddRemove.bind(this)));this._sourceListener.push(s.on('clearstart',this.blockStart.bind(this)));this._sourceListener.push(s.on('clearend',this.blockEnd.bind(this)));}).bind(this));this._sourceListener.push(map.getLayers().on(['add','remove'],this._watchSources.bind(this)));}};ol.interaction.UndoRedo.prototype._watchInteractions=function(){var map=this.getMap();if(this._interactionListener){this._interactionListener.forEach(function(l){ol.Observable.unByKey(l);})}
this._interactionListener=[];if(map){map.getInteractions().forEach((function(i){this._interactionListener.push(i.on(['setattributestart','modifystart','rotatestart','translatestart','scalestart','deletestart','deleteend','beforesplit','aftersplit'],this._onInteraction.bind(this)));}).bind(this));this._interactionListener.push(map.getInteractions().on(['add','remove'],this._watchInteractions.bind(this)));}};ol.interaction.UndoRedo.prototype._onAddRemove=function(e){if(this._record){this._undoStack.push({type:e.type,source:e.target,feature:e.feature});this._redoStack=[];}};ol.interaction.UndoRedo.prototype._onInteraction=function(e){var fn=this._onInteraction[e.type];if(fn)fn.call(this,e);};ol.interaction.UndoRedo.prototype._onInteraction.setattributestart=function(e){this.blockStart();var newp=Object.assign({},e.properties);e.features.forEach(function(f){var oldp={};for(var p in newp){oldp[p]=f.get(p);}
this._undoStack.push({type:'changeattribute',feature:f,newProperties:newp,oldProperties:oldp});}.bind(this));this.blockEnd();};ol.interaction.UndoRedo.prototype._onInteraction.rotatestart=ol.interaction.UndoRedo.prototype._onInteraction.translatestart=ol.interaction.UndoRedo.prototype._onInteraction.scalestart=ol.interaction.UndoRedo.prototype._onInteraction.modifystart=function(e){this.blockStart();e.features.forEach(function(m){this._undoStack.push({type:'changefeature',feature:m,oldFeature:m.clone()});}.bind(this));this.blockEnd();};ol.interaction.UndoRedo.prototype.blockStart=function(){this._undoStack.push({type:'blockstart'});this._redoStack=[];};ol.interaction.UndoRedo.prototype._onInteraction.beforesplit=ol.interaction.UndoRedo.prototype._onInteraction.deletestart=ol.interaction.UndoRedo.prototype.blockStart;ol.interaction.UndoRedo.prototype.blockEnd=function(){this._undoStack.push({type:'blockend'});};ol.interaction.UndoRedo.prototype._onInteraction.aftersplit=ol.interaction.UndoRedo.prototype._onInteraction.deleteend=ol.interaction.UndoRedo.prototype.blockEnd;ol.interaction.UndoRedo.prototype._handleDo=function(e,undo){if(!this.getActive())return;this._record=false;switch(e.type){case'addfeature':{if(undo)e.source.removeFeature(e.feature);else e.source.addFeature(e.feature);break;}
case'removefeature':{if(undo)e.source.addFeature(e.feature);else e.source.removeFeature(e.feature);break;}
case'changefeature':{var geom=e.feature.getGeometry();e.feature.setGeometry(e.oldFeature.getGeometry());e.oldFeature.setGeometry(geom);break;}
case'changeattribute':{var newp=e.newProperties;var oldp=e.oldProperties;for(var p in oldp){if(oldp===undefined)e.feature.unset(p);else e.feature.set(p,oldp[p]);}
e.oldProperties=newp;e.newProperties=oldp;break;}
case'blockstart':{this._block+=undo?-1:1;break;}
case'blockend':{this._block+=undo?1:-1;break;}
default:{if(this._defs[e.type]){if(undo)this._defs[e.type].undo(e.prop);else this._defs[e.type].redo(e.prop);}else{console.warn('[UndoRedoInteraction]: "'+e.type.substr(1)+'" is not defined.');}}}
if(this._block<0)this._block=0;if(this._block){if(undo)this.undo();else this.redo();}
this._record=true;this.dispatchEvent({type:undo?'undo':'redo',action:e});};ol.interaction.UndoRedo.prototype.undo=function(){var e=this._undoStack.pop();if(!e)return;this._redoStack.push(e);this._handleDo(e,true);};ol.interaction.UndoRedo.prototype.redo=function(){var e=this._redoStack.pop();if(!e)return;this._undoStack.push(e);this._handleDo(e,false);};ol.interaction.UndoRedo.prototype.clear=function(){this._undoStack=[];this._redoStack=[];};ol.interaction.UndoRedo.prototype.hasUndo=function(){return this._undoStack.length;};ol.interaction.UndoRedo.prototype.hasRedo=function(){return this._redoStack.length;};ol.source.BinBase=function(options){options=options||{};this._bindModify=this._onModifyFeature.bind(this);this._watch===true;ol.source.Vector.call(this,options);this._origin=options.source;this._listen=(options.listenChange!==false);this._geomFn=options.geometryFunction||ol.coordinate.getFeatureCenter||function(f){return f.getGeometry().getFirstCoordinate();};this.reset();this._origin.on('addfeature',this._onAddFeature.bind(this));this._origin.on('removefeature',this._onRemoveFeature.bind(this));this._origin.on('clearstart',this._onClearFeature.bind(this));this._origin.on('clearend',this._onClearFeature.bind(this));if(typeof(options.flatAttributes)==='function')this._flatAttributes=options.flatAttributes;};ol.ext.inherits(ol.source.BinBase,ol.source.Vector);ol.source.BinBase.prototype._onAddFeature=function(e,bin,listen){var f=e.feature||e.target;bin=bin||this.getBinAt(this._geomFn(f),true);if(bin)bin.get('features').push(f);if(this._listen&&listen!==false)f.on('change',this._bindModify);};ol.source.BinBase.prototype._onRemoveFeature=function(e,bin,listen){if(!this._watch)return;var f=e.feature||e.target;bin=bin||this.getBinAt(this._geomFn(f));if(bin){var features=bin.get('features');for(var i=0,fi;fi=features[i];i++){if(fi===f){features.splice(i,1);break;}}
if(!features.length){this.removeFeature(bin);}}else{}
if(this._listen&&listen!==false)f.un('change',this._bindModify);};ol.source.BinBase.prototype._onClearFeature=function(e){if(e.type==='clearstart'){if(this._listen){this._origin.getFeatures().forEach(function(f){f.un('change',this._bindModify);}.bind(this));}
this.clear();this._watch=false;}else{this._watch=true;}};ol.source.BinBase.prototype.getBin=function(feature){var bins=this.getFeatures();for(var i=0,b;b=bins[i];i++){var features=b.get('features');for(var j=0,f;f=features[j];j++){if(f===feature)return b;}}
return null;}
ol.source.BinBase.prototype.getGridGeomAt=function(coord){return new ol.geom.Polygon([coord]);};ol.source.BinBase.prototype.getBinAt=function(coord,create){var attributes={};var g=this.getGridGeomAt(coord,attributes);if(!g)return null;var center=g.getInteriorPoint?g.getInteriorPoint().getCoordinates():g.getInteriorPoints().getCoordinates()[0];var features=this.getFeaturesAtCoordinate(center);var bin=features[0];if(!bin&&create){attributes.geometry=g;attributes.features=[];attributes.center=center;bin=new ol.Feature(attributes);this.addFeature(bin);}
return bin||null;};ol.source.BinBase.prototype._onModifyFeature=function(e){var bin=this.getBin(e.target);var bin2=this.getBinAt(this._geomFn(e.target),'create');if(bin!==bin2){if(bin){this._onRemoveFeature(e,bin,false);}
if(bin2){this._onAddFeature(e,bin2,false);}}
this.changed();};ol.source.BinBase.prototype.reset=function(){this.clear();var features=this._origin.getFeatures();for(var i=0,f;f=features[i];i++){this._onAddFeature({feature:f});}};ol.source.BinBase.prototype.getGridFeatures=function(){var features=[];this.getFeatures().forEach(function(f){var bin=new ol.Feature(f.getGeometry().clone());for(var i in f.getProperties()){if(i!=='features'&&i!=='geometry'){bin.set(i,f.get(i));}}
bin.set('nb',f.get('features').length);this._flatAttributes(bin,f.get('features'));features.push(bin);}.bind(this));return features;};ol.source.BinBase.prototype._flatAttributes=function(){};ol.source.BinBase.prototype.getSource=function(){return this._origin;};ol.source.DBPedia=function(opt_options){var options=opt_options||{};options.loader=this._loaderFn;this._url=options.url||"http://fr.dbpedia.org/sparql";this._maxResolution=options.maxResolution||100;this._lang=options.lang||"fr";this._limit=options.limit||1000;if(!options.attributions)options.attributions=["&copy; <a href='http://dbpedia.org/'>DBpedia</a> CC-by-SA"];if(!options.strategy)options.strategy=ol.loadingstrategy.bbox;ol.source.Vector.call(this,options);};ol.ext.inherits(ol.source.DBPedia,ol.source.Vector);ol.source.DBPedia.prototype.readFeature=function(feature,attributes,lastfeature){for(var i in attributes){if(attributes[i].type==='uri')attributes[i].value=encodeURI(attributes[i].value);feature.set(i,attributes[i].value);}
if(lastfeature&&lastfeature.get("subject")==attributes.subject.value){lastfeature.set("type",lastfeature.get("type")+"\n"+attributes.type.value);return false;}else{return true;}};ol.source.DBPedia.prototype.querySubject=function(){return"?subject rdfs:label ?label. "
+"OPTIONAL {?subject dbpedia-owl:thumbnail ?thumbnail}."
+"OPTIONAL {?subject dbpedia-owl:abstract ?abstract} . "
+"OPTIONAL {?subject rdf:type ?type}";}
ol.source.DBPedia.prototype.queryFilter=function(){return"lang(?label) = '"+this._lang+"' "
+"&& lang(?abstract) = '"+this._lang+"'"}
ol.source.DBPedia.prototype._loaderFn=function(extent,resolution,projection){if(resolution>this._maxResolution)return;var self=this;var bbox=ol.proj.transformExtent(extent,projection,"EPSG:4326");var query="PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> "
+"SELECT DISTINCT * WHERE { "
+"?subject geo:lat ?lat . "
+"?subject geo:long ?long . "
+this.querySubject()+" . "
+"FILTER("+this.queryFilter()+") . "
+"FILTER(xsd:float(?lat) <= "+bbox[3]+" && "+bbox[1]+" <= xsd:float(?lat) "
+"&& xsd:float(?long) <= "+bbox[2]+" && "+bbox[0]+" <= xsd:float(?long) "
+") . "
+"} LIMIT "+this._limit;ol.ext.Ajax.get({url:this._url,data:{query:query,format:"json"},success:function(data){var bindings=data.results.bindings;var features=[];var att,pt,feature,lastfeature=null;for(var i in bindings){att=bindings[i];pt=[Number(bindings[i].long.value),Number(bindings[i].lat.value)];feature=new ol.Feature(new ol.geom.Point(ol.proj.transform(pt,"EPSG:4326",projection)));if(self.readFeature(feature,att,lastfeature)){features.push(feature);lastfeature=feature;}}
self.addFeatures(features);}});};ol.style.clearDBPediaStyleCache;ol.style.dbPediaStyleFunction;(function(){var styleCache={};ol.style.clearDBPediaStyleCache=function(){styleCache={};}
ol.style.dbPediaStyleFunction=function(options){if(!options)options={};var getFont;switch(typeof(options.glyph)){case"function":getFont=options.glyph;break;case"string":getFont=function(){return options.glyph;};break;default:{getFont=function(f){var type=f.get("type");if(type){if(type.match("/Museum"))return"fa-camera";else if(type.match("/Monument"))return"fa-building";else if(type.match("/Sculpture"))return"fa-android";else if(type.match("/Religious"))return"fa-institution";else if(type.match("/Castle"))return"fa-key";else if(type.match("Water"))return"fa-tint";else if(type.match("Island"))return"fa-leaf";else if(type.match("/Event"))return"fa-heart";else if(type.match("/Artwork"))return"fa-asterisk";else if(type.match("/Stadium"))return"fa-futbol-o";else if(type.match("/Place"))return"fa-street-view";}
return"fa-star";}
break;}}
var radius=options.radius||8;var fill=options.fill||new ol.style.Fill({color:"navy"});var stroke=options.stroke||new ol.style.Stroke({color:"#fff",width:2});var prefix=options.prefix?options.prefix+"_":"";return function(feature){var glyph=getFont(feature);var k=prefix+glyph;var style=styleCache[k];if(!style){styleCache[k]=style=new ol.style.Style({image:new ol.style.FontSymbol({glyph:glyph,radius:radius,fill:fill,stroke:stroke})});}
return[style];}};})();ol.source.DFCI=function(options){options=options||{};options.loader=this._calcGrid;options.strategy=function(extent,resolution){if(this.resolution&&this.resolution!=resolution){this.clear();this.refresh();}
return[extent];}
this._bbox=[[0,1600000],[11*100000,1600000+10*100000]];ol.source.Vector.call(this,options);this.set('resolutions',options.resolutions||[1000,100,20]);if(!proj4.defs["EPSG:27572"])proj4.defs("EPSG:27572","+proj=lcc +lat_1=46.8 +lat_0=46.8 +lon_0=0 +k_0=0.99987742 +x_0=600000 +y_0=2200000 +a=6378249.2 +b=6356515 +towgs84=-168,-60,320,0,0,0,0 +pm=paris +units=m +no_defs");ol.proj.proj4.register(proj4);};ol.ext.inherits(ol.source.DFCI,ol.source.Vector);ol.source.DFCI.prototype._calcGrid=function(extent,resolution,projection){var f,ext,res=this.get('resolutions');if(resolution>(res[0]||1000)){if(this.resolution!=resolution){if(!this._features0){ext=[this._bbox[0][0],this._bbox[0][1],this._bbox[1][0],this._bbox[1][1]];this._features0=this._getFeatures(0,ext,projection);}
this.addFeatures(this._features0);}}
else if(resolution>(res[1]||100)){this.clear();ext=ol.proj.transformExtent(extent,projection,'EPSG:27572');f=this._getFeatures(1,ext,projection)
this.addFeatures(f);}
else if(resolution>(res[2]||0)){this.clear();ext=ol.proj.transformExtent(extent,projection,'EPSG:27572');f=this._getFeatures(2,ext,projection)
this.addFeatures(f);}
else{this.clear();ext=ol.proj.transformExtent(extent,projection,'EPSG:27572');f=this._getFeatures(3,ext,projection)
this.addFeatures(f);}
this.resolution=resolution;};ol.source.DFCI.prototype._midPt=function(p1,p2){return[(p1[0]+p2[0])/2,(p1[1]+p2[1])/2];};ol.source.DFCI.prototype._trFeature=function(geom,id,level,projection){var g=new ol.geom.Polygon([geom]);var f=new ol.Feature(g.transform('EPSG:27572',projection));f.set('id',id);f.set('level',level);return f;};ol.source.DFCI.prototype._getFeatures=function(level,extent,projection){var features=[];var i;var step=100000;if(level>0)step/=5;if(level>1)step/=10;var p0=[Math.max(this._bbox[0][0],Math.floor(extent[0]/step)*step),Math.max(this._bbox[0][1],Math.floor(extent[1]/step)*step)];var p1=[Math.min(this._bbox[1][0]+99999,Math.floor(extent[2]/step)*step),Math.min(this._bbox[1][1]+99999,Math.floor(extent[3]/step)*step)];for(var x=p0[0];x<=p1[0];x+=step){for(var y=p0[1];y<=p1[1];y+=step){var p,geom=[[x,y],[x+step,y],[x+step,y+step],[x,y+step],[x,y]];if(level>2){var m=this._midPt(geom[0],geom[2]);var g=[];for(i=0;i<geom.length;i++){g.push(this._midPt(geom[i],m))}
features.push(this._trFeature(g,ol.coordinate.toDFCI([x,y],2)+'.5',level,projection));for(i=0;i<4;i++){g=[];g.push(geom[i]);g.push(this._midPt(geom[i],geom[(i+1)%4]));g.push(this._midPt(m,g[1]));g.push(this._midPt(m,geom[i]));p=this._midPt(geom[i],geom[(i+3)%4]);g.push(this._midPt(m,p));g.push(p);g.push(geom[i]);features.push(this._trFeature(g,ol.coordinate.toDFCI([x,y],2)+'.'+(4-i),level,projection));}}else{features.push(this._trFeature(geom,ol.coordinate.toDFCI([x,y],level),level,projection));}}}
return features};ol.source.Delaunay=function(options){options=options||{};this._nodes=options.source;delete options.source;ol.source.Vector.call(this,options);this.hull=[];this._nodes.on('addfeature',this._onAddNode.bind(this));this._nodes.on('removefeature',this._onRemoveNode.bind(this));this.set('epsilon',options.epsilon||.0001)};ol.ext.inherits(ol.source.Delaunay,ol.source.Vector);ol.source.Delaunay.prototype._addTriangle=function(pts){var triangle=new ol.Feature(new ol.geom.Polygon([pts]));this.addFeature(triangle);this.flip.push(triangle);return triangle;};ol.source.Delaunay.prototype.getNodes=function(){return this._nodes.getFeatures();};ol.source.Delaunay.prototype.getNodeSource=function(){return this._nodes;};ol.source.Delaunay.prototype._onRemoveNode=function(evt){var pt=evt.feature.getGeometry().getCoordinates();if(!pt)return;if(this.getNodesAt(pt).length)return;var triangles=this.getTrianglesAt(pt);this.flip=[];var i;var edges=[];while(triangles.length){var tr=triangles.pop()
this.removeFeature(tr);tr=tr.getGeometry().getCoordinates()[0];var pts=[];for(i=0,p;p=tr[i];i++){if(!ol.coordinate.equal(p,pt)){pts.push(p);}}
edges.push(pts);}
pts=edges.pop();var se='';edges.forEach(function(e){se+=' - '+this.listpt(e);}.bind(this));console.log('EDGES',se);i=0;function testEdge(p0,p1,index){if(ol.coordinate.equal(p0,pts[index])){if(index)pts.push(p1);else pts.unshift(p1);return true}
return false;}
while(true){var e=edges[i];if(testEdge(e[0],e[1],0)||testEdge(e[1],e[0],0)||testEdge(e[0],e[1],pts.length-1)||testEdge(e[1],e[0],pts.length-1)){edges.splice(i,1);i=0;}else{i++}
if(!edges.length)break;if(i>=edges.length){console.log(this.listpt(pts),this.listpt(edges));throw'[DELAUNAY:removePoint] No edge found';}}
console.log('PTS',this.listpt(pts))
var closed=ol.coordinate.equal(pts[0],pts[pts.length-1]);if(closed)pts.pop();var p;for(i;p=this.hull[i];i++){if(ol.coordinate.equal(pt,p)){this.hull.splice(i,1);break;}}
this.hull=ol.coordinate.convexHull(this.hull.concat(pts));var clockwise=function(t){var i1,s=0;for(var i=0;i<t.length;i++){i1=(i+1)%t.length;s+=(t[i1][0]-t[i][0])*(t[i1][1]+t[i][1]);}
console.log(s)
return(s>=0?1:-1)};var clock;var enveloppe=pts.slice();if(closed){clock=clockwise(pts);}else{console.log('ouvert',pts,pts.slice().push(pt))
enveloppe.push(pt);clock=clockwise(enveloppe);}
console.log('S=',clock,'CLOSED',closed)
console.log('E=',this.listpt(enveloppe))
for(i=0;i<=pts.length+1;i++){if(pts.length<3)break;var t=[pts[i%pts.length],pts[(i+1)%pts.length],pts[(i+2)%pts.length]];if(clockwise(t)===clock){var ok=true;for(var k=i+3;k<i+pts.length;k++){console.log('test '+k,this.listpt([pts[k%pts.length]]))
if(this.inCircle(pts[k%pts.length],t)){ok=false;break;}}
if(ok){console.log(this.listpt(t),'ok');this._addTriangle(t);pts.splice((i+1)%pts.length,1);i=-1;}}
else console.log(this.listpt(t),'nok');}
this.flipTriangles();};ol.source.Delaunay.prototype._onAddNode=function(e){var finserted=e.feature;var i,p;if(finserted.getGeometry().getType()!=='Point'){this._nodes.removeFeature(finserted);return;}
this.flip=[];var nodes=this.getNodes();var pt=finserted.getGeometry().getCoordinates();if(this.getNodesAt(pt).length>1){console.log('remove duplicated points')
this._nodes.removeFeature(finserted);return;}
if(nodes.length<=3){if(nodes.length===3){var pts=[];for(i=0;i<3;i++)pts.push(nodes[i].getGeometry().getCoordinates());this._addTriangle(pts);this.hull=ol.coordinate.convexHull(pts);}
return;}
var t=this.getFeaturesAtCoordinate(pt)[0];if(t){this.removeFeature(t);t.set('del',true);var c=t.getGeometry().getCoordinates()[0];for(i=0;i<3;i++){this._addTriangle([pt,c[i],c[(i+1)%3]]);}}else{var hull2=this.hull.slice();hull2.push(pt);hull2=ol.coordinate.convexHull(hull2);for(i=0;p=hull2[i];i++){if(ol.coordinate.equal(p,pt))break;}
i=(i!==0?i-1:hull2.length-1);var p0=hull2[i];var stop=hull2[(i+2)%hull2.length];for(i=0;p=this.hull[i];i++){if(ol.coordinate.equal(p,p0))break;}
while(true){if(i>1000){console.error('[DELAUNAY:addPoint] Too many iterations')
break;}
i++;p=this.hull[i%this.hull.length];this._addTriangle([pt,p,p0]);p0=p;if(p[0]===stop[0]&&p[1]===stop[1])break;}
this.hull=hull2;}
this.flipTriangles();};ol.source.Delaunay.prototype.flipTriangles=function(){var count=1000;var pi;while(this.flip.length){if(count--<0){console.error('[DELAUNAY:flipTriangles] Too many iterations')
break;}
var tri=this.flip.pop();if(tri.get('del'))continue;var ti=tri.getGeometry().getCoordinates()[0];for(var k=0;k<3;k++){var mid=[(ti[(k+1)%3][0]+ti[k][0])/2,(ti[(k+1)%3][1]+ti[k][1])/2];var triangles=this.getTrianglesAt(mid);var pt1=null;if(triangles.length>1){var t0=triangles[0].getGeometry().getCoordinates()[0];var t1=triangles[1].getGeometry().getCoordinates()[0];for(pi=0;pi<t1.length;pi++){if(!this._ptInTriangle(t1[pi],t0)){pt1=t1[pi];break;}}}
if(pt1){if(this.inCircle(pt1,t0)){var pt2;for(pi=0;pi<t0.length;pi++){if(!this._ptInTriangle(t0[pi],t1)){pt2=t0.splice(pi,1)[0];break;}}
if(this.intersectSegs([pt1,pt2],t0)){while(triangles.length){var tmp=triangles.pop();tmp.set('del',true);this.removeFeature(tmp);}
this._addTriangle([pt1,pt2,t0[0]]);this._addTriangle([pt1,pt2,t0[1]]);}}}}}};ol.source.Delaunay.prototype.intersectSegs=function(d1,d2){var d1x=d1[1][0]-d1[0][0];var d1y=d1[1][1]-d1[0][1];var d2x=d2[1][0]-d2[0][0];var d2y=d2[1][1]-d2[0][1];var det=d1x*d2y-d1y*d2x;if(det!=0){var k=(d1x*d1[0][1]-d1x*d2[0][1]-d1y*d1[0][0]+d1y*d2[0][0])/det;return(0<k&&k<1);}
else return false;};ol.source.Delaunay.prototype._ptInTriangle=function(pt,triangle){for(var i=0,p;p=triangle[i];i++){if(ol.coordinate.equal(pt,p))return true;}
return false;};ol.source.Delaunay.prototype.listpt=function(pts){var s='';for(var i=0,p;p=pts[i];i++){var c=this._nodes.getClosestFeatureToCoordinate(p);if(!ol.coordinate.equal(c.getGeometry().getCoordinates(),p))c=null;s+=(s?', ':'')+(c?c.get('id'):'?');}
return s;};ol.source.Delaunay.prototype.inCircle=function(coord,triangle){var c=this.getCircumCircle(triangle);return ol.coordinate.dist2d(coord,c.center)<c.radius;}
ol.source.Delaunay.prototype.getCircumCircle=function(triangle){var x1=triangle[0][0];var y1=triangle[0][1];var x2=triangle[1][0];var y2=triangle[1][1];var x3=triangle[2][0];var y3=triangle[2][1];var m1=(x1-x2)/(y2-y1);var m2=(x1-x3)/(y3-y1);var b1=((y1+y2)/2)-m1*(x1+x2)/2;var b2=((y1+y3)/2)-m2*(x1+x3)/2;var cx=(b2-b1)/(m1-m2);var cy=m1*cx+b1;var center=[cx,cy];return{center:center,radius:ol.coordinate.dist2d(center,triangle[0])};};ol.source.Delaunay.prototype.getTrianglesAt=function(coord){var extent=ol.extent.buffer(ol.extent.boundingExtent([coord]),this.get('epsilon'));var result=[];this.forEachFeatureIntersectingExtent(extent,function(f){result.push(f);});return result;};ol.source.Delaunay.prototype.getNodesAt=function(coord){var extent=ol.extent.buffer(ol.extent.boundingExtent([coord]),this.get('epsilon'));return this._nodes.getFeaturesInExtent(extent);};ol.source.FeatureBin=function(options){options=options||{};this._sourceFeature=new ol.source.Vector({features:options.features||[]});ol.source.BinBase.call(this,options);};ol.ext.inherits(ol.source.FeatureBin,ol.source.BinBase);ol.source.FeatureBin.prototype.setFeatures=function(features){this._sourceFeature.clear();this._sourceFeature.addFeatures(features||[]);this.reset();};ol.source.FeatureBin.prototype.getGridGeomAt=function(coord,attributes){var f=this._sourceFeature.getFeaturesAtCoordinate(coord)[0];if(!f)return null;var a=f.getProperties();for(var i in a){if(i!=='geometry')attributes[i]=a[i];}
return f.getGeometry();};ol.source.GeoImage=function(opt_options){var options={attributions:opt_options.attributions,logo:opt_options.logo,projection:opt_options.projection};this.center=opt_options.imageCenter;this.scale=opt_options.imageScale;this.rotate=opt_options.imageRotate?opt_options.imageRotate:0;this.crop=opt_options.imageCrop;this.mask=opt_options.imageMask;this._image=(opt_options.image?opt_options.image:new Image);this._image.crossOrigin=opt_options.crossOrigin;var self=this;this._image.onload=function(){self.setCrop(self.crop);self.changed();}
if(!opt_options.image)this._image.src=opt_options.url;options.canvasFunction=function(extent,resolution,pixelRatio,size){var canvas=document.createElement('canvas');canvas.width=size[0];canvas.height=size[1];var ctx=canvas.getContext('2d');if(!this._imageSize)return canvas;function tr(xy){return[(xy[0]-extent[0])/(extent[2]-extent[0])*size[0],(xy[1]-extent[3])/(extent[1]-extent[3])*size[1]];}
if(this.mask){ctx.beginPath();var p=tr(this.mask[0]);ctx.moveTo(p[0],p[1]);for(var i=1;i<this.mask.length;i++){p=tr(this.mask[i]);ctx.lineTo(p[0],p[1]);}
ctx.clip();}
var pixel=tr(this.center);var dx=(this._image.naturalWidth/2-this.crop[0])*this.scale[0]/resolution*pixelRatio;var dy=(this._image.naturalHeight/2-this.crop[1])*this.scale[1]/resolution*pixelRatio;var sx=this._imageSize[0]*this.scale[0]/resolution*pixelRatio;var sy=this._imageSize[1]*this.scale[1]/resolution*pixelRatio;ctx.translate(pixel[0],pixel[1]);if(this.rotate)ctx.rotate(this.rotate);ctx.drawImage(this._image,this.crop[0],this.crop[1],this._imageSize[0],this._imageSize[1],-dx,-dy,sx,sy);return canvas;}
ol.source.ImageCanvas.call(this,options);this.setCrop(this.crop);this.on('change',function(){this.set('extent',this.calculateExtent());}.bind(this));};ol.ext.inherits(ol.source.GeoImage,ol.source.ImageCanvas);ol.source.GeoImage.prototype.getCenter=function(){return this.center;}
ol.source.GeoImage.prototype.setCenter=function(center){this.center=center;this.changed();}
ol.source.GeoImage.prototype.getScale=function(){return this.scale;}
ol.source.GeoImage.prototype.setScale=function(scale){switch(typeof(scale)){case'number':scale=[scale,scale];break;case'object':if(scale.length!=2)return;break;default:return;}
this.scale=scale;this.changed();};ol.source.GeoImage.prototype.getRotation=function(){return this.rotate;};ol.source.GeoImage.prototype.setRotation=function(angle){this.rotate=angle;this.changed();};ol.source.GeoImage.prototype.getGeoImage=function(){return this._image;};ol.source.GeoImage.prototype.getCrop=function(){return this.crop;};ol.source.GeoImage.prototype.setMask=function(mask){this.mask=mask;this.changed();};ol.source.GeoImage.prototype.getMask=function(){return this.mask;};ol.source.GeoImage.prototype.setCrop=function(crop){if(!this._image.naturalWidth){this.crop=crop;return;}
if(crop){switch(typeof(crop)){case'number':crop=[crop,crop,this._image.naturalWidth-crop,this._image.naturalHeight-crop];break;case'object':if(crop.length!=4)return;break;default:return;}
crop=ol.extent.boundingExtent([[crop[0],crop[1]],[crop[2],crop[3]]]);this.crop=[Math.max(0,crop[0]),Math.max(0,crop[1]),Math.min(this._image.naturalWidth,crop[2]),Math.min(this._image.naturalHeight,crop[3])];}
else this.crop=[0,0,this._image.naturalWidth,this._image.naturalHeight];if(this.crop[2]<=this.crop[0])this.crop[2]=this.crop[0]+1;if(this.crop[3]<=this.crop[1])this.crop[3]=this.crop[1]+1;this._imageSize=[this.crop[2]-this.crop[0],this.crop[3]-this.crop[1]];this.changed();};ol.source.GeoImage.prototype.getExtent=function(opt_extent){if(opt_extent){var ext=this.get('extent');for(var i=0;i<opt_extent.length;i++){opt_extent[i]=ext[i];}
return ext;}else{return this.get('extent');}};ol.source.GeoImage.prototype.calculateExtent=function(usemask){var polygon;if(usemask!==false&&this.getMask()){polygon=new ol.geom.Polygon([this.getMask()])}else{var center=this.getCenter();var scale=this.getScale();var width=this.getGeoImage().width*scale[0];var height=this.getGeoImage().height*scale[1];var extent=ol.extent.boundingExtent([[center[0]-width/2,center[1]-height/2],[center[0]+width/2,center[1]+height/2]]);polygon=ol.geom.Polygon.fromExtent(extent);polygon.rotate(-this.getRotation(),center);}
var ext=polygon.getExtent();return ext;};ol.source.GeoRSS=function(options){options=options||{};options.loader=this._loaderFn;ol.source.Vector.call(this,options);};ol.ext.inherits(ol.source.GeoRSS,ol.source.Vector);ol.source.GeoRSS.prototype._loaderFn=function(extent,resolution,projection){ol.ext.Ajax.get({url:this.getUrl(),dataType:'XML',error:function(){console.log('oops');},success:function(xml){var features=(new ol.format.GeoRSS()).readFeatures(xml,{featureProjection:projection});this.addFeatures(features);}.bind(this)});};ol.source.Geoportail=function(layer,options){options=options||{};var matrixIds=new Array();var resolutions=new Array();var size=ol.extent.getWidth(ol.proj.get('EPSG:3857').getExtent())/256;for(var z=0;z<=(options.maxZoom?options.maxZoom:20);z++){matrixIds[z]=z;resolutions[z]=size/Math.pow(2,z);}
var tg=new ol.tilegrid.WMTS({origin:[-20037508,20037508],resolutions:resolutions,matrixIds:matrixIds});tg.minZoom=(options.minZoom?options.minZoom:0);var attr=[ol.source.Geoportail.prototype.attribution];if(options.attributions)attr=options.attributions;this._server=options.server||'https://wxs.ign.fr/geoportail/wmts';this._gppKey=options.gppKey||'choisirgeoportail';var wmts_options={url:this.serviceURL(),layer:layer,matrixSet:'PM',format:options.format?options.format:'image/jpeg',projection:'EPSG:3857',tileGrid:tg,style:options.style?options.style:'normal',attributions:attr,crossOrigin:(typeof options.crossOrigin=='undefined')?'anonymous':options.crossOrigin,wrapX:!(options.wrapX===false)};ol.source.WMTS.call(this,wmts_options);if(options.authentication){this.setTileLoadFunction(ol.source.Geoportail.tileLoadFunctionWithAuthentication(options.authentication,this.getFormat()));}};ol.ext.inherits(ol.source.Geoportail,ol.source.WMTS);ol.source.Geoportail.prototype.attribution='<a href="http://www.geoportail.gouv.fr/">Géoportail</a> &copy; <a href="http://www.ign.fr/">IGN-France</a>';ol.source.Geoportail.prototype.serviceURL=function(){if(this._server){return this._server.replace(/^(https?:\/\/[^/]*)(.*)$/,"$1/"+this._gppKey+"$2");}else{return(window.geoportailConfig?window.geoportailConfig.url:"https://wxs.ign.fr/")+this._gppKey+"/geoportail/wmts";}};ol.source.Geoportail.prototype.getGPPKey=function(){return this._gppKey;};ol.source.Geoportail.prototype.setGPPKey=function(key,authentication){this._gppKey=key;var serviceURL=this.serviceURL();this.setTileUrlFunction(function(){var url=ol.source.Geoportail.prototype.getTileUrlFunction().apply(this,arguments);if(url){var args=url.split("?");return serviceURL+"?"+args[1];}
else return url;});if(authentication){this.setTileLoadFunction(ol.source.Geoportail.tileLoadFunctionWithAuthentication(authentication,this.getFormat()));}};ol.source.Geoportail.prototype.getFeatureInfoUrl=function(coord,resolution,projection,options){options=options||{};if(!projection)projection=this.getProjection();var tileCoord=this.tileGrid.getTileCoordForCoordAndResolution(coord,resolution);var ratio=1;var url=this.getTileUrlFunction()(tileCoord,ratio,projection);if(!url)return url;var tileResolution=this.tileGrid.getResolution(tileCoord[0]);var tileExtent=this.tileGrid.getTileCoordExtent(tileCoord);var i=Math.floor((coord[0]-tileExtent[0])/(tileResolution/ratio));var j=Math.floor((tileExtent[3]-coord[1])/(tileResolution/ratio));return url.replace(/Request=GetTile/i,'Request=getFeatureInfo')
+'&INFOFORMAT='+(options.INFO_FORMAT||'text/plain')
+'&I='+i
+'&J='+j;};ol.source.Geoportail.prototype.getFeatureInfo=function(coord,resolution,options){var url=this.getFeatureInfoUrl(coord,resolution,null,options);ol.ext.Ajax.get({url:url,dataType:options.format||'text/plain',options:{encode:false},success:function(resp){if(options.callback)options.callback(resp);},error:options.error||function(){}})};ol.source.Geoportail.tileLoadFunctionWithAuthentication=function(authentication,format){if(!authentication)return undefined;return function(tile,src){var xhr=new XMLHttpRequest();xhr.open("GET",src);xhr.setRequestHeader("Authorization","Basic "+authentication);xhr.responseType="arraybuffer";xhr.onload=function(){var arrayBufferView=new Uint8Array(this.response);var blob=new Blob([arrayBufferView],{type:format});var urlCreator=window.URL||window.webkitURL;var imageUrl=urlCreator.createObjectURL(blob);tile.getImage().src=imageUrl;};xhr.onerror=function(){tile.getImage().src="";};xhr.send();};};ol.source.GridBin=function(options){options=options||{};ol.source.BinBase.call(this,options);this.set('gridProjection',options.gridProjection||'EPSG:4326');this.set('size',options.size||1);};ol.ext.inherits(ol.source.GridBin,ol.source.BinBase);ol.source.GridBin.prototype.setGridProjection=function(proj){this.set('gridProjection',proj);this.reset();};ol.source.GridBin.prototype.setSize=function(size){this.set('size',size);this.reset();};ol.source.GridBin.prototype.getGridGeomAt=function(coord){coord=ol.proj.transform(coord,this.getProjection()||'EPSG:3857',this.get('gridProjection'));var size=this.get('size');var x=size*Math.floor(coord[0]/size);var y=size*Math.floor(coord[1]/size);var geom=new ol.geom.Polygon([[[x,y],[x+size,y],[x+size,y+size],[x,y+size],[x,y]]]);return geom.transform(this.get('gridProjection'),this.getProjection()||'EPSG:3857');};ol.source.HexBin=function(options){options=options||{};this._hexgrid=new ol.HexGrid(options);ol.source.BinBase.call(this,options);};ol.ext.inherits(ol.source.HexBin,ol.source.BinBase);ol.source.HexBin.prototype.getGridGeomAt=function(coord){var h=this._hexgrid.coord2hex(coord);return new ol.geom.Polygon([this._hexgrid.getHexagon(h)])};ol.source.HexBin.prototype.setSize=function(newSize,noreset){this._hexgrid.setSize(newSize);if(!noreset){this.reset();}}
ol.source.HexBin.prototype.getSize=function(){return this._hexgrid.getSize();}
ol.source.HexBin.prototype.setLayout=function(newLayout,noreset){this._hexgrid.setLayout(newLayout);if(!noreset){this.reset();}}
ol.source.HexBin.prototype.getLayout=function(){return this._hexgrid.getLayout();};ol.source.HexBin.prototype.setOrigin=function(newLayout,noreset){this._hexgrid.setOrigin(newLayout);if(!noreset){this.reset();}};ol.source.HexBin.prototype.getOrigin=function(){return this._hexgrid.getOrigin();};ol.source.HexBin.prototype.getHexFeatures=function(){return ol.source.BinBase.prototype.getGridFeatures.call(this);};ol.source.InseeBin=function(options){options=options||{};this._grid=new ol.InseeGrid({size:options.size});ol.source.BinBase.call(this,options);};ol.ext.inherits(ol.source.InseeBin,ol.source.BinBase);ol.source.InseeBin.prototype.setSize=function(size){if(this.getSize()!==size){this._grid.set('size',size);this.reset();}};ol.source.InseeBin.prototype.getSize=function(){return this._grid.get('size');};ol.source.InseeBin.prototype.getGridGeomAt=function(coord){return this._grid.getGridAtCoordinate(coord,this.getProjection());};ol.source.InseeBin.prototype.getGridExtent=function(proj){return this._grid.getExtent(proj);};ol.source.Mapillary=function(opt_options)
{var options=opt_options||{};options.loader=this._loaderFn;this._maxResolution=options.maxResolution||100;this._limit=options.limit||100;if(!options.attributions)options.attributions=["&copy; <a href='https://www.mapillary.com/'>Mapillary</a>"];if(!options.strategy)options.strategy=ol.loadingstrategy.bbox;ol.source.Vector.call(this,options);};ol.ext.inherits(ol.source.Mapillary,ol.source.Vector);ol.source.Mapillary.prototype.readFeature=function()
{return true;};ol.source.Mapillary.prototype._loaderFn=function(extent,resolution,projection)
{if(resolution>this._maxResolution)return;var bbox=ol.proj.transformExtent(extent,projection,"EPSG:4326");var date=Date.now()-6*30*24*60*60*1000;var url="https://a.mapillary.com/v2/search/im?client_id="
+this.get('clientId')
+"&max_lat="+bbox[3]
+"&max_lon="+bbox[2]
+"&min_lat="+bbox[1]
+"&min_lon="+bbox[0]
+"&limit="+(this._limit-1)
+"&start_time="+date;ol.ext.Ajax.get({url:url,dataType:'jsonp',success:function(data)
{console.log(data);}});};ol.source.Overpass=function(options){options=options||{};options.loader=this._loaderFn;this._url=options.url||'https://overpass-api.de/api/interpreter';this._maxResolution=options.maxResolution||100;if(!options.attributions){options.attributions=ol.source.OSM.ATTRIBUTION;}
if(!options.strategy)options.strategy=ol.loadingstrategy.bbox;ol.source.Vector.call(this,options);this._types={node:options.node!==false,way:options.way!==false,rel:options.rel===true};this._filter=options.filter;};ol.ext.inherits(ol.source.Overpass,ol.source.Vector);ol.source.Overpass.prototype._loaderFn=function(extent,resolution,projection){if(resolution>this._maxResolution)return;var self=this;var bbox=ol.proj.transformExtent(extent,projection,"EPSG:4326");bbox=bbox[1]+','+bbox[0]+','+bbox[3]+','+bbox[2];var query='[bbox:'+bbox+'][out:xml][timeout:25];';query+='(';for(var t in this._types){if(this._types[t]){query+=t;for(var n=0,filter;filter=this._filter[n];n++){query+='['+filter+']';}
query+=';'}}
query+=');out;>;out skel qt;'
var ajax=new XMLHttpRequest();ajax.open('POST',this._url,true);ajax.onload=function(){var features=new ol.format.OSMXML().readFeatures(this.responseText,{featureProjection:projection});var result=[];for(var i=0,f;f=features[i];i++){if(!self.hasFeature(f))result.push(f);}
self.addFeatures(result);};ajax.onerror=function(){console.log(arguments);};ajax.send('data='+query);};ol.source.Overpass.prototype.hasFeature=function(feature){var p=feature.getGeometry().getFirstCoordinate();var id=feature.getId();var existing=this.getFeaturesInExtent([p[0]-0.1,p[1]-0.1,p[0]+0.1,p[1]+0.1]);for(var i=0,f;f=existing[i];i++){if(id===f.getId()){return true;}}
return false;};(function(){var clear=ol.source.Vector.prototype.clear;ol.source.Vector.prototype.clear=function(opt_fast){this.dispatchEvent({type:'clearstart'});clear.call(this,opt_fast)
this.dispatchEvent({type:'clearend'});};})();ol.layer.Vector3D=function(options){options=options||{};this._source=options.source;this.height_=options.height=this.getHfn(options.height);var canvas=document.createElement('canvas');ol.layer.Image.call(this,{source:new ol.source.ImageCanvas({canvasFunction:function(extent,resolution,pixelRatio,size){canvas.width=size[0];canvas.height=size[1];return canvas;}}),height:options.height,center:options.center||[.5,1],defaultHeight:options.defaultHeight||0,maxResolution:options.maxResolution||Infinity});this.setStyle(options.style);this.on(['postcompose','postrender'],this.onPostcompose_.bind(this));}
ol.ext.inherits(ol.layer.Vector3D,ol.layer.Image);ol.layer.Vector3D.prototype.setStyle=function(s){if(s instanceof ol.style.Style)this._style=s;else this._style=new ol.style.Style();if(!this._style.getStroke()){this._style.setStroke(new ol.style.Stroke({width:1,color:'red'}));}
if(!this._style.getFill()){this._style.setFill(new ol.style.Fill({color:'rgba(0,0,255,0.5)'}));}
if(!this._style.getText()){this._style.setText(new ol.style.Fill({color:'red'}));}
if(s&&s.getGeometry()){var geom=s.getGeometry();if(typeof(geom)==='function'){this.set('geometry',geom);}else{this.set('geometry',function(){return geom;});}}else{this.set('geometry',function(f){return f.getGeometry();});}};ol.layer.Vector3D.prototype.getStyle=function(){return this._style;};ol.layer.Vector3D.prototype.onPostcompose_=function(e){var res=e.frameState.viewState.resolution;if(res>this.get('maxResolution'))return;this.res_=res*400;if(this.animate_){var elapsed=e.frameState.time-this.animate_;if(elapsed<this.animateDuration_){this.elapsedRatio_=this.easing_(elapsed/this.animateDuration_);e.frameState.animate=true;}else{this.animate_=false;this.height_=this.toHeight_}}
var ratio=e.frameState.pixelRatio;var ctx=e.context;var m=this.matrix_=e.frameState.coordinateToPixelTransform;if(!m){m=e.frameState.coordinateToPixelMatrix,m[2]=m[4];m[3]=m[5];m[4]=m[12];m[5]=m[13];}
this.center_=[ctx.canvas.width*this.get('center')[0]/ratio,ctx.canvas.height*this.get('center')[1]/ratio];var f=this._source.getFeaturesInExtent(e.frameState.extent);ctx.save();ctx.scale(ratio,ratio);var s=this.getStyle();ctx.lineWidth=s.getStroke().getWidth();ctx.lineCap=s.getStroke().getLineCap();ctx.strokeStyle=ol.color.asString(s.getStroke().getColor());ctx.fillStyle=ol.color.asString(s.getFill().getColor());var builds=[];for(var i=0;i<f.length;i++){builds.push(this.getFeature3D_(f[i],this.getFeatureHeight(f[i])));}
this.drawFeature3D_(ctx,builds);ctx.restore();};ol.layer.Vector3D.prototype.getHfn=function(h){switch(typeof(h)){case'function':return h;case'string':{var dh=this.get('defaultHeight');return(function(f){return(Number(f.get(h))||dh);});}
case'number':return(function(){return h;});default:return(function(){return 10;});}}
ol.layer.Vector3D.prototype.animate=function(options){options=options||{};this.toHeight_=this.getHfn(options.height);this.animate_=new Date().getTime();this.animateDuration_=options.duration||1000;this.easing_=options.easing||ol.easing.easeOut;this.changed();}
ol.layer.Vector3D.prototype.animating=function(){if(this.animate_&&new Date().getTime()-this.animate_>this.animateDuration_){this.animate_=false;}
return!!this.animate_;}
ol.layer.Vector3D.prototype.getFeatureHeight=function(f){if(this.animate_){var h1=this.height_(f);var h2=this.toHeight_(f);return(h1*(1-this.elapsedRatio_)+this.elapsedRatio_*h2);}
else return this.height_(f);};ol.layer.Vector3D.prototype.hvector_=function(pt,h){var p0=[pt[0]*this.matrix_[0]+pt[1]*this.matrix_[1]+this.matrix_[4],pt[0]*this.matrix_[2]+pt[1]*this.matrix_[3]+this.matrix_[5]];return{p0:p0,p1:[p0[0]+h/this.res_*(p0[0]-this.center_[0]),p0[1]+h/this.res_*(p0[1]-this.center_[1])]};};ol.layer.Vector3D.prototype.getFeature3D_=function(f,h){var geom=this.get('geometry')(f);var c=geom.getCoordinates();switch(geom.getType()){case"Polygon":c=[c];case"MultiPolygon":var build=[];for(var i=0;i<c.length;i++){for(var j=0;j<c[i].length;j++){var b=[];for(var k=0;k<c[i][j].length;k++){b.push(this.hvector_(c[i][j][k],h));}
build.push(b);}}
return{type:"MultiPolygon",feature:f,geom:build};case"Point":return{type:"Point",feature:f,geom:this.hvector_(c,h)};default:return{};}}
ol.layer.Vector3D.prototype.drawFeature3D_=function(ctx,build){var i,j,b,k;for(i=0;i<build.length;i++){switch(build[i].type){case"MultiPolygon":{for(j=0;j<build[i].geom.length;j++){b=build[i].geom[j];for(k=0;k<b.length;k++){ctx.beginPath();ctx.moveTo(b[k].p0[0],b[k].p0[1]);ctx.lineTo(b[k].p1[0],b[k].p1[1]);ctx.stroke();}}
break;}
case"Point":{var g=build[i].geom;ctx.beginPath();ctx.moveTo(g.p0[0],g.p0[1]);ctx.lineTo(g.p1[0],g.p1[1]);ctx.stroke();break;}
default:break;}}
for(i=0;i<build.length;i++){switch(build[i].type){case"MultiPolygon":{ctx.beginPath();for(j=0;j<build[i].geom.length;j++){b=build[i].geom[j];if(j==0){ctx.moveTo(b[0].p1[0],b[0].p1[1]);for(k=1;k<b.length;k++){ctx.lineTo(b[k].p1[0],b[k].p1[1]);}}else{ctx.moveTo(b[0].p1[0],b[0].p1[1]);for(k=b.length-2;k>=0;k--){ctx.lineTo(b[k].p1[0],b[k].p1[1]);}}
ctx.closePath();}
ctx.fill("evenodd");ctx.stroke();break;}
case"Point":{b=build[i];var t=b.feature.get('label');if(t){var p=b.geom.p1;var m=ctx.measureText(t);var h=Number(ctx.font.match(/\d+(\.\d+)?/g).join([]));ctx.fillRect(p[0]-m.width/2-5,p[1]-h-5,m.width+10,h+10)
ctx.strokeRect(p[0]-m.width/2-5,p[1]-h-5,m.width+10,h+10)
ctx.save()
ctx.fillStyle=ol.color.asString(this._style.getText().getFill().getColor());ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(t,p[0],p[1]);ctx.restore();}
break;}
default:break;}}}
ol.source.WikiCommons=function(opt_options){var options=opt_options||{};options.loader=this._loaderFn;this._maxResolution=options.maxResolution||100;this._lang=options.lang||"fr";this._limit=options.limit||100;if(!options.attributions)options.attributions=["&copy; <a href='https://commons.wikimedia.org/'>Wikimedia Commons</a>"];if(!options.strategy)options.strategy=ol.loadingstrategy.bbox;ol.source.Vector.call(this,options);};ol.ext.inherits(ol.source.WikiCommons,ol.source.Vector);ol.source.WikiCommons.prototype.readFeature=function(feature,attributes){feature.set("descriptionurl",attributes.descriptionurl);feature.set("url",attributes.url);feature.set("title",attributes.title.replace(/^file:|.jpg$/ig,""));feature.set("thumbnail",attributes.url.replace(/^(.+wikipedia\/commons)\/([a-zA-Z0-9]\/[a-zA-Z0-9]{2})\/(.+)$/,"$1/thumb/$2/$3/200px-$3"));feature.set("user",attributes.user);if(attributes.extmetadata&&attributes.extmetadata.LicenseShortName)feature.set("copy",attributes.extmetadata.LicenseShortName.value);return true;};ol.source.WikiCommons.prototype._loaderFn=function(extent,resolution,projection){if(resolution>this._maxResolution)return;var self=this;var bbox=ol.proj.transformExtent(extent,projection,"EPSG:4326");var url="https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&prop=coordinates|imageinfo"
+"&generator=geosearch&iiprop=timestamp|user|url|extmetadata|metadata|size&iiextmetadatafilter=LicenseShortName"
+"&ggsbbox="+bbox[3]+"|"+bbox[0]+"|"+bbox[1]+"|"+bbox[2]
+"&ggslimit="+this._limit
+"&iilimit="+(this._limit-1)
+"&ggsnamespace=6";ol.ext.Ajax.get({url:url,success:function(data){var features=[];var att,pt,feature;if(!data.query||!data.query.pages)return;for(var i in data.query.pages){att=data.query.pages[i];if(att.coordinates&&att.coordinates.length){pt=[att.coordinates[0].lon,att.coordinates[0].lat];}else{var meta=att.imageinfo[0].metadata;if(!meta){continue;}
pt=[];var found=0;for(var k=0;k<meta.length;k++){if(meta[k].name=="GPSLongitude"){pt[0]=meta[k].value;found++;}
if(meta[k].name=="GPSLatitude"){pt[1]=meta[k].value;found++;}}
if(found!=2){continue;}}
feature=new ol.Feature(new ol.geom.Point(ol.proj.transform(pt,"EPSG:4326",projection)));att.imageinfo[0].title=att.title;if(self.readFeature(feature,att.imageinfo[0])){features.push(feature);}}
self.addFeatures(features);}});};ol.layer.AnimatedCluster=function(opt_options)
{var options=opt_options||{};ol.layer.Vector.call(this,options);this.oldcluster=new ol.source.Vector();this.clusters=[];this.animation={start:false};this.set('animationDuration',typeof(options.animationDuration)=='number'?options.animationDuration:700);this.set('animationMethod',options.animationMethod||ol.easing.easeOut);this.getSource().on('change',this.saveCluster.bind(this));this.on(['precompose','prerender'],this.animate.bind(this));this.on(['postcompose','postrender'],this.postanimate.bind(this));};ol.ext.inherits(ol.layer.AnimatedCluster,ol.layer.Vector);ol.layer.AnimatedCluster.prototype.saveCluster=function(){if(this.oldcluster){this.oldcluster.clear();if(!this.get('animationDuration'))return;var features=this.getSource().getFeatures();if(features.length&&features[0].get('features'))
{this.oldcluster.addFeatures(this.clusters);this.clusters=features.slice(0);this.sourceChanged=true;}}};ol.layer.AnimatedCluster.prototype.getClusterForFeature=function(f,cluster)
{for(var j=0,c;c=cluster[j];j++)
{var features=c.get('features');if(features&&features.length)
{for(var k=0,f2;f2=features[k];k++)
{if(f===f2)
{return c;}}}}
return false;};ol.layer.AnimatedCluster.prototype.stopAnimation=function()
{this.animation.start=false;this.animation.cA=[];this.animation.cB=[];};ol.layer.AnimatedCluster.prototype.animate=function(e)
{var duration=this.get('animationDuration');if(!duration)return;var resolution=e.frameState.viewState.resolution;var i,c0,a=this.animation;var time=e.frameState.time;if(a.resolution!=resolution&&this.sourceChanged)
{var extent=e.frameState.extent;if(a.resolution<resolution)
{extent=ol.extent.buffer(extent,100*resolution);a.cA=this.oldcluster.getFeaturesInExtent(extent);a.cB=this.getSource().getFeaturesInExtent(extent);a.revers=false;}
else
{extent=ol.extent.buffer(extent,100*resolution);a.cA=this.getSource().getFeaturesInExtent(extent);a.cB=this.oldcluster.getFeaturesInExtent(extent);a.revers=true;}
a.clusters=[];for(i=0,c0;c0=a.cA[i];i++)
{var f=c0.get('features');if(f&&f.length)
{var c=this.getClusterForFeature(f[0],a.cB);if(c)a.clusters.push({f:c0,pt:c.getGeometry().getCoordinates()});}}
a.resolution=resolution;this.sourceChanged=false;if(!a.clusters.length||a.clusters.length>1000)
{this.stopAnimation();return;}
time=a.start=(new Date()).getTime();}
if(a.start){var vectorContext=e.vectorContext||ol.render.getVectorContext(e);var d=(time-a.start)/duration;if(d>1.0)
{this.stopAnimation();d=1;}
d=this.get('animationMethod')(d);var style=this.getStyle();var stylefn=(typeof(style)=='function')?style:style.length?function(){return style;}:function(){return[style];};e.context.save();e.context.globalAlpha=this.getOpacity();for(i=0,c;c=a.clusters[i];i++)
{var pt=c.f.getGeometry().getCoordinates();var dx=pt[0]-c.pt[0];var dy=pt[1]-c.pt[1];if(a.revers)
{pt[0]=c.pt[0]+d*dx;pt[1]=c.pt[1]+d*dy;}
else
{pt[0]=pt[0]-d*dx;pt[1]=pt[1]-d*dy;}
var st=stylefn(c.f,resolution,true);if(!st.length)st=[st];if(c.f.get("features").length===1&&!dx&&!dy){f=c.f.get("features")[0];}
else{var geo=new ol.geom.Point(pt);f=new ol.Feature(geo);}
for(var k=0,s;s=st[k];k++){if(s.getText()&&/\n/.test(s.getText().getText())){var offsetX=s.getText().getOffsetX();var offsetY=s.getText().getOffsetY();var rot=s.getText().getRotation()||0;var fontSize=Number((s.getText().getFont()||'10px').match(/\d+/))*1.2;var str=s.getText().getText().split('\n')
var dl,nb=str.length-1;var s2=s.clone();str.forEach(function(t,i){if(i==1){s2.setImage();s2.setFill();s2.setStroke();}
switch(s.getText().getTextBaseline()){case'alphabetic':case'ideographic':case'bottom':{dl=nb;break;}
case'hanging':case'top':{dl=0;break;}
default:{dl=nb/2;break;}}
s2.getText().setOffsetX(offsetX-Math.sin(rot)*fontSize*(i-dl));s2.getText().setOffsetY(offsetY+Math.cos(rot)*fontSize*(i-dl));s2.getText().setText(t);vectorContext.drawFeature(f,s2);});}else{vectorContext.drawFeature(f,s);}}}
e.context.restore();e.frameState.animate=true;e.context.save();e.context.beginPath();e.context.rect(0,0,0,0);e.context.clip();this.clip_=true;}
return;};ol.layer.AnimatedCluster.prototype.postanimate=function(e)
{if(this.clip_)
{e.context.restore();this.clip_=false;}};ol.layer.GeoImage=function(options){ol.layer.Image.call(this,options);}
ol.ext.inherits(ol.layer.GeoImage,ol.layer.Image);ol.layer.GeoImage.prototype.getExtent=function(){return this.getSource().getExtent();}
ol.layer.Geoportail=function(layer,options,tileoptions){options=options||{};tileoptions=tileoptions||{};var capabilities=window.geoportailConfig?window.geoportailConfig.capabilities[options.gppKey||options.key]||window.geoportailConfig.capabilities["default"]||ol.layer.Geoportail.capabilities:ol.layer.Geoportail.capabilities;capabilities=capabilities[layer];if(!capabilities){capabilities={title:layer,originators:[]};console.error("ol.layer.Geoportail: no layer definition for \""+layer+"\"\nTry to use ol/layer/Geoportail~loadCapabilities() to get it.");}
for(var i in capabilities)if(typeof tileoptions[i]=="undefined")tileoptions[i]=capabilities[i];this._originators=capabilities.originators;if(!tileoptions.gppKey)tileoptions.gppKey=options.gppKey||options.key;options.source=new ol.source.Geoportail(layer,tileoptions);if(!options.name)options.name=capabilities.title;if(!options.desc)options.desc=capabilities.desc;if(!options.extent&&capabilities.bbox){if(capabilities.bbox[0]>-170&&capabilities.bbox[2]<170)
options.extent=ol.proj.transformExtent(capabilities.bbox,'EPSG:4326','EPSG:3857');}
if(!options.maxResolution&&tileoptions.minZoom){options.source.getTileGrid().minZoom-=(tileoptions.minZoom>1?2:1);options.maxResolution=options.source.getTileGrid().getResolution(options.source.getTileGrid().minZoom)
options.source.getTileGrid().minZoom=tileoptions.minZoom;}
ol.layer.Tile.call(this,options);this.set('layer',layer);this.set('queryable',capabilities.queryable);};ol.ext.inherits(ol.layer.Geoportail,ol.layer.Tile);ol.layer.Geoportail.capabilities={"GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN-EXPRESS.STANDARD":{"server":"https://wxs.ign.fr/geoportail/wmts","layer":"GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN-EXPRESS.STANDARD","title":"Carte IGN","format":"image/jpeg","style":"normal","queryable":false,"tilematrix":"PM","minZoom":0,"maxZoom":18,"bbox":[-179.62723,-84.5047,179.74588,85.47958],"desc":"Cartographie topographique multi-échelles du territoire français issue des bases de données vecteur de l’IGN - emprise nationale, visible du 1/200 au 1/130000000","originators":{"IGN":{"href":"http://www.ign.fr","attribution":"Institut national de l'information géographique et forestière","logo":"https://wxs.ign.fr/static/logos/IGN/IGN.gif","minZoom":0,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":13,"bbox":[-63.37252,13.428586,11.429714,51.44377]},{"minZoom":11,"maxZoom":12,"bbox":[-63.37252,13.428586,11.496459,51.444122]},{"minZoom":9,"maxZoom":9,"bbox":[-64.81273,13.428586,11.496459,51.444016]},{"minZoom":10,"maxZoom":10,"bbox":[-63.37252,13.428586,11.496459,51.444016]},{"minZoom":0,"maxZoom":2,"bbox":[-175.99709,-84.42859,175.99709,84.2865]},{"minZoom":4,"maxZoom":4,"bbox":[-179.62723,-84.0159,-179.21112,85.47958]},{"minZoom":18,"maxZoom":18,"bbox":[-63.189068,-21.428364,55.846638,51.175068]},{"minZoom":15,"maxZoom":17,"bbox":[-63.189117,-21.428364,55.84698,51.175068]},{"minZoom":14,"maxZoom":14,"bbox":[-63.283817,-21.7006,56.039127,51.44377]},{"minZoom":6,"maxZoom":8,"bbox":[-179.49689,-84.02368,179.74588,85.30035]},{"minZoom":3,"maxZoom":3,"bbox":[-176.23093,-84.5047,179.08267,84.89126]},{"minZoom":5,"maxZoom":5,"bbox":[-179.57285,-83.84196,178.4975,85.36646]}]}}},"ELEVATION.SLOPES":{"server":"https://wxs.ign.fr/geoportail/wmts","layer":"ELEVATION.SLOPES","title":"Altitude","format":"image/jpeg","style":"normal","queryable":true,"tilematrix":"PM","minZoom":6,"maxZoom":14,"bbox":[-178.20589,-22.595179,167.43176,50.93085],"desc":"La couche altitude se compose d'un MNT (Modèle Numérique de Terrain) affiché en teintes hypsométriques et issu de la BD ALTI®.","originators":{"IGN":{"href":"http://www.ign.fr","attribution":"Institut national de l'information géographique et forestière","logo":"https://wxs.ign.fr/static/logos/IGN/IGN.gif","minZoom":6,"maxZoom":14,"constraint":[{"minZoom":6,"maxZoom":14,"bbox":[55.205746,-21.392344,55.846554,-20.86271]}]}}},"GEOGRAPHICALGRIDSYSTEMS.MAPS.BDUNI.J1":{"server":"https://wxs.ign.fr/geoportail/wmts","layer":"GEOGRAPHICALGRIDSYSTEMS.MAPS.BDUNI.J1","title":"Plan IGN j+1","format":"image/png","style":"normal","queryable":false,"tilematrix":"PM","minZoom":0,"maxZoom":18,"bbox":[-179.5,-75,179.5,75],"desc":"Plan IGN j+1","originators":{"IGN":{"href":"http://www.ign.fr","attribution":"Institut national de l'information géographique et forestière","logo":"https://wxs.ign.fr/static/logos/IGN/IGN.gif","minZoom":0,"maxZoom":18,"constraint":[{"minZoom":0,"maxZoom":18,"bbox":[-179,-80,179,80]}]}}},"CADASTRALPARCELS.PARCELS":{"server":"https://wxs.ign.fr/geoportail/wmts","layer":"CADASTRALPARCELS.PARCELS","title":"Parcelles cadastrales","format":"image/png","style":"bdparcellaire","queryable":false,"tilematrix":"PM","minZoom":0,"maxZoom":20,"bbox":[-63.160706,-21.39223,55.84643,51.090965],"desc":"Limites des parcelles cadastrales issues de plans scannés et de plans numériques.","originators":{"IGN":{"href":"http://www.ign.fr","attribution":"Institut national de l'information géographique et forestière","logo":"https://wxs.ign.fr/static/logos/IGN/IGN.gif","minZoom":0,"maxZoom":20,"constraint":[{"minZoom":0,"maxZoom":20,"bbox":[-63.160706,-21.39223,55.84643,51.090965]}]}}},"ORTHOIMAGERY.ORTHOPHOTOS":{"server":"https://wxs.ign.fr/geoportail/wmts","layer":"ORTHOIMAGERY.ORTHOPHOTOS","title":"Photographies aériennes","format":"image/jpeg","style":"normal","queryable":true,"tilematrix":"PM","minZoom":0,"bbox":[-180,-86,180,84],"desc":"Photographies aériennes","originators":{"PLANETOBSERVER":{"href":"http://www.planetobserver.com/","attribution":"PlanetObserver (images satellites)","logo":"https://wxs.ign.fr/static/logos/PLANETOBSERVER/PLANETOBSERVER.gif","minZoom":0,"maxZoom":12,"constraint":[{"minZoom":0,"maxZoom":12,"bbox":[-180,-86,180,84]}]},"MPM":{"href":"http://www.marseille-provence.com/","attribution":"Marseille Provence Métropole","logo":"https://wxs.ign.fr/static/logos/MPM/MPM.gif","minZoom":20,"maxZoom":20,"constraint":[{"minZoom":20,"maxZoom":20,"bbox":[5.076959,43.153347,5.7168245,43.454994]}]},"IGN":{"href":"http://www.ign.fr","attribution":"Institut national de l'information géographique et forestière","logo":"https://wxs.ign.fr/static/logos/IGN/IGN.gif","minZoom":13,"maxZoom":20,"constraint":[{"bbox":[0.035491213,43.221077,6.0235267,49.696926]},{"minZoom":20,"maxZoom":20,"bbox":[0.035491213,43.221077,6.0235267,49.696926]},{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"CRAIG":{"href":"http://www.craig.fr","attribution":"Centre Régional Auvergnat de l'Information Géographique (CRAIG)","logo":"https://wxs.ign.fr/static/logos/CRAIG/CRAIG.gif","minZoom":13,"maxZoom":20,"constraint":[{"minZoom":20,"maxZoom":20,"bbox":[2.2243388,44.76621,2.7314367,45.11295]},{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"CNES":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES/CNES.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"CG06":{"href":"http://www.cg06.fr","attribution":"Département Alpes Maritimes (06) en partenariat avec : Groupement Orthophoto 06 (NCA, Ville de Cannes, CARF, CASA,CG06, CA de Grasse) ","logo":"https://wxs.ign.fr/static/logos/CG06/CG06.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"CG45":{"href":"http://www.loiret.com","attribution":"Le conseil général du Loiret","logo":"https://wxs.ign.fr/static/logos/CG45/CG45.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"RGD_SAVOIE":{"href":"http://www.rgd.fr","attribution":"Régie de Gestion de Données des Pays de Savoie (RGD 73-74)","logo":"https://wxs.ign.fr/static/logos/RGD_SAVOIE/RGD_SAVOIE.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"e-Megalis":{"href":"http://www.e-megalisbretagne.org//","attribution":"Syndicat mixte de coopération territoriale (e-Megalis)","logo":"https://wxs.ign.fr/static/logos/e-Megalis/e-Megalis.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"SIGLR":{"href":"http://www.siglr.org//","attribution":"SIGLR","logo":"https://wxs.ign.fr/static/logos/SIGLR/SIGLR.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"PPIGE":{"href":"http://www.ppige-npdc.fr/","attribution":"PPIGE","logo":"https://wxs.ign.fr/static/logos/PPIGE/PPIGE.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"FEDER2":{"href":"http://www.europe-en-france.gouv.fr/","attribution":"Fonds européen de développement économique et régional","logo":"https://wxs.ign.fr/static/logos/FEDER2/FEDER2.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"FEDER":{"href":"http://www.europe-en-france.gouv.fr/","attribution":"Fonds européen de développement économique et régional","logo":"https://wxs.ign.fr/static/logos/FEDER/FEDER.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"CRCORSE":{"href":"http://www.corse.fr//","attribution":"CRCORSE","logo":"https://wxs.ign.fr/static/logos/CRCORSE/CRCORSE.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"CNES_AUVERGNE":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_AUVERGNE/CNES_AUVERGNE.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"FEDER_PAYSDELALOIRE":{"href":"http://www.europe-en-paysdelaloire.eu/","attribution":"Pays-de-la-Loire","logo":"https://wxs.ign.fr/static/logos/FEDER_PAYSDELALOIRE/FEDER_PAYSDELALOIRE.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"FEDER_AUVERGNE":{"href":"http://www.europe-en-auvergne.eu/","attribution":"Auvergne","logo":"https://wxs.ign.fr/static/logos/FEDER_AUVERGNE/FEDER_AUVERGNE.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"PREFECTURE_GUADELOUPE":{"href":"www.guadeloupe.pref.gouv.fr/","attribution":"guadeloupe","logo":"https://wxs.ign.fr/static/logos/PREFECTURE_GUADELOUPE/PREFECTURE_GUADELOUPE.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"BOURGOGNE-FRANCHE-COMTE":{"href":"https://www.bourgognefranchecomte.fr/","attribution":"Auvergne","logo":"https://wxs.ign.fr/static/logos/BOURGOGNE-FRANCHE-COMTE/BOURGOGNE-FRANCHE-COMTE.gif","minZoom":13,"maxZoom":19,"constraint":[{"minZoom":13,"maxZoom":19,"bbox":[-179.5,-75,179.5,75]}]},"ASTRIUM":{"href":"http://www.geo-airbusds.com/","attribution":"Airbus Defence and Space","logo":"https://wxs.ign.fr/static/logos/ASTRIUM/ASTRIUM.gif","minZoom":13,"maxZoom":16,"constraint":[{"minZoom":13,"maxZoom":16,"bbox":[-55.01953,1.845384,-50.88867,6.053161]}]},"DITTT":{"href":"http://www.dittt.gouv.nc/portal/page/portal/dittt/","attribution":"Direction des Infrastructures, de la Topographie et des Transports Terrestres","logo":"https://wxs.ign.fr/static/logos/DITTT/DITTT.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[163.47784,-22.767689,167.94624,-19.434975]}]},"CNES_ALSACE":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_ALSACE/CNES_ALSACE.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[-179.5,-75,179.5,75]}]},"CNES_971":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_971/CNES_971.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[-179.5,-75,179.5,75]}]},"CNES_972":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_972/CNES_972.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[-179.5,-75,179.5,75]}]},"CNES_974":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_974/CNES_974.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[-179.5,-75,179.5,75]}]},"CNES_975":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_975/CNES_975.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[-179.5,-75,179.5,75]}]},"CNES_976":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_976/CNES_976.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[-179.5,-75,179.5,75]}]},"CNES_977":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_977/CNES_977.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[-179.5,-75,179.5,75]}]},"CNES_978":{"href":"http://www.cnes.fr/","attribution":"Centre national d'études spatiales (CNES)","logo":"https://wxs.ign.fr/static/logos/CNES_978/CNES_978.gif","minZoom":13,"maxZoom":18,"constraint":[{"minZoom":13,"maxZoom":18,"bbox":[-179.5,-75,179.5,75]}]}}},"GEOGRAPHICALGRIDSYSTEMS.PLANIGN":{"server":"https://wxs.ign.fr/geoportail/wmts","layer":"GEOGRAPHICALGRIDSYSTEMS.PLANIGN","title":"Plan IGN","format":"image/jpeg","style":"normal","queryable":false,"tilematrix":"PM","minZoom":0,"maxZoom":18,"bbox":[-179.5,-75,179.5,75],"desc":"Représentation graphique des bases de données IGN.","originators":{"IGN":{"href":"http://www.ign.fr","attribution":"Institut national de l'information géographique et forestière","logo":"https://wxs.ign.fr/static/logos/IGN/IGN.gif","minZoom":0,"maxZoom":18,"constraint":[{"minZoom":10,"maxZoom":18,"bbox":[-63.37252,-21.475586,55.925865,51.31212]},{"minZoom":0,"maxZoom":9,"bbox":[-179.5,-75,179.5,75]}]}}},"GEOGRAPHICALGRIDSYSTEMS.MAPS":{"server":"https://wxs.ign.fr/geoportail/wmts","layer":"GEOGRAPHICALGRIDSYSTEMS.MAPS","title":"Cartes IGN","format":"image/jpeg","style":"normal","queryable":true,"tilematrix":"PM","minZoom":0,"maxZoom":18,"bbox":[-180,-68.138855,180,80],"desc":"Cartes IGN","originators":{"IGN":{"href":"http://www.ign.fr","attribution":"Institut national de l'information géographique et forestière","logo":"https://wxs.ign.fr/static/logos/IGN/IGN.gif","minZoom":0,"maxZoom":18,"constraint":[{"minZoom":17,"maxZoom":17,"bbox":[-63.189117,-21.428364,55.84698,51.175068]},{"minZoom":18,"maxZoom":18,"bbox":[-63.189068,-21.428364,55.846638,51.175068]},{"minZoom":7,"maxZoom":8,"bbox":[-178.20573,-68.138855,144.84375,51.909786]},{"minZoom":13,"maxZoom":14,"bbox":[-178.20573,-67.101425,142.03836,51.44377]},{"minZoom":11,"maxZoom":12,"bbox":[-178.20573,-67.101425,142.03836,51.444122]},{"minZoom":9,"maxZoom":10,"bbox":[-178.20573,-68.138855,144.84375,51.444016]},{"minZoom":15,"maxZoom":16,"bbox":[-178.20573,-46.502903,77.60037,51.175068]},{"minZoom":0,"maxZoom":6,"bbox":[-180,-60,180,80]}]},"NCL-DITTT":{"href":"http://www.dittt.gouv.nc/portal/page/portal/dittt","attribution":"Direction des Infrastructures, de la Topographie et des Transports Terrestres du gouvernement de la Nouvelle-Calédonie","logo":"https://wxs.ign.fr/static/logos/NCL-DITTT/NCL-DITTT.gif","minZoom":8,"maxZoom":16,"constraint":[{"minZoom":8,"maxZoom":10,"bbox":[163.47784,-22.854631,168.24048,-19.402704]},{"minZoom":11,"maxZoom":13,"bbox":[163.47784,-22.972307,168.24327,-19.494438]},{"minZoom":14,"maxZoom":15,"bbox":[164.53125,-22.75592,168.22266,-20.303417]},{"minZoom":16,"maxZoom":16,"bbox":[163.47784,-22.79525,168.19109,-19.494438]}]}}},"TRANSPORTNETWORKS.ROADS":{"server":"https://wxs.ign.fr/geoportail/wmts","layer":"TRANSPORTNETWORKS.ROADS","title":"Routes","format":"image/png","style":"normal","queryable":false,"tilematrix":"PM","minZoom":6,"maxZoom":18,"bbox":[-63.969162,-21.49687,55.964417,71.584076],"desc":"Affichage du réseau routier français et européen.","originators":{"IGN":{"href":"http://www.ign.fr","attribution":"Institut national de l'information géographique et forestière","logo":"https://wxs.ign.fr/static/logos/IGN/IGN.gif","minZoom":6,"maxZoom":18,"constraint":[{"minZoom":15,"maxZoom":18,"bbox":[-63.37252,-21.475586,55.925865,51.31212]},{"minZoom":6,"maxZoom":14,"bbox":[-63.969162,-21.49687,55.964417,71.584076]}]}}},};ol.layer.Geoportail.loadCapabilities=function(gppKey,all){var onSuccess=function(){}
var onError=function(){}
var onFinally=function(){};this.getCapabilities(gppKey,all).then(function(c){ol.layer.Geoportail.capabilities=c;onSuccess(c);}).catch(function(e){onError(e);}).finally(function(c){onFinally(c);});var response={then:function(callback){if(typeof(callback)==='function')onSuccess=callback;return response;},catch:function(callback){if(typeof(callback)==='function')onError=callback;return response;},finally:function(callback){if(typeof(callback)==='function')onFinally=callback;return response;}}
return response;};ol.layer.Geoportail.getCapabilities=function(gppKey){var capabilities={};var onSuccess=function(){}
var onError=function(){}
var onFinally=function(){}
var geopresolutions=[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,0.5971642833948135,0.29858214169740677,0.14929107084870338];function getZoom(res){res=Number(res)*0.000281;for(var r=0;r<geopresolutions.length;r++)
if(res>geopresolutions[r])return r;}
function mergeConstraints(ori){for(var i=ori.constraint.length-1;i>0;i--){for(var j=0;j<i;j++){var bok=true;for(var k=0;k<4;k++){if(ori.constraint[i].bbox[k]!=ori.constraint[j].bbox[k]){bok=false;break;}}
if(!bok)continue;if(ori.constraint[i].maxZoom==ori.constraint[j].minZoom||ori.constraint[j].maxZoom==ori.constraint[i].minZoom||ori.constraint[i].maxZoom+1==ori.constraint[j].minZoom||ori.constraint[j].maxZoom+1==ori.constraint[i].minZoom||ori.constraint[i].minZoom-1==ori.constraint[j].maxZoom||ori.constraint[j].minZoom-1==ori.constraint[i].maxZoom){ori.constraint[j].maxZoom=Math.max(ori.constraint[i].maxZoom,ori.constraint[j].maxZoom);ori.constraint[j].minZoom=Math.min(ori.constraint[i].minZoom,ori.constraint[j].minZoom);ori.constraint.splice(i,1);break;}}}}
ol.ext.Ajax.get({url:'https://wxs.ign.fr/'+gppKey+'/autoconf/',dataType:'TEXT',error:function(e){onError(e);onFinally({});},success:function(resp){var parser=new DOMParser();var config=parser.parseFromString(resp,"text/xml");var layers=config.getElementsByTagName('Layer');for(var i=0,l;l=layers[i];i++){if(!/WMTS/.test(l.getElementsByTagName('Server')[0].attributes['service'].value))continue;var service={server:l.getElementsByTagName('gpp:Key')[0].innerHTML.replace(gppKey+"/",""),layer:l.getElementsByTagName('Name')[0].innerHTML,title:l.getElementsByTagName('Title')[0].innerHTML,format:l.getElementsByTagName('Format')[0].innerHTML,style:l.getElementsByTagName('Style')[0].getElementsByTagName('Name')[0].innerHTML,queryable:(l.attributes.queryable.value==='1'),tilematrix:'PM',minZoom:getZoom(l.getElementsByTagName('sld:MaxScaleDenominator')[0].innerHTML),maxZoom:getZoom(l.getElementsByTagName('sld:MinScaleDenominator')[0].innerHTML),bbox:JSON.parse('['+l.getElementsByTagName('gpp:BoundingBox')[0].innerHTML+']'),desc:l.getElementsByTagName('Abstract')[0].innerHTML.replace(/^<!\[CDATA\[(.*)\]\]>$/,'$1')};service.originators={};var origin=l.getElementsByTagName('gpp:Originator');for(var k=0,o;o=origin[k];k++){var ori=service.originators[o.attributes['name'].value]={href:o.getElementsByTagName('gpp:URL')[0].innerHTML,attribution:o.getElementsByTagName('gpp:Attribution')[0].innerHTML,logo:o.getElementsByTagName('gpp:Logo')[0].innerHTML,minZoom:20,maxZoom:0,constraint:[]};var constraint=o.getElementsByTagName('gpp:Constraint');for(var j=0,c;c=constraint[j];j++){var zmax=getZoom(c.getElementsByTagName('sld:MinScaleDenominator')[0].innerHTML);var zmin=getZoom(c.getElementsByTagName('sld:MaxScaleDenominator')[0].innerHTML);if(zmin>ori.maxZoom)ori.maxZoom=zmin;if(zmin<ori.minZoom)ori.minZoom=zmin;if(zmax>ori.maxZoom)ori.maxZoom=zmax;if(zmax<ori.minZoom)ori.minZoom=zmax;ori.constraint.push({minZoom:zmin,maxZoom:zmax,bbox:JSON.parse('['+c.getElementsByTagName('gpp:BoundingBox')[0].innerHTML+']')});}
mergeConstraints(ori)}
capabilities[service.layer]=service;}
onSuccess(capabilities);onFinally(capabilities);}});var response={then:function(callback){if(typeof(callback)==='function')onSuccess=callback;return response;},catch:function(callback){if(typeof(callback)==='function')onError=callback;return response;},finally:function(callback){if(typeof(callback)==='function')onFinally=callback;return response;},}
return response;};ol.source.Source.prototype.getPreview=function(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAk6QAAJOkBUCTn+AAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAANeSURBVHic7ZpPiE1RHMc/780MBhkik79JSUlIUbOxI+wkI2yRhYSUlJLNpJF/xcpiJBmZGBZsNM1CkmhKITGkGbH0/BuPmXnP4rxbb/TOn3fvOffeec6nfqvb/b7f93fveeec37ng8Xg8Ho/nf6Uu4d+fDswFssCvhHOJhaXAMeApMAQUyyIPPAdOAiuTStAVy4EHjDWsix5gdRLJ2mY34ulWYz6IEeA4kIk9awtkgTOEM/5vdAKT4k0/Ou3YMR/ELcbRm9AKFLBbgCJwNE4TYZkJfMG++SIwDCyLz0o4bI17WdyJz0r1TAZ+oDcxCBwAFgIzEIuhvcBbg3sLwOK4DFXLFvQGniCGSSUagS4DjUPOHESkA3XiOWCORqMR6Nfo9DjI3QqPUSd+ylBnv0Zn0GrWFvmIOvGNhjqrNDp/EAutyFgRKUM2tgO+Gur81FxvAKYZaimxXYBvmuuLDHWWaK4X0RfJCNsF6NdcbzXU2a65PohYFKWOc+jn8PUajbWIXaBKp9NB7lZYh34OzwFbFfd/NtDYYSth27urLGIm0M31AL3APWAAmIooymaDnPIl/Vz4NN1yHrd7gcvxWQnHAuA3bsyPop8hUsE13BSgK04TUViBeFo2zedJ8S6wElexW4D2eNOPTjNi6WvD/DtEr8E6tk6GGoAmxFY2iFHE9NZiQf8gogiB9gTEH23izAZuE77vHyU+ANucO1QwD3hD/MbLowAcdm20EmkwXx4n3NodS9rMB2HabYpEWs0HcRqHp0fNwAvJD+eBTZr7p6BvmQVxUaEzEbiruNfJekH15L8jtrEm7JJolEcOmKXRqQOuKDQuY7HZY8s8iNfzkSLxIuI43FTrkkLnOlBfRW4VsWk+oAX5weknxFAxJQNckGgVgZuIRVoomoGXEmGTMa+iQ6K7M4SW7k24QYgiuDQPYinbhugiF4H3RGtzZYCzyIvQXfpNI1ybLyeLpf5+iTbkRbiP2EcocTHm4+YI8iI8RFHwWjAfsA95Q+YZFU6wasl8wB7kReijtNbIILa0vcg/PRlGfPQwHmlCviDqAzaA+OREtzqr1ejOIDorxlNEjTGUBV4nnUWCvAJxGDlA8q9j3DEArAn2zvXAfOwfl6eVAmJrPpJ0Ih6Px+PxeJLjLwPul3vj5d0eAAAAAElFTkSuQmCC";};ol.source.Tile.prototype.getPreview=function(lonlat,resolution)
{if(!lonlat)lonlat=[21020,6355964];if(!resolution)resolution=150;var coord=this.getTileGrid().getTileCoordForCoordAndResolution(lonlat,resolution);var fn=this.getTileUrlFunction();return fn.call(this,coord,this.getProjection());};ol.source.TileWMS.prototype.getPreview=function(lonlat,resolution)
{if(!lonlat)lonlat=[21020,6355964];if(!resolution)resolution=150;var url=this.getGetFeatureInfoUrl?this.getGetFeatureInfoUrl(lonlat,resolution,this.getProjection()||'EPSG:3857',{}):this.getFeatureInfoUrl(lonlat,resolution,this.getProjection()||'EPSG:3857',{});url=url.replace(/getfeatureinfo/i,"GetMap");return url;};ol.layer.Base.prototype.getPreview=function(lonlat,resolution)
{if(this.get("preview"))return[this.get("preview")];if(!resolution)resolution=150;if(resolution<this.getMinResolution()||resolution>this.getMaxResolution())
{var rmin=this.getMinResolution(),rmax=this.getMaxResolution();if(rmax>100000)rmax=156543;if(rmin<0.15)rmin=0.15;resolution=rmax;while(rmax>rmin)
{rmin*=2;rmax/=2;resolution=rmin;}}
var e=this.getExtent();if(!lonlat)lonlat=[21020,6355964];if(e&&!ol.extent.containsCoordinate(e,lonlat))lonlat=[(e[0]+e[2])/2,(e[1]+e[3])/2];if(this.getSource)return[this.getSource().getPreview(lonlat,resolution)];return[];};ol.layer.Group.prototype.getPreview=function(lonlat,resolution)
{if(this.get("preview"))return[this.get("preview")];var t=[];if(this.getLayers)
{var l=this.getLayers().getArray();for(var i=0;i<l.length;i++)
{t=t.concat(l[i].getPreview(lonlat,resolution));}}
return t;};ol.layer.Vector.prototype.setRender3D=function(r){r.setLayer(this);}
ol.render3D=function(options){options=options||{};options.maxResolution=options.maxResolution||100
options.defaultHeight=options.defaultHeight||0;ol.Object.call(this,options);this.setStyle(options.style);this.height_=options.height=this.getHfn(options.height);if(options.layer)this.setLayer(options.layer);}
ol.ext.inherits(ol.render3D,ol.Object);ol.render3D.prototype.setStyle=function(s){if(s instanceof ol.style.Style)this._style=s;else this._style=new ol.style.Style();if(!this._style.getStroke()){this._style.setStroke(new ol.style.Stroke({width:1,color:'red'}));}
if(!this._style.getFill()){this._style.setFill(new ol.style.Fill({color:'rgba(0,0,255,0.5)'}));}
if(s&&s.getGeometry()){var geom=s.getGeometry();if(typeof(geom)==='function'){this.set('geometry',geom);}else{this.set('geometry',function(){return geom;});}}else{this.set('geometry',function(f){return f.getGeometry();});}};ol.render3D.prototype.getStyle=function(){return this._style;};ol.render3D.prototype.onPostcompose_=function(e){var res=e.frameState.viewState.resolution;if(res>this.get('maxResolution'))return;this.res_=res*400;if(this.animate_){var elapsed=e.frameState.time-this.animate_;if(elapsed<this.animateDuration_){this.elapsedRatio_=this.easing_(elapsed/this.animateDuration_);e.frameState.animate=true;}else{this.animate_=false;this.height_=this.toHeight_}}
var ratio=e.frameState.pixelRatio;var ctx=e.context;var m=this.matrix_=e.frameState.coordinateToPixelTransform;if(!m){m=e.frameState.coordinateToPixelMatrix,m[2]=m[4];m[3]=m[5];m[4]=m[12];m[5]=m[13];}
this.center_=[ctx.canvas.width/2/ratio,ctx.canvas.height/ratio];var f=this.layer_.getSource().getFeaturesInExtent(e.frameState.extent);ctx.save();ctx.scale(ratio,ratio);var s=this.getStyle();ctx.lineWidth=s.getStroke().getWidth();ctx.strokeStyle=ol.color.asString(s.getStroke().getColor());ctx.fillStyle=ol.color.asString(s.getFill().getColor());var builds=[];for(var i=0;i<f.length;i++){builds.push(this.getFeature3D_(f[i],this.getFeatureHeight(f[i])));}
this.drawFeature3D_(ctx,builds);ctx.restore();};ol.render3D.prototype.setLayer=function(l){if(this._listener){this._listener.forEach(function(l){ol.Observable.unByKey(l);});}
this.layer_=l;this._listener=l.on(['postcompose','postrender'],this.onPostcompose_.bind(this));}
ol.render3D.prototype.getHfn=function(h){switch(typeof(h)){case'function':return h;case'string':{var dh=this.get('defaultHeight');return(function(f){return(Number(f.get(h))||dh);});}
case'number':return(function(){return h;});default:return(function(){return 10;});}}
ol.render3D.prototype.animate=function(options){options=options||{};this.toHeight_=this.getHfn(options.height);this.animate_=new Date().getTime();this.animateDuration_=options.duration||1000;this.easing_=options.easing||ol.easing.easeOut;this.layer_.changed();}
ol.render3D.prototype.animating=function(){if(this.animate_&&new Date().getTime()-this.animate_>this.animateDuration_){this.animate_=false;}
return!!this.animate_;}
ol.render3D.prototype.getFeatureHeight=function(f){if(this.animate_){var h1=this.height_(f);var h2=this.toHeight_(f);return(h1*(1-this.elapsedRatio_)+this.elapsedRatio_*h2);}
else return this.height_(f);};ol.render3D.prototype.hvector_=function(pt,h){var p0=[pt[0]*this.matrix_[0]+pt[1]*this.matrix_[1]+this.matrix_[4],pt[0]*this.matrix_[2]+pt[1]*this.matrix_[3]+this.matrix_[5]];return{p0:p0,p1:[p0[0]+h/this.res_*(p0[0]-this.center_[0]),p0[1]+h/this.res_*(p0[1]-this.center_[1])]};};ol.render3D.prototype.getFeature3D_=function(f,h){var geom=this.get('geometry')(f);var c=geom.getCoordinates();switch(geom.getType()){case"Polygon":c=[c];case"MultiPolygon":var build=[];for(var i=0;i<c.length;i++){for(var j=0;j<c[i].length;j++){var b=[];for(var k=0;k<c[i][j].length;k++){b.push(this.hvector_(c[i][j][k],h));}
build.push(b);}}
return{type:"MultiPolygon",feature:f,geom:build};case"Point":return{type:"Point",feature:f,geom:this.hvector_(c,h)};default:return{};}}
ol.render3D.prototype.drawFeature3D_=function(ctx,build){var i,j,b,k;for(i=0;i<build.length;i++){switch(build[i].type){case"MultiPolygon":{for(j=0;j<build[i].geom.length;j++){b=build[i].geom[j];for(k=0;k<b.length;k++){ctx.beginPath();ctx.moveTo(b[k].p0[0],b[k].p0[1]);ctx.lineTo(b[k].p1[0],b[k].p1[1]);ctx.stroke();}}
break;}
case"Point":{var g=build[i].geom;ctx.beginPath();ctx.moveTo(g.p0[0],g.p0[1]);ctx.lineTo(g.p1[0],g.p1[1]);ctx.stroke();break;}
default:break;}}
for(i=0;i<build.length;i++){switch(build[i].type){case"MultiPolygon":{ctx.beginPath();for(j=0;j<build[i].geom.length;j++){b=build[i].geom[j];if(j==0){ctx.moveTo(b[0].p1[0],b[0].p1[1]);for(k=1;k<b.length;k++){ctx.lineTo(b[k].p1[0],b[k].p1[1]);}}else{ctx.moveTo(b[0].p1[0],b[0].p1[1]);for(k=b.length-2;k>=0;k--){ctx.lineTo(b[k].p1[0],b[k].p1[1]);}}
ctx.closePath();}
ctx.fill("evenodd");ctx.stroke();break;}
case"Point":{b=build[i];var t=b.feature.get('label');if(t){var p=b.geom.p1;var f=ctx.fillStyle;ctx.fillStyle=ctx.strokeStyle;ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(t,p[0],p[1]);var m=ctx.measureText(t);var h=Number(ctx.font.match(/\d+(\.\d+)?/g).join([]));ctx.fillStyle="rgba(255,255,255,0.5)";ctx.fillRect(p[0]-m.width/2-5,p[1]-h-5,m.width+10,h+10)
ctx.strokeRect(p[0]-m.width/2-5,p[1]-h-5,m.width+10,h+10)
ctx.fillStyle=f;}
break;}
default:break;}}}
ol.Overlay.Popup=function(options){var self=this;options=options||{};if(typeof(options.offsetBox)==='number')this.offsetBox=[options.offsetBox,options.offsetBox,options.offsetBox,options.offsetBox];else this.offsetBox=options.offsetBox;var element=document.createElement("div");options.element=element;var anchorElement=document.createElement("div");anchorElement.classList.add("anchor");element.appendChild(anchorElement);this.content=ol.ext.element.create("div",{html:options.html||'',className:"ol-popup-content",parent:element});this.closeBox=options.closeBox;this.onclose=options.onclose;this.onshow=options.onshow;var button=document.createElement("button");button.classList.add("closeBox");if(options.closeBox)button.classList.add('hasclosebox');button.setAttribute('type','button');element.insertBefore(button,anchorElement);button.addEventListener("click",function(){self.hide();});if(options.stopEvent){element.addEventListener("mousedown",function(e){e.stopPropagation();});element.addEventListener("touchstart",function(e){e.stopPropagation();});}
ol.Overlay.call(this,options);this._elt=element;this.setPositioning(options.positioning||'auto');this.setPopupClass(options.popupClass||options.className||'default');if(options.position){setTimeout(function(){this.show(options.position);}.bind(this));}};ol.ext.inherits(ol.Overlay.Popup,ol.Overlay);ol.Overlay.Popup.prototype.getClassPositioning=function(){var c="";var pos=this.getPositioning();if(/bottom/.test(pos))c+="ol-popup-bottom ";if(/top/.test(pos))c+="ol-popup-top ";if(/left/.test(pos))c+="ol-popup-left ";if(/right/.test(pos))c+="ol-popup-right ";if(/^center/.test(pos))c+="ol-popup-middle ";if(/center$/.test(pos))c+="ol-popup-center ";return c;};ol.Overlay.Popup.prototype.setClosebox=function(b){this.closeBox=b;if(b)this._elt.classList.add("hasclosebox");else this._elt.classList.remove("hasclosebox");};ol.Overlay.Popup.prototype.setPopupClass=function(c){this._elt.className="";var classesPositioning=this.getClassPositioning().split(' ').filter(function(className){return className.length>0;});var classes=["ol-popup"];if(c){c.split(' ').filter(function(className){return className.length>0;}).forEach(function(className){classes.push(className);});}else{classes.push("default");}
classesPositioning.forEach(function(className){classes.push(className);});if(this.closeBox){classes.push("hasclosebox");}
this._elt.classList.add.apply(this._elt.classList,classes);};ol.Overlay.Popup.prototype.addPopupClass=function(c){this._elt.classList.add(c);};ol.Overlay.Popup.prototype.removePopupClass=function(c){this._elt.classList.remove(c);};ol.Overlay.Popup.prototype.setPositioning=function(pos){if(pos===undefined)
return;if(/auto/.test(pos)){this.autoPositioning=pos.split('-');if(this.autoPositioning.length==1)this.autoPositioning[1]="auto";}
else this.autoPositioning=false;pos=pos.replace(/auto/g,"center");if(pos=="center")pos="bottom-center";this.setPositioning_(pos);};ol.Overlay.Popup.prototype.setPositioning_=function(pos){if(this._elt){ol.Overlay.prototype.setPositioning.call(this,pos);this._elt.classList.remove("ol-popup-top","ol-popup-bottom","ol-popup-left","ol-popup-right","ol-popup-center","ol-popup-middle");var classes=this.getClassPositioning().split(' ').filter(function(className){return className.length>0;});this._elt.classList.add.apply(this._elt.classList,classes);}};ol.Overlay.Popup.prototype.getVisible=function(){return this._elt.classList.contains("visible");};ol.Overlay.Popup.prototype.show=function(coordinate,html){if(!html&&typeof(coordinate)=='string'){html=coordinate;coordinate=null;}
if(coordinate===true){coordinate=this.getPosition();}
var self=this;var map=this.getMap();if(!map)return;if(html&&html!==this.prevHTML){this.prevHTML=html;this.content.innerHTML="";if(html instanceof Element){this.content.appendChild(html);}else{this.content.insertAdjacentHTML('beforeend',html);}
Array.prototype.slice.call(this.content.querySelectorAll('img')).forEach(function(image){image.addEventListener("load",function(){map.renderSync();});});}
if(coordinate){if(this.autoPositioning){var p=map.getPixelFromCoordinate(coordinate);var s=map.getSize();var pos=[];if(this.autoPositioning[0]=='auto'){pos[0]=(p[1]<s[1]/3)?"top":"bottom";}
else pos[0]=this.autoPositioning[0];pos[1]=(p[0]<2*s[0]/3)?"left":"right";this.setPositioning_(pos[0]+"-"+pos[1]);if(this.offsetBox){this.setOffset([this.offsetBox[pos[1]=="left"?2:0],this.offsetBox[pos[0]=="top"?3:1]]);}}else{if(this.offsetBox){this.setOffset(this.offsetBox);}}
this.setPosition(coordinate);this._elt.parentElement.style.display='';if(typeof(this.onshow)=='function')this.onshow();this._tout=setTimeout(function(){self._elt.classList.add("visible");},0);}};ol.Overlay.Popup.prototype.hide=function(){if(this.getPosition()==undefined)return;if(typeof(this.onclose)=='function')this.onclose();this.setPosition(undefined);if(this._tout)clearTimeout(this._tout);this._elt.classList.remove("visible");};ol.Overlay.Magnify=function(options){var elt=document.createElement("div");elt.className="ol-magnify";this._elt=elt;ol.Overlay.call(this,{positioning:options.positioning||"center-center",element:this._elt,stopEvent:false});this.mgmap_=new ol.Map({controls:new ol.Collection(),interactions:new ol.Collection(),target:options.target||this._elt,view:new ol.View({projection:options.projection}),layers:options.layers});this.mgview_=this.mgmap_.getView();this.external_=options.target?true:false;this.set("zoomOffset",options.zoomOffset||1);this.set("active",true);this.on("propertychange",this.setView_.bind(this));};ol.ext.inherits(ol.Overlay.Magnify,ol.Overlay);ol.Overlay.Magnify.prototype.setMap=function(map){if(this.getMap()){this.getMap().getViewport().removeEventListener("mousemove",this.onMouseMove_);}
if(this._listener)ol.Observable.unByKey(this._listener);this._listener=null;ol.Overlay.prototype.setMap.call(this,map);map.getViewport().addEventListener("mousemove",this.onMouseMove_.bind(this));this._listener=map.getView().on('propertychange',this.setView_.bind(this));this.setView_();};ol.Overlay.Magnify.prototype.getMagMap=function()
{return this.mgmap_;};ol.Overlay.Magnify.prototype.getActive=function()
{return this.get("active");};ol.Overlay.Magnify.prototype.setActive=function(active)
{return this.set("active",active);};ol.Overlay.Magnify.prototype.onMouseMove_=function(e)
{var self=this;if(!self.get("active"))
{self.setPosition();}
else
{var px=self.getMap().getEventCoordinate(e);if(!self.external_)self.setPosition(px);self.mgview_.setCenter(px);if(self._elt.querySelector('canvas').style.display=="none")self.mgmap_.updateSize();}};ol.Overlay.Magnify.prototype.setView_=function(e)
{if(!this.get("active"))
{this.setPosition();return;}
if(!e)
{this.setView_({key:'rotation'});this.setView_({key:'resolution'});return;}
switch(e.key)
{case'rotation':this.mgview_.setRotation(this.getMap().getView().getRotation());break;case'zoomOffset':case'resolution':{var z=Math.max(0,this.getMap().getView().getZoom()+Number(this.get("zoomOffset")));this.mgview_.setZoom(z);break;}
default:break;}};ol.Overlay.Placemark=function(options){options=options||{};options.popupClass=(options.popupClass||'')+' placemark anim'
options.positioning='bottom-center',ol.Overlay.Popup.call(this,options);this.setPositioning=function(){};if(options.color)this.element.style.color=options.color;if(options.backgroundColor)this.element.style.backgroundColor=options.backgroundColor;if(options.contentColor)this.setContentColor(options.contentColor);if(options.size)this.setRadius(options.size);};ol.ext.inherits(ol.Overlay.Placemark,ol.Overlay.Popup);ol.Overlay.Placemark.prototype.show=function(coordinate,html){if(coordinate===true){coordinate=this.getPosition();}
this.hide();ol.Overlay.Popup.prototype.show.apply(this,[coordinate,html]);};ol.Overlay.Placemark.prototype.setColor=function(color){this.element.style.color=color;};ol.Overlay.Placemark.prototype.setBackgroundColor=function(color){this.element.style.backgroundColor=color;};ol.Overlay.Placemark.prototype.setContentColor=function(color){var c=this.element.getElementsByClassName('ol-popup-content')[0];if(c)c.style.color=color;};ol.Overlay.Placemark.prototype.setClassName=function(name){var oldclass=this.element.className;this.element.className='ol-popup placemark ol-popup-bottom ol-popup-center '
+(/visible/.test(oldclass)?'visible ':'')
+(/anim/.test(oldclass)?'anim ':'')
+name;};ol.Overlay.Placemark.prototype.setRadius=function(size){this.element.style.fontSize=size+'px';};ol.Overlay.PopupFeature=function(options){options=options||{};ol.Overlay.Popup.call(this,options);this.setTemplate(options.template);this.set('canFix',options.canFix)
this.set('showImage',options.showImage)
this.set('maxChar',options.maxChar||200)
if(options.select&&(typeof options.select.on==='function')){this._select=options.select;options.select.on('select',function(e){if(!this._noselect)this.show(e.mapBrowserEvent.coordinate,options.select.getFeatures().getArray());}.bind(this));}};ol.ext.inherits(ol.Overlay.PopupFeature,ol.Overlay.Popup);ol.Overlay.PopupFeature.prototype.setTemplate=function(template){this._template=template;if(this._template&&this._template.attributes instanceof Array){var att={};this._template.attributes.forEach(function(a){att[a]=true;});this._template.attributes=att;}};ol.Overlay.PopupFeature.prototype.show=function(coordinate,features){if(coordinate instanceof ol.Feature||(coordinate instanceof Array&&coordinate[0]instanceof ol.Feature)){features=coordinate;coordinate=null;}
if(!(features instanceof Array))features=[features];this._features=features.slice();if(!this._count)this._count=1;this._count=1;var html=this._getHtml(features[0]);this.hide();if(html){if(!coordinate||features[0].getGeometry().getType()==='Point'){coordinate=features[0].getGeometry().getFirstCoordinate();}
ol.Overlay.Popup.prototype.show.call(this,coordinate,html);}};ol.Overlay.PopupFeature.prototype._getHtml=function(feature){if(!feature)return'';var html=ol.ext.element.create('DIV',{className:'ol-popupfeature'});if(this.get('canFix')){ol.ext.element.create('I',{className:'ol-fix',parent:html}).addEventListener('click',function(){this.element.classList.toggle('ol-fixed');}.bind(this));}
var template=this._template;if(!template||!template.attributes){template=template||{};template.attributes={};for(var i in feature.getProperties())if(i!='geometry'){template.attributes[i]=i;}}
if(template.title){var title;if(typeof template.title==='function'){title=template.title(feature);}else{title=feature.get(template.title);}
ol.ext.element.create('H1',{html:title,parent:html});}
if(template.attributes){var tr,table=ol.ext.element.create('TABLE',{parent:html});var atts=template.attributes;for(var att in atts){var a=atts[att];var content,val=feature.get(att);if(typeof(a.format)==='function'){val=a.format(val,feature);}
var visible=true;if(typeof(a.visible)==='boolean'){visible=a.visible;}else if(typeof(a.visible)==='function'){visible=a.visible(feature,val);}
if(visible){tr=ol.ext.element.create('TR',{parent:table});ol.ext.element.create('TD',{html:a.title||att,parent:tr});if(this.get('showImage')&&/(http(s?):)([/|.|\w|\s|-])*\.(?:jpg|gif|png)/.test(val)){content=ol.ext.element.create('IMG',{src:val});}else{content=(a.before||'')+val+(a.after||'');var maxc=this.get('maxChar')||200;if(typeof(content)==='string'&&content.length>maxc)content=content.substr(0,maxc)+'[...]';}
ol.ext.element.create('TD',{html:content,parent:tr});}}}
ol.ext.element.create('BUTTON',{className:'ol-zoombt',parent:html}).addEventListener('click',function(){if(feature.getGeometry().getType()==='Point'){this.getMap().getView().animate({center:feature.getGeometry().getFirstCoordinate(),zoom:Math.max(this.getMap().getView().getZoom(),18)});}else{var ext=feature.getGeometry().getExtent();this.getMap().getView().fit(ext,{duration:1000});}}.bind(this));if(this._features.length>1){var div=ol.ext.element.create('DIV',{className:'ol-count',parent:html});ol.ext.element.create('DIV',{className:'ol-prev',parent:div,click:function(){this._count--;if(this._count<1)this._count=this._features.length;html=this._getHtml(this._features[this._count-1]);setTimeout(function(){ol.Overlay.Popup.prototype.show.call(this,this.getPosition(),html);}.bind(this),350);}.bind(this)});ol.ext.element.create('TEXT',{html:this._count+'/'+this._features.length,parent:div});ol.ext.element.create('DIV',{className:'ol-next',parent:div,click:function(){this._count++;if(this._count>this._features.length)this._count=1;html=this._getHtml(this._features[this._count-1]);setTimeout(function(){ol.Overlay.Popup.prototype.show.call(this,this.getPosition(),html);}.bind(this),350);}.bind(this)});}
if(this._select){this._noselect=true;this._select.getFeatures().clear();this._select.getFeatures().push(feature);this._noselect=false;}
return html;};ol.Overlay.PopupFeature.prototype.setFix=function(fix){if(fix)this.element.classList.add('ol-fixed');else this.element.classList.remove('ol-fixed');};ol.Overlay.PopupFeature.prototype.getFix=function(){return this.element.classList.contains('ol-fixed');};ol.Overlay.PopupFeature.localString=function(locales,options){return function(a){if(a&&a.toLocaleString){return a.toLocaleString(locales,options);}else{var date=new Date(a);if(isNaN(date))return a;else return date.toLocaleString(locales,options);}};};ol.Overlay.Tooltip=function(options){options=options||{};options.popupClass=options.popupClass||options.className||'tooltips black';options.positioning=options.positioning||'center-left';options.stopEvent=!!(options.stopEvent);ol.Overlay.Popup.call(this,options);this.set('maximumFractionDigits',options.maximumFractionDigits||2);if(typeof(options.formatLength)==='function')this.formatLength=options.formatLength;if(typeof(options.formatArea)==='function')this.formatArea=options.formatArea;if(typeof(options.getHTML)==='function')this.getHTML=options.getHTML;this._interaction=new ol.interaction.Interaction({handleEvent:function(e){if(e.type==='pointermove'||e.type==='click'){var info=this.getHTML(this._feature,this.get('info'));if(info){this.show(e.coordinate,info);}
else this.hide();this._coord=e.coordinate;}
return true;}.bind(this)});};ol.ext.inherits(ol.Overlay.Tooltip,ol.Overlay.Popup);ol.Overlay.Tooltip.prototype.setMap=function(map){if(this.getMap())this.getMap().removeInteraction(this._interaction);ol.Overlay.Popup.prototype.setMap.call(this,map);if(this.getMap())this.getMap().addInteraction(this._interaction);};ol.Overlay.Tooltip.prototype.getHTML=function(feature,info){if(this.get('measure'))return this.get('measure')+(info?'<br/>'+info:'');else return info||'';};ol.Overlay.Tooltip.prototype.setInfo=function(what){if(!what){this.set('info','');this.hide();}
else setTimeout(function(){this.set('info',what);this.show(this._coord,this.get('info'));}.bind(this));};ol.Overlay.Tooltip.prototype.removeFeature=function(){this.setFeature();};ol.Overlay.Tooltip.prototype.formatArea=function(area){if(area>Math.pow(10,-1*this.get('maximumFractionDigits'))){if(area>10000){return(area/1000000).toLocaleString(undefined,{maximumFractionDigits:this.get('maximumFractionDigits)')})+' km²';}else{return area.toLocaleString(undefined,{maximumFractionDigits:this.get('maximumFractionDigits')})+' m²';}}else{return'';}};ol.Overlay.Tooltip.prototype.formatLength=function(length){if(length>Math.pow(10,-1*this.get('maximumFractionDigits'))){if(length>100){return(length/1000).toLocaleString(undefined,{maximumFractionDigits:this.get('maximumFractionDigits')})+' km';}else{return length.toLocaleString(undefined,{maximumFractionDigits:this.get('maximumFractionDigits')})+' m';}}else{return'';}};ol.Overlay.Tooltip.prototype.setFeature=function(feature){if(feature&&feature.feature)feature=feature.feature;this._feature=feature;if(this._listener){this._listener.forEach(function(l){ol.Observable.unByKey(l);});}
this._listener=[];this.set('measure','');if(feature){this._listener.push(feature.getGeometry().on('change',function(e){var geom=e.target;var measure;if(geom.getArea){measure=this.formatArea(ol.sphere.getArea(geom,{projection:this.getMap().getView().getProjection()}));}else if(geom.getLength){measure=this.formatLength(ol.sphere.getLength(geom,{projection:this.getMap().getView().getProjection()}));}
this.set('measure',measure);}.bind(this)));}};ol.coordinate.convexHull;(function(){var clockwise=function(a,b,o){return((a[0]-o[0])*(b[1]-o[1])-(a[1]-o[1])*(b[0]-o[0])<=0);};ol.coordinate.convexHull=function(points){var i;points.sort(function(a,b){return a[0]==b[0]?a[1]-b[1]:a[0]-b[0];});var lower=[];for(i=0;i<points.length;i++){while(lower.length>=2&&clockwise(lower[lower.length-2],lower[lower.length-1],points[i])){lower.pop();}
lower.push(points[i]);}
var upper=[];for(i=points.length-1;i>=0;i--){while(upper.length>=2&&clockwise(upper[upper.length-2],upper[upper.length-1],points[i])){upper.pop();}
upper.push(points[i]);}
upper.pop();lower.pop();return lower.concat(upper);};var getCoordinates=function(geom){var i,p
var h=[];switch(geom.getType()){case"Point":h.push(geom.getCoordinates());break;case"LineString":case"LinearRing":case"MultiPoint":h=geom.getCoordinates();break;case"MultiLineString":p=geom.getLineStrings();for(i=0;i<p.length;i++)h.concat(getCoordinates(p[i]));break;case"Polygon":h=getCoordinates(geom.getLinearRing(0));break;case"MultiPolygon":p=geom.getPolygons();for(i=0;i<p.length;i++)h.concat(getCoordinates(p[i]));break;case"GeometryCollection":p=geom.getGeometries();for(i=0;i<p.length;i++)h.concat(getCoordinates(p[i]));break;default:break;}
return h;};ol.geom.Geometry.prototype.convexHull=function(){return ol.coordinate.convexHull(getCoordinates(this));};})();ol.coordinate.toDFCI=function(coord,level,projection){if(!level&&level!==0)level=3;if(projection){if(!ol.proj.get('EPSG:27572')){if(!proj4.defs["EPSG:27572"])proj4.defs("EPSG:27572","+proj=lcc +lat_1=46.8 +lat_0=46.8 +lon_0=0 +k_0=0.99987742 +x_0=600000 +y_0=2200000 +a=6378249.2 +b=6356515 +towgs84=-168,-60,320,0,0,0,0 +pm=paris +units=m +no_defs");ol.proj.proj4.register(proj4);}
coord=ol.proj.transform(coord,projection,'EPSG:27572');}
var x=coord[0];var y=coord[1];var s='';var step=100000;s+=String.fromCharCode(65+Math.floor((x<800000?x:x+200000)/step))
+String.fromCharCode(65+Math.floor((y<2300000?y:y+200000)/step)-1500000/step);if(level===0)return s;var step1=100000/5;s+=2*Math.floor((x%step)/step1);s+=2*Math.floor((y%step)/step1);if(level===1)return s;var step2=step1/10;var x0=Math.floor((x%step1)/step2);s+=String.fromCharCode(65+(x0<8?x0:x0+2));s+=Math.floor((y%step1)/step2);if(level===2)return s;var x3=Math.floor((x%step2)/500);var y3=Math.floor((y%step2)/500);if(x3<1){if(y3>1)s+='.1';else s+='.4';}else if(x3>2){if(y3>1)s+='.2';else s+='.3';}else if(y3>2){if(x3<2)s+='.1';else s+='.2';}else if(y3<1){if(x3<2)s+='.4';else s+='.3';}else{s+='.5';}
return s;};ol.coordinate.fromDFCI=function(index,projection){var coord;var step=100000;var x=index.charCodeAt(0)-65;x=(x<8?x:x-2)*step;var y=index.charCodeAt(1)-65;y=(y<8?y:y-2)*step+1500000;if(index.length===2){coord=[x+step/2,y+step/2];}else{step/=5;x+=Number(index.charAt(2))/2*step;y+=Number(index.charAt(3))/2*step;if(index.length===4){coord=[x+step/2,y+step/2];}else{step/=10;var x0=index.charCodeAt(4)-65;x+=(x0<8?x0:x0-2)*step;y+=Number(index.charAt(5))*step;if(index.length===6){coord=[x+step/2,y+step/2];}else{switch(index.charAt(7)){case'1':coord=[x+step/4,y+3*step/4];break;case'2':coord=[x+3*step/4,y+3*step/4];break;case'3':coord=[x+3*step/4,y+step/4];break;case'4':coord=[x+step/4,y+step/4];break;default:coord=[x+step/2,y+step/2];break;}}}}
if(projection){if(!ol.proj.get('EPSG:27572')){if(!proj4.defs["EPSG:27572"])proj4.defs("EPSG:27572","+proj=lcc +lat_1=46.8 +lat_0=46.8 +lon_0=0 +k_0=0.99987742 +x_0=600000 +y_0=2200000 +a=6378249.2 +b=6356515 +towgs84=-168,-60,320,0,0,0,0 +pm=paris +units=m +no_defs");ol.proj.proj4.register(proj4);}
coord=ol.proj.transform(coord,'EPSG:27572',projection);}
return coord;};ol.coordinate.validDFCI=function(index){if(index.length<2||index.length>8)return false;if(/[^A-H|^K-N]/.test(index.substr(0,1)))return false;if(/[^B-H|^K-N]/.test(index.substr(1,1)))return false;if(index.length>2){if(index.length<4)return false;if(/[^0,^2,^4,^6,^8]/.test(index.substr(2,1)))return false;if(/[^0,^2,^4,^6,^8]/.test(index.substr(3,1)))return false;}
if(index.length>4){if(index.length<6)return false;if(/[^A-H|^K-L]/.test(index.substr(4,1)))return false;if(/[^0-9]/.test(index.substr(5,1)))return false;}
if(index.length>6){if(index.length<8)return false;if(index.substr(6,1)!=='.')return false;if(/[^1-5]/.test(index.substr(7,1)))return false;}
return true;}
ol.coordinate.validDFCICoord=function(coord,projection){if(projection){if(!ol.proj.get('EPSG:27572')){if(!proj4.defs["EPSG:27572"])proj4.defs("EPSG:27572","+proj=lcc +lat_1=46.8 +lat_0=46.8 +lon_0=0 +k_0=0.99987742 +x_0=600000 +y_0=2200000 +a=6378249.2 +b=6356515 +towgs84=-168,-60,320,0,0,0,0 +pm=paris +units=m +no_defs");ol.proj.proj4.register(proj4);}
coord=ol.proj.transform(coord,projection,'EPSG:27572');}
if(0>coord[0]||coord[0]>1200000)return false;if(1600000>coord[1]||coord[1]>2700000)return false;return true;};ol.graph={};ol.graph.Dijskra=function(options){options=options||{};this.source=options.source;this.nodes=new ol.source.Vector();this.maxIteration=options.maxIteration||20000;this.stepIteration=options.stepIteration||2000;this.astar=true;this.candidat=[];ol.Object.call(this);this.set('epsilon',options.epsilon||1E-6);};ol.ext.inherits(ol.graph.Dijskra,ol.Object);ol.graph.Dijskra.prototype.weight=function(){return 1;};ol.graph.Dijskra.prototype.direction=function(){return 2;};ol.graph.Dijskra.prototype.getLength=function(geom){if(geom.getGeometry)geom=geom.getGeometry();return geom.getLength();};ol.graph.Dijskra.prototype.getNodeSource=function(){return this.nodes;};ol.graph.Dijskra.prototype.getEdges=function(coord){var extent=ol.extent.buffer(ol.extent.boundingExtent([coord]),this.get('epsilon'));var result=[];this.source.forEachFeatureIntersectingExtent(extent,function(f){result.push(f);});return result;};ol.graph.Dijskra.prototype.getNode=function(coord){var extent=ol.extent.buffer(ol.extent.boundingExtent([coord]),this.get('epsilon'));var result=[];this.nodes.forEachFeatureIntersectingExtent(extent,function(f){result.push(f);});return result[0];};ol.graph.Dijskra.prototype.addNode=function(p,wdist,dist,from,prev){if(this.wdist&&wdist>this.wdist)return false;var node=this.getNode(p);var dtotal=wdist+this.getLength(new ol.geom.LineString([this.end,p]))*this.weight();if(this.astar&&this.wdist&&dtotal>this.wdist)return false;if(node){if(node!==this.arrival&&node.get('wdist')<=wdist)return node;node.set('dist',dist);node.set('wdist',wdist);node.set('dtotal',dtotal);node.set('from',from);node.set('prev',prev);if(node===this.arrival){this.wdist=wdist;}
this.candidat.push(node);}else{node=new ol.Feature({geometry:new ol.geom.Point(p),from:from,prev:prev,dist:dist||0,wdist:wdist,dtotal:dtotal,});if(wdist<0){node.set('wdist',false);}
else this.candidat.push(node);this.nodes.addFeature(node);}
return node;};ol.graph.Dijskra.prototype.closestCoordinate=function(p){var e=this.source.getClosestFeatureToCoordinate(p);var p0=e.getGeometry().getFirstCoordinate();var p1=e.getGeometry().getLastCoordinate();if(ol.coordinate.dist2d(p,p0)<ol.coordinate.dist2d(p,p1))return p0;else return p1;};ol.graph.Dijskra.prototype.path=function(start,end){if(this.running)return false;start=this.closestCoordinate(start);this.end=this.closestCoordinate(end);if(start[0]===this.end[0]&&start[1]===this.end[1]){this.dispatchEvent({type:'finish',route:[],wDistance:-1,distance:this.wdist});return false;}
var self=this;this.nodes.clear();this.candidat=[];this.wdist=0;this.running=true;this.addNode(start,0);this.arrival=this.addNode(this.end,-1);this.nb=0;this.dispatchEvent({type:'start'});setTimeout(function(){self._resume();});return[start,this.end];};ol.graph.Dijskra.prototype.resume=function(){if(this.running)return;if(this.candidat.length){this.running=true;this.nb=0;this._resume();}};ol.graph.Dijskra.prototype.pause=function(){if(!this.running)return;this.nb=-1;};ol.graph.Dijskra.prototype.getBestWay=function(){var node,max=-1;for(var i=0,n;n=this.candidat[i];i++){if(n.get('wdist')>max){node=n;max=n.get('wdist');}}
return this.getRoute(node);};ol.graph.Dijskra.prototype._resume=function(){if(!this.running)return;while(this.candidat.length){this.candidat.sort(function(a,b){return(a.get('dtotal')<b.get('dtotal')?1:a.get('dtotal')===b.get('dtotal')?0:-1);});var node=this.candidat.pop();var p=node.getGeometry().getCoordinates();var edges=this.getEdges(p);for(var i=0,e;e=edges[i];i++){if(node.get('from')!==e){var dist=this.getLength(e);if(dist<0){console.log('distance < 0!');}
var wdist=node.get('wdist')+dist*this.weight(e);dist=node.get('dist')+dist;var pt1=e.getGeometry().getFirstCoordinate();var pt2=e.getGeometry().getLastCoordinate();var sens=this.direction(e);if(sens!==0){if(p[0]===pt1[0]&&p[1]===pt1[1]&&sens!==-1){this.addNode(pt2,wdist,dist,e,node);}
if(p[0]===pt2[0]&&p[0]===pt2[0]&&sens!==1){this.addNode(pt1,wdist,dist,e,node);}}}
if(this.nb===-1||this.nb++>this.maxIteration){this.running=false;this.dispatchEvent({type:'pause',overflow:(this.nb!==-1)});return;}
if(!(this.nb%this.stepIteration)){var self=this;window.setTimeout(function(){self._resume()},5);this.dispatchEvent({type:'calculating'});return;}}}
this.nodes.clear();this.running=false;this.dispatchEvent({type:'finish',route:this.getRoute(this.arrival),wDistance:this.wdist,distance:this.arrival.get('dist')});};ol.graph.Dijskra.prototype.getRoute=function(node){var route=[];while(node){route.unshift(node.get('from'));node=node.get('prev');}
route.shift();return route;};ol.coordinate.dist2d=function(p1,p2){var dx=p1[0]-p2[0];var dy=p1[1]-p2[1];return Math.sqrt(dx*dx+dy*dy);}
ol.coordinate.equal=function(p1,p2){return(p1[0]==p2[0]&&p1[1]==p2[1]);}
ol.coordinate.getFeatureCenter=function(f){return ol.coordinate.getGeomCenter(f.getGeometry());};ol.coordinate.getGeomCenter=function(geom){switch(geom.getType()){case'Point':return geom.getCoordinates();case"MultiPolygon":geom=geom.getPolygon(0);case"Polygon":return geom.getInteriorPoint().getCoordinates();default:return geom.getClosestPoint(ol.extent.getCenter(geom.getExtent()));}};ol.coordinate.offsetCoords=function(coords,offset){var path=[];var N=coords.length-1;var max=N;var mi,mi1,li,li1,ri,ri1,si,si1,Xi1,Yi1;var p0,p1,p2;var isClosed=ol.coordinate.equal(coords[0],coords[N]);if(!isClosed){p0=coords[0];p1=coords[1];p2=[p0[0]+(p1[1]-p0[1])/ol.coordinate.dist2d(p0,p1)*offset,p0[1]-(p1[0]-p0[0])/ol.coordinate.dist2d(p0,p1)*offset];path.push(p2);coords.push(coords[N])
N++;max--;}
for(var i=0;i<max;i++){p0=coords[i];p1=coords[(i+1)%N];p2=coords[(i+2)%N];mi=(p1[1]-p0[1])/(p1[0]-p0[0]);mi1=(p2[1]-p1[1])/(p2[0]-p1[0]);if(Math.abs(mi-mi1)>1e-10){li=Math.sqrt((p1[0]-p0[0])*(p1[0]-p0[0])+(p1[1]-p0[1])*(p1[1]-p0[1]));li1=Math.sqrt((p2[0]-p1[0])*(p2[0]-p1[0])+(p2[1]-p1[1])*(p2[1]-p1[1]));ri=p0[0]+offset*(p1[1]-p0[1])/li;ri1=p1[0]+offset*(p2[1]-p1[1])/li1;si=p0[1]-offset*(p1[0]-p0[0])/li;si1=p1[1]-offset*(p2[0]-p1[0])/li1;Xi1=(mi1*ri1-mi*ri+si-si1)/(mi1-mi);Yi1=(mi*mi1*(ri1-ri)+mi1*si-mi*si1)/(mi1-mi);if(p1[0]-p0[0]==0){Xi1=p1[0]+offset*(p1[1]-p0[1])/Math.abs(p1[1]-p0[1]);Yi1=mi1*Xi1-mi1*ri1+si1;}
if(p2[0]-p1[0]==0){Xi1=p2[0]+offset*(p2[1]-p1[1])/Math.abs(p2[1]-p1[1]);Yi1=mi*Xi1-mi*ri+si;}
path.push([Xi1,Yi1]);}}
if(isClosed){path.push(path[0]);}else{coords.pop();p0=coords[coords.length-1];p1=coords[coords.length-2];p2=[p0[0]-(p1[1]-p0[1])/ol.coordinate.dist2d(p0,p1)*offset,p0[1]+(p1[0]-p0[0])/ol.coordinate.dist2d(p0,p1)*offset];path.push(p2);}
return path;}
ol.coordinate.findSegment=function(pt,coords){for(var i=0;i<coords.length-1;i++){var p0=coords[i];var p1=coords[i+1];if(ol.coordinate.equal(pt,p0)||ol.coordinate.equal(pt,p1)){return{index:1,segment:[p0,p1]};}else{var d0=ol.coordinate.dist2d(p0,p1);var v0=[(p1[0]-p0[0])/d0,(p1[1]-p0[1])/d0];var d1=ol.coordinate.dist2d(p0,pt);var v1=[(pt[0]-p0[0])/d1,(pt[1]-p0[1])/d1];if(Math.abs(v0[0]*v1[1]-v0[1]*v1[0])<1e-10){return{index:1,segment:[p0,p1]};}}}
return{index:-1};};ol.coordinate.splitH=function(geom,y,n){var x,abs;var list=[];for(var i=0;i<geom.length-1;i++){if(!geom[i].length||!geom[i+1].length)continue;if(geom[i][1]<=y&&geom[i+1][1]>y||geom[i][1]>=y&&geom[i+1][1]<y){abs=(y-geom[i][1])/(geom[i+1][1]-geom[i][1]);x=abs*(geom[i+1][0]-geom[i][0])+geom[i][0];list.push({contour:n,index:i,pt:[x,y],abs:abs});}}
list.sort(function(a,b){return a.pt[0]-b.pt[0]});var result=[];for(var j=0;j<list.length-1;j+=2){result.push([list[j],list[j+1]])}
return result;};ol.geom.createFromType=function(type,coordinates){switch(type){case'LineString':return new ol.geom.LineString(coordinates);case'LinearRing':return new ol.geom.LinearRing(coordinates);case'MultiLineString':return new ol.geom.MultiLineString(coordinates);case'MultiPoint':return new ol.geom.MultiPoint(coordinates);case'MultiPolygon':return new ol.geom.MultiPolygon(coordinates);case'Point':return new ol.geom.Point(coordinates);case'Polygon':return new ol.geom.Polygon(coordinates);default:console.error('[createFromType] Unsupported type: '+type);return null;}};ol.geom.LineString.prototype.splitAt=function(pt,tol){var i;if(!pt)return[this];if(!tol)tol=1e-10;if(pt.length&&pt[0].length){var result=[this];for(i=0;i<pt.length;i++){var r=[];for(var k=0;k<result.length;k++){var ri=result[k].splitAt(pt[i],tol);r=r.concat(ri);}
result=r;}
return result;}
if(ol.coordinate.equal(pt,this.getFirstCoordinate())||ol.coordinate.equal(pt,this.getLastCoordinate())){return[this];}
var c0=this.getCoordinates();var ci=[c0[0]];var c=[];for(i=0;i<c0.length-1;i++){if(ol.coordinate.equal(c0[i],c0[i+1]))continue;if(ol.coordinate.equal(pt,c0[i+1])){ci.push(c0[i+1]);c.push(new ol.geom.LineString(ci));ci=[];}
else if(!ol.coordinate.equal(pt,c0[i])){var d1,d2,split=false;if(c0[i][0]==c0[i+1][0]){d1=(c0[i][1]-pt[1])/(c0[i][1]-c0[i+1][1]);split=(c0[i][0]==pt[0])&&(0<d1&&d1<=1)}else if(c0[i][1]==c0[i+1][1]){d1=(c0[i][0]-pt[0])/(c0[i][0]-c0[i+1][0]);split=(c0[i][1]==pt[1])&&(0<d1&&d1<=1)}else{d1=(c0[i][0]-pt[0])/(c0[i][0]-c0[i+1][0]);d2=(c0[i][1]-pt[1])/(c0[i][1]-c0[i+1][1]);split=(Math.abs(d1-d2)<=tol&&0<d1&&d1<=1)}
if(split){ci.push(pt);c.push(new ol.geom.LineString(ci));ci=[pt];}}
ci.push(c0[i+1]);}
if(ci.length>1)c.push(new ol.geom.LineString(ci));if(c.length)return c;else return[this];}
ol.geom.MultiPolygon.prototype.scribbleFill=function(options){var scribbles=[];var poly=this.getPolygons();var i,p,s;for(i=0;p=poly[i];i++){var mls=p.scribbleFill(options);if(mls)scribbles.push(mls);}
if(!scribbles.length)return null;var scribble=scribbles[0];var ls;for(i=0;s=scribbles[i];i++){ls=s.getLineStrings();for(var k=0;k<ls.length;k++){scribble.appendLineString(ls[k]);}}
return scribble;};ol.geom.Polygon.prototype.scribbleFill=function(options){var step=options.interval;var angle=options.angle||Math.PI/2;var i,k,l;var geom=this.clone();geom.rotate(angle,[0,0]);var coords=geom.getCoordinates();var coord=coords[0];for(i=1;i<coords.length;i++){coord.push([]);coord=coord.concat(coords[i]);}
var ext=geom.getExtent();var lines=[];for(var y=(Math.floor(ext[1]/step)+1)*step;y<ext[3];y+=step){l=ol.coordinate.splitH(coord,y,i);lines=lines.concat(l);}
if(!lines.length)return null;var mod=coord.length-1;var first=lines[0][0].index;for(k=0;l=lines[k];k++){lines[k][0].index=(lines[k][0].index-first+mod)%mod;lines[k][1].index=(lines[k][1].index-first+mod)%mod;}
var scribble=[];while(true){for(k=0;l=lines[k];k++){if(!l[0].done)break;}
if(!l)break;var scrib=[];while(l){l[0].done=true;scrib.push(l[0].pt);scrib.push(l[1].pt);var nexty=l[0].pt[1]+step;var d0=Infinity;var l2=null;while(lines[k]){if(lines[k][0].pt[1]>nexty)break;if(lines[k][0].pt[1]===nexty){var d=Math.min((lines[k][0].index-l[0].index+mod)%mod,(l[0].index-lines[k][0].index+mod)%mod);var d2=Math.min((l[1].index-l[0].index+mod)%mod,(l[0].index-l[1].index+mod)%mod);if(d<d0&&d<d2){d0=d;if(!lines[k][0].done)l2=lines[k];else l2=null;}}
k++;}
l=l2;}
if(scrib.length){scribble.push(scrib);}}
if(!scribble.length)return null;var mline=new ol.geom.MultiLineString(scribble);mline.rotate(-angle,[0,0]);return mline.cspline({pointsPerSeg:8,tension:.9});};ol.sphere.greatCircleBearing=function(origin,destination){var toRad=Math.PI/180;var ori=[origin[0]*toRad,origin[1]*toRad];var dest=[destination[0]*toRad,destination[1]*toRad];var bearing=Math.atan2(Math.sin(dest[0]-ori[0])*Math.cos(dest[1]),Math.cos(ori[1])*Math.sin(dest[1])-Math.sin(ori[1])*Math.cos(dest[1])*Math.cos(dest[0]-ori[0]));return bearing;};ol.sphere.computeDestinationPoint=function(origin,distance,bearing,options){options=options||{};var toRad=Math.PI/180;var radius=options.radius||6371008.8;var phi1=origin[1]*toRad;var lambda1=origin[0]*toRad;var delta=distance/radius;var phi2=Math.asin(Math.sin(phi1)*Math.cos(delta)+
Math.cos(phi1)*Math.sin(delta)*Math.cos(bearing));var lambda2=lambda1+
Math.atan2(Math.sin(bearing)*Math.sin(delta)*Math.cos(phi1),Math.cos(delta)-Math.sin(phi1)*Math.sin(phi2));var lon=lambda2/toRad;if(options.normalize!==false&&(lon<-180||lon>180)){lon=((lon*540)%360)-180;}
return[lon,phi2/toRad];};ol.sphere.greatCircleTrack=function(origin,destination,options){options=options||{};var bearing=ol.sphere.greatCircleBearing(origin,destination);var dist=ol.sphere.getDistance(origin,destination,options.radius);var distance=options.distance||1000;var d=distance;var geom=[origin];while(d<dist){geom.push(ol.sphere.computeDestinationPoint(origin,d,bearing,{radius:options.radius,normalize:false}));d+=distance;}
var pt=ol.sphere.computeDestinationPoint(origin,dist,bearing,{radius:options.radius,normalize:false});if(Math.abs(pt[0]-destination[0])>1){if(pt[0]>destination[0])destination[0]+=360;else destination[0]-=360;}
geom.push(destination);return geom;};ol.Map.prototype.animExtent=function(extent,options)
{var listenerKey;options=options||{};if(options.projection)
{extent=ol.proj.transformExtent(extent,options.projection,this.getView().getProjection());}
var start=new Date().getTime();var duration=options.duration||1000;var easing=options.easing||ol.easing.upAndDown;var width=options.style?options.style.getWidth()||2:2;var color=options.style?options.style.getColr()||'red':'red';function animate(event)
{var frameState=event.frameState;var ratio=frameState.pixelRatio;var elapsed=frameState.time-start;if(elapsed>duration)ol.Observable.unByKey(listenerKey);else
{var elapsedRatio=elapsed/duration;var p0=this.getPixelFromCoordinate([extent[0],extent[1]]);var p1=this.getPixelFromCoordinate([extent[2],extent[3]]);var context=event.context;context.save();context.scale(ratio,ratio);context.beginPath();context.globalAlpha=easing(1-elapsedRatio);context.lineWidth=width;context.strokeStyle=color;context.rect(p0[0],p0[1],p1[0]-p0[0],p1[1]-p0[1]);context.stroke();context.restore();frameState.animate=true;}}
listenerKey=this.on('postcompose',animate.bind(this));this.renderSync();}
ol.geom.Geometry.prototype.cspline=function(options)
{if(this.calcCSpline_)
{if(this.csplineGeometryRevision!=this.getRevision()||this.csplineOption!=JSON.stringify(options))
{this.csplineGeometry_=this.calcCSpline_(options)
this.csplineGeometryRevision=this.getRevision();this.csplineOption=JSON.stringify(options);}
return this.csplineGeometry_;}
else
{return this;}}
ol.geom.GeometryCollection.prototype.calcCSpline_=function(options)
{var g=[],g0=this.getGeometries();for(var i=0;i<g0.length;i++)
{g.push(g0[i].cspline(options));}
return new ol.geom.GeometryCollection(g);}
ol.geom.MultiLineString.prototype.calcCSpline_=function(options)
{var g=[],lines=this.getLineStrings();for(var i=0;i<lines.length;i++)
{g.push(lines[i].cspline(options).getCoordinates());}
return new ol.geom.MultiLineString(g);}
ol.geom.Polygon.prototype.calcCSpline_=function(options)
{var g=[],g0=this.getCoordinates();for(var i=0;i<g0.length;i++)
{g.push((new ol.geom.LineString(g0[i])).cspline(options).getCoordinates());}
return new ol.geom.Polygon(g);}
ol.geom.MultiPolygon.prototype.calcCSpline_=function(options)
{var g=[],g0=this.getPolygons();for(var i=0;i<g0.length;i++)
{g.push(g0[i].cspline(options).getCoordinates());}
return new ol.geom.MultiPolygon(g);}
ol.geom.LineString.prototype.calcCSpline_=function(options)
{if(!options)options={};var line=this.getCoordinates();var tension=typeof options.tension==="number"?options.tension:0.5;var resolution=options.resolution||(this.getLength()/line.length/(options.pointsPerSeg||10));var pts,res=[],x,y,t1x,t2x,t1y,t2y,c1,c2,c3,c4,st,t,i;pts=line.slice(0);if(line.length>2&&line[0][0]==line[line.length-1][0]&&line[0][1]==line[line.length-1][1])
{pts.unshift(line[line.length-2]);pts.push(line[1]);}
else
{pts.unshift(line[0]);pts.push(line[line.length-1]);}
function dist2d(x1,y1,x2,y2)
{var dx=x2-x1;var dy=y2-y1;return Math.sqrt(dx*dx+dy*dy);}
for(i=1;i<(pts.length-2);i++)
{var d1=dist2d(pts[i][0],pts[i][1],pts[i+1][0],pts[i+1][1]);var numOfSegments=Math.round(d1/resolution);var d=1;if(options.normalize)
{d1=dist2d(pts[i+1][0],pts[i+1][1],pts[i-1][0],pts[i-1][1]);var d2=dist2d(pts[i+2][0],pts[i+2][1],pts[i][0],pts[i][1]);if(d1<d2)d=d1/d2;else d=d2/d1;}
t1x=(pts[i+1][0]-pts[i-1][0])*tension*d;t2x=(pts[i+2][0]-pts[i][0])*tension*d;t1y=(pts[i+1][1]-pts[i-1][1])*tension*d;t2y=(pts[i+2][1]-pts[i][1])*tension*d;for(t=0;t<=numOfSegments;t++)
{st=t/numOfSegments;c1=2*Math.pow(st,3)-3*Math.pow(st,2)+1;c2=-(2*Math.pow(st,3))+3*Math.pow(st,2);c3=Math.pow(st,3)-2*Math.pow(st,2)+st;c4=Math.pow(st,3)-Math.pow(st,2);x=c1*pts[i][0]+c2*pts[i+1][0]+c3*t1x+c4*t2x;y=c1*pts[i][1]+c2*pts[i+1][1]+c3*t1y+c4*t2y;if(x&&y)res.push([x,y]);}}
return new ol.geom.LineString(res);}
ol.HexGrid=function(options)
{options=options||{};ol.Object.call(this,options);this.size_=options.size||80000;this.origin_=options.origin||[0,0];this.layout_=this.layout[options.layout]||this.layout.pointy;};ol.ext.inherits(ol.HexGrid,ol.Object);ol.HexGrid.prototype.layout={pointy:[Math.sqrt(3),Math.sqrt(3)/2,0,3/2,Math.sqrt(3)/3,-1/3,0,2/3,Math.cos(Math.PI/180*(60*0+30)),Math.sin(Math.PI/180*(60*0+30)),Math.cos(Math.PI/180*(60*1+30)),Math.sin(Math.PI/180*(60*1+30)),Math.cos(Math.PI/180*(60*2+30)),Math.sin(Math.PI/180*(60*2+30)),Math.cos(Math.PI/180*(60*3+30)),Math.sin(Math.PI/180*(60*3+30)),Math.cos(Math.PI/180*(60*4+30)),Math.sin(Math.PI/180*(60*4+30)),Math.cos(Math.PI/180*(60*5+30)),Math.sin(Math.PI/180*(60*5+30))],flat:[3/2,0,Math.sqrt(3)/2,Math.sqrt(3),2/3,0,-1/3,Math.sqrt(3)/3,Math.cos(Math.PI/180*(60*0)),Math.sin(Math.PI/180*(60*0)),Math.cos(Math.PI/180*(60*1)),Math.sin(Math.PI/180*(60*1)),Math.cos(Math.PI/180*(60*2)),Math.sin(Math.PI/180*(60*2)),Math.cos(Math.PI/180*(60*3)),Math.sin(Math.PI/180*(60*3)),Math.cos(Math.PI/180*(60*4)),Math.sin(Math.PI/180*(60*4)),Math.cos(Math.PI/180*(60*5)),Math.sin(Math.PI/180*(60*5))]};ol.HexGrid.prototype.setLayout=function(layout)
{this.layout_=this.layout[layout]||this.layout.pointy;this.changed();}
ol.HexGrid.prototype.getLayout=function()
{return(this.layout_[9]!=0?'pointy':'flat');}
ol.HexGrid.prototype.setOrigin=function(coord)
{this.origin_=coord;this.changed();}
ol.HexGrid.prototype.getOrigin=function()
{return this.origin_;}
ol.HexGrid.prototype.setSize=function(s){this.size_=s||80000;this.changed();}
ol.HexGrid.prototype.getSize=function(){return this.size_;}
ol.HexGrid.prototype.cube2hex=function(c)
{return[c[0],c[2]];};ol.HexGrid.prototype.hex2cube=function(h)
{return[h[0],-h[0]-h[1],h[1]];};ol.HexGrid.prototype.hex2offset=function(h)
{if(this.layout_[9])return[h[0]+(h[1]-(h[1]&1))/2,h[1]];else return[h[0],h[1]+(h[0]+(h[0]&1))/2];}
ol.HexGrid.prototype.offset2hex=function(o)
{if(this.layout_[9])return[o[0]-(o[1]-(o[1]&1))/2,o[1]];else return[o[0],o[1]-(o[0]+(o[0]&1))/2];}
ol.HexGrid.prototype.cube_round=function(h)
{var rx=Math.round(h[0])
var ry=Math.round(h[1])
var rz=Math.round(h[2])
var x_diff=Math.abs(rx-h[0])
var y_diff=Math.abs(ry-h[1])
var z_diff=Math.abs(rz-h[2])
if(x_diff>y_diff&&x_diff>z_diff)rx=-ry-rz
else if(y_diff>z_diff)ry=-rx-rz
else rz=-rx-ry
return[rx,ry,rz];};ol.HexGrid.prototype.hex_round=function(h)
{return this.cube2hex(this.cube_round(this.hex2cube(h)));};ol.HexGrid.prototype.hex_corner=function(center,size,i)
{return[center[0]+size*this.layout_[8+(2*(i%6))],center[1]+size*this.layout_[9+(2*(i%6))]];};ol.HexGrid.prototype.getHexagonAtCoord=function(coord)
{return(this.getHexagon(this.coord2hex(coord)));};ol.HexGrid.prototype.getHexagon=function(hex)
{var p=[];var c=this.hex2coord(hex);for(var i=0;i<=7;i++)
{p.push(this.hex_corner(c,this.size_,i,this.layout_[8]));}
return p;};ol.HexGrid.prototype.hex2coord=function(hex)
{return[this.origin_[0]+this.size_*(this.layout_[0]*hex[0]+this.layout_[1]*hex[1]),this.origin_[1]+this.size_*(this.layout_[2]*hex[0]+this.layout_[3]*hex[1])];};ol.HexGrid.prototype.coord2hex=function(coord)
{var c=[(coord[0]-this.origin_[0])/this.size_,(coord[1]-this.origin_[1])/this.size_];var q=this.layout_[4]*c[0]+this.layout_[5]*c[1];var r=this.layout_[6]*c[0]+this.layout_[7]*c[1];return this.hex_round([q,r]);};ol.HexGrid.prototype.cube_distance=function(a,b)
{return(Math.max(Math.abs(a[0]-b[0]),Math.abs(a[1]-b[1]),Math.abs(a[2]-b[2])));};(function(){function lerp(a,b,t)
{return a+(b-a)*t;}
function cube_lerp(a,b,t)
{return[lerp(a[0]+1e-6,b[0],t),lerp(a[1]+1e-6,b[1],t),lerp(a[2]+1e-6,b[2],t)];}
ol.HexGrid.prototype.cube_line=function(a,b)
{var d=this.cube_distance(a,b);if(!d)return[a];var results=[]
for(var i=0;i<=d;i++)
{results.push(this.cube_round(cube_lerp(a,b,i/d)));}
return results;};})();ol.HexGrid.prototype.neighbors={'cube':[[+1,-1,0],[+1,0,-1],[0,+1,-1],[-1,+1,0],[-1,0,+1],[0,-1,+1]],'hex':[[+1,0],[+1,-1],[0,-1],[-1,0],[-1,+1],[0,+1]]};ol.HexGrid.prototype.hex_neighbors=function(h,d)
{if(d!==undefined)
{return[h[0]+this.neighbors.hex[d%6][0],h[1]+this.neighbors.hex[d%6][1]];}
else
{var n=[];for(d=0;d<6;d++)
{n.push([h[0]+this.neighbors.hex[d][0],h[1]+this.neighbors.hex[d][1]]);}
return n;}};ol.HexGrid.prototype.cube_neighbors=function(c,d)
{if(d!==undefined)
{return[c[0]+this.neighbors.cube[d%6][0],c[1]+this.neighbors.cube[d%6][1],c[2]+this.neighbors.cube[d%6][2]];}
else
{var n=[];for(d=0;d<6;d++)
{n.push([c[0]+this.neighbors.cube[d][0],c[1]+this.neighbors.cube[d][1],c[2]+this.neighbors.cube[d][2]]);}
for(d=0;d<6;d++)n[d]=this.cube2hex(n[d])
return n;}};ol.InseeGrid=function(options){options=options||{};if(!proj4.defs["EPSG:3035"]){proj4.defs("EPSG:3035","+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs");ol.proj.proj4.register(proj4);}
ol.Object.call(this,options);var size=Math.max(200,Math.round((options.size||0)/200)*200);this.set('size',size);};ol.ext.inherits(ol.InseeGrid,ol.Object);ol.InseeGrid.extent=[3200000,2000000,4300000,3140000];ol.InseeGrid.prototype.getExtent=function(proj){return ol.proj.transformExtent(ol.InseeGrid.extent,proj||'EPSG:3035','EPSG:3857')};ol.InseeGrid.prototype.getGridAtCoordinate=function(coord,proj){var c=ol.proj.transform(coord,proj||'EPSG:3857','EPSG:3035')
var s=this.get('size');var x=Math.floor(c[0]/s)*s;var y=Math.floor(c[1]/s)*s;var geom=new ol.geom.Polygon([[[x,y],[x+s,y],[x+s,y+s],[x,y+s],[x,y]]]);geom.transform('EPSG:3035',proj||'EPSG:3857');return geom;};ol.Map.prototype.markup=function(coords,options)
{var listenerKey;var self=this;options=options||{};if(options.projection)
{coords=ol.proj.transform(coords,options.projection,this.getView().getProjection());}
var start=new Date().getTime();var delay=options.delay||3000;var duration=1000;var maxZoom=options.maxZoom||100;var easing=ol.easing.easeOut;var style=options.style;if(!style)style=new ol.style.Circle({radius:10,stroke:new ol.style.Stroke({color:'red',width:2})});if(style instanceof ol.style.Image)style=new ol.style.Style({image:style});if(!(style instanceof Array))style=[style];function animate(event)
{var frameState=event.frameState;var elapsed=frameState.time-start;if(elapsed>delay+duration)
{ol.Observable.unByKey(listenerKey);listenerKey=null;}
else
{if(delay>elapsed&&this.getView().getZoom()>maxZoom)delay=elapsed;var ratio=frameState.pixelRatio;var elapsedRatio=0;if(elapsed>delay)elapsedRatio=(elapsed-delay)/duration;var context=event.context;context.save();context.beginPath();context.globalAlpha=easing(1-elapsedRatio);for(var i=0;i<style.length;i++)
{var imgs=style[i].getImage();var sc=imgs.getScale();imgs.setScale(sc*ratio);event.vectorContext.setStyle(style[i]);event.vectorContext.drawGeometry(new ol.geom.Point(coords));imgs.setScale(sc);}
context.restore();if(elapsed>=delay)frameState.animate=true;}}
setTimeout(function()
{if(listenerKey)self.renderSync();},delay);listenerKey=this.on('postcompose',animate.bind(this));this.renderSync();listenerKey.stop=function()
{delay=duration=0;this.target.renderSync();};return listenerKey;}
ol.ordering={};ol.ordering.yOrdering=function()
{return function(f0,f1)
{return f1.getGeometry().getExtent()[1]-f0.getGeometry().getExtent()[1];};};ol.ordering.zIndex=function(options)
{if(!options)options={};var attr=options.attribute||'zIndex';if(options.equalFn)
{return function(f0,f1)
{if(f0.get(attr)==f1.get(attr))return options.equalFn(f0,f1);else return f0.get(attr)<f1.get(attr)?1:-1;};}
else
{return function(f0,f1)
{if(f0.get(attr)==f1.get(attr))return 0;else return f0.get(attr)<f1.get(attr)?1:-1;};}};ol.Map.prototype.pulse=function(coords,options)
{var listenerKey;options=options||{};if(options.projection)
{coords=ol.proj.transform(coords,options.projection,this.getView().getProjection());}
var start=new Date().getTime();var duration=options.duration||3000;var easing=options.easing||ol.easing.easeOut;var style=options.style;if(!style)style=new ol.style.Circle({radius:30,stroke:new ol.style.Stroke({color:'red',width:2})});if(style instanceof ol.style.Image)style=new ol.style.Style({image:style});if(!(style instanceof Array))style=[style];var amplitude=options.amplitude||1;if(amplitude<0)amplitude=0;var maxRadius=options.radius||15;if(maxRadius<0)maxRadius=5;function animate(event)
{var frameState=event.frameState;var ratio=frameState.pixelRatio;var elapsed=frameState.time-start;if(elapsed>duration)ol.Observable.unByKey(listenerKey);else
{var elapsedRatio=elapsed/duration;var context=event.context;context.save();context.beginPath();var e=easing(elapsedRatio)
context.globalAlpha=easing(1-elapsedRatio);console.log("anim")
for(var i=0;i<style.length;i++)
{var imgs=style[i].getImage();var sc=imgs.getScale();imgs.setScale(ratio*sc*(1+amplitude*(e-1)));event.vectorContext.setStyle(style[i]);event.vectorContext.drawGeometry(new ol.geom.Point(coords));imgs.setScale(sc);}
context.restore();frameState.animate=true;}}
listenerKey=this.on('postcompose',animate.bind(this));this.renderSync();}
ol.style.Chart=function(opt_options){var options=opt_options||{};var strokeWidth=0;if(opt_options.stroke)strokeWidth=opt_options.stroke.getWidth();ol.style.RegularShape.call(this,{radius:options.radius+strokeWidth,fill:new ol.style.Fill({color:[0,0,0]}),rotation:options.rotation,snapToPixel:options.snapToPixel});if(options.scale)this.setScale(options.scale);this.stroke_=options.stroke;this.radius_=options.radius||20;this.donutratio_=options.donutRatio||0.5;this.type_=options.type;this.offset_=[options.offsetX?options.offsetX:0,options.offsetY?options.offsetY:0];this.animation_=(typeof(options.animation)=='number')?{animate:true,step:options.animation}:this.animation_={animate:false,step:1};this.max_=options.max;this.data_=options.data;if(options.colors instanceof Array){this.colors_=options.colors;}else{this.colors_=ol.style.Chart.colors[options.colors];if(!this.colors_)this.colors_=ol.style.Chart.colors.classic;}
this.renderChart_();};ol.ext.inherits(ol.style.Chart,ol.style.RegularShape);ol.style.Chart.colors={"classic":["#ffa500","blue","red","green","cyan","magenta","yellow","#0f0"],"dark":["#960","#003","#900","#060","#099","#909","#990","#090"],"pale":["#fd0","#369","#f64","#3b7","#880","#b5d","#666"],"pastel":["#fb4","#79c","#f66","#7d7","#acc","#fdd","#ff9","#b9b"],"neon":["#ff0","#0ff","#0f0","#f0f","#f00","#00f"]}
ol.style.Chart.prototype.clone=function(){var s=new ol.style.Chart({type:this.type_,radius:this.radius_,rotation:this.getRotation(),scale:this.getScale(),data:this.getData(),snapToPixel:this.getSnapToPixel?this.getSnapToPixel():false,stroke:this.stroke_,colors:this.colors_,offsetX:this.offset_[0],offsetY:this.offset_[1],animation:this.animation_});s.setScale(this.getScale());s.setOpacity(this.getOpacity());return s;};ol.style.Chart.prototype.getData=function(){return this.data_;}
ol.style.Chart.prototype.setData=function(data){this.data_=data;this.renderChart_();}
ol.style.Chart.prototype.getRadius=function(){return this.radius_;}
ol.style.Chart.prototype.setRadius=function(radius,ratio){this.radius_=radius;this.donuratio_=ratio||this.donuratio_;this.renderChart_();}
ol.style.Chart.prototype.setAnimation=function(step){if(step===false){if(this.animation_.animate==false)return;this.animation_.animate=false;}else{if(this.animation_.step==step)return;this.animation_.animate=true;this.animation_.step=step;}
this.renderChart_();}
ol.style.Chart.prototype.renderChart_=function(){var strokeStyle;var strokeWidth=0;if(this.stroke_){strokeStyle=ol.color.asString(this.stroke_.getColor());strokeWidth=this.stroke_.getWidth();}
var canvas=this.getImage();var context=(canvas.getContext('2d'));context.clearRect(0,0,canvas.width,canvas.height);context.lineJoin='round';var sum=0;var i,c;for(i=0;i<this.data_.length;i++){sum+=this.data_[i];}
context.setTransform(1,0,0,1,0,0);context.translate(0,0);var step=this.animation_.animate?this.animation_.step:1;switch(this.type_){case"donut":case"pie3D":case"pie":{var a,a0=Math.PI*(step-1.5);c=canvas.width/2;context.strokeStyle=strokeStyle;context.lineWidth=strokeWidth;context.save();if(this.type_=="pie3D"){context.translate(0,c*0.3);context.scale(1,0.7);context.beginPath();context.fillStyle="#369";context.arc(c,c*1.4,this.radius_*step,0,2*Math.PI);context.fill();context.stroke();}
if(this.type_=="donut"){context.save();context.beginPath();context.rect(0,0,2*c,2*c);context.arc(c,c,this.radius_*step*this.donutratio_,0,2*Math.PI);context.clip("evenodd");}
for(i=0;i<this.data_.length;i++){context.beginPath();context.moveTo(c,c);context.fillStyle=this.colors_[i%this.colors_.length];a=a0+2*Math.PI*this.data_[i]/sum*step;context.arc(c,c,this.radius_*step,a0,a);context.closePath();context.fill();context.stroke();a0=a;}
if(this.type_=="donut"){context.restore();context.beginPath();context.strokeStyle=strokeStyle;context.lineWidth=strokeWidth;context.arc(c,c,this.radius_*step*this.donutratio_,Math.PI*(step-1.5),a0);context.stroke();}
context.restore();break;}
case"bar":default:{var max=0;if(this.max_){max=this.max_;}else{for(i=0;i<this.data_.length;i++){if(max<this.data_[i])max=this.data_[i];}}
var s=Math.min(5,2*this.radius_/this.data_.length);c=canvas.width/2;var b=canvas.width-strokeWidth;var x,x0=c-this.data_.length*s/2
context.strokeStyle=strokeStyle;context.lineWidth=strokeWidth;for(i=0;i<this.data_.length;i++){context.beginPath();context.fillStyle=this.colors_[i%this.colors_.length];x=x0+s;var h=this.data_[i]/max*2*this.radius_*step;context.rect(x0,b-h,s,h);context.closePath();context.fill();context.stroke();x0=x;}}}
var anchor=this.getAnchor();anchor[0]=c-this.offset_[0];anchor[1]=c-this.offset_[1];};ol.style.Chart.prototype.getChecksum=function(){var strokeChecksum=(this.stroke_!==null)?this.stroke_.getChecksum():'-';var fillChecksum;var recalculate=(this.checksums_===null)||(strokeChecksum!=this.checksums_[1]||fillChecksum!=this.checksums_[2]||this.radius_!=this.checksums_[3]||this.data_.join('|')!=this.checksums_[4]);if(recalculate){var checksum='c'+strokeChecksum+fillChecksum
+((this.radius_!==void 0)?this.radius_.toString():'-')
+this.data_.join('|');this.checksums_=[checksum,strokeChecksum,fillChecksum,this.radius_,this.data_.join('|')];}
return this.checksums_[0];};ol.style.FillPattern=function(options)
{if(!options)options={};var pattern;var canvas=this.canvas_=document.createElement('canvas');var scale=Number(options.scale)>0?Number(options.scale):1;var ratio=scale*ol.has.DEVICE_PIXEL_RATIO||ol.has.DEVICE_PIXEL_RATIO;var ctx=canvas.getContext('2d');if(options.image)
{options.image.load();var i;var img=options.image.getImage();if(img.width)
{canvas.width=Math.round(img.width*ratio);canvas.height=Math.round(img.height*ratio);ctx.globalAlpha=typeof(options.opacity)=='number'?options.opacity:1;ctx.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height);pattern=ctx.createPattern(canvas,'repeat');}
else
{var self=this;pattern=[0,0,0,0];img.onload=function()
{canvas.width=Math.round(img.width*ratio);canvas.height=Math.round(img.height*ratio);ctx.globalAlpha=typeof(options.opacity)=='number'?options.opacity:1;ctx.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height);pattern=ctx.createPattern(canvas,'repeat');self.setColor(pattern);}}}
else
{var pat=this.getPattern_(options);canvas.width=Math.round(pat.width*ratio);canvas.height=Math.round(pat.height*ratio);ctx.beginPath();if(options.fill)
{ctx.fillStyle=ol.color.asString(options.fill.getColor());ctx.fillRect(0,0,canvas.width,canvas.height);}
ctx.scale(ratio,ratio);ctx.lineCap="round";ctx.lineWidth=pat.stroke||1;ctx.fillStyle=ol.color.asString(options.color||"#000");ctx.strokeStyle=ol.color.asString(options.color||"#000");if(pat.circles)for(i=0;i<pat.circles.length;i++)
{var ci=pat.circles[i];ctx.beginPath();ctx.arc(ci[0],ci[1],ci[2],0,2*Math.PI);if(pat.fill)ctx.fill();if(pat.stroke)ctx.stroke();}
if(!pat.repeat)pat.repeat=[[0,0]];if(pat.char)
{ctx.font=pat.font||(pat.width)+"px Arial";ctx.textAlign='center';ctx.textBaseline='middle';if(pat.angle)
{ctx.fillText(pat.char,pat.width/4,pat.height/4);ctx.fillText(pat.char,5*pat.width/4,5*pat.height/4);ctx.fillText(pat.char,pat.width/4,5*pat.height/4);ctx.fillText(pat.char,5*pat.width/4,pat.height/4);ctx.fillText(pat.char,3*pat.width/4,3*pat.height/4);ctx.fillText(pat.char,-pat.width/4,-pat.height/4);ctx.fillText(pat.char,3*pat.width/4,-pat.height/4);ctx.fillText(pat.char,-pat.width/4,3*pat.height/4);}
else ctx.fillText(pat.char,pat.width/2,pat.height/2);}
if(pat.lines)for(i=0;i<pat.lines.length;i++)for(var r=0;r<pat.repeat.length;r++)
{var li=pat.lines[i];ctx.beginPath();ctx.moveTo(li[0]+pat.repeat[r][0],li[1]+pat.repeat[r][1]);for(var k=2;k<li.length;k+=2)
{ctx.lineTo(li[k]+pat.repeat[r][0],li[k+1]+pat.repeat[r][1]);}
if(pat.fill)ctx.fill();if(pat.stroke)ctx.stroke();ctx.save()
ctx.strokeStyle='red';ctx.strokeWidth=0.1;ctx.restore()}
pattern=ctx.createPattern(canvas,'repeat');if(options.offset)
{var offset=options.offset;if(typeof(offset)=="number")offset=[offset,offset];if(offset instanceof Array)
{var dx=Math.round((offset[0]*ratio));var dy=Math.round((offset[1]*ratio));ctx.scale(1/ratio,1/ratio)
ctx.clearRect(0,0,canvas.width,canvas.height);ctx.translate(dx,dy);ctx.fillStyle=pattern;ctx.fillRect(-dx,-dy,canvas.width,canvas.height);pattern=ctx.createPattern(canvas,'repeat');}}}
ol.style.Fill.call(this,{color:pattern});};ol.ext.inherits(ol.style.FillPattern,ol.style.Fill);ol.style.FillPattern.prototype.clone=function()
{var s=ol.style.Fill.prototype.clone.call(this);s.canvas_=this.canvas_;return s;};ol.style.FillPattern.prototype.getImage=function()
{return this.canvas_;}
ol.style.FillPattern.prototype.getPattern_=function(options)
{var pat=ol.style.FillPattern.prototype.patterns[options.pattern]||ol.style.FillPattern.prototype.patterns.dot;var d=Math.round(options.spacing)||10;var size;switch(options.pattern)
{case'dot':case'circle':{size=options.size===0?0:options.size/2||2;if(!options.angle)
{pat.width=pat.height=d;pat.circles=[[d/2,d/2,size]]
if(options.pattern=='circle')
{pat.circles=pat.circles.concat([[d/2+d,d/2,size],[d/2-d,d/2,size],[d/2,d/2+d,size],[d/2,d/2-d,size],[d/2+d,d/2+d,size],[d/2+d,d/2-d,size],[d/2-d,d/2+d,size],[d/2-d,d/2-d,size]])}}
else
{d=pat.width=pat.height=Math.round(d*1.4);pat.circles=[[d/4,d/4,size],[3*d/4,3*d/4,size]];if(options.pattern=='circle')
{pat.circles=pat.circles.concat([[d/4+d,d/4,size],[d/4,d/4+d,size],[3*d/4-d,3*d/4,size],[3*d/4,3*d/4-d,size],[d/4+d,d/4+d,size],[3*d/4-d,3*d/4-d,size]]);}}
break;}
case'tile':case'square':{size=options.size===0?0:options.size/2||2;if(!options.angle)
{pat.width=pat.height=d;pat.lines=[[d/2-size,d/2-size,d/2+size,d/2-size,d/2+size,d/2+size,d/2-size,d/2+size,d/2-size,d/2-size]]}
else
{pat.width=pat.height=d;pat.lines=[[d/2-size,d/2,d/2,d/2-size,d/2+size,d/2,d/2,d/2+size,d/2-size,d/2]]}
if(options.pattern=='square')pat.repeat=[[0,0],[0,d],[d,0],[0,-d],[-d,0],[-d,-d],[d,d],[-d,d],[d,-d]]
break;}
case'cross':{if(options.angle)options.angle=45;}
case'hatch':{var a=Math.round(((options.angle||0)-90)%360);if(a>180)a-=360;a*=Math.PI/180;var cos=Math.cos(a);var sin=Math.sin(a);if(Math.abs(sin)<0.0001)
{pat.width=pat.height=d;pat.lines=[[0,0.5,d,0.5]];pat.repeat=[[0,0],[0,d]];}
else if(Math.abs(cos)<0.0001)
{pat.width=pat.height=d;pat.lines=[[0.5,0,0.5,d]];pat.repeat=[[0,0],[d,0]];if(options.pattern=='cross')
{pat.lines.push([0,0.5,d,0.5]);pat.repeat.push([0,d]);}}
else
{var w=pat.width=Math.round(Math.abs(d/sin))||1;var h=pat.height=Math.round(Math.abs(d/cos))||1;if(options.pattern=='cross')
{pat.lines=[[-w,-h,2*w,2*h],[2*w,-h,-w,2*h]];pat.repeat=[[0,0]];}
else if(cos*sin>0)
{pat.lines=[[-w,-h,2*w,2*h]];pat.repeat=[[0,0],[w,0],[0,h]];}
else
{pat.lines=[[2*w,-h,-w,2*h]];pat.repeat=[[0,0],[-w,0],[0,h]];}}
pat.stroke=options.size===0?0:options.size||4;break;}
default:break;}
return pat}
ol.style.FillPattern.addPattern=function(title,options)
{if(!options)options={};ol.style.FillPattern.prototype.patterns[title||options.char]={width:options.width||options.size||10,height:options.height||options.size||10,font:options.font,char:options.char,circles:options.circles,lines:options.lines,repeat:options.repeat,stroke:options.stroke,angle:options.angle,fill:options.fill}}
ol.style.FillPattern.prototype.patterns={"hatch":{width:5,height:5,lines:[[0,2.5,5,2.5]],stroke:1},"cross":{width:7,height:7,lines:[[0,3,10,3],[3,0,3,10]],stroke:1},"dot":{width:8,height:8,circles:[[5,5,2]],stroke:false,fill:true,},"circle":{width:10,height:10,circles:[[5,5,2]],stroke:1,fill:false,},"square":{width:10,height:10,lines:[[3,3,3,8,8,8,8,3,3,3]],stroke:1,fill:false,},"tile":{width:10,height:10,lines:[[3,3,3,8,8,8,8,3,3,3]],fill:true,},"woven":{width:12,height:12,lines:[[3,3,9,9],[0,12,3,9],[9,3,12,0],[-1,1,1,-1],[13,11,11,13]],stroke:1},"crosses":{width:8,height:8,lines:[[2,2,6,6],[2,6,6,2]],stroke:1},"caps":{width:8,height:8,lines:[[2,6,4,2,6,6]],stroke:1},"nylon":{width:20,height:20,lines:[[1,6,1,1,6,1],[6,11,11,11,11,6],[11,16,11,21,16,21],[16,11,21,11,21,16]],repeat:[[0,0],[-20,0],[0,-20]],stroke:1},"hexagon":{width:20,height:12,lines:[[0,10,4,4,10,4,14,10,10,16,4,16,0,10]],stroke:1,repeat:[[0,0],[10,6],[10,-6],[-10,-6]]},"cemetry":{width:15,height:19,lines:[[0,3.5,7,3.5],[3.5,0,3.5,10],],stroke:1,repeat:[[0,0],[7,9]]},"sand":{width:20,height:20,circles:[[1,2,1],[9,3,1],[2,16,1],[7,8,1],[6,14,1],[4,19,1],[14,2,1],[12,10,1],[14,18,1],[18,8,1],[18,14,1]],fill:1},"conglomerate":{width:30,height:20,circles:[[2,4,1],[17,3,1],[26,18,1],[12,17,1],[5,17,2],[28,11,2]],lines:[[7,5,6,7,9,9,11,8,11,6,9,5,7,5],[16,10,15,13,16,14,19,15,21,13,22,9,20,8,19,8,16,10],[24,6,26,7,27,5,26,4,24,4,24,6]],stroke:1},"gravel":{width:15,height:10,circles:[[4,2,1],[5,9,1],[1,7,1]],lines:[[7,5,6,6,7,7,8,7,9,7,10,5,9,4,7,5],[11,2,14,4,14,1,12,1,11,2]],stroke:1},"brick":{width:18,height:16,lines:[[0,1,18,1],[0,10,18,10],[6,1,6,10],[12,10,12,18],[12,0,12,1]],stroke:1},"dolomite":{width:20,height:16,lines:[[0,1,20,1],[0,9,20,9],[1,9,6,1],[11,9,14,16],[14,0,14.4,1]],stroke:1},"coal":{width:20,height:16,lines:[[1,5,7,1,7,7],[11,10,12,5,18,9],[5,10,2,15,9,15,],[15,16,15,13,20,16],[15,0,15,2,20,0]],fill:1},"breccia":{width:20,height:16,lines:[[1,5,7,1,7,7,1,5],[11,10,12,5,18,9,11,10],[5,10,2,15,9,15,5,10],[15,16,15,13,22,18],[15,0,15,2,20,0]],stroke:1,},"clay":{width:20,height:20,lines:[[0,0,3,11,0,20],[11,0,10,3,13,13,11,20],[0,0,10,3,20,0],[0,12,3,11,13,13,20,12]],stroke:1},"flooded":{width:15,height:10,lines:[[0,1,10,1],[0,6,5,6],[10,6,15,6]],stroke:1},"chaos":{width:40,height:40,lines:[[40,2,40,0,38,0,40,2],[4,0,3,2,2,5,0,0,0,3,2,7,5,6,7,7,8,10,9,12,9,13,9,14,8,14,6,15,2,15,0,20,0,22,2,20,5,19,8,15,10,14,11,12.25,10,12,10,10,12,9,13,7,12,6,13,4,16,7,17,4,20,0,18,0,15,3,14,2,14,0,12,1,11,0,10,1,11,4,10,7,9,8,8,5,6,4,5,3,5,1,5,0,4,0],[7,1,7,3,8,3,8,2,7,1],[4,3,5,5,4,5,4,3],[34,5,33,7,38,10,38,8,36,5,34,5],[27,0,23,2,21,8,30,0,27,0],[25,8,26,12,26,16,22.71875,15.375,20,13,18,15,17,18,13,22,17,21,19,22,21,20,19,18,22,17,30,25,26,26,24,28,21.75,33.34375,20,36,18,40,20,40,24,37,25,32,27,31,26,38,27,37,30,32,32,35,36,37,38,40,38,39,40,40,37,36,34,32,37,31,36,29,33,27,34,24,39,21,40,21,40,16,37,20,31,22,32,25,27,20,29,15,30,20,32,20,34,18,33,12,31,11,29,14,26,9,25,8],[39,24,37,26,40,28,39,24],[13,15,9,19,14,18,13,15],[18,23,14,27,16,27,17,25,20,26,18,23],[6,24,2,26,1,28,2,30,5,28,12,30,16,32,18,30,15,30,12,28,9,25,7,27,6,24],[29,27,32,28,33,31,30,29,27,28,29,27],[5,35,1,33,3,36,13,38,15,35,10,36,5,35]],fill:1,},"grass":{width:27,height:22,lines:[[0,10.5,13,10.5],[2.5,10,1.5,7],[4.5,10,4.5,5,3.5,4],[7,10,7.5,6,8.5,3],[10,10,11,6]],repeat:[[0,0],[14,10]],stroke:1},"swamp":{width:24,height:23,lines:[[0,10.5,9.5,10.5],[2.5,10,2.5,7],[4.5,10,4.5,4],[6.5,10,6.5,6],[3,12.5,7,12.5]],repeat:[[0,0],[14,10]],stroke:1},"wave":{width:10,height:8,lines:[[0,0,5,4,10,0]],stroke:1},"vine":{width:13,height:13,lines:[[3,0,3,6],[9,7,9,13]],stroke:1.0},"forest":{width:55,height:30,circles:[[7,7,3.5],[20,20,1.5],[42,22,3.5],[35,5,1.5]],stroke:1},"scrub":{width:26,height:20,lines:[[1,4,4,8,6,4]],circles:[[20,13,1.5]],stroke:1,},"tree":{width:30,height:30,lines:[[7.78,10.61,4.95,10.61,4.95,7.78,3.54,7.78,2.12,6.36,0.71,6.36,0,4.24,0.71,2.12,4.24,0,7.78,0.71,9.19,3.54,7.78,4.95,7.07,7.07,4.95,7.78]],repeat:[[3,1],[18,16]],stroke:1},"pine":{width:30,height:30,lines:[[5.66,11.31,2.83,11.31,2.83,8.49,0,8.49,2.83,0,5.66,8.49,2.83,8.49]],repeat:[[3,1],[18,16]],stroke:1},"pines":{width:22,height:20,lines:[[1,4,3.5,1,6,4],[1,8,3.5,5,6,8],[3.5,1,3.5,11],[12,14.5,14.5,14,17,14.5],[12,18,17,18],[14.5,12,14.5,18]],repeat:[[2,1]],stroke:1},"rock":{width:20,height:20,lines:[[1,0,1,9],[4,0,4,9],[7,0,7,9],[10,1,19,1],[10,4,19,4],[10,7,19,7],[0,11,9,11],[0,14,9,14],[0,17,9,17],[12,10,12,19],[15,10,15,19],[18,10,18,19]],repeat:[[0.5,0.5]],stroke:1},"rocks":{width:20,height:20,lines:[[5,0,3,0,5,4,4,6,0,3,0,5,3,6,5,9,3.75,10,2.5,10,0,9,0,10,4,11,5,14,4,15,0,13,0,13,0,13,0,14,0,14,5,16,5,18,3,19,0,19,-0.25,19.9375,5,20,10,19,10,20,11,20,12,19,14,20,15,20,17,19,20,20,20,19,19,16,20,15,20,11,20,10,19,8,20,5,20,0,19,0,20,2,19,4,17,4,16,3,15,0,14,0,15,4,11,5,10,4,11,0,10,0,9,4,6,5,5,0,],[18,5,19,6,18,10,16,10,14,9,16,5,18,5],[5,6,9,5,10,6,10,9,6,10,5,6],[14,5,14,8,13,9,12,9,11,7,12,5,14,5],[5,11,8,10,9,11,10,14,6,15,6,15,5,11],[13,10,14,11,15,14,15,14,15,14,11,15,10,11,11,10,13,10],[15,12,16,11,19,11,19,15,16,14,16,14,15,12],[6,16,9,15,10,18,5,19,6,16],[10,16,14,16,14,18,13,19,11,18,10,16],[15,15,18,16,18,18,16,19,15,18,15,15]],stroke:1}}
ol.style.FlowLine=function(options){if(!options)options={};ol.style.Style.call(this,{renderer:this._render.bind(this),geometry:options.geometry});this._visible=(options.visible!==false);if(typeof options.width==='function'){this._widthFn=options.width;}else{this.setWidth(options.width);}
this.setWidth2(options.width2);if(typeof options.color==='function'){this._colorFn=options.color;}else{this.setColor(options.color);}
this.setColor2(options.color2);this.setLineCap(options.lineCap);};ol.ext.inherits(ol.style.FlowLine,ol.style.Style);ol.style.FlowLine.prototype.setWidth=function(width){this._width=width||0;};ol.style.FlowLine.prototype.setWidth2=function(width){this._width2=width;};ol.style.FlowLine.prototype.setLineCap=function(cap){this._lineCap=(cap==='round'?'round':'mitter');};ol.style.FlowLine.prototype.getWidth=function(feature,step){if(this._widthFn)return this._widthFn(feature,step);var w2=(typeof(this._width2)==='number')?this._width2:this._width;return this._width+(w2-this._width)*step;};ol.style.FlowLine.prototype.setColor=function(color){try{this._color=ol.color.asArray(color);}catch(e){this._color=[0,0,0,1];}};ol.style.FlowLine.prototype.setColor2=function(color){try{this._color2=ol.color.asArray(color);}catch(e){this._color2=null;}};ol.style.FlowLine.prototype.getColor=function(feature,step){if(this._colorFn)return ol.color.asString(this._colorFn(feature,step));var color=this._color;var color2=this._color2||this._color
return'rgba('+
+Math.round(color[0]+(color2[0]-color[0])*step)+','
+Math.round(color[1]+(color2[1]-color[1])*step)+','
+Math.round(color[2]+(color2[2]-color[2])*step)+','
+(color[3]+(color2[3]-color[3])*step)
+')';};ol.style.FlowLine.prototype._render=function(geom,e){if(e.geometry.getType()==='LineString'){var i,p,ctx=e.context;if(!this._visible){var a=e.pixelRatio/e.resolution;var g=e.geometry.getCoordinates();var dx=geom[0][0]-g[0][0]*a;var dy=geom[0][1]+g[0][1]*a;geom=[];for(i=0;p=g[i];i++){geom[i]=[dx+p[0]*a,dy-p[1]*a];}}
var geoms=this._splitInto(geom,255,2);var k=0;var nb=geoms.length;ctx.save();ctx.lineJoin='round';ctx.lineCap=this._lineCap||'mitter';geoms.forEach(function(g){var step=k++/nb;ctx.lineWidth=this.getWidth(e.feature,step)*e.pixelRatio;ctx.strokeStyle=this.getColor(e.feature,step);ctx.beginPath();ctx.moveTo(g[0][0],g[0][1]);for(i=1;p=g[i];i++){ctx.lineTo(p[0],p[1]);ctx.stroke();}}.bind(this));ctx.restore();}};ol.style.FlowLine.prototype._splitInto=function(geom,nb,min){var i,p;var geoms=[];var dl,l=0;for(i=1;p=geom[i];i++){l+=ol.coordinate.dist2d(geom[i-1],p);}
var length=Math.max(min||2,l/(nb||255));var p0=geom[0];l=0;var g=[p0];i=1;p=geom[1];while(i<geom.length){var dx=p[0]-p0[0];var dy=p[1]-p0[1];dl=Math.sqrt(dx*dx+dy*dy);if(l+dl>length){var d=(length-l)/dl;g.push([p0[0]+dx*d,p0[1]+dy*d]);geoms.push(g);p0=[p0[0]+dx*d*.9,p0[1]+dy*d*.9];g=[p0];l=0;}else{l+=dl;p0=p;g.push(p0);i++;p=geom[i];}}
geoms.push(g);return geoms;}
ol.style.FontSymbol=function(options)
{options=options||{};var strokeWidth=0;if(options.stroke)strokeWidth=options.stroke.getWidth();ol.style.RegularShape.call(this,{radius:options.radius,fill:options.fill,rotation:options.rotation,rotateWithView:options.rotateWithView});if(typeof(options.opacity)=="number")this.setOpacity(options.opacity);this.color_=options.color;this.fontSize_=options.fontSize||1;this.fontStyle_=options.fontStyle||'';this.stroke_=options.stroke;this.fill_=options.fill;this.radius_=options.radius-strokeWidth;this.form_=options.form||"none";this.gradient_=options.gradient;this.offset_=[options.offsetX?options.offsetX:0,options.offsetY?options.offsetY:0];this.glyph_=this.getGlyph(options.glyph)||"";this.renderMarker_();};ol.ext.inherits(ol.style.FontSymbol,ol.style.RegularShape);ol.style.Image.prototype.getImagePNG=function()
{var canvas=this.getImage();if(canvas)
{try{return canvas.toDataURL("image/png");}
catch(e){return false;}}
else return false;}
ol.style.FontSymbol.prototype.defs={'fonts':{},'glyphs':{}};ol.style.FontSymbol.addDefs=function(font,glyphs)
{var thefont=font;if(typeof(font)=="string")thefont={"font":font,"name":font,"copyright":""};if(!thefont.font||typeof(thefont.font)!="string")
{console.log("bad font def");return;}
var fontname=thefont.font;ol.style.FontSymbol.prototype.defs.fonts[fontname]=thefont;for(var i in glyphs)
{var g=glyphs[i];if(typeof(g)=="string"&&g.length==1)g={char:g};ol.style.FontSymbol.prototype.defs.glyphs[i]={font:thefont.font,char:g.char||""+String.fromCharCode(g.code)||"",theme:g.theme||thefont.name,name:g.name||i,search:g.search||""};}};ol.style.FontSymbol.prototype.clone=function()
{var g=new ol.style.FontSymbol({glyph:"",color:this.color_,fontSize:this.fontSize_,fontStyle:this.fontStyle_,stroke:this.stroke_,fill:this.fill_,radius:this.radius_+(this.stroke_?this.stroke_.getWidth():0),form:this.form_,gradient:this.gradient_,offsetX:this.offset_[0],offsetY:this.offset_[1],opacity:this.getOpacity(),rotation:this.getRotation(),rotateWithView:this.getRotateWithView()});g.setScale(this.getScale());g.glyph_=this.glyph_;g.renderMarker_();return g;};ol.style.FontSymbol.prototype.getFill=function(){return this.fill_;};ol.style.FontSymbol.prototype.getStroke=function(){return this.stroke_;};ol.style.FontSymbol.prototype.getGlyph=function(name)
{if(name)return ol.style.FontSymbol.prototype.defs.glyphs[name]||{"font":"none","char":name.charAt(0),"theme":"none","name":"none","search":""};else return this.glyph_;};ol.style.FontSymbol.prototype.getGlyphName=function()
{for(var i in ol.style.FontSymbol.prototype.defs.glyphs)
{if(ol.style.FontSymbol.prototype.defs.glyphs[i]===this.glyph_)return i;}
return"";};ol.style.FontSymbol.prototype.getFontInfo=function(glyph)
{return ol.style.FontSymbol.prototype.defs.fonts[glyph.font];}
ol.style.FontSymbol.prototype.renderMarker_=function()
{var strokeStyle;var strokeWidth=0;if(this.stroke_)
{strokeStyle=ol.color.asString(this.stroke_.getColor());strokeWidth=this.stroke_.getWidth();}
var canvas=this.getImage();var renderOptions={strokeStyle:strokeStyle,strokeWidth:strokeWidth,size:canvas.width,};var context=(canvas.getContext('2d'));context.clearRect(0,0,canvas.width,canvas.height);this.drawMarker_(renderOptions,context,0,0);var a=this.getAnchor();a[0]=canvas.width/2-this.offset_[0];a[1]=canvas.width/2-this.offset_[1];};ol.style.FontSymbol.prototype.drawPath_=function(renderOptions,context)
{var s=2*this.radius_+renderOptions.strokeWidth+1;var w=renderOptions.strokeWidth/2;var c=renderOptions.size/2;var transfo={fac:1,posX:renderOptions.size/2,posY:renderOptions.size/2};context.lineJoin='round';context.beginPath();switch(this.form_)
{case"none":transfo.fac=1;break;case"circle":case"ban":context.arc(c,c,s/2,0,2*Math.PI,true);break;case"poi":context.arc(c,c-0.4*this.radius_,0.6*this.radius_,0.15*Math.PI,0.85*Math.PI,true);context.lineTo(c-0.89*0.05*s,(0.95+0.45*0.05)*s+w);context.arc(c,0.95*s+w,0.05*s,0.85*Math.PI,0.15*Math.PI,true);transfo={fac:0.45,posX:c,posY:c-0.35*this.radius_};break;case"bubble":context.arc(c,c-0.2*this.radius_,0.8*this.radius_,0.4*Math.PI,0.6*Math.PI,true);context.lineTo(0.5*s+w,s+w);transfo={fac:0.7,posX:c,posY:c-0.2*this.radius_};break;case"marker":context.arc(c,c-0.2*this.radius_,0.8*this.radius_,0.25*Math.PI,0.75*Math.PI,true);context.lineTo(0.5*s+w,s+w);transfo={fac:0.7,posX:c,posY:c-0.2*this.radius_};break;case"coma":context.moveTo(c+0.8*this.radius_,c-0.2*this.radius_);context.quadraticCurveTo(0.95*s+w,0.75*s+w,0.5*s+w,s+w);context.arc(c,c-0.2*this.radius_,0.8*this.radius_,0.45*Math.PI,0,false);transfo={fac:0.7,posX:c,posY:c-0.2*this.radius_};break;default:{var pts;switch(this.form_)
{case"shield":pts=[0.05,0,0.95,0,0.95,0.8,0.5,1,0.05,0.8,0.05,0];transfo.posY=0.45*s+w;break;case"blazon":pts=[0.1,0,0.9,0,0.9,0.8,0.6,0.8,0.5,1,0.4,0.8,0.1,0.8,0.1,0];transfo.fac=0.8;transfo.posY=0.4*s+w;break;case"bookmark":pts=[0.05,0,0.95,0,0.95,1,0.5,0.8,0.05,1,0.05,0];transfo.fac=0.9;transfo.posY=0.4*s+w;break;case"hexagon":pts=[0.05,0.2,0.5,0,0.95,0.2,0.95,0.8,0.5,1,0.05,0.8,0.05,0.2];transfo.fac=0.9;transfo.posY=0.5*s+w;break;case"diamond":pts=[0.25,0,0.75,0,1,0.2,1,0.4,0.5,1,0,0.4,0,0.2,0.25,0];transfo.fac=0.75;transfo.posY=0.35*s+w;break;case"triangle":pts=[0,0,1,0,0.5,1,0,0];transfo.fac=0.6;transfo.posY=0.3*s+w;break;case"sign":pts=[0.5,0.05,1,0.95,0,0.95,0.5,0.05];transfo.fac=0.7;transfo.posY=0.65*s+w;break;case"lozenge":pts=[0.5,0,1,0.5,0.5,1,0,0.5,0.5,0];transfo.fac=0.7;break;case"square":default:pts=[0,0,1,0,1,1,0,1,0,0];break;}
for(var i=0;i<pts.length;i+=2)context.lineTo(pts[i]*s+w,pts[i+1]*s+w);}}
context.closePath();return transfo;}
ol.style.FontSymbol.prototype.drawMarker_=function(renderOptions,context,x,y)
{var fcolor=this.fill_?this.fill_.getColor():"#000";var scolor=this.stroke_?this.stroke_.getColor():"#000";if(this.form_=="none"&&this.stroke_&&this.fill_)
{scolor=this.fill_.getColor();fcolor=this.stroke_.getColor();}
context.setTransform(1,0,0,1,0,0);context.translate(x,y);var tr=this.drawPath_(renderOptions,context);if(this.fill_)
{if(this.gradient_&&this.form_!="none")
{var grd=context.createLinearGradient(0,0,renderOptions.size/2,renderOptions.size);grd.addColorStop(1,ol.color.asString(fcolor));grd.addColorStop(0,ol.color.asString(scolor));context.fillStyle=grd;}
else context.fillStyle=ol.color.asString(fcolor);context.fill();}
if(this.stroke_&&renderOptions.strokeWidth){context.strokeStyle=renderOptions.strokeStyle;context.lineWidth=renderOptions.strokeWidth;context.stroke();}
if(this.glyph_.char)
{context.font=this.fontStyle_+' '
+(2*tr.fac*(this.radius_)*this.fontSize_)+"px "
+this.glyph_.font;context.strokeStyle=context.fillStyle;context.lineWidth=renderOptions.strokeWidth*(this.form_=="none"?2:1);context.fillStyle=ol.color.asString(this.color_||scolor);context.textAlign="center";context.textBaseline="middle";var t=this.glyph_.char;if(renderOptions.strokeWidth&&scolor!="transparent")context.strokeText(t,tr.posX,tr.posY);context.fillText(t,tr.posX,tr.posY);}
if(this.form_=="ban"&&this.stroke_&&renderOptions.strokeWidth)
{context.strokeStyle=renderOptions.strokeStyle;context.lineWidth=renderOptions.strokeWidth;var r=this.radius_+renderOptions.strokeWidth;var d=this.radius_*Math.cos(Math.PI/4);context.moveTo(r+d,r-d);context.lineTo(r-d,r+d);context.stroke();}};ol.style.FontSymbol.prototype.getChecksum=function()
{var strokeChecksum=(this.stroke_!==null)?this.stroke_.getChecksum():'-';var fillChecksum=(this.fill_!==null)?this.fill_.getChecksum():'-';var recalculate=(this.checksums_===null)||(strokeChecksum!=this.checksums_[1]||fillChecksum!=this.checksums_[2]||this.radius_!=this.checksums_[3]||this.form_+"-"+this.glyphs_!=this.checksums_[4]);if(recalculate){var checksum='c'+strokeChecksum+fillChecksum
+((this.radius_!==void 0)?this.radius_.toString():'-')
+this.form_+"-"+this.glyphs_;this.checksums_=[checksum,strokeChecksum,fillChecksum,this.radius_,this.form_+"-"+this.glyphs_];}
return this.checksums_[0];};ol.style.Photo=function(options){options=options||{};this.sanchor_=options.kind=="anchored"?8:0;this.shadow_=Number(options.shadow)||0;if(!options.stroke){options.stroke=new ol.style.Stroke({width:0,color:"#000"})}
var strokeWidth=options.stroke.getWidth();if(strokeWidth<0)strokeWidth=0;if(options.kind=='folio')strokeWidth+=6;options.stroke.setWidth(strokeWidth);ol.style.RegularShape.call(this,{radius:options.radius+strokeWidth+this.sanchor_/2+this.shadow_/2,points:0});if(!this.hitDetectionCanvas_){var img=this.getImage();for(var i in this){if(this[i]&&this[i].getContext&&this[i]!==img){this.hitDetectionCanvas_=this[i];break;}}}
this.hitDetectionCanvas_=document.createElement('canvas');this.hitDetectionCanvas_.width=this.getImage().width;this.hitDetectionCanvas_.height=this.getImage().height;this.stroke_=options.stroke;this.fill_=options.fill;this.crop_=options.crop;this.crossOrigin_=options.crossOrigin;this.kind_=options.kind||"default";this.radius_=options.radius;this.src_=options.src;this.offset_=[options.offsetX?options.offsetX:0,options.offsetY?options.offsetY:0];this.onload_=options.onload;if(typeof(options.opacity)=='number')this.setOpacity(options.opacity);if(typeof(options.rotation)=='number')this.setRotation(options.rotation);this.renderPhoto_();};ol.ext.inherits(ol.style.Photo,ol.style.RegularShape);ol.style.Photo.prototype.clone=function(){return new ol.style.Photo({stroke:this.stroke_,fill:this.fill_,shadow:this.shadow_,crop:this.crop_,crossOrigin:this.crossOrigin_,kind:this.kind_,radius:this.radius_,src:this.src_,offsetX:this.offset_[0],offsetY:this.offset_[1],opacity:this.getOpacity(),rotation:this.getRotation()});};CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){if(!r){this.rect(x,y,w,h);}else{if(w<2*r)r=w/2;if(h<2*r)r=h/2;this.beginPath();this.moveTo(x+r,y);this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();}
return this;};ol.style.Photo.prototype.drawBack_=function(context,color,strokeWidth){var canvas=context.canvas;context.beginPath();context.fillStyle=color;context.clearRect(0,0,canvas.width,canvas.height);switch(this.kind_){case'square':{context.rect(0,0,canvas.width-this.shadow_,canvas.height-this.shadow_);break;}
case'circle':{context.arc(this.radius_+strokeWidth,this.radius_+strokeWidth,this.radius_+strokeWidth,0,2*Math.PI,false);break;}
case'folio':{var offset=6;strokeWidth-=offset;context.strokeStyle='rgba(0,0,0,0.5)';var w=canvas.width-this.shadow_-2*offset;var a=Math.atan(6/w);context.save();context.rotate(-a);context.translate(-6,2);context.beginPath();context.rect(offset,offset,w,w);context.stroke();context.fill();context.restore();context.save();context.translate(6,-1);context.rotate(a);context.beginPath();context.rect(offset,offset,w,w);context.stroke();context.fill();context.restore();context.beginPath();context.rect(offset,offset,w,w);context.stroke();break;}
case'anchored':{context.roundRect(this.sanchor_/2,0,canvas.width-this.sanchor_-this.shadow_,canvas.height-this.sanchor_-this.shadow_,strokeWidth);context.moveTo(canvas.width/2-this.sanchor_-this.shadow_/2,canvas.height-this.sanchor_-this.shadow_);context.lineTo(canvas.width/2+this.sanchor_-this.shadow_/2,canvas.height-this.sanchor_-this.shadow_);context.lineTo(canvas.width/2-this.shadow_/2,canvas.height-this.shadow_);break;}
default:{context.roundRect(0,0,canvas.width-this.shadow_,canvas.height-this.shadow_,strokeWidth);break;}}
context.closePath();};ol.style.Photo.prototype.renderPhoto_=function(){var strokeStyle;var strokeWidth=0;if(this.stroke_){strokeStyle=ol.color.asString(this.stroke_.getColor());strokeWidth=this.stroke_.getWidth();}
var canvas=this.getImage();var context=this.hitDetectionCanvas_.getContext('2d');this.drawBack_(context,"#000",strokeWidth);context.fill();context=canvas.getContext('2d');this.drawBack_(context,strokeStyle,strokeWidth);if(this.shadow_){context.shadowColor='rgba(0,0,0,0.5)';context.shadowBlur=this.shadow_/2;context.shadowOffsetX=this.shadow_/2;context.shadowOffsetY=this.shadow_/2;}
context.fill();context.shadowColor='transparent';var self=this;var img=this.img_=new Image();if(this.crossOrigin_)img.crossOrigin=this.crossOrigin_;img.src=this.src_;if(img.width){self.drawImage_(img);}else{img.onload=function(){self.drawImage_(img);if(self.onload_)self.onload_();};}
var a=this.getAnchor();a[0]=(canvas.width-this.shadow_)/2;a[1]=(canvas.height-this.shadow_)/2;if(this.sanchor_){a[1]=canvas.height-this.shadow_;}};ol.style.Photo.prototype.drawImage_=function(img){var canvas=this.getImage();var context=(canvas.getContext('2d'));var strokeWidth=0;if(this.stroke_)strokeWidth=this.stroke_.getWidth();var size=2*this.radius_;context.save();if(this.kind_=='circle'){context.beginPath();context.arc(this.radius_+strokeWidth,this.radius_+strokeWidth,this.radius_,0,2*Math.PI,false);context.clip();}
var s,x,y,w,h,sx,sy,sw,sh;if(this.crop_){s=Math.min(img.width/size,img.height/size);sw=sh=s*size;sx=(img.width-sw)/2;sy=(img.height-sh)/2;x=y=0;w=h=size+1;}else{s=Math.min(size/img.width,size/img.height);sx=sy=0;sw=img.width;sh=img.height;w=s*sw;h=s*sh;x=(size-w)/2;y=(size-h)/2;}
x+=strokeWidth+this.sanchor_/2;y+=strokeWidth;context.drawImage(img,sx,sy,sw,sh,x,y,w,h);context.restore();if(this.kind_=='circle'&&strokeWidth){context.beginPath();context.strokeStyle=ol.color.asString(this.stroke_.getColor());context.lineWidth=strokeWidth/4;context.arc(this.radius_+strokeWidth,this.radius_+strokeWidth,this.radius_,0,2*Math.PI,false);context.stroke();}};(function()
{function drawTextPath(e)
{if(e.frameState.viewState.resolution>this.textPathMaxResolution_)return;var extent=e.frameState.extent;var c2p=e.frameState.coordinateToPixelTransform;var k;function getPath(c,readable)
{var path1=[];for(k=0;k<c.length;k++)
{path1.push(c2p[0]*c[k][0]+c2p[1]*c[k][1]+c2p[4]);path1.push(c2p[2]*c[k][0]+c2p[3]*c[k][1]+c2p[5]);}
if(readable&&path1[0]>path1[path1.length-2])
{var path2=[];for(k=path1.length-2;k>=0;k-=2)
{path2.push(path1[k]);path2.push(path1[k+1]);}
return path2;}
else return path1;}
var ctx=e.context;ctx.save();ctx.scale(e.frameState.pixelRatio,e.frameState.pixelRatio);var features=this.getSource().getFeaturesInExtent(extent);for(var i=0,f;f=features[i];i++)
{{var style=this.textPathStyle_(f,e.frameState.viewState.resolution);for(var s,j=0;s=style[j];j++)
{var g=s.getGeometry()||f.getGeometry();var c;switch(g.getType())
{case"LineString":c=g.getCoordinates();break;case"MultiLineString":c=g.getLineString(0).getCoordinates();break;default:continue;}
var st=s.getText();var path=getPath(c,st.getRotateWithView());ctx.font=st.getFont();ctx.textBaseline=st.getTextBaseline();ctx.textAlign=st.getTextAlign();ctx.lineWidth=st.getStroke()?(st.getStroke().getWidth()||0):0;ctx.strokeStyle=st.getStroke()?(st.getStroke().getColor()||"#fff"):"#fff";ctx.fillStyle=st.getFill()?st.getFill().getColor()||"#000":"#000";ctx.textJustify=st.getTextAlign()=="justify";ctx.textOverflow=st.getTextOverflow?st.getTextOverflow():"";ctx.minWidth=st.getMinWidth?st.getMinWidth():0;ctx.textPath(st.getText()||f.get("name"),path);}}}
ctx.restore();}
ol.layer.Vector.prototype.setTextPathStyle=function(style,maxResolution)
{if(style===null)
{if(this.textPath_)this.unByKey(this.textPath_);this.textPath_=null;this.changed();return;}
if(!this.textPath_)
{this.textPath_=this.on(['postcompose','postrender'],drawTextPath.bind(this));}
if(style===undefined)
{style=[new ol.style.Style({text:new ol.style.Text()})];}
if(typeof(style)=="function")this.textPathStyle_=style;else this.textPathStyle_=function(){return style;};this.textPathMaxResolution_=Number(maxResolution)||Number.MAX_VALUE;this.changed();}
ol.style.TextPath=function(options)
{if(!options)options={};ol.style.Text.call(this,options);this.textOverflow_=typeof(options.textOverflow)!="undefined"?options.textOverflow:"visible";this.minWidth_=options.minWidth||0;}
ol.ext.inherits(ol.style.TextPath,ol.style.Text);ol.style.TextPath.prototype.getTextOverflow=function()
{return this.textOverflow_;};ol.style.TextPath.prototype.getMinWidth=function()
{return this.minWidth_;};})();CanvasRenderingContext2D.prototype.textPath=function(text,path)
{var ctx=this;function dist2D(x1,y1,x2,y2)
{var dx=x2-x1;var dy=y2-y1;return Math.sqrt(dx*dx+dy*dy);}
var di,dpos=0;var pos=2;function getPoint(path,dl)
{if(!di||dpos+di<dl)
{for(;pos<path.length;)
{di=dist2D(path[pos-2],path[pos-1],path[pos],path[pos+1]);if(dpos+di>dl)break;pos+=2;if(pos>=path.length)break;dpos+=di;}}
var x,y,a,dt=dl-dpos;if(pos>=path.length)
{pos=path.length-2;}
if(!dt)
{x=path[pos-2];y=path[pos-1];a=Math.atan2(path[pos+1]-path[pos-1],path[pos]-path[pos-2]);}
else
{x=path[pos-2]+(path[pos]-path[pos-2])*dt/di;y=path[pos-1]+(path[pos+1]-path[pos-1])*dt/di;a=Math.atan2(path[pos+1]-path[pos-1],path[pos]-path[pos-2]);}
return[x,y,a];}
var letterPadding=ctx.measureText(" ").width*0.25;var start=0;var d=0;for(var i=2;i<path.length;i+=2)
{d+=dist2D(path[i-2],path[i-1],path[i],path[i+1])}
if(d<ctx.minWidth)return;var nbspace=text.split(" ").length-1;if(ctx.textOverflow!="visible")
{if(d<ctx.measureText(text).width+(text.length-1+nbspace)*letterPadding)
{var overflow=(ctx.textOverflow=="ellipsis")?'\u2026':ctx.textOverflow;do
{nbspace=text.split(" ").length-1;text=text.slice(0,text.length-1);}while(text&&d<ctx.measureText(text+overflow).width+(text.length+overflow.length-1+nbspace)*letterPadding)
text+=overflow;}}
switch(ctx.textJustify||ctx.textAlign)
{case true:case"center":case"end":case"right":{if(ctx.textJustify)
{start=0;letterPadding=(d-ctx.measureText(text).width)/(text.length-1+nbspace);}
else
{start=d-ctx.measureText(text).width-(text.length+nbspace)*letterPadding;if(ctx.textAlign=="center")start/=2;}
break;}
default:break;}
for(var t=0;t<text.length;t++)
{var letter=text[t];var wl=ctx.measureText(letter).width;var p=getPoint(path,start+wl/2);ctx.save();ctx.textAlign="center";ctx.translate(p[0],p[1]);ctx.rotate(p[2]);if(ctx.lineWidth)ctx.strokeText(letter,0,0);ctx.fillText(letter,0,0);ctx.restore();start+=wl+letterPadding*(letter==" "?2:1);}};ol.style.Shadow=function(options)
{options=options||{};if(!options.fill)options.fill=new ol.style.Fill({color:"rgba(0,0,0,0.5)"});ol.style.RegularShape.call(this,{radius:options.radius,fill:options.fill});this.fill_=options.fill;this.radius_=options.radius;this.blur_=options.blur===0?0:options.blur||options.radius/3;this.offset_=[options.offsetX?options.offsetX:0,options.offsetY?options.offsetY:0];this.renderShadow_();};ol.ext.inherits(ol.style.Shadow,ol.style.RegularShape);ol.style.Shadow.prototype.clone=function()
{var s=new ol.style.Shadow({fill:this.fill_,radius:this.radius_,blur:this.blur_,offsetX:this.offset_[0],offsetY:this.offset_[1]});s.setScale(this.getScale());s.setOpacity(this.getOpacity());return s;};ol.style.Shadow.prototype.renderShadow_=function()
{var radius=this.radius_;var canvas=this.getImage();var s=[canvas.width,canvas.height];s[1]=radius;var context=(canvas.getContext('2d'));context.beginPath();context.clearRect(0,0,canvas.width,canvas.height);context.scale(1,0.5);context.arc(radius,-radius,radius-this.blur_,0,2*Math.PI,false);context.fillStyle='#000';context.shadowColor=this.fill_.getColor();context.shadowBlur=0.7*this.blur_;context.shadowOffsetX=0;context.shadowOffsetY=1.5*radius;context.closePath();context.fill();context.shadowColor='transparent';var a=this.getAnchor();a[0]=canvas.width/2-this.offset_[0];a[1]=canvas.height/2-this.offset_[1];}
ol.style.Shadow.prototype.getChecksum=function()
{var strokeChecksum=(this.stroke_!==null)?this.stroke_.getChecksum():'-';var fillChecksum=(this.fill_!==null)?this.fill_.getChecksum():'-';var recalculate=(this.checksums_===null)||(strokeChecksum!=this.checksums_[1]||fillChecksum!=this.checksums_[2]||this.radius_!=this.checksums_[3]||this.form_+"-"+this.glyphs_!=this.checksums_[4]);if(recalculate){var checksum='c'+strokeChecksum+fillChecksum
+((this.radius_!==void 0)?this.radius_.toString():'-')
+this.form_+"-"+this.glyphs_;this.checksums_=[checksum,strokeChecksum,fillChecksum,this.radius_,this.form_+"-"+this.glyphs_];}
return this.checksums_[0];};ol.style.StrokePattern=function(options)
{if(!options)options={};var pattern,i;var canvas=this.canvas_=document.createElement('canvas');var scale=Number(options.scale)>0?Number(options.scale):1;var ratio=scale*ol.has.DEVICE_PIXEL_RATIO||ol.has.DEVICE_PIXEL_RATIO;var ctx=canvas.getContext('2d');if(options.image)
{options.image.load();var img=options.image.getImage();if(img.width)
{canvas.width=Math.round(img.width*ratio);canvas.height=Math.round(img.height*ratio);ctx.globalAlpha=typeof(options.opacity)=='number'?options.opacity:1;ctx.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height);pattern=ctx.createPattern(canvas,'repeat');}
else
{var self=this;pattern=[0,0,0,0];img.onload=function()
{canvas.width=Math.round(img.width*ratio);canvas.height=Math.round(img.height*ratio);ctx.globalAlpha=typeof(options.opacity)=='number'?options.opacity:1;ctx.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height);pattern=ctx.createPattern(canvas,'repeat');self.setColor(pattern);}}}
else
{var pat=this.getPattern_(options);canvas.width=Math.round(pat.width*ratio);canvas.height=Math.round(pat.height*ratio);ctx.beginPath();if(options.fill)
{ctx.fillStyle=ol.color.asString(options.fill.getColor());ctx.fillRect(0,0,canvas.width,canvas.height);}
ctx.scale(ratio,ratio);ctx.lineCap="round";ctx.lineWidth=pat.stroke||1;ctx.fillStyle=ol.color.asString(options.color||"#000");ctx.strokeStyle=ol.color.asString(options.color||"#000");if(pat.circles)for(i=0;i<pat.circles.length;i++)
{var ci=pat.circles[i];ctx.beginPath();ctx.arc(ci[0],ci[1],ci[2],0,2*Math.PI);if(pat.fill)ctx.fill();if(pat.stroke)ctx.stroke();}
if(!pat.repeat)pat.repeat=[[0,0]];if(pat.char)
{ctx.font=pat.font||(pat.width)+"px Arial";ctx.textAlign='center';ctx.textBaseline='middle';if(pat.angle)
{ctx.fillText(pat.char,pat.width/4,pat.height/4);ctx.fillText(pat.char,5*pat.width/4,5*pat.height/4);ctx.fillText(pat.char,pat.width/4,5*pat.height/4);ctx.fillText(pat.char,5*pat.width/4,pat.height/4);ctx.fillText(pat.char,3*pat.width/4,3*pat.height/4);ctx.fillText(pat.char,-pat.width/4,-pat.height/4);ctx.fillText(pat.char,3*pat.width/4,-pat.height/4);ctx.fillText(pat.char,-pat.width/4,3*pat.height/4);}
else ctx.fillText(pat.char,pat.width/2,pat.height/2);}
if(pat.lines)for(i=0;i<pat.lines.length;i++)for(var r=0;r<pat.repeat.length;r++)
{var li=pat.lines[i];ctx.beginPath();ctx.moveTo(li[0]+pat.repeat[r][0],li[1]+pat.repeat[r][1]);for(var k=2;k<li.length;k+=2)
{ctx.lineTo(li[k]+pat.repeat[r][0],li[k+1]+pat.repeat[r][1]);}
if(pat.fill)ctx.fill();if(pat.stroke)ctx.stroke();ctx.save()
ctx.strokeStyle='red';ctx.strokeWidth=0.1;ctx.restore()}
pattern=ctx.createPattern(canvas,'repeat');if(options.offset)
{var offset=options.offset;if(typeof(offset)=="number")offset=[offset,offset];if(offset instanceof Array)
{var dx=Math.round((offset[0]*ratio));var dy=Math.round((offset[1]*ratio));ctx.scale(1/ratio,1/ratio)
ctx.clearRect(0,0,canvas.width,canvas.height);ctx.translate(dx,dy);ctx.fillStyle=pattern;ctx.fillRect(-dx,-dy,canvas.width,canvas.height);pattern=ctx.createPattern(canvas,'repeat');}}}
options.color=pattern;ol.style.Stroke.call(this,options);};ol.ext.inherits(ol.style.StrokePattern,ol.style.Stroke);ol.style.StrokePattern.prototype.clone=function(){var s=ol.style.Fill.prototype.clone.call(this);s.canvas_=this.canvas_;return s;};ol.style.StrokePattern.prototype.getImage=function()
{return this.canvas_;}
ol.style.StrokePattern.prototype.getPattern_=function(options)
{var pat=ol.style.FillPattern.prototype.patterns[options.pattern]||ol.style.FillPattern.prototype.patterns.dot;var d=Math.round(options.spacing)||10;var size;switch(options.pattern)
{case'dot':case'circle':{size=options.size===0?0:options.size/2||2;if(!options.angle)
{pat.width=pat.height=d;pat.circles=[[d/2,d/2,size]]
if(options.pattern=='circle')
{pat.circles=pat.circles.concat([[d/2+d,d/2,size],[d/2-d,d/2,size],[d/2,d/2+d,size],[d/2,d/2-d,size],[d/2+d,d/2+d,size],[d/2+d,d/2-d,size],[d/2-d,d/2+d,size],[d/2-d,d/2-d,size]])}}
else
{d=pat.width=pat.height=Math.round(d*1.4);pat.circles=[[d/4,d/4,size],[3*d/4,3*d/4,size]];if(options.pattern=='circle')
{pat.circles=pat.circles.concat([[d/4+d,d/4,size],[d/4,d/4+d,size],[3*d/4-d,3*d/4,size],[3*d/4,3*d/4-d,size],[d/4+d,d/4+d,size],[3*d/4-d,3*d/4-d,size]]);}}
break;}
case'tile':case'square':{size=options.size===0?0:options.size/2||2;if(!options.angle)
{pat.width=pat.height=d;pat.lines=[[d/2-size,d/2-size,d/2+size,d/2-size,d/2+size,d/2+size,d/2-size,d/2+size,d/2-size,d/2-size]]}
else
{pat.width=pat.height=d;pat.lines=[[d/2-size,d/2,d/2,d/2-size,d/2+size,d/2,d/2,d/2+size,d/2-size,d/2]]}
if(options.pattern=='square')pat.repeat=[[0,0],[0,d],[d,0],[0,-d],[-d,0],[-d,-d],[d,d],[-d,d],[d,-d]]
break;}
case'cross':{if(options.angle)options.angle=45;}
case'hatch':{var a=Math.round(((options.angle||0)-90)%360);if(a>180)a-=360;a*=Math.PI/180;var cos=Math.cos(a);var sin=Math.sin(a);if(Math.abs(sin)<0.0001)
{pat.width=pat.height=d;pat.lines=[[0,0.5,d,0.5]];pat.repeat=[[0,0],[0,d]];}
else if(Math.abs(cos)<0.0001)
{pat.width=pat.height=d;pat.lines=[[0.5,0,0.5,d]];pat.repeat=[[0,0],[d,0]];if(options.pattern=='cross')
{pat.lines.push([0,0.5,d,0.5]);pat.repeat.push([0,d]);}}
else
{var w=pat.width=Math.round(Math.abs(d/sin))||1;var h=pat.height=Math.round(Math.abs(d/cos))||1;if(options.pattern=='cross')
{pat.lines=[[-w,-h,2*w,2*h],[2*w,-h,-w,2*h]];pat.repeat=[[0,0]];}
else if(cos*sin>0)
{pat.lines=[[-w,-h,2*w,2*h]];pat.repeat=[[0,0],[w,0],[0,h]];}
else
{pat.lines=[[2*w,-h,-w,2*h]];pat.repeat=[[0,0],[-w,0],[0,h]];}}
pat.stroke=options.size===0?0:options.size||4;break;}
default:{break;}}
return pat}