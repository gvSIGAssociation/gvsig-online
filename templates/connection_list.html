{% extends "base.html" %} 
{% load staticfiles %} 
{% load i18n %} 

{% block content %}
<div class="row">
	<div class="col-md-12">
	
		<div class="row">
			<div class="col-md-12 form-group">
				<div class="box-tools pull-right">
					<button id="button-add-connection" class="btn btn-block btn-default btn-sm"><i class="fa fa-plus margin-r-5"></i> {% trans "Add connection" %}</button>
				</div>
			</div>
		</div>
		
		<div class="box">		
			<div class="box-body">
				<table class="table" id="connections-table">
					<thead>
						<tr>
							<th>ID</th>
							<th>{% trans "Name" %}</th>
							<th>{% trans "Description" %}</th>
							<th>{% trans "Type" %}</th>
							<th>{% trans "Permissions" %}</th>
							<th>{% trans "Datastores" %}</th>
							<th></th>
							<th></th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						{% for conn in connections %}
						<tr>
							<td>{{ conn.id }}</td> 
							<td>{{ conn.name }}</td>
							<td>{{ conn.description|default:"-" }}</td>
							<td>
								{% if conn.type == 'indenova' %}InDenova
								{% elif conn.type == 'padron-atm' %}Padrón-ATM
								{% elif conn.type == 'sharepoint' %}SharePoint
								{% elif conn.type == 'segex' %}SEGEX
								{% else %}{{ conn.type }}{% endif %}
							</td>
							<td>
								{% if conn.allow_all_datastore %}
									<span class="label label-success" title="{% trans 'All users can create datastores' %}">{% trans "Datastores" %}</span>
								{% endif %}
								{% if conn.allow_all_etl %}
									<span class="label label-info" title="{% trans 'All users can use in ETL' %}">{% trans "ETL" %}</span>
								{% endif %}
								{% if conn.allow_all_manage %}
									<span class="label label-warning" title="{% trans 'All users can manage' %}">{% trans "Manage" %}</span>
								{% endif %}
								{% if not conn.allow_all_datastore and not conn.allow_all_etl and not conn.allow_all_manage %}
									<span class="label label-default" title="{% trans 'Permissions by role only' %}">{% trans "By role" %}</span>
								{% endif %}
							</td>
							<td>
								{% if conn.type == 'PostGIS' %}
									<span class="badge bg-blue">{{ conn.datastore_count }}</span>
								{% else %}
									<span class="text-muted"><small>{% trans "Not compatible" %}</small></span>
								{% endif %}
							</td>
							<td>
								{% if conn.type == 'PostGIS' %}
									<button type="button" name="button-options-connection" data-toggle="tooltip" data-placement="bottom" title="{% trans 'Options' %}" class="btn btn-default"><i class="fa fa-cog"></i></button>
								{% endif %}
							</td>
							<td></td>
							<td></td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>      

<!-- Modal -->
<div class="modal fade" id="modal-delete-connection" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title" id="myModalLabel">{% trans "Delete connection" %}</h4>
			</div>
			<div class="modal-body">
				<div id="delete-connection-simple">
					<p>{% trans "The connection will be deleted. Do you want to continue?" %}</p>
				</div>
				<div id="delete-connection-cascade" style="display: none;">
					<div class="alert alert-warning">
						<strong><i class="fa fa-exclamation-triangle"></i> {% trans "Warning" %}</strong>
						<p id="delete-cascade-message"></p>
					</div>
					<p>{% trans "The connection and all associated resources will be deleted:" %}</p>
					<ul>
						<li>{% trans "All datastores linked to this connection" %}</li>
						<li>{% trans "All layers in those datastores" %}</li>
						<li>{% trans "All triggers and topology rules of those layers" %}</li>
					</ul>
					<div class="checkbox">
						<label>
							<input type="checkbox" id="confirm-cascade-delete"> 
							{% trans "I understand that this action cannot be undone" %}
						</label>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button id="button-delete-connection-cancel" type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
				<button id="button-delete-connection-accept" type="button" class="btn btn-danger">{% trans "Delete" %}</button>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra-scripts %}
<script>
	$('#menu-manage-services').addClass("active");
	$('#submenu-connections').addClass("active");
</script>
<script>
$(document).ready(function() {
	var table = $('#connections-table').DataTable({
		responsive: true,
	    language: {
	    	processing		: '{% trans "Processing request..." %}',
		    search			: '{% blocktrans with sep="&nbsp;:" %}Search{{sep}}{% endblocktrans %}',
		    lengthMenu		: '{% blocktrans with numrecords="_MENU_" %}Showing {{numrecords}} records{% endblocktrans %}',
		    info			: '{% blocktrans with start="_START_" end="_END_" numrecords="_TOTAL_" %}Showing from {{start}} to {{end}} of {{numrecords}} records{% endblocktrans %}',
		    infoEmpty		: '{% trans "Showing from 0 to 0 of 0 records" %}',
		    infoFiltered	: '{% blocktrans with max="_MAX_" %}Filtering {{max}} records{% endblocktrans %}',
		    infoPostFix		: "",
		    loadingRecords	: '{% trans "Loading..." %}',
		    zeroRecords		: '{% trans "No records available" %}',
		    emptyTable		: '{% trans "No records available" %}',
		    paginate: {
		    	first		: '{% trans "First" %}',
		        previous	: '{% trans "Previous" %}',
		        next		: '{% trans "Next" %}',
		        last		: '{% trans "Last" %}'
		    },
		    aria: {
		        sortAscending: '{% blocktrans with sep=": " %}{{sep}}Sort ascending{% endblocktrans %}',
		        sortDescending: '{% blocktrans with sep=": " %}{{sep}}Sort descending{% endblocktrans %}'
		    }
		},
		"columnDefs": [{
	  		"targets": -1,
	        "data": null,
	        "defaultContent": '<button type="button" name="button-delete-connection" data-toggle="modal" data-target="#modal-delete-connection" data-placement="bottom" title="{% trans "Delete connection" %}" class="btn btn-danger"><i class="fa fa-times"></i></button>'
	  	},{
	      	"targets": -2,
	       	"data": null,
	        "defaultContent": '<button type="button" name="button-update-connection" data-toggle="tooltip" data-placement="bottom" title="{% trans "Edit connection" %}" class="btn btn-success"><i class="fa fa-edit"></i></button>'
	  	}],
	    "dom": 'T<"clear">lfrtip',
		"bLengthChange": false
	});
	
	$('#button-add-connection').click( function() {
		location.href = '{% url "connection_add" %}';
	});
		 
	$('#connections-table tbody').on('click', 'button', function (){
		var row = table.row($(this).parents('tr'));
	    var data = row.data();  
	    if (this.name == "button-update-connection") {
	        updateConnection(data);
	        
	    } else if (this.name == "button-delete-connection"){
	        deleteConnection(data, row);
	        
	    } else if (this.name == "button-options-connection"){
	        openConnectionConfig(data);
	    }
	});
	
	function updateConnection(data){			
		location.href = '{% url "connection_list" %}' + '../connection_update/' + data[0] + '/';
	}
	
	function openConnectionConfig(data){
		location.href = '{% url "connection_list" %}' + '../connection_config/' + data[0] + '/';
	}

	function deleteConnection(data, row){
		var connectionId = data[0];
		var connectionName = data[1];
		
		// Verificar si hay datastores asociados
		$.ajax({
			type: 'GET',
			url: '/gvsigonline/services/api/connection/' + connectionId + '/info/',
			success: function(response) {
				var datastoreCount = response.datastore_count || 0;
				var layerCount = response.layer_count || 0;
				
				if (datastoreCount > 0) {
					// Mostrar advertencia de eliminación en cascada
					$('#delete-connection-simple').hide();
					$('#delete-connection-cascade').show();
					$('#delete-cascade-message').text(
						'{% trans "This connection has" %} ' + datastoreCount + ' {% trans "datastore(s) and" %} ' + 
						layerCount + ' {% trans "layer(s) associated." %}'
					);
					$('#confirm-cascade-delete').prop('checked', false);
					$('#button-delete-connection-accept').prop('disabled', true);
				} else {
					// Eliminación simple
					$('#delete-connection-simple').show();
					$('#delete-connection-cascade').hide();
					$('#button-delete-connection-accept').prop('disabled', false);
				}
			},
			error: function() {
				// En caso de error, mostrar diálogo simple
				$('#delete-connection-simple').show();
				$('#delete-connection-cascade').hide();
				$('#button-delete-connection-accept').prop('disabled', false);
			}
		});
		
		// Habilitar/deshabilitar botón según checkbox
		$('#confirm-cascade-delete').off('change').on('change', function() {
			$('#button-delete-connection-accept').prop('disabled', !$(this).is(':checked'));
		});
		
		$('#button-delete-connection-accept').unbind('click').click( function() {
			var forceCascade = $('#delete-connection-cascade').is(':visible');
			
			$.ajax({
				type: 'POST',
				async: false,
				url: '{% url "connection_list" %}' + '../connection_delete/' + connectionId + '/',
				data: {
					'force_cascade': forceCascade ? 'true' : 'false'
				},
				beforeSend:function(xhr){
				    xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
				},
				success	:function(response){
					$('#modal-delete-connection').modal('hide');
					location.reload();
				},
				error: function(xhr, status, error){
					$('#modal-delete-connection').modal('hide');
					var errorMsg = '{% trans "Error deleting connection" %}';
					try {
						var resp = JSON.parse(xhr.responseText);
						if (resp.error) errorMsg = resp.error;
					} catch(e) {}
					alert(errorMsg);
				}
			});
		});
	}
	    
});
</script>
{% endblock %}
