{% extends "base.html" %}
{% load staticfiles %}
{% load i18n %}
{% load key %}

{% block content %}

{% if redirect_to_layergroup %}
<form role="form" method="post" action="/gvsigonline/services/layer_config/{{layer_id}}/?redirect=layergroup-redirect{% if layergroup_id %}&layergroup_id={{layergroup_id}}{% endif %}{% if project_id %}&project_id={{project_id}}{% endif %}{% if from_redirect %}&from_redirect={{from_redirect}}{% endif %}">
{% else %}
<form role="form" method="post" action="/gvsigonline/services/layer_config/{{layer_id}}/">
{% endif %}
<div class="row">
	<div class="col-md-12">
		<div class="row">
			<div class="col-md-12 form-group">
				<div class="box-tools pull-right">
					<a href="javascript:window.history.back();" class="btn btn-default btn-sm"><i class="fa fa-chevron-left margin-r-5"></i> {% trans "Back" %}</a>
					<button type="submit" class="btn btn-default btn-sm  save-button"><i class="fa fa-floppy-o margin-r-5"></i> {% trans "Save" %}</button>
				</div>
			</div>
		</div>
		<div class="">
					{% csrf_token %}
		
		<!-- Campos ocultos para reglas topológicas -->
		<input type="hidden" name="topology_no_overlap" id="topology_no_overlap_hidden" value="false">
		<input type="hidden" name="topology_no_gaps" id="topology_no_gaps_hidden" value="false">
		<input type="hidden" name="topology_must_be_covered_by" id="topology_must_be_covered_by_hidden" value="false">
		<input type="hidden" name="topology_covered_by_layer" id="topology_covered_by_layer_hidden" value="">
		<input type="hidden" name="topology_must_not_overlap_with" id="topology_must_not_overlap_with_hidden" value="false">
		<input type="hidden" name="topology_overlap_layers" id="topology_overlap_layers_hidden" value="">
		<input type="hidden" name="topology_must_be_contiguous" id="topology_must_be_contiguous_hidden" value="false">
		<input type="hidden" name="topology_contiguous_tolerance" id="topology_contiguous_tolerance_hidden" value="1.0">
		
		{% if form.errors %}
			<div id="form-error" style="color:#ff0000;">
				<ul>
				{% for field in form %}
					{% if field.errors %}
						<li>{{field.label}}. {{ field.errors|striptags }}</li>
					{% endif %}
				{% endfor %}
				</ul>
			</div>
			{% endif %}

			{% if message %}
			<div id="form-error" style="color:#ff0000;">
				<p>* {{ message }}</p>
			</div>
			{% endif %}
		</div>
		<ul class="nav nav-tabs">
			<li role="presentation" class="active"><a href="#tab-layer-config" data-toggle="tab">{% trans "Field management" %}</a></li>
			<li role="presentation"><a href="#tab-layer-field-trans" data-toggle="tab">{% trans "Field titles" %}</a></li>
			<li role="presentation" class="tab-li-layer-fieldgroups"><a href="#tab-layer-fieldgroups" data-toggle="tab">{% trans "Field groups" %}</a></li>
			<li role="presentation" class="tab-li-layer-fieldgroup-trans"><a href="#tab-layer-fieldgroup-trans" data-toggle="tab">{% trans "Group titles" %}</a></li>
			<li role="presentation"><a href="#tab-editing-restrictions" data-toggle="tab">{% trans "Editing restrictions" %}</a></li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane active" id="tab-layer-config">
				<div class="row">
					<div class="col-md-12">
						<div class="box">
							<div class="box-body">
								<div id="layer-fields" class="row">
									<div class="col-md-12">
										<div class="table-responsive">
											<table id="field-list-table" class="table no-margin">
												<thead>
													<tr>
														<th>{% trans "Field name" %}</th>
														<th>{% trans "Type" %}</th>
														<th>{% trans "Calculated" %}</th>
														<th>{% trans "Nullable" %}</th>
														<th>{% trans "mandatory" %}</th>
														<th>{% trans "Is visible?" %}</th>
														<th>{% trans "Is editable?" %}</th>
														<th>{% trans "Is shown in getFeatureInfo?" %}</th>
														<th>{% trans "Actions" %}</th>
													</tr>
												</thead>
												<tbody id="field-list-table-body">
													{% for f in fields %}
														{% with counter=forloop.counter %}
																<tr data-fieldname="{{f.name}}">
																	<td><input readonly name="field-name-{{counter}}" type="text" class="form-control" value="{{f.name}}"></td>
																	<td><input readonly name="field-type-{{counter}}" type="text" class="form-control" value="{% if f.gvsigol_type == 'link' %}link{% else %}{{f.type}}{% endif %}"></td>
																	<td><input readonly name="field-calculation-{{counter}}" type="text" class="form-control" value="{{f.calculationLabel}}"></td>
																	{% if f.nullable %}
																	<td><input title="{% trans 'Set at database level' %}" type="checkbox" data-counter="{{counter}}" name="field-nullable-{{counter}}" checked/></td>
																	{% else %}
																	<td><input title="{% trans 'Set at database level' %}" id="nullable-check-{{counter}}"  data-counter="{{counter}}" data-type="nullable" data-fieldname="{{f.name}}" type="checkbox" name="field-nullable-{{counter}}"/></td>
																	{% endif %}
																	{% if f.mandatory %}
																	<td><input title="{% trans 'Required in editing forms' %}" id="field-mandatory-{{counter}}" type="checkbox" name="field-mandatory-{{counter}}" {% if not f.nullable %}disabled{% endif %} checked /></td>
																	{% else %}
																	<td><input title="{% trans 'Required in editing forms' %}" id="field-mandatory-{{counter}}" data-type="mandatory" data-fieldname="{{f.name}}" type="checkbox" name="field-mandatory-{{counter}}"/></td>
																	{% endif %}
																	{% if f.visible %}
																	<td><input type="checkbox" name="field-visible-{{counter}}" checked/></td>
																	{% else %}
																	<td><input type="checkbox" name="field-visible-{{counter}}"/></td>
																	{% endif %}
																	{% if f.editable %}
																	<td><input type="checkbox" name="field-editable-{{counter}}" checked/></td>
																	{% else %}
																		{% if f.editableactive %}
																		<td><input type="checkbox" name="field-editable-{{counter}}"/></td>
																		{% else %}
																		<td><input type="checkbox" disabled name="field-editable-{{counter}}"/></td>
																		{% endif %}
																	{% endif %}
																	{% if f.infovisible %}
																	<td><input type="checkbox" name="field-infovisible-{{counter}}" checked/></td>
																	{% else %}
																	<td><input type="checkbox" name="field-infovisible-{{counter}}"/></td>
																	{% endif %}
																	<td>
																	{% if f.editableactive or f.calculationLabel %}
																		{% if counter > 3 %}
																		<div class="btn-group dropup">
																		{% else %}
																		<div class="btn-group">
																		{% endif %}
																			{% if is_view %}
																			<button type="button" class="btn btn-box-tool dropdown-toggle" title="{% trans 'SQL views can\'t be edited.' %}" disabled>
																				<i class="fa fa-wrench"></i>
																			</button>
																			{% else %}
																			<button type="button" class="btn btn-box-tool dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
																				<i class="fa fa-wrench"></i>
																			</button>
																			<ul class="dropdown-menu dropdown-menu-right" role="menu">
																				<li><a href="#" class="actions-menu-entry rename-field"><i class="fa fa-edit" style="color: #3c8dbc;"></i> {% trans "Rename" %}</a></li>
																				<!--  <li><a href="#" class="actions-menu-entry change-field-type"><i class="fa fa-tag" style="color: #3c8dbc;"></i> {% trans "Change type" %}</a></li> -->
																				{% if f.type == 'integer' or f.type == 'bigint' or f.type == 'smallint' or f.type == 'bigserial' or f.type == 'serial' or f.type == 'smallserial' or f.type == 'double precision' or f.type == 'float' or f.type == 'real' or f.type == 'decimal' or f.type == 'double' or f.type == 'numeric' %}
																				{% if f.name != 'ogc_fid' %}
																				<li><a href="#" class="actions-menu-entry format-field"><i class="fa fa-cog" style="color: #3c8dbc;"></i> {% trans "Format field" %}</a></li>
																				{% endif %}
																				{% endif %}
																				{% if not f.calculationLabel %}
																				<li id="li-convert-to-enumerate"><a href="#" class="actions-menu-entry convert-to-enumerate"><i class="fa fa-list-alt" style="color: #3c8dbc;"></i> {% trans "Convert to enumerate" %}</a></li>
																				{% endif %}
																				<li><a href="#" class="actions-menu-entry delete-field"><i class="fa fa-times" style="color: #f56954;"></i> {% trans "Delete field" %}</a></li>
																			</ul>
																			{% endif %}
																		</div>
																	{% else %}
																		<button type="button" class="btn btn-box-tool dropdown-toggle" data-toggle="dropdown" disabled aria-expanded="false" title="{% trans "Reserved field" %}">
																			<i class="fa fa-wrench"></i>
																		</button>
																	{% endif %}
																	</td>
																</tr>
																{% if forloop.last %}
																<input type="hidden" name="counter" value="{{counter}}" />
																{% endif %}
														{% endwith %}
													{% endfor %}
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
							<div class="box-footer clearfix">
								{% if is_view %}
								<button type="button" class="btn btn-box-tool pull-left margin-r-5" title="{% trans 'SQL views can\'t be edited.' %}" disabled>
									<i class="fa fa-plus margin-r-5"></i>{% trans "Add field" %}
								</button>
								{% else %}
								<a id="add-field-button" href="javascript:void(0)" class="btn btn-box-tool pull-left margin-r-5">
									<i class="fa fa-plus margin-r-5"></i>{% trans "Add field" %}
								</a>
								{% endif %}
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="tab-pane" id="tab-layer-field-trans">
				<div class="row">
					<div class="col-md-12">
						<div class="box">
							<div class="box-body">
								<div class="row">
									<div class="col-md-12">
										<div class="table-responsive">
											<table id="field-list-table" class="table no-margin">
												<thead>
													<tr>
														<th>{% trans "Field name" %}</th>
														{% for id, language in available_languages %}
														<th>{% trans "Field title" %}&nbsp;({{ language }})</th>
														{% endfor %}
													</tr>
												</thead>
												<tbody id="field-list-table-body">
													{% for f in fields %}
														{% with counter=forloop.counter %}
																<tr>
																	<td><input readonly name="field-name-{{counter}}" type="text" class="form-control field-name" value="{{f.name}}"></td>
																	{% for id, language in available_languages %}
																	<td><input name="field-title-{{id}}-{{counter}}" type="text" class="form-control" placeHolder="{{f.name}}" value=""></td>
																	{% endfor %}
																</tr>
																{% if forloop.last %}
																<input type="hidden" name="counter" value="{{counter}}" />
															{% endif %}
														{% endwith %}
													{% endfor %}
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="tab-pane" id="tab-layer-fieldgroups">
				<div class="row">
					<div class="col-md-12">
						<div class="box">
							<div class="box-body">
								<div id="field-groups-order">
									{% for g in form_groups %}
									{% with counter=forloop.counter %}
									<div class="box box-default collapsed-box sortable-fieldgroup" data-groupid="{{counter}}" style="border-top: none;">
										<div class="box-header">
											<div class="handle form-inline">
												<span class="" style="margin-right: 20px;">
													<i class="fa fa-ellipsis-v"></i>
													<i class="fa fa-ellipsis-v"></i>
												</span>
												<input type="text" class="form-control" value="{{g.name}}">
												&nbsp;<span class="text-danger group-name-error"></span>
											</div>
											<div class="box-tools box-tools-buttons pull-right">
												<button type="button" class="button-delete-group" name="button-delete-group" title="{% trans 'Delete group' %}" class="btn btn-danger"><i class="fa fa-times"></i></button>
											</div>
										</div>
									</div>
									{% for f in g.fields %}
									<div data-name="{{f}}"  class="box box-default collapsed-box sortable-fieldgroup-field" style="padding-left: 45px; border-top: none;">
										<div class="box-header">
											<div class="handle">
												<span class="" style="margin-right: 20px;">
													<i class="fa fa-ellipsis-v"></i>
													<i class="fa fa-ellipsis-v"></i>
												</span>
												<span class="text">{{f}}</span>
											</div>
										</div>
									</div>
									{% endfor %}
									{% if forloop.last %}
									<input class="hide" id="fieldgroup-total-counter" value="{{counter}}" type="text">
									{% endif %}
									{% endwith %}
									{% endfor %}
								</div>
							</div>
							<div class="box-footer clearfix">
								<a id="add-field-group-button" href="javascript:void(0)" class="btn btn-box-tool pull-left margin-r-5">
									<i class="fa fa-plus margin-r-5"></i>{% trans "Add field group" %}
								</a>
								<input class="hide form-control" id="form_groups" name="form_groups" type="text" />
							</div>

						</div>
					</div>
				</div>
			</div>
			<div class="tab-pane" id="tab-layer-fieldgroup-trans">
				<div class="row">
					<div class="col-md-12">
						<div class="box">
							<div class="box-body">
								<div class="row">
									<div class="col-md-12">
										<div class="table-responsive">
											<table id="fieldgroup-trans-table" class="table no-margin">
												<thead>
													<tr>
														<th>{% trans "Group name" %}</th>
														{% for id, language in available_languages %}
														<th>{% trans "Group title" %}&nbsp;({{ language }})</th>
														{% endfor %}
													</tr>
												</thead>
												<tbody id="fieldgroup-trans-table-body">
													{% for g in form_groups %}
														{% with counter=forloop.counter %}
															<tr class="fieldgroup-trans-row" data-groupid="{{counter}}">
																<td><input readonly name="fieldgroup-name-{{counter}}" type="text" class="form-control" value="{{g.name}}"></td>
																{% for id, language in available_languages %}
																{% with thelangtitleid="title-"|add:id %}
																<td><input name="fieldgroup-title-{{id}}-{{counter}}" type="text" data-langid="{{id}}" data-title="{{thelangtitleid}}" class="form-control fieldgroup-trans" placeHolder="{{g.name}}" value="{{g|key:thelangtitleid}}"></td>
																{% endwith %}
																{% endfor %}
															</tr>
														{% endwith %}
													{% endfor %}
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="tab-pane" id="tab-editing-restrictions">
				<div class="row">
					<div class="col-md-12">
						<div class="box">
							<div class="box-header with-border">
								<h3 class="box-title">{% trans "Topological rules" %}</h3>
							</div>
							<div class="box-body">
								<div class="row">
									<div class="col-md-12">
										<div class="table-responsive">
											<table id="topology-rules-table" class="table no-margin">
												<thead>
													<tr>
														<th width="18%">{% trans "Rule" %}</th>
														<th width="25%">{% trans "Description" %}</th>
														<th width="20%">{% trans "Geometry Limitations" %}</th>
														<th width="8%">{% trans "Active" %}</th>
														<th width="29%">{% trans "Configuration" %}</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td>{% trans "Must not overlap" %}</td>
														<td class="rule-description">
															<small class="text-muted">{% trans "Geometries within the same layer cannot overlap with each other" %}</small>
														</td>
														<td class="geometry-limitations">
															<small class="text-success">
																<i class="fa fa-check"></i> {% trans "Compatible with all geometry types" %}
															</small>
														</td>
														<td>
															<input type="checkbox" name="no_overlap" id="no_overlap" value="1">
														</td>
														<td>
															<span class="text-muted">{% trans "No additional configuration required" %}</span>
														</td>
													</tr>
													<tr>
														<td>{% trans "Must not have gaps" %}</td>
														<td class="rule-description">
															<small class="text-muted">{% trans "The layer coverage must be continuous without empty spaces between geometries" %}</small>
														</td>
														<td class="geometry-limitations">
															<small class="text-success">
																<i class="fa fa-check"></i> {% trans "Polygons" %}: {% trans "Recommended" %}<br>
															</small>
															<small class="text-warning">
																<i class="fa fa-exclamation-triangle"></i> {% trans "Lines" %}: {% trans "Limited use" %}<br>
															</small>
															<small class="text-danger">
																<i class="fa fa-times"></i> {% trans "Points" %}: {% trans "Not applicable" %}
															</small>
														</td>
														<td>
															<input type="checkbox" name="no_gaps" id="no_gaps" value="1">
														</td>
														<td>
															<span class="text-muted">{% trans "No additional configuration required" %}</span>
														</td>
													</tr>
													<tr>
														<td>{% trans "Must be covered by" %}</td>
														<td class="rule-description">
															<small class="text-muted">{% trans "All geometries must be completely covered by geometries from another layer" %}</small>
														</td>
														<td class="geometry-limitations">
															<small class="text-success">
																<i class="fa fa-check"></i> {% trans "Compatible with all geometry types" %}
															</small>
														</td>
														<td>
															<input type="checkbox" name="must_be_covered_by" id="must_be_covered_by" value="1">
														</td>
														<td>
															<div id="covered_by_layer_group" class="topology-control-group">
																<select class="form-control" name="covered_by_layer" id="covered_by_layer">
																	<option value="">{% trans "Select a layer" %}</option>
																	<!-- Las capas se cargarán dinámicamente vía AJAX -->
																</select>
															</div>
														</td>
													</tr>
													<tr>
														<td>{% trans "Must not overlap with" %}</td>
														<td class="rule-description">
															<small class="text-muted">{% trans "Geometries cannot overlap with geometries from specified layers" %}</small>
														</td>
														<td class="geometry-limitations">
															<small class="text-success">
																<i class="fa fa-check"></i> {% trans "Compatible with all geometry types" %}
															</small>
														</td>
														<td>
															<input type="checkbox" name="must_not_overlap_with" id="must_not_overlap_with" value="1">
														</td>
														<td>
															<div id="overlap_layers_group" class="topology-control-group">
																<select class="form-control" name="overlap_layers" id="overlap_layers" multiple>
																	<!-- Las capas se cargarán dinámicamente vía AJAX -->
																</select>
																<small class="form-text text-muted">{% trans "Select multiple layers" %}</small>
															</div>
														</td>
													</tr>
													<tr>
														<td>{% trans "Must be contiguous" %}</td>
														<td class="rule-description">
															<small class="text-muted">{% trans "Geometries must be connected." %}</small>
														</td>
														<td class="geometry-limitations">
															<small class="text-success">
																<i class="fa fa-check"></i> {% trans "Polygons" %}: {% trans "Recommended" %}<br>
															</small>
															<small class="text-warning">
																<i class="fa fa-exclamation-triangle"></i> {% trans "Lines" %}: {% trans "Suitable for networks" %}<br>
															</small>
															<small class="text-danger">
																<i class="fa fa-times"></i> {% trans "Points" %}: {% trans "Not applicable" %}
															</small>
														</td>
														<td>
															<input type="checkbox" name="must_be_contiguous" id="must_be_contiguous" value="1">
														</td>
														<td>
															<div id="tolerance_group" class="topology-control-group">
																<div class="input-group" style="max-width: 200px;">
																	<input type="number" class="form-control" name="contiguous_tolerance" id="contiguous_tolerance" value="1" step="1" min="0" placeholder="{% trans 'Tolerance' %}">
																	<div class="input-group-addon">m</div>
																</div>
																<small class="form-text text-muted">{% trans "Tolerance distance for contiguity check" %}</small>
															</div>
														</td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</form>

<div class="modal fade" id="my-modal-dialog" tabindex="-1" role="dialog" aria-labelledby="modalTitle">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 id="modalTitle" class="modal-title"></h4>
			</div>
			<div class="modal-body">
			</div>
			<div class="modal-footer">
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block extra-scripts %}
<script type="text/javascript" src="{% static "js/gvsigollibs/layers/newFieldUi.js" %}"></script>
<style>
/* Estilos para la pestaña de restricciones de edición */
#topology-rules-table {
	margin-bottom: 0;
}

#topology-rules-table tbody tr td:first-child {
	font-weight: 500;
	vertical-align: middle;
}

#topology-rules-table tbody tr td:nth-child(2) {
	vertical-align: middle;
	padding-right: 15px;
}

#topology-rules-table tbody tr td:nth-child(3) {
	vertical-align: middle;
	padding-right: 10px;
	line-height: 1.3;
}

#topology-rules-table tbody tr td:nth-child(4) {
	text-align: left;
	vertical-align: middle;
	width: 60px;
	padding-left: 15px;
}

#topology-rules-table tbody tr td:nth-child(5) {
	vertical-align: middle;
}

.geometry-limitations {
	font-size: 11px;
	line-height: 1.4;
}

.geometry-limitations .text-success {
	color: #5cb85c !important;
}

.geometry-limitations .text-warning {
	color: #f0ad4e !important;
}

.geometry-limitations .text-danger {
	color: #d9534f !important;
}

.topology-control-group {
	margin-top: 5px;
}

.topology-control-group.hidden {
	display: none;
}

.rule-description {
	vertical-align: middle !important;
	padding-right: 10px;
}

.rule-description small {
	line-height: 1.3;
	color: #666;
}

#topology-rules-table .select2-container {
	width: 100% !important;
}

#topology-rules-table input[type="checkbox"] {
	transform: scale(1.3);
	margin: 0;
}

#tolerance_group .input-group {
	max-width: 200px;
}

#topology-rules-table .form-text {
	margin-top: 5px;
	font-size: 12px;
}

/* Espaciado mejorado para la tabla */
#topology-rules-table tbody tr {
	border-bottom: 1px solid #f4f4f4;
}

#topology-rules-table tbody tr:last-child {
	border-bottom: none;
}

/* Estilo para botón deshabilitado */
.save-button.disabled {
	opacity: 0.6;
	cursor: not-allowed !important;
}

/* Estilos para el modal de dar formato a campos */
#symbol {
	max-width: 100px;
}

#symbol-position {
	max-width: 200px;
}

#symbol-position:disabled {
	background-color: #f5f5f5;
	color: #999;
	cursor: not-allowed;
	opacity: 0.6;
}

#decimal-places {
	max-width: 200px;
}

#decrease-decimals, #increase-decimals {
	min-width: 40px;
	height: 34px;
	border: 1px solid #ccc;
}

#decrease-decimals:hover, #increase-decimals:hover {
	background-color: #e6e6e6;
	border-color: #adadad;
}

#decrease-decimals:active, #increase-decimals:active {
	background-color: #d4d4d4;
	border-color: #8c8c8c;
}

#decimal-places {
	text-align: center;
	font-weight: bold;
	background-color: #f9f9f9;
}

#thousands-separator {
	margin-right: 8px;
}

.checkbox label {
	font-weight: normal;
	cursor: pointer;
}

.checkbox input[type="checkbox"] {
	margin-top: 2px;
}

#decimal-separator {
	max-width: 100%;
}

#decimal-separator:disabled {
	background-color: #f5f5f5;
	color: #999;
	cursor: not-allowed;
	opacity: 0.6;
}

#thousands-separator {
	max-width: 45%;
}

.decimal-row .col-md-6:first-child {
	padding-right: 10px;
}

.decimal-row .col-md-6:last-child {
	padding-left: 10px;
}

.decimal-row label {
	margin-bottom: 8px;
	display: block;
}

.decimal-row .form-control {
	margin-bottom: 5px;
}

.decimal-row .input-group {
	display: flex;
	align-items: stretch;
	width: 100%;
	max-width: 180px;
	position: relative;
}

.decimal-row .input-group-btn {
	display: flex;
	flex-shrink: 0;
	position: relative;
	z-index: 2;
}

.decimal-row .input-group-btn button {
	height: 34px;
	width: 40px;
	display: flex;
	align-items: center;
	justify-content: center;
	border: 1px solid #ccc;
	position: relative;
	z-index: 3;
}

.decimal-row .input-group input {
	flex: 1;
	text-align: center;
	border-radius: 0;
	position: relative;
	z-index: 1;
	min-width: 60px;
}

/* Asegurar que el botón izquierdo esté visible */
.decimal-row .input-group-btn:first-child {
	margin-right: -1px;
}

.decimal-row .input-group-btn:last-child {
	margin-left: -1px;
}

.symbol-row .col-md-6:first-child {
	padding-right: 10px;
}

.symbol-row .col-md-6:last-child {
	padding-left: 10px;
}

.symbol-row label {
	margin-bottom: 8px;
	display: block;
}

.symbol-row .form-control {
	margin-bottom: 5px;
}

.bg-info {
	background-color: #d9edf7 !important;
	border: 1px solid #bce8f1;
	border-radius: 4px;
}

.form-text {
	font-size: 12px;
	color: #666;
	margin-top: 5px;
}
</style>
<script type="text/javascript">

	$('#menu-manage-services').addClass("active");
	$('#submenu-layers').addClass("active");

	$(document).ready(function() {
		$('.save-button').click( function() {
			$("body").overlay();
		});

		var fields = {{ fields_json|safe }};
		var available_languages = {{ available_languages_array|safe }};

		for(var i=0; i<fields.length; i++){
			var field = fields[i];
			for(var j=0; j<available_languages.length; j++){
				var lang = available_languages[j];
				$("input[name=\"field-title-"+lang+"-"+(i+1)+"\"]").val(field["title-"+lang]);

			}
		}
	});

	$('input[type="checkbox"]'). click(function(evt){
		if (evt.target.id.startsWith('nullable-check')){
			if(!$(this).is(":checked")) {
				var obj = document.getElementById(evt.target.id);
				var field_name = obj.getAttribute('data-fieldname');
				var counter = obj.getAttribute('data-counter');
				data = {
					"layer_id" : "{{layer_id}}",
					"field_name": field_name,
				}
				$.ajax({
					type: 'POST',
					async: false,
					data: data,
					url: '/gvsigonline/services/nullable_check/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success	:function(response) {
						document.getElementById("field-mandatory-"+counter).disabled = true;
						document.getElementById("field-mandatory-"+counter).checked = true;
					},
					error: function() {
						obj.checked = true;
						document.getElementById("field-mandatory-"+counter).disabled = false;
						messageBox.show('error', gettext('The field can not be set as mandatory at database level because some records contain NULL values in this column. Delete the NULL values and try again.'));
					}
				});
			}
			else {
				var obj = document.getElementById(evt.target.id);
				var counter = obj.getAttribute('data-counter');
				document.getElementById("field-mandatory-"+counter).disabled = false;
			}
		}
		else if (evt.target.name.startsWith('field-nullable-')){
			var obj = evt.target;
			var counter = obj.getAttribute('data-counter');
			if(!$(this).is(":checked")) {
				document.getElementById("field-mandatory-"+counter).disabled = true;
				document.getElementById("field-mandatory-"+counter).checked = true;
			}
			else {
				document.getElementById("field-mandatory-"+counter).disabled = false;
			}
		}
	});

	$('.convert-to-enumerate').on('click', function (evt){
		var fieldName = $(this).closest('tr')[0].getAttribute('data-fieldname');
		converToEnumModal(fieldName);
	});
	$('.delete-field').on('click', function (evt){
		var fieldName = $(this).closest('tr')[0].getAttribute('data-fieldname');
		deleteFieldModal(fieldName);
	});
	$('.change-field-type').on('click', function (evt){
		var fieldName = $(this).closest('tr')[0].getAttribute('data-fieldname');
		//deleteFieldModal(fieldName);
	});
	$('.rename-field').on('click', function (evt){
		var fieldName = $(this).closest('tr')[0].getAttribute('data-fieldname');
		renameFieldModal(fieldName);
	});
	$('.format-field').on('click', function (evt){
		var fieldName = $(this).closest('tr')[0].getAttribute('data-fieldname');
		formatFieldModal(fieldName);
	});

	function converToEnumModal(fieldName){
		$('#my-modal-dialog .modal-body').empty();
		$('#my-modal-dialog .modal-title').text(gettext("Convert to enum"));

		var ui = '';
		ui += '<div id="div-name" class="row">';

		ui += '<div class="col-md-12 form-group">';
		ui += 	'<label>' + gettext('Select enumeration') + '</label>';
		ui += 	'<select id="enumeration-list" class="form-control">';
				'{% for enum in enumerations %}'
					ui += '<option value="{{enum.id}}">{{enum.title}}</option>';
				'{% endfor%}'
		ui += 	'</select>';
		ui += '</div>';

		ui += '</div>';
		$('#my-modal-dialog .modal-body').append(ui);
		var buttons = '';
		buttons += '<button id="enum-convert-cancel" type="button" class="btn btn-default" data-dismiss="modal">' + gettext('Cancel') + '</button>';
		buttons += '<button id="convert" type="button" class="btn btn-default">' + gettext('Convert') + '</button>';
		buttons += '<button id="autogen" type="button" class="btn btn-default">' + gettext('Autogen') + '</button>';
		$('#my-modal-dialog .modal-footer').empty();
		$('#my-modal-dialog .modal-footer').append(buttons);

		$('#convert').on('click', function () {
			$.ajax({
				type: 'POST',
				async: false,
				url: '/gvsigonline/services/convert_to_enumerate/',
				beforeSend:function(xhr){
					xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
				},
			  	data:{
			  		'field': fieldName,
			  		'enum_id': $('#enumeration-list').val(),
			  		'layer_id': "{{layer_id}}",
			  		'layer_name': "{{layer}}",
			  		'autogen': 'False'
			  	},
				success	:function(response) {
					messageBox.show('Info', gettext('Convert ok'));
					$('#my-modal-dialog').modal('hide');
				},
				error: function() {
					messageBox.show('error', files.responseText);
					$('#my-modal-dialog').modal('hide');
				}
			});
		});

		$('#autogen').on('click', function () {
			$.ajax({
				type: 'POST',
				async: false,
				url: '/gvsigonline/services/convert_to_enumerate/',
				beforeSend:function(xhr){
					xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
				},
			  	data:{
			  		'field': fieldName,
			  		'enum_id': $('#enumeration-list').val(),
			  		'layer_id': "{{layer_id}}",
			  		'layer_name': "{{layer}}",
			  		'autogen': 'True'
			  	},
				success	:function(response) {
					messageBox.show('Info', gettext('Autogen ok'));
					$('#my-modal-dialog').modal('hide');
				},
				error: function(jqXHR, status, errMsg) {
					messageBox.show('error', jqXHR.responseText);
					$('#my-modal-dialog').modal('hide');
				}
			});
		});

		$('#my-modal-dialog').modal('show');
	}

	function deleteFieldModal(fieldName){
		$('#my-modal-dialog .modal-body').empty();
		$('#my-modal-dialog .modal-title').text(gettext("Delete field"));
		var ui = '';
		ui += '<div id="div-name" class="row">';
		ui += '<div class="col-md-12 form-group">';
		ui += '<div class="bg-warning" style="padding: 10px; margin-bottom: 5px">';
		ui += gettext("Warning: the field will be deleted from the database. This operation cannot be undone. Type the name of the field to confirm the deletion:");
		ui += '<code>' + fieldName + '</code>';
		ui += '</div>';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += 	'<label for="deleted-field-name">' + gettext('Field to delete') + '</label>';
		ui += 	'<input placeholder="' + gettext('Field name') + '" name="deleted-field-name" id="deleted-field-name" type="text" class="form-control">';
		ui += '</div>';
		ui += '</div>';
		$('#my-modal-dialog .modal-body').append(ui);
		var buttons = '';
		buttons += '<button id="cancel-delete" type="button" class="btn btn-default" data-dismiss="modal">' + gettext('Cancel') + '</button>';
		buttons += '<button id="confirm-delete" type="button" class="btn btn-warning" disabled>' + gettext('Delete') + '</button>';
		$('#my-modal-dialog .modal-footer').empty();
		$('#my-modal-dialog .modal-footer').append(buttons);
		$('#deleted-field-name').change(function(evt) {
			if ($(this).val() == fieldName) {
				document.getElementById('confirm-delete').disabled = false;
			}
			else {
				document.getElementById('confirm-delete').disabled = true;
			}
		});
		$('#deleted-field-name').keyup(function(evt) {
			if ($(this).val() == fieldName) {
				document.getElementById('confirm-delete').disabled = false;
			}
			else {
				document.getElementById('confirm-delete').disabled = true;
			}
		});

		$('#confirm-delete').on('click', function () {
			$.ajax({
				type: 'POST',
				async: false,
				url: '/gvsigonline/services/db_field_delete/',
				beforeSend:function(xhr){
					xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
				},
			  	data:{
			  		'field': fieldName,
			  		'layer_id': "{{layer_id}}"
			  	},
				success	:function(response) {
					$('#my-modal-dialog').modal('hide');
					messageBox.show('Info', gettext('Field was deleted'));
					$('tr[data-fieldname="' + fieldName + '"]').remove();
					$('.sortable-fieldgroup-field').filter(function(){
						return $(this).find('span.text').text()==fieldName
					}).remove();
					$('#field-list-table-body tr').filter(function(){
						return $(this).find('input.field-name').text()==fieldName
					}).remove();
				},
				error: function(jqXHR) {
					messageBox.show('error', jqXHR.responseText);
					$('#my-modal-dialog').modal('hide');
				}
			});
		});
		$('#my-modal-dialog').modal('show');
	}

	function renameFieldModal(fieldName){
		$('#my-modal-dialog .modal-body').empty();
		$('#my-modal-dialog .modal-title').text(gettext("Rename field"));
		var ui = '';
		ui += '<div id="div-name" class="row">';
		ui += '<div id="field-errors" class="col-md-12 form-group">';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += '<div class="bg-warning" style="padding: 10px; margin-bottom: 5px">';
		ui += gettext("Warning: renaming a field may have side effects, such as breaking a field-based legend.");
		ui += '</div>';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += 	'<label for="old-field-name">' + gettext('Old name') + '</label>';
		ui += 	'<input name="old-field-name" id="old-field-name" type="text" class="form-control" value="' + fieldName + '" disabled>';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += 	'<label for="new-field-name">' + gettext('New name') + '</label>';
		ui += 	'<input placeholder="' + gettext('Field name') + '" name="new-field-name" id="new-field-name" type="text" class="form-control">';
		ui += '</div>';
		ui += '</div>';
		$('#my-modal-dialog .modal-body').append(ui);
		var buttons = '';
		buttons += '<button id="cancel-rename" type="button" class="btn btn-default" data-dismiss="modal">' + gettext('Cancel') + '</button>';
		buttons += '<button id="confirm-rename" type="button" class="btn btn-warning">' + gettext('Rename') + '</button>';
		$('#my-modal-dialog .modal-footer').empty();
		$('#my-modal-dialog .modal-footer').append(buttons);

		$('#confirm-rename').on('click', function () {
			var new_name = document.getElementById('new-field-name').value;
			if (validateRegex(new_name)) {
				$.ajax({
					type: 'POST',
					async: false,
					url: '/gvsigonline/services/db_field_rename/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
				  	data:{
				  		'field': fieldName,
				  		'new_field_name': new_name,
				  		'layer_id': "{{layer_id}}"
				  	},
					success	:function(response) {
						$('#my-modal-dialog').modal('hide');
						messageBox.show('Info', gettext('Field was renamed'));
						$('tr[data-fieldname="' + fieldName + '"] input')[0].value = new_name;
						$('tr[data-fieldname="' + fieldName + '"]')[0].setAttribute('data-fieldname', new_name);
						$('.sortable-fieldgroup-field span.text').filter(function(){
							return $(this).text()==fieldName
						}).text(new_name);
						$('#field-list-table-body input.field-name').filter(function(){
							return $(this).val()==fieldName
						}).val(new_name);
					},
					error: function(jqXHR) {
						messageBox.show('error', jqXHR.responseText);
						$('#my-modal-dialog').modal('hide');
					}
				});
			} else {
				var error = '<p class="text-muted" style="color: #ff0000; padding: 10px;">* ' + gettext('Invalid name: Identifiers must begin with a letter or an underscore (_). Subsequent characters can be letters, underscores or numbers') + '.</p>';
				$('#field-errors').empty();
				$('#field-errors').append(error);
			}
		});
		$('#my-modal-dialog').modal('show');
	}

	function formatFieldModal(fieldName){
		$('#my-modal-dialog .modal-body').empty();
		$('#my-modal-dialog .modal-title').text(gettext("Format field"));

		$.ajax({
			type: 'GET',
			async: false,
			url: '/gvsigonline/services/get_field_format/',
			data: {
				'field': fieldName,
				'layer_id': "{{layer_id}}"
			},
			beforeSend: function(xhr){
				xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
			},
			success: function(response) {
				var data = response;
				if (typeof response === 'string') {
					data = JSON.parse(response);
				}
				
				var existingFormat = data.field_format || {};
				var hasFormat = data.has_format || false;
				
				buildFormatModal(fieldName, existingFormat, hasFormat);
			},
			error: function(jqXHR) {
				console.error('Error loading field format:', jqXHR);
				// Build modal with default values
				buildFormatModal(fieldName, {}, false);
			}
		});
	}
	function buildFormatModal(fieldName, existingFormat, hasFormat) {
		var ui = '';
		ui += '<div id="div-name" class="row">';
		ui += '<div id="field-errors" class="col-md-12 form-group">';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += '<div class="bg-info" style="padding: 10px; margin-bottom: 5px">';
		ui += gettext("Configure the display format for numeric fields will affect how values are shown in forms and reports.");
		ui += '</div>';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += 	'<label for="field-name">' + gettext('Field name') + '</label>';
		ui += 	'<input name="field-name" id="field-name" type="text" class="form-control" value="' + fieldName + '" disabled>';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += 	'<div class="row symbol-row">';
		ui += 		'<div class="col-md-6">';
		ui += 			'<label for="symbol">' + gettext('Symbol') + '</label>';
		ui += 			'<input placeholder="' + gettext('e.g., €, $, m, kg, °') + '" name="symbol" id="symbol" type="text" class="form-control" maxlength="5" value="' + (existingFormat.symbol || '') + '">';
		ui += 		'</div>';
		ui += 		'<div class="col-md-6">';
		ui += 			'<label for="symbol-position">' + gettext('Symbol position') + '</label>';
		ui += 			'<select name="symbol-position" id="symbol-position" class="form-control">';
		ui += 				'<option value="after"' + (existingFormat.symbol_position === 'after' || !existingFormat.symbol_position ? ' selected' : '') + '>' + gettext('After number') + '</option>';
		ui += 				'<option value="before"' + (existingFormat.symbol_position === 'before' ? ' selected' : '') + '>' + gettext('Before number') + '</option>';		
		ui += 			'</select>';
		ui += 		'</div>';
		ui += 	'</div>';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += 	'<div class="row decimal-row">';
		ui += 		'<div class="col-md-6">';
		ui += 			'<label for="decimal-places">' + gettext('Decimal places') + '</label>';
		ui += 			'<div class="input-group" style="max-width: 180px;">';
		ui += 				'<span class="input-group-btn">';
		ui += 					'<button type="button" class="btn btn-default" id="decrease-decimals" style="border-radius: 4px 0 0 4px;">';
		ui += 						'<i class="fa fa-minus"></i>';
		ui += 				'</button>';
		ui += 			'</span>';
		ui += 				'<input type="number" name="decimal-places" id="decimal-places" class="form-control" value="' + (existingFormat.decimal_places || 2) + '" min="0" max="4" readonly style="text-align: center; border-radius: 0;">';
		ui += 				'<span class="input-group-btn">';
		ui += 					'<button type="button" class="btn btn-default" id="increase-decimals" style="border-radius: 0 4px 4px 0;">';
		ui += 					'<i class="fa fa-plus"></i>';
		ui += 					'</button>';
		ui += 				'</span>';
		ui += 			'</div>';
		ui += 		'</div>';
		ui += 		'<div class="col-md-6">';
		ui += 			'<label for="decimal-separator">' + gettext('Decimal separator') + '</label>';
		ui += 			'<select name="decimal-separator" id="decimal-separator" class="form-control">';
		ui += 				'<option value=","' + (existingFormat.decimal_separator === ',' || !existingFormat.decimal_separator ? ' selected' : '') + '>' + gettext('Comma (,)') + '</option>';	
		ui += 				'<option value="."' + (existingFormat.decimal_separator === '.' ? ' selected' : '') + '>' + gettext('Point (.)') + '</option>';		
		ui += 			'</select>';
		ui += 		'</div>';
		ui += 	'</div>';
		ui += '</div>';
		ui += '<div class="col-md-12 form-group">';
		ui += 	'<label for="thousands-separator">' + gettext('Thousands separator') + '</label>';
		ui += 	'<select name="thousands-separator" id="thousands-separator" class="form-control">';
		ui += 		'<option value=""' + (!existingFormat.thousands_separator ? ' selected' : '') + '>' + gettext('No separator') + '</option>';
		ui += 		'<option value=","' + (existingFormat.thousands_separator === ',' ? ' selected' : '') + '>' + gettext('Comma (,)') + '</option>';
		ui += 		'<option value="."' + (existingFormat.thousands_separator === '.' ? ' selected' : '') + '>' + gettext('Point (.)') + '</option>';
		ui += 	'</select>';
		ui += '</div>';
		$('#my-modal-dialog .modal-body').append(ui);
		
		var buttons = '';
		buttons += '<button id="cancel-format" type="button" class="btn btn-default" data-dismiss="modal">' + gettext('Cancel') + '</button>';
		
		if (hasFormat) {
			buttons += '<button id="delete-format" type="button" class="btn btn-warning" style="float: left;">' + gettext('Delete Format') + '</button>';
		}
		
		buttons += '<button id="confirm-format" type="button" class="btn btn-primary">' + gettext('Save') + '</button>';
		$('#my-modal-dialog .modal-footer').empty();
		$('#my-modal-dialog .modal-footer').append(buttons);

		$('#decrease-decimals').on('click', function() {
			var currentValue = parseInt($('#decimal-places').val());
			if (currentValue > 0) {
				$('#decimal-places').val(currentValue - 1);
				toggleDecimalSeparator(); 
			}
		});

		$('#increase-decimals').on('click', function() {
			var currentValue = parseInt($('#decimal-places').val());
			if (currentValue < 4) {
				$('#decimal-places').val(currentValue + 1);
				toggleDecimalSeparator(); 
			}
		});

		function toggleSymbolPosition() {
			var symbol = $('#symbol').val().trim();
			var symbolPosition = $('#symbol-position');
			
			if (symbol === '') {
				symbolPosition.prop('disabled', true);
				symbolPosition.val('after'); 
			} else {
				symbolPosition.prop('disabled', false);
			}
		}

		function toggleDecimalSeparator() {
			var decimalPlaces = parseInt($('#decimal-places').val());
			var decimalSeparator = $('#decimal-separator');
			
			if (decimalPlaces === 0) {
				decimalSeparator.prop('disabled', true);
				decimalSeparator.val(','); 
			} else {
				decimalSeparator.prop('disabled', false);
			}
		}

		$('#symbol').on('input change', function() {
			toggleSymbolPosition();
		});


		// Inicializar el estado al abrir el modal
		toggleSymbolPosition();
		toggleDecimalSeparator();

		$('#confirm-format').on('click', function () {
			var symbol = document.getElementById('symbol').value;
			var symbolPosition = document.getElementById('symbol-position').value;
			var decimalPlaces = document.getElementById('decimal-places').value;
			var thousandsSeparator = document.getElementById('thousands-separator').value;
			var decimalSeparator = document.getElementById('decimal-separator').value;
			
			$.ajax({
				type: 'POST',
				async: false,
				url: '/gvsigonline/services/db_save_field_format/',
				beforeSend:function(xhr){
					xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
				},
				data:{
					'field': fieldName,
					'symbol': symbol,
					'symbol_position': symbolPosition,
					'decimal_places': decimalPlaces,
					'thousands_separator': thousandsSeparator,
					'decimal_separator': decimalSeparator,
					'layer_id': "{{layer_id}}"
				},
				success	:function(response) {
					$('#my-modal-dialog').modal('hide');
					messageBox.show('Info', gettext('Field format was saved successfully'));
				},
				error: function(jqXHR) {
					messageBox.show('error', jqXHR.responseText);
					$('#my-modal-dialog').modal('hide');
				}
			});
		});

		$('#delete-format').on('click', function () {        
				$.ajax({
					type: 'POST',
					async: false,
					url: '/gvsigonline/services/db_delete_field_format/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					data:{
						'field': fieldName,
						'layer_id': "{{layer_id}}"
					},
					success	:function(response) {
						$('#my-modal-dialog').modal('hide');
						messageBox.show('Info', gettext('Field format was deleted'));
					},
					error: function(jqXHR) {
						messageBox.show('error', jqXHR.responseText);
						$('#my-modal-dialog').modal('hide');
					}
				});
		});
		$('#my-modal-dialog').modal('show');
	}

	function getEnumerations() {
		var enumerations = [];
		{% for e in enumerations %}
		enumerations.push({"name": "{{e.name}}", "title": "{{e.title}}"});
		{% endfor%}
		return enumerations;
	}

	function getForms() {
		var forms = [];
		{% for f in forms %}
		forms.push({"name": "{{f.name}}", "title": "{{f.title}}"});
		{% endfor%}
		return forms;
	}

	function addField(field) {
		$.ajax({
			type: 'POST',
			async: false,
			url: '/gvsigonline/services/db_field_add/',
			beforeSend:function(xhr){
				xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
			},
		  	data:{
		  		'field': field.name,
		  		'type': field.type,
		  		'enumkey': field.enumkey,
		  		'layer_id': "{{layer_id}}",
		  		'calculation': field.calculation,
		  		'gvsigol_type': field.gvsigol_type || '',
		  		'type_params': JSON.stringify(field.type_params || {}),
				'field_format': JSON.stringify(field.field_format || {})
		  	},
			success	:function(response) {
				// Si es un campo de tipo link, rellenar con URLs los registros existentes
				if (field.gvsigol_type === 'link' && field.type_params && field.type_params.related_field) {
					fillLinkFieldWithUrls(field.name, field.type_params.related_field, "{{layer_id}}");
				} else {
					messageBox.show('Info', gettext('Field was added'));
					$('#modal-error').on('hidden.bs.modal', function (e) {
						// reload page to get the updated list of fields
						window.location = window.location.toString().split("#", 1)[0];
					});
				}
			},
			error: function(jqXHR) {
				messageBox.show('error', jqXHR.responseText);
				$('#my-modal-dialog').modal('hide');
			}
		});
	}

	function fillLinkFieldWithUrls(newFieldName, relatedFieldName, layerId) {
		
		$.ajax({
			type: 'POST',
			async: false,
			url: '/gvsigonline/services/db_fill_link_field/',
			beforeSend:function(xhr){
				xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
			},
			data: {
				'layer_id': layerId,
				'new_field_name': newFieldName,
				'related_field_name': relatedFieldName
			},
			success: function(response) {
				console.log('fillLinkFieldWithUrls success response:', response);
				try {
					var data = response;
					if (typeof response === 'string') {
						data = JSON.parse(response);
					}
					
					if (data.status === 'success') {
						messageBox.show('Info', gettext('Field was added and filled with ' + data.updated_records + ' URLs'));
					} else {
						messageBox.show('Info', gettext('Field was added but there was an error filling URLs: ' + (data.message || 'Unknown error')));
					}
				} catch (e) {
					console.error('Error parsing response:', e, response);
					messageBox.show('Info', gettext('Field was added but there was an error filling URLs'));
				}
				
				$('#modal-error').on('hidden.bs.modal', function (e) {
					// reload page to get the updated list of fields
					window.location = window.location.toString().split("#", 1)[0];
				});
			},
			error: function(jqXHR) {
				console.error('fillLinkFieldWithUrls error:', jqXHR);
				messageBox.show('Info', gettext('Field was added but there was an error filling URLs'));
				$('#modal-error').on('hidden.bs.modal', function (e) {
					// reload page to get the updated list of fields
					window.location = window.location.toString().split("#", 1)[0];
				});
			}
		});
	}

	function getAddFieldConfig() {
		var config = {};
		{% if GVSIGOL_ENABLE_ENUMERATIONS %}
		config.enableEnums = true;
		{% else %}
		config.enableEnums = false;
		{% endif %}

		{% if 'gvsigol_plugin_form' in INSTALLED_APPS %}
		config.enableForms = true;
		{% else %}
		config.enableForms = false;
		{% endif %}

		config.enumerations = [];
		{% for e in enumerations %}
		config.enumerations.push({"id": "{{e.id}}", "title": "{{e.title}}"});
		{% endfor%}
		config.forms = [];
		{% for f in forms %}
		config.forms.push({"name": "{{f.name}}", "title": "{{f.title}}"});
		{% endfor%}
		config.triggerProcedures = [];
		{% for tp in procedures %}
		config.triggerProcedures.push({"id": "{{tp.signature}}", "label": "{{tp.localized_label}}"});
		{% endfor%}
		config.modalSelector = '#my-modal-dialog';
		return config;
	}
	var addFieldConfig = getAddFieldConfig();

	$("#add-field-button").on('click', function(e) {
    var fieldNames = [];
    var seenNames = {};  // Track seen names
    
    $('#field-list-table-body tr').each(function() {
        var name = $(this).find('input[name^="field-name-"]').val();
        if (name && !seenNames[name]) {
            seenNames[name] = true;
            fieldNames.push(name);
        }
    });
    
    createModalContent(null, 'create', gettext("New field"), addFieldConfig, fieldNames);
});
	var createFieldGroupTrans = function(groupId, groupName){
		var clonedRow = $('.fieldgroup-trans-row').first().clone()[0];
		clonedRow.dataset['groupid'] = groupId;
		var tdName = $(clonedRow).find('input').first()[0];
		tdName.name = "fieldgroup-name-" + groupId;
		tdName.value = groupName;
		$(clonedRow).find('input.fieldgroup-trans').each(function(idx, elem) {
			elem.name = "fieldgroup-title-" + elem.dataset["langid"] + "-" + groupId;
			elem.value = '';
			elem.placeholder = groupName;
		});
		$(clonedRow).appendTo('#fieldgroup-trans-table-body');
	}
	var createFieldGroup = function(){
		var i = 1;
		var groupName = "group1";
		var nameExists;
		do {
			nameExists = false;
			$('.sortable-fieldgroup input').each(function(idx, elem){
				if (elem.value == groupName) {
					nameExists = true;
					return false;
				}
			});
			if (nameExists) {
				i = i + 1;
				groupName = 'group' + i;
			}
		} while (nameExists);
		var groupId = parseInt($('#fieldgroup-total-counter').val()) + 1;
		$('#fieldgroup-total-counter').val(groupId);

		var ui = '<div data-groupid="'+ groupId + '" class="box box-default collapsed-box sortable-fieldgroup" style="border-top: none;">';
		ui += '<div class="box-header"><div class="handle form-inline">';
		ui += '<span class="" style="margin-right: 20px;">';
		ui += '<i class="fa fa-ellipsis-v"></i> <i class="fa fa-ellipsis-v"></i>';
		ui += '</span>';
		ui += '<input type="text" class="form-control" value="' + groupName + '">';
		ui += '&nbsp;<span class="text-danger group-name-error"></span>';
		ui += '</div>';
		ui += '<div class="box-tools box-tools-buttons pull-right">';
		ui += '<button type="button" class="button-delete-group" name="button-delete-group" title="{% blocktrans %}Delete group{% endblocktrans %}" class="btn btn-danger"><i class="fa fa-times"></i></button>';
		ui += '</div>';
		ui += '</div>';
		ui += '</div>';
		$('#field-groups-order').append(ui);

		createFieldGroupTrans(groupId, groupName);
		return groupName;
	}
	var checkUniqueGroupNames = function() {
		var groupNames = {};
		var unique = true;
		$(".sortable-fieldgroup input").each(function(idx, elem) {
			if (groupNames[elem.value]) {
				$(elem).next('span.group-name-error').text(gettext('Group names must be unique'));
				unique = false;
			}
			else {
				groupNames[elem.value] = true;
			}
		});
		return unique;
	}
	var installEvents = function() {
		$('.button-delete-group').off('click').on('click', function(e) {
			// move children fields of the deleted group to the first group
			var selected = $(this).parents('.sortable-fieldgroup');
			if ($('.sortable-fieldgroup').length > 0 &&
					selected.length > 0) {
				var first = $('.sortable-fieldgroup').first();
				if ($('.sortable-fieldgroup').length == 1) {
					// we must have at least a group, so just rename it using default name
					first.find('input')[0].value = "group1";
				}
				else {
					var nextGroup = selected.nextAll('.sortable-fieldgroup').first();
					var groupChildrenFields = selected.nextUntil(nextGroup);
					if (first[0]==selected[0]){
						// first will be removed, consider the new first
						first = first.nextAll('.sortable-fieldgroup').first();
					}
					var second = first.nextAll('.sortable-fieldgroup').first();
					if (second.length == 1) { // insert under next group
						groupChildrenFields.insertBefore(second);
					}
					else { // there is no next group, insert at the end
						groupChildrenFields.insertAfter($('.sortable-fieldgroup-field').last());
					}
					selected.remove();
				}
			}
			// delete group translations
			var groupId = selected[0].dataset['groupid'];
			$('.fieldgroup-trans-row').filter(function(){
				return $(this).data("groupid") == groupId;
			}).remove();
		});
		$("#field-groups-order").sortable({
			placeholder: "sort-highlight",
			handle: ".handle",
			forcePlaceholderSize: true,
			zIndex: 999999,
			stop: function(event, ui) {
				// ensure the first group is above any field
				if (ui.item.hasClass('sortable-fieldgroup-field') &&
						!ui.item.prev().hasClass('sortable-fieldgroup')) {
					$('.sortable-fieldgroup').first().prependTo('#field-groups-order');
				}
			}
		});
		$(".sortable-fieldgroup input").off("input change").on("input change", function(){
			var newGroupName = $(this).val();
			var groupId = $(this).closest('.sortable-fieldgroup')[0].dataset['groupid'];
			$('.fieldgroup-trans-row').filter(function(){
				return $(this).data("groupid") == groupId;
			}).find('input').first().val(newGroupName);
			checkUniqueGroupNames();
		});
	};
	$("#add-field-group-button").on('click', function(e){
		createFieldGroup();
		installEvents();
	});
	installEvents();
	$('form').submit(function(e) {
			$("body").overlay();
			if (!checkUniqueGroupNames()) {
				e.preventDefault();
				$("body").overlayout();
				return;
			}
			
			var jsonGroups = [];
			var lastGroup;
			$('#field-groups-order').children().each(function(idx, elem) {
				var jqElem = $(elem);
				if(jqElem.hasClass('sortable-fieldgroup')) {
					var groupId = jqElem.data('groupid');
					var groupName = jqElem.find('input')[0].value;
					lastGroup = {
						"name": groupName,
						"fields": []
					};
					$('.fieldgroup-trans-row').filter(function(){
						return $(this).data("groupid") == groupId;
					}).find("input.fieldgroup-trans").each(function(idx, elem) {
						var lang = elem.dataset['title'];
						var trans = elem.value;
						lastGroup[lang] = trans;
					});
					jsonGroups.push(lastGroup);
				}
				else if (jqElem.hasClass('sortable-fieldgroup-field')) {
					var fieldName = jqElem.find('span.text').text();
					lastGroup.fields.push(fieldName);
				}
			});
			$('#form_groups').val(JSON.stringify(jsonGroups));
			
			// Actualizar campos ocultos con valores de reglas topológicas antes de enviar
			$('#topology_no_overlap_hidden').val($('#no_overlap').is(':checked') ? 'true' : 'false');
			$('#topology_no_gaps_hidden').val($('#no_gaps').is(':checked') ? 'true' : 'false');
			$('#topology_must_be_covered_by_hidden').val($('#must_be_covered_by').is(':checked') ? 'true' : 'false');
			$('#topology_covered_by_layer_hidden').val($('#covered_by_layer').val() || '');
			$('#topology_must_not_overlap_with_hidden').val($('#must_not_overlap_with').is(':checked') ? 'true' : 'false');
			$('#topology_overlap_layers_hidden').val(JSON.stringify($('#overlap_layers').val() || []));
			$('#topology_must_be_contiguous_hidden').val($('#must_be_contiguous').is(':checked') ? 'true' : 'false');
			$('#topology_contiguous_tolerance_hidden').val($('#contiguous_tolerance').val() || '1.0');
		});

		// Funcionalidad para la pestaña de Restricciones de edición
		$(document).ready(function() {
			// Función para habilitar/deshabilitar controles (siempre visibles)
			function toggleTopologyControls() {
				console.log('Ejecutando toggleTopologyControls...');
				var coveredByChecked = $('#must_be_covered_by').is(':checked');
				var overlapWithChecked = $('#must_not_overlap_with').is(':checked');
				var contiguousChecked = $('#must_be_contiguous').is(':checked');
				console.log('Checkboxes:', { coveredByChecked, overlapWithChecked, contiguousChecked });

				// Control de "Must be covered by" - solo habilitar/deshabilitar
				if (coveredByChecked) {
					$('#covered_by_layer').prop('disabled', false);
				} else {
					$('#covered_by_layer').val('').trigger('change');
					$('#covered_by_layer').prop('disabled', true);
				}

				// Control de "Must not overlap with" - solo habilitar/deshabilitar
				if (overlapWithChecked) {
					$('#overlap_layers').prop('disabled', false);
				} else {
					$('#overlap_layers').val([]).trigger('change');
					$('#overlap_layers').prop('disabled', true);
				}

				// Control de "Must be contiguous" - solo habilitar/deshabilitar
				if (contiguousChecked) {
					$('#contiguous_tolerance').prop('disabled', false);
				} else {
					$('#contiguous_tolerance').prop('disabled', true);
				}
			}

			// Función para validar reglas topológicas
			function validateTopologyRules() {
				var errors = [];
				
				// Validar "Must be covered by"
				if ($('#must_be_covered_by').is(':checked')) {
					var coveredByLayer = $('#covered_by_layer').val();
					if (!coveredByLayer || coveredByLayer.trim() === '') {
						errors.push('Must select a layer for "Must be covered by" rule');
					}
				}
				
				// Validar "Must not overlap with"
				if ($('#must_not_overlap_with').is(':checked')) {
					var overlapLayers = $('#overlap_layers').val();
					if (!overlapLayers || overlapLayers.length === 0) {
						errors.push('Must select at least one layer for "Must not overlap with" rule');
					}
				}
				
				// Habilitar/deshabilitar botón de guardar
				if (errors.length > 0) {
					$('.save-button').prop('disabled', true).addClass('disabled');
					$('.save-button').attr('title', 'Cannot save: ' + errors.join(', '));
				} else {
					$('.save-button').prop('disabled', false).removeClass('disabled');
					$('.save-button').removeAttr('title');
				}
				
				return errors.length === 0;
			}

			// Event handlers para los checkboxes
			$('#must_be_covered_by').change(function() {
				toggleTopologyControls();
				setTimeout(validateTopologyRules, 100);
			});
			$('#must_not_overlap_with').change(function() {
				toggleTopologyControls();
				setTimeout(validateTopologyRules, 100);
			});
			$('#must_be_contiguous').change(function() {
				toggleTopologyControls();
				setTimeout(validateTopologyRules, 100);
			});

			// Función para cargar capas disponibles
			function loadAvailableLayers() {
				console.log('Cargando capas disponibles...');
				
				$.ajax({
					type: 'GET',
					url: '/gvsigonline/services/get_topology_available_layers/{{layer_id}}/',
					beforeSend: function(xhr) {
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success: function(response) {
						if (response.status === 'success') {
							// Limpiar opciones existentes (mantener solo la opción vacía)
							$('#covered_by_layer option:not([value=""])').remove();
							$('#overlap_layers option').remove();
							
							// Agregar las capas reales
							$.each(response.layers, function(index, layer) {
								var tooltip = layer.geom_type + ' - ' + layer.workspace;
								if (layer.layer_title) {
									tooltip += ' (' + layer.layer_title + ')';
								}
								var option = '<option value="' + layer.id + '" title="' + tooltip + '">' + layer.name + '</option>';
								$('#covered_by_layer').append(option);
								$('#overlap_layers').append(option);
							});
							
							console.log('Capas cargadas: ' + response.total + ' (excluyendo capa actual: ' + response.current_layer_name + ')');
							initializeTopologySelect2();
							// Cargar reglas existentes después de cargar las capas
							loadExistingTopologyRules();
						} else {
							console.error('Error al cargar capas:', response.message);
						}
					},
					error: function(xhr, status, error) {
						console.error('Error AJAX al cargar capas:', error);
					}
				});
			}

			// Función para cargar reglas topológicas existentes
			function loadExistingTopologyRules() {
				console.log('Cargando reglas topológicas existentes...');
				
				$.ajax({
					type: 'GET',
					url: '/gvsigonline/services/get_topology_rules/{{layer_id}}/',
					beforeSend: function(xhr) {
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success: function(response) {
						if (response.status === 'success') {
							var rules = response.rules;
							
							// Establecer checkboxes
							$('#no_overlap').prop('checked', rules.no_overlap);
							$('#no_gaps').prop('checked', rules.no_gaps);
							$('#must_be_covered_by').prop('checked', rules.must_be_covered_by);
							$('#must_not_overlap_with').prop('checked', rules.must_not_overlap_with);
							$('#must_be_contiguous').prop('checked', rules.must_be_contiguous);
							
							// Establecer valores de configuración
							if (rules.covered_by_layer) {
								$('#covered_by_layer').val(rules.covered_by_layer).trigger('change');
							}
							if (rules.overlap_layers && rules.overlap_layers.length > 0) {
								$('#overlap_layers').val(rules.overlap_layers).trigger('change');
							}
							if (rules.contiguous_tolerance) {
								$('#contiguous_tolerance').val(rules.contiguous_tolerance);
							}
							
							console.log('Reglas cargadas: ' + response.total_rules);
							
							// Actualizar controles después de cargar las reglas
							setTimeout(function() {
								toggleTopologyControls();
								validateTopologyRules();
							}, 200);
						} else {
							console.log('No hay reglas existentes para esta capa');
							
							// Actualizar controles aunque no haya reglas
							setTimeout(function() {
								toggleTopologyControls();
								validateTopologyRules();
							}, 200);
						}
					},
					error: function(xhr, status, error) {
						console.log('No se pudieron cargar las reglas existentes:', error);
					}
				});
			}

			// Función para inicializar Select2
			function initializeTopologySelect2() {
				console.log('Inicializando Select2...');
				
				// Destruir instancias existentes si las hay
				if ($('#covered_by_layer').hasClass('select2-hidden-accessible')) {
					$('#covered_by_layer').select2('destroy');
				}
				if ($('#overlap_layers').hasClass('select2-hidden-accessible')) {
					$('#overlap_layers').select2('destroy');
				}
				
				// Inicializar Select2 para selects simples
				$('#covered_by_layer').select2({
					placeholder: "{% trans 'Select a layer' %}",
					allowClear: true,
					width: '100%'
				});

				// Inicializar Select2 para selects múltiples
				$('#overlap_layers').select2({
					placeholder: "{% trans 'Select layers' %}",
					allowClear: true,
					width: '100%',
					multiple: true
				});
				
				// Event handlers para los selects
				$('#covered_by_layer').on('change select2:select select2:unselect', function() {
					setTimeout(validateTopologyRules, 100);
				});
				$('#overlap_layers').on('change select2:select select2:unselect', function() {
					setTimeout(validateTopologyRules, 100);
				});
				
				console.log('Select2 inicializado correctamente');
			}

			// Inicializar estado al cargar la página
			setTimeout(function() {
				console.log('Inicializando pestaña de topology...');
				loadAvailableLayers();
				setTimeout(function() {
					toggleTopologyControls();
					validateTopologyRules();
				}, 500);
			}, 300);

			// Re-inicializar cuando se cambie a la pestaña de restricciones
			$('a[href="#tab-editing-restrictions"]').on('shown.bs.tab', function() {
				console.log('Cambiando a pestaña de restricciones...');
				setTimeout(function() {
					// Solo re-inicializar Select2 si las capas ya están cargadas
					if ($('#covered_by_layer option').length > 1) {
						initializeTopologySelect2();
					} else {
						loadAvailableLayers();
					}
					toggleTopologyControls();
					validateTopologyRules();
				}, 100);
			});
		});
</script>
{% endblock %}