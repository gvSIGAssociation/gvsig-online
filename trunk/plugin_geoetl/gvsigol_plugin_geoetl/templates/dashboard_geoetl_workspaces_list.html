{% extends "base.html" %} 
{% load staticfiles %} 
{% load i18n %} 

{% block content %}
{% if user.is_staff %}
	<div class="row">
		<div class="col-md-12">
			<div class="row">
				<div class="col-md-12 form-group">
					<div class="box-tools pull-right">
						<button id="button-new-empty-canvas" class="btn btn-block btn-default btn-sm"><i class="fa fa-file-o margin-r-5"></i> {% trans "New" %}</button>
					</div>
					<div class="box-tools pull-right">
						<button id="button-upload-workspace-etl" class="btn btn-block btn-default btn-sm"><i class="fa fa-upload margin-r-5"></i>{% trans "Upload" %}</button>
					</div>
					<div class="box-tools pull-right">
						<button id="button-clean-tmp" class="btn btn-block btn-default btn-sm" data-toggle="tooltip"  data-placement="top" title='{% trans "Clean temporal tables" %}'><i class="fa fa-trash margin-r-5"></i> {% trans "Clean" %}</button>
					</div>
					<div class="box-tools pull-right">
						<button id="button-concat-workspaces" class="btn btn-block btn-default btn-sm" data-toggle="tooltip"  data-placement="top" title='{% trans "Concat. workspaces" %}'><i class="fa fa-th-list margin-r-5"></i> {% trans "Concat. workspaces" %}</button>
					</div>
				</div>
			</div>
			<div class="box">
				<div class="box-header with-border">
					<h3 class="box-title col-md-6">{% trans "Workspaces list" %}</h3>
				</div>
				<div class="box-body">
					<table class="table" id="etl-table">
						<thead>
							<tr>
								<th>{% trans "ID" %}</th>
								<th></th>
								<th>{% trans "Status" %}</th>
								<th>{% trans "Name" %}</th>
								<th>{% trans "Description" %}</th>
								<th>{% trans "Periodicity" %}</th>
								<th>{% trans "User" %}</th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							{% for workspace in workspaces %}
								<tr data-workspaceid="{{ workspace.id }}" data-editable="{{workspace.editable}}">
									<td> {{ workspace.id }} </td>
									<td></td>
									
										<td>
											<i id ="icon-success-{{ workspace.id }}" class="fa fa-check" style="color:green; display:none" aria-hidden="true"></i> 
											<i id = "icon-running-{{ workspace.id }}" class="fa fa-spinner fa-spin" style=" display:none"></i> 
											<i id ="icon-error-{{ workspace.id }}" class="fa fa-times" style="color:red; display:none" aria-hidden="true" ></i>
										</td>


									<td>{{ workspace.name }}</td>
									<td>{{ workspace.description }}</td>
									{% if workspace.every %}
										<td>{{ workspace.every }} {{ workspace.period }}</td>
									{% elif workspace.day_of_week%}
										<td>{{ workspace.day_of_week }} {{ workspace.hour }}:{{ workspace.minute }}</td>
									{% else %}
										<td></td>
									{% endif %}
									<td> {{ workspace.username }} </td>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
									<th></th>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>      

	<!-- Modals -->
	<div class="modal fade" id="modal-delete-workspace-etl" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">{% trans "Delete workspace" %}</h4>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-md-12 form-group">
							<p style="font-weight: 600;">{% trans "The ETL workspace and its parameters will be deleted" %}</p>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button id="button-delete-workspace-cancel" type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
					<button id="button-delete-workspace-accept" type="button" class="btn btn-default">{% trans "Accept" %}</button>
				</div>
			</div>
		</div>
	</div>

<!-- MODALS-->
<!-- Modal to update a workspace-->
	<div id="modal-update-workspace-etl" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
			
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title">{% trans "Update ETL Workspace" %}</h4>
				</div>

				<div class="modal-body">
					<form id="layer-group-form" role="form">

						<div class="row">
							<div class="col-md-12">
								<label for="etl_id">ID</label>
								<input placeholder = "{% trans 'ETL Workspace ID' %}" name="etl_id" id="etl_id" type="text" class="form-control">
							</div>
						</div>

						<div class="row">
							<div class="col-md-12">
								<label for="etl_name">{% trans "Name" %}</label>
								<input placeholder="{% trans 'ETL Workspace name' %}" name="etl_name" id="etl_name" type="text" class="form-control">							
							</div>
						</div>

						<div class="row">
							<div class="col-md-12">
								<label for="etl_desc">{% trans "Description" %}</label>
								<input placeholder="{% trans 'ETL Workspace description' %}" name="etl_desc" id="etl_desc" type="text" class="form-control">								
							</div>
						</div>

						<div class="row">
							<div class="col-md-12">
								<input type="checkbox" name="repeat_periodically" id="repeat_periodically"/>	
								<label for="repeat_periodically">{% trans "Run periodically?" %}</label>&nbsp;&nbsp;										
							</div>
							
							<div class="col-md-6 repeat_periodically_time" >
								<select class="form-control" style="width: 100%;" id="ws-program-day" name="ws-program-day">
									<option value="all">{% trans 'All days' %}</option>
									<option value="monday">{% trans 'Monday' %}</option>
									<option value="tuesday">{% trans 'Tuesday' %}</option>
									<option value="wednesday">{% trans 'Wednesday' %}</option>
									<option value="thursday">{% trans 'Thursday' %}</option>
									<option value="friday">{% trans 'Friday' %}</option>
									<option value="saturday">{% trans 'Saturday' %}</option>
									<option value="sunday">{% trans 'Sunday' %}</option>
									<option value="every">{% trans 'Every' %} ...</option>
								</select> 	
							</div>
							<div class="more-hour-options">
								<div class="col-md-6 repeat_periodically_time">
									<div class="form-group">
										<div class='input-group date'>
											<input type='text' class="form-control" id='ws-program-time' name='ws-program-time' placeHolder="HH:mm:ss"/>
											<span class="input-group-addon">
											</span>
										</div>
									</div>
								</div>
							</div>
							
							<div class="more-options">
								<div class="col-md-12 repeat_periodically_time">
									<label>{% trans "Run workspace every..." %}</label>
								</div>
							
								<div class="col-md-6 repeat_periodically_time">
									<input placeholder="{% trans 'Select number of...' %}" name="ws-program-interval" id="ws-program-interval" type="number" value=1 class="form-control">
								</div>
								
								<div class="col-md-6 repeat_periodically_time">
									<select class="form-control" style="width: 100%;" id="ws-program-unit" name="ws-program-unit">
										<option value="empty">{% trans '... time measure' %}</option>
										<option value="minutes">{% trans 'minutes' %}</option>
										<option value="hours">{% trans 'hours' %}</option>
										<option value="days">{% trans 'days' %}</option>
									</select>
								</div>
							</div>
						</div>
						{% if user.is_superuser %}
							<div class="row">
								<div class="col-md-12">
									<input type="checkbox" name="change_superuser" id="change_superuser"/>
									<label for="change_superuser">{% trans 'Change to superuser?' %}</label>											
								</div>
							</div>
						{% endif %}
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default btn-sm" data-dismiss="modal">{% trans "Close" %}</button>
					<button type="button" class="btn btn-default btn-sm" id="update-etl-workspace">{% trans "Update" %}</button>
				</div>
			</div>
		</div>
	</div>

    <!-- Modal name and user is already in database-->
    <div class="modal fade" id="modal-ws-exists" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">{% trans 'Not allowed' %}</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 form-group">
                            <p style="font-weight: 600;">{% trans 'In database already exists a workspace with the same name and the same user' %}</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="button-ws-exists-accept" type="button" class="btn btn-default">{% trans 'Accept' %}</button>
                </div>
            </div>
        </div>
    </div>

	<div id="modal-upload-workspace-etl" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
			
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title">{% trans "Upload ETL Workspace" %}</h4>
				</div>

				<div class="modal-body">
					<form id="layer-group-form" role="form">

						<div class="row">
							<div class="col-md-12">
								<label for="etl_name">{% trans "Name" %}</label>
								<input placeholder="{% trans 'ETL Workspace name' %}" name="etl_name" id="etl_name_upload" type="text" class="form-control">							
							</div>
						</div>

						<div class="row">
							<div class="col-md-12">
								<label for="etl_desc">{% trans "Description" %}</label>
								<input placeholder="{% trans 'ETL Workspace description' %}" name="etl_desc_upload" id="etl_desc_upload" type="text" class="form-control">								
							</div>
						</div>

						<div class="row">
							<div class="col-md-12">
								<label for="etl_json">{% trans "ETL Workspace JSON" %}</label>
								<div>
									<a href="#" id="select-file-button-0" style="float: left" class="btn btn-default btn-sm"><i class="fa fa-folder-open margin-r-5"></i>Select file</a>
									<div style="overflow: hidden; padding-right: .5em;">
										<input  placeholder = "{% trans 'ETL Workspace JSON' %}" name="etl_json" id="etl_json_upload" type="text" class="form-control">
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default btn-sm" data-dismiss="modal">{% trans "Close" %}</button>
					<button type="button" class="btn btn-default btn-sm" id="upload-etl-workspace">{% trans "Upload" %}</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal clean temporal tables-->
	<div id="modal-clean-tmp-tables" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
			
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title">{% trans "Clean temporal tables" %}</h4>
				</div>

				<div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 form-group">
                            <p style="font-weight: 600; font-size: 15px;">{% trans 'Some ETL workspace is running. Are you sure you want to drop the temporary tables? ' %}</p>
                        </div>
                    </div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default btn-sm" data-dismiss="modal">{% trans "Close" %}</button>
					<button type="button" class="btn btn-default btn-sm" id="accept-clean-tmp">{% trans "Clean" %}</button>
				</div>
			</div>
		</div>
	</div>

<!-- Modal to set parameters for workspace-->
<div id="modal-set-parameters-workspace" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
		
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title">{% trans "Set parameters for workspace" %}</h4>
			</div>

			<div class="modal-body" style="max-height: calc(100vh - 225px); overflow: scroll;">
				<form id="layer-group-form" role="form">

					<div class="row">
						<div class="col-md-12">
							<label for="etl_id">ID</label>
							<input placeholder = "{% trans 'ETL Workspace ID' %}" name="etl_id" id="etl_id" type="text" class="form-control">
						</div>
					</div>

					<div class="row">
						<div class="col-md-12">
							<label form="db" class="col-form-label">{% trans "DB Connection" %}</label>
							<select id="db" class="form-control"></select>
						</div>
					</div>
					
					<div>
						<label class="col-form-label" id ="sql-params">{% trans "SQL Parameters" %} <i id ="img-sql-params" class="fa fa-caret-right"></i> </label>
					</div>

					<div id="more-options-sql" class="more-options">

						<div class="row">
							<div class="col-md-12">
								<label class="col-form-label">{% trans "SQL before running workspace" %}</a></label>
								<textarea id="sql-before" rows="3" class="form-control"></textarea>
							</div>
						</div>

						<div class="row">
							<div class="col-md-12">
								<label class="col-form-label">{% trans "SQL after running workspace" %}</a></label>
								<textarea id="sql-after" rows="3" class="form-control"></textarea>
							</div>
						</div>
					</div>

					<div>
						<label class="col-form-label" id ="user-params">{% trans "User Parameters" %} <i id ="img-user-params" class="fa fa-caret-right"></i> </label>
					</div>

					<div id="more-options-user" class="more-options">
						<div class="row">
							<div class="col-md-12">
								<label class="col-form-label">{% trans "Add user parameter" %}</a></label> 
							</div>
						</div>

						<div class="row">
							<div class="col-sm-4">
								<label >{% trans "Name" %}</a></label>
								<input type="text" id="name-user-params" class="form-control"></input>
							</div>
							<div class="col-sm-4">
								<label >{% trans "Type" %}</a></label>
									<select class="form-control" id="type-user-params">
										<option value="VARCHAR"> {% trans "Varchar" %}</option>
										<option value="INTEGER"> {% trans "Integer" %}</option>
										<option value="FLOAT"> {% trans "Float" %} </option>
									</select>
							</div>

							<div class="col-sm-4">
								<label >{% trans "Value" %}</a></label>
								<input type="text" id="value-user-params" class="form-control"></input>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-12">
								<button type="button" style="float: right;" class="btn btn-default btn-sm" id="quit-user-params"><i class="fa fa-minus" aria-hidden="true"></i></button>
								<button type="button" style="float: right;" class="btn btn-default btn-sm" id="add-user-params"><i class="fa fa-plus" aria-hidden="true"></i></button>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-12">
								<input type="text" id="json-user-params" class="form-control" readonly="readonly" value ="{}"></input>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-12">
                                <input type="checkbox" id="checkbox-user-params" value = 'False'/>
                                <label for="checkbox"> {% trans "There are variable parameters (The workspace will be executed in a loop)" %} </label>   							
							</div>
						</div>
						
						<div class="row">
							<div class="col-sm-4">
								<label >{% trans "Variable parameter" %}</a></label>
								<select class="form-control" id="loop-user-params">

								</select>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-12">
                                <div class="form-check">
                                    <input type="radio" name="radio-params-user" class="form-check-input" id="loop-integer-user-params" value="integer">
                                    <label>{% trans "Integer iterative value from" %}</label> <input type="number" id="init-loop-integer-user-params" value="0" size ="3"/><label>{% trans " to " %} </label> <input type="number" id="end-loop-integer-user-params" value="0" size ="3"/>
                                </div>
                                <div class="form-check">
                                    <input type="radio" name="radio-params-user" class="form-check-input" id="loop-postgres-user-params" value="postgres">
                                    <label>{% trans "Iterative value from a column of a PostgreSQL table" %}</label>
                                </div>						
							</div>
						</div>

						<div class="row">
							<div class="col-sm-4">
								<label class="col-form-label">{% trans "Get schemas" %}</label><br>
								<a href="#" id="get-schemas" class="btn btn-default btn-sm">{% trans "Get schemas" %}</a>
							</div>
							<div class="col-sm-8">
								<label class="col-form-label">{% trans "Schemas" %}</label>
								<select id="schema-name-user-params" class="form-control"></select>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-4">
								<label class="col-form-label">{% trans "Get tables" %}</label><br>
								<a href="#" id="get-tables" class="btn btn-default btn-sm">{% trans "Get tables" %}</a>
							</div>
							<div class="col-sm-8">
								<label class="col-form-label">{% trans "Tables" %}</label>
								<select id="table-name-user-params" class="form-control"></select>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-4">
								<label class="col-form-label">{% trans "Get attributes" %}</label><br>
								<a href="#" id="get-attrs" class="btn btn-default btn-sm">{% trans "Get attributes" %}</a>
							</div>
							<div class="col-sm-8">
								<label class="col-form-label">{% trans "Attributes" %}</label>
								<select id="attr-name-user-params" class="form-control"></select>
							</div>
						</div>  

					</div>

				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default btn-sm" data-dismiss="modal">{% trans "Close" %}</button>
				<button type="button" class="btn btn-default btn-sm" id="set-parameters">{% trans "Set parameters" %}</button>
			</div>
		</div>
	</div>
</div>



{% endif %}

{% endblock %}

{% block extra-scripts %}

<script>
	$('#menu-plugin-etl').addClass("active");
	$('#submenu-etl').addClass("active");

	username = '{{ user.username }}'

	//Parámetros de usuario

	$("#sql-params").click(function(){
		$("#img-sql-params").toggleClass('fa-caret-right fa-caret-down')
        $("#more-options-sql").slideToggle("slow");
        });

	$("#user-params").click(function(){
		$("#img-user-params").toggleClass('fa-caret-right fa-caret-down')
		$("#more-options-user").slideToggle("slow");
	});


	$('#add-user-params').click(function(){
		name = $('#name-user-params').val()

		$('#loop-user-params').append(
                '<option value="'+name+'">'+name+'</option>'
            );

		type = $('#type-user-params').val()
		
		if (type == 'VARCHAR'){

			value = $('#value-user-params').val()

		}else if (type == 'INTEGER'){

			value = parseInt($('#value-user-params').val())

		} else if (type == 'FLOAT'){

			value = parseFloat($('#value-user-params').val())

		}

		json = JSON.parse($('#json-user-params').val())

		json[name] = value;

		jsonString = JSON.stringify(json);

		$('#json-user-params').val(jsonString);

	})

	$('#quit-user-params').click(function(){
		name = $('#name-user-params').val()
		json = JSON.parse($('#json-user-params').val())

		if (name != ''){

			delete json[name]

			$("#loop-user-params option[value='"+name+"']").remove();

		} else {
			keys = Object.keys(json)
			delete json[keys[keys.length-1]]

			$("#loop-user-params").find("option:last").remove();

		}

		jsonString = JSON.stringify(json);
		$('#json-user-params').val(jsonString);

	});

	$('#checkbox-user-params').change(function(){

		if ($('#checkbox-user-params').is(':checked')){

			$('#checkbox-user-params').val('True')
					
			$("#loop-user-params").prop('disabled', false)
			$('[name = "radio-params-user"]').prop('disabled', false)
			$("#init-loop-integer-user-params").prop('disabled', false)
			$("#end-loop-integer-user-params").prop('disabled', false)
			$("#get-schemas").removeClass('disabled')
			$("#schema-name-user-params").prop('disabled', false)
			$("#get-tables").removeClass('disabled')
			$("#table-name-user-params").prop('disabled', false)
			$("#get-attrs").removeClass('disabled')
			$("#attr-name-user-params").prop('disabled', false)
					
		}

		else {
			$('#checkbox-user-params').val('False')

			$("#loop-user-params").prop('disabled', true)
			$('[name = "radio-params-user"]').prop('disabled', true)
			$("#init-loop-integer-user-params").prop('disabled', true)
			$("#end-loop-integer-user-params").prop('disabled', true)
			$("#get-schemas").addClass('disabled')
			$("#schema-name-user-params").prop('disabled', true)
			$("#get-tables").addClass('disabled')
			$("#table-name-user-params").prop('disabled', true)
			$("#get-attrs").addClass('disabled')
			$("#attr-name-user-params").prop('disabled', true)
		}
	});


	$('input:radio[name = "radio-params-user"]').change(function(){

		if ($('#loop-integer-user-params').is(':checked')){

			$("#init-loop-integer-user-params").prop('disabled', false)
			$("#end-loop-integer-user-params").prop('disabled', false)
			$("#get-schemas").addClass('disabled')
			$("#schema-name-user-params").prop('disabled', true)
			$("#get-tables").addClass('disabled')
			$("#table-name-user-params").prop('disabled', true)
			$("#get-attrs").addClass('disabled')
			$("#attr-name-user-params").prop('disabled', true)

		}
		else{
			$("#init-loop-integer-user-params").prop('disabled', true)
			$("#end-loop-integer-user-params").prop('disabled', true)
			$("#get-schemas").removeClass('disabled')
			$("#schema-name-user-params").prop('disabled', false)
			$("#get-tables").removeClass('disabled')
			$("#table-name-user-params").prop('disabled', false)
			$("#get-attrs").removeClass('disabled')
			$("#attr-name-user-params").prop('disabled', false)

		}

	})

	$('#get-schemas').on("click", function(){
                                
		var paramsGetSchemas = {
		"parameters": [
			{"db": $('#db').val()}
		]}

		var formDataGetSchemas = new FormData();
		
		formDataGetSchemas.append('jsonParams', JSON.stringify(paramsGetSchemas))

		$.ajax({
			type: 'POST',
			url: '/gvsigonline/etl/etl_schemas_name_postgres/',
			data: formDataGetSchemas,
			beforeSend:function(xhr){
				xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
			},
			cache: false, 
			contentType: false, 
			processData: false,
			success: function (data) {

				$('#schema-name-user-params').empty()

				for (i = 0; i < data.length; i++){
					$('#schema-name-user-params').append('<option>'+data[i]+'</option>')
				}
			}
		})
	});

	$('#get-tables').on("click", function(){
                                
		var paramsGetSchemas = {
		"parameters": [
			{"db": $('#db').val(),
			"schema-name": $('#schema-name-user-params').val()}
		]}

		var formDataGetSchemas = new FormData();
		
		formDataGetSchemas.append('jsonParams', JSON.stringify(paramsGetSchemas))

		$.ajax({
			type: 'POST',
			url: '/gvsigonline/etl/etl_table_name_postgres/',
			data: formDataGetSchemas,
			beforeSend:function(xhr){
				xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
			},
			cache: false, 
			contentType: false, 
			processData: false,
			success: function (data) {
				
				$('#table-name-user-params').empty()

				for (i = 0; i < data.length; i++){
					$('#table-name-user-params').append('<option>'+data[i]+'</option>')

				}
			}
		})
	});

	$('#get-attrs').on("click", function(){
                                
		var paramsGetAttrs = {
		"parameters": [
			{"db": $('#db').val(),
			"schema-name": $('#schema-name-user-params').val(),
			"tablename": $('#table-name-user-params').val()}
		]}

		var formDataGetAttrs = new FormData();
		
		formDataGetAttrs.append('jsonParamsPostgres', JSON.stringify(paramsGetAttrs))

		$.ajax({
			type: 'POST',
			url: '/gvsigonline/etl/etl_schema_postgresql/',
			data: formDataGetAttrs,
			beforeSend:function(xhr){
				xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
			},
			cache: false, 
			contentType: false, 
			processData: false,
			success: function (data) {
				
				$('#attr-name-user-params').empty()

				for (i = 0; i < data.length; i++){
					$('#attr-name-user-params').append('<option>'+data[i]+'</option>')

				}
			}
		})
	});

	$(document).ready(function() {
		var table = $('#etl-table').DataTable({
			responsive: true,
			language: {
				processing		: '{% trans "Processing request..." %}',
				search			: '{% blocktrans with sep="&nbsp;:" %}Search{{sep}}{% endblocktrans %}',
				lengthMenu		: '{% blocktrans with numrecords="_MENU_" %}Showing {{numrecords}} records{% endblocktrans %}',
				info			: '{% blocktrans with start="_START_" end="_END_" numrecords="_TOTAL_" %}Showing from {{start}} to {{end}} of {{numrecords}} records{% endblocktrans %}',
				infoEmpty		: '{% trans "Showing from 0 to 0 of 0 records" %}',
				infoFiltered	: '{% blocktrans with max="_MAX_" %}Filtering {{max}} records{% endblocktrans %}',
				infoPostFix		: "",
				loadingRecords	: '{% trans "Loading..." %}',
				zeroRecords		: '{% trans "No records available" %}',
				emptyTable		: '{% trans "No records available" %}',
				paginate: {
					first		: '{% trans "First" %}',
					previous	: '{% trans "Previous" %}',
					next		: '{% trans "Next" %}',
					last		: '{% trans "Last" %}'
				},
				aria: {
					sortAscending: '{% blocktrans with sep=": " %}{{sep}}Sort ascending{% endblocktrans %}',
					sortDescending: '{% blocktrans with sep=": " %}{{sep}}Sort descending{% endblocktrans %}'
				}
			},
			"columnDefs": [{
				"targets": -1,
				"data": null,
				"render": function ( data, type, row ) {
					var filter = 'tr[data-workspaceid="' + data[0] + '"]';
					var dataset = $('#etl-table').find(filter).data();
					if (dataset['editable']) {
						return '<button type="button" name="button-download-workspace-etl" data-toggle="tooltip"  data-placement="bottom" title="' + '{% trans "Download workspace" %}' + '" class="btn btn-primary"><i class="fa fa-download"></i></button>';
					}
					else {
						return '';
					}
				}
			},{
				"targets": -2,
				"data": null,
				"render": function ( data, type, row ) {
					var filter = 'tr[data-workspaceid="' + data[0] + '"]';
					var dataset = $('#etl-table').find(filter).data();
					if (dataset['editable']) {
						return '<button type="button" name="button-delete-workspace-etl" data-toggle="modal" data-toggle-second="tooltip" data-target="#modal-delete-workspace-etl" data-placement="bottom" title="' + '{% trans "Delete workspace" %}' + '" class="btn btn-danger"><i class="fa fa-times"></i></button>';
					}
					else {
						return '';
					}
				}
			},{
				"targets": -3,
				"data": null,
				"render": function ( data, type, row ) {
					var filter = 'tr[data-workspaceid="' + data[0] + '"]';
					var dataset = $('#etl-table').find(filter).data();
					if (dataset['editable']) {
						return '<button type="button" name="button-update-workspace-etl" data-toggle="tooltip" data-placement="bottom" title="' + '{% trans "Update workspace" %}' + '" class="btn btn-warning"><i class="fa fa-edit"></i></button>';
					}
					else {
						return '';
					}
				}
			},{
				"targets": -4,
				"data": null,
				"render": function ( data, type, row ) {
					var filter = 'tr[data-workspaceid="' + data[0] + '"]';
					var dataset = $('#etl-table').find(filter).data();
					if (dataset['editable']) {
						return '<button type="button" name="button-open-workspace-etl" data-toggle="tooltip"  data-placement="bottom" title="' + '{% trans "Open workspace" %}' + '" class="btn btn-success"><i class="fa fa-folder-open"></i></button>';
					}
					else {
						return '';
					}
				}
			},{
				"targets": -5,
				"data": null,
				"render": function ( data, type, row ) {
					var filter = 'tr[data-workspaceid="' + data[0] + '"]';
					var dataset = $('#etl-table').find(filter).data();
					if (dataset['editable']) {
						return '<button type="button" name="button-set-parameters-workspace" data-toggle="tooltip"  data-placement="bottom" title="' + '{% trans "Set parameters" %}' + '" class="btn btn-secondary"><i class="fa fa-bars"></i></button>';
					}
					else {
						return '';
					}
				}
			},{
				"targets": 1,
				"data": null,
				"defaultContent": '<button type="button" name="button-run-workspace-etl" data-toggle="tooltip"  data-placement="bottom" title="' + '{% trans "Run workspace" %}' + '" class="btn btn-light"><i class="fa fa-play"></i></button>'
			}],
			"dom": 'T<"clear">lfrtip',
			"bLengthChange": false
		});


		$('[data-toggle-second="tooltip"]').tooltip();

		$('#button-clean-tmp').on('click', function (){

			$.ajax({
					type: 'POST',
					async: false,
					url: '/gvsigonline/etl/etl_workspace_is_running/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success	:function(response){

						if (response.run == 'true'){

							$('#modal-clean-tmp-tables').modal('show')

						}
					},
					error: function(){}
				});
		
		});

		$('#accept-clean-tmp').on('click', function (){
			CleanTemporalTables()
		})


		$('#button-concat-workspaces').on('click', function (){

			location.href = '/gvsigonline/etl/etl_concat_workspaces/';
		});


		function CleanTemporalTables(){
			$('#modal-clean-tmp-tables').modal('hide')

			$.ajax({
				type: 'POST',
				async: false,
				url: '/gvsigonline/etl/etl_clean_tmp_tables/',
				beforeSend:function(xhr){
					xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
				},
				success	:function(){},
				error: function(){}
			});

		}

		$('#button-new-empty-canvas').on('click', function (){

			location.href = '/gvsigonline/etl/etl_canvas/';
		});

		upload = false

		$('#button-upload-workspace-etl').on('click', function (){
		$('#modal-upload-workspace-etl').modal('show')
				fm_directory = '{{ fm_directory }}'
				getPathFile('json', '0')
		})

		$("#upload-etl-workspace").on('click', function(){

			$.ajax({
					type: 'POST',
					async: false,
					data: {
						"name": $("#etl_name_upload").val(),
						"description": $("#etl_desc_upload").val(),
						"file": $("#etl_json_upload").val(),
						"username": username
					},
					url: '/gvsigonline/etl/etl_workspace_upload/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success	:function(response){
						$('#modal-upload-workspace-etl').modal('hide');
						$("#etl_name_upload").val("")
						$("#etl_desc_upload").val("")
						$("#etl_json_upload").val("")

						if(response['exists']=="true"){
							upload = true
							$('#modal-ws-exists').modal('show')
							
						}else{
							location.reload();
						}
					},
					error: function(){}
				});

		})
		

		$('#etl-table tbody').on('click', 'button', function (){
			var row = table.row($(this).parents('tr'));
			var data = row.data();
			if (this.name == "button-update-workspace-etl") {
				
				$(".modal-body #etl_id").val( data[0] );
				$(".modal-body #etl_name").val( data[3] );
				$(".modal-body #etl_desc").val( data[4] );

				if(data[5]!=''){
					$("#repeat_periodically").prop('checked', true)
					$(".repeat_periodically_time").slideDown("slow");

					if(data[5].includes(':')){

						$(".more-options").slideUp("slow"); 
						$(".more-hour-options").slideDown("slow");
						
						$(".modal-body #ws-program-day").val(data[5].split(' ')[0])
						$(".modal-body #ws-program-time").val(data[5].split(' ')[1]+':00')

					}else{

						$(".more-options").slideDown("slow");  // checked
						$(".more-hour-options").slideUp("slow");

						$(".modal-body #ws-program-day").val('every')
						$(".modal-body #ws-program-interval").val(data[5].split(' ')[0])
						$(".modal-body #ws-program-unit").val(data[5].split(' ')[1])

					}
				
				}else{
					$("#repeat_periodically").prop('checked', false)
					$(".repeat_periodically_time").slideUp("slow");
				}
				
				$('#modal-update-workspace-etl').modal('show')
				
				updateWorkspace(data)
				
			} else if (this.name == "button-delete-workspace-etl"){
				deleteWorkspace(data);   
			}

			else if (this.name == "button-open-workspace-etl"){
				openWorkspace(data);  
			}

			else if (this.name == "button-download-workspace-etl"){
				location.href = '/gvsigonline/etl/etl_workspace_download/?lgid=' + data[0]
			}

			else if (this.name == "button-run-workspace-etl"){
				runWorkspace(data);  
			}

			else if (this.name == "button-set-parameters-workspace"){

				$(".more-options").slideUp("slow");
				$("#img-sql-params").removeClass('fa-caret-down')
				$("#img-sql-params").addClass('fa-caret-right')

				$("#img-user-params").removeClass('fa-caret-down')
				$("#img-user-params").addClass('fa-caret-right')

				$('#name-user-params').val('')
				$('#type-user-params').val('VARCHAR')
				$('#value-user-params').val('')

				$(".modal-body #etl_id").val( data[0] );

				$.ajax({
					type: 'POST',
					async: false,
					data: {
						"id": data[0],
					},
					url: '/gvsigonline/etl/get_workspace_parameters/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success	:function(response){

						$("#db option").each(function() {
							$(this).remove();
						});

						dbc = response['dbcs']

						for(i=0;i<dbc.length;i++){

							$('#db').append(
								'<option value="'+dbc[i].name+'">'+dbc[i].name+'</option>'
							);
						};

						if (response['db'] != ''){
							$(".modal-body #db").val( response['db'] );
						}

						try{
							sqlbefore = response['sql-before'].join(' \n ')
							sqlafter = response['sql-after'].join(' \n ')
						}catch{
							sqlbefore = ''
							sqlafter = ''
						}

						$(".modal-body #sql-before").val( sqlbefore.replace( /_##_/g, '"').replace( /#--#/g, "'"));

						$(".modal-body #sql-after").val( sqlafter.replace( /_##_/g, '"').replace( /#--#/g, "'"));

						json_user_params = response['json-user-params']
						if (json_user_params == undefined){
							json_user_params = "{}"
						};
						checkbox_user_params = response['checkbox-user-params']
						if (checkbox_user_params == undefined){
							checkbox_user_params = ""
						};
						get_loop_user_params = response['get_loop-user-params']
						if (get_loop_user_params == undefined){
							get_loop_user_params = []
						};
						loop_user_params = response['loop-user-params']
						if (loop_user_params == undefined){
							loop_user_params = ""
						};
						radio_params_user = response['radio-params-user']
						if (radio_params_user == undefined){
							radio_params_user = ""
						};
						init_loop_integer_user_params = response['init-loop-integer-user-params']
						if (init_loop_integer_user_params == undefined){
							init_loop_integer_user_params = 0
						};
						end_loop_integer_user_params = response['end-loop-integer-user-params']
						if (end_loop_integer_user_params == undefined){
							end_loop_integer_user_params = 0
						};
						get_schema_name_user_params = response['get_schema-name-user-params']
						if (get_schema_name_user_params == undefined){
							get_schema_name_user_params = []
						};
						schema_name_user_params = response['schema-name-user-params']
						if (schema_name_user_params == undefined){
							schema_name_user_params = ""
						};
						get_table_name_user_params = response['get_table-name-user-params']
						if (get_table_name_user_params == undefined){
							get_table_name_user_params = []
						};
						table_name_user_params = response['table-name-user-params']
						if (table_name_user_params == undefined){
							table_name_user_params = ""
						};
						get_attr_name_user_params = response['get_attr-name-user-params']
						if (get_attr_name_user_params == undefined){
							get_attr_name_user_params = []
						};
						attr_name_user_params = response['attr-name-user-params']
						if (attr_name_user_params == undefined){
							attr_name_user_params = ""
						};
			

						$(".modal-body #json-user-params").val(json_user_params)

						if (checkbox_user_params == 'True'){
							$('#checkbox-user-params').val('True')
							$('#checkbox-user-params').prop('checked', true);

							$("#loop-user-params").prop('disabled', false)
							$('[name = "radio-params-user"]').prop('disabled', false)
							$("#init-loop-integer-user-params").prop('disabled', false)
							$("#end-loop-integer-user-params").prop('disabled', false)
							$("#get-schemas").removeClass('disabled')
							$("#schema-name-user-params").prop('disabled', false)
							$("#get-tables").removeClass('disabled')
							$("#table-name-user-params").prop('disabled', false)
							$("#get-attrs").removeClass('disabled')
							$("#attr-name-user-params").prop('disabled', false)
									
						}

						else {
							$('#checkbox-user-params').val('False')
							$('#checkbox-user-params').prop('checked', false);

							$("#loop-user-params").prop('disabled', true)
							$('[name = "radio-params-user"]').prop('disabled', true)
							$("#init-loop-integer-user-params").prop('disabled', true)
							$("#end-loop-integer-user-params").prop('disabled', true)
							$("#get-schemas").addClass('disabled')
							$("#schema-name-user-params").prop('disabled', true)
							$("#get-tables").addClass('disabled')
							$("#table-name-user-params").prop('disabled', true)
							$("#get-attrs").addClass('disabled')
							$("#attr-name-user-params").prop('disabled', true)
						};

						$('#loop-user-params').empty()
						for (i = 0; i < get_loop_user_params.length; i++){
							$('#loop-user-params').append('<option>'+get_loop_user_params[i]+'</option>')
						};
						
						$("#loop-user-params").val(loop_user_params)

						if (radio_params_user == 'integer'){

							$('#loop-integer-user-params').prop('checked', true);

							$("#init-loop-integer-user-params").prop('disabled', false)
							$("#end-loop-integer-user-params").prop('disabled', false)
							$("#get-schemas").addClass('disabled')
							$("#schema-name-user-params").prop('disabled', true)
							$("#get-tables").addClass('disabled')
							$("#table-name-user-params").prop('disabled', true)
							$("#get-attrs").addClass('disabled')
							$("#attr-name-user-params").prop('disabled', true)

						}else{

							$('#loop-postgres-user-params').prop('checked', true);

							$("#init-loop-integer-user-params").prop('disabled', true)
							$("#end-loop-integer-user-params").prop('disabled', true)
							$("#get-schemas").removeClass('disabled')
							$("#schema-name-user-params").prop('disabled', false)
							$("#get-tables").removeClass('disabled')
							$("#table-name-user-params").prop('disabled', false)
							$("#get-attrs").removeClass('disabled')
							$("#attr-name-user-params").prop('disabled', false)

						};

						$("#init-loop-integer-user-params").val(init_loop_integer_user_params)
						$("#end-loop-integer-user-params").val(end_loop_integer_user_params)

						
						
						$('#schema-name-user-params').empty()
						for (i = 0; i < get_schema_name_user_params.length; i++){
							$('#schema-name-user-params').append('<option>'+get_schema_name_user_params[i]+'</option>')
						};
						
						$("#schema-name-user-params").val(schema_name_user_params)

						$('#table-name-user-params').empty()
						for (i = 0; i < get_table_name_user_params.length; i++){
							$('#table-name-user-params').append('<option>'+get_table_name_user_params[i]+'</option>')
						};
						
						$("#table-name-user-params").val(table_name_user_params)

						$('#attr-name-user-params').empty()
						for (i = 0; i < get_attr_name_user_params.length; i++){
							$('#attr-name-user-params').append('<option>'+get_attr_name_user_params[i]+'</option>')
						};
						
						$("#attr-name-user-params").val(attr_name_user_params)

						$('#modal-set-parameters-workspace').modal('show')
					},
					error: function(){}
				});
				 
			}

		});


		$('#set-parameters').on('click', function (){

			var get_loop = []
			var get_sch = []
			var get_tbl = []
			var get_attr = []

			$("#loop-user-params option").each(function()
				{
					get_loop.push($(this).val())
				});

			$("#schema-name-user-params option").each(function()
			{
				get_sch.push($(this).val())
			});

			$("#table-name-user-params option").each(function()
			{
				get_tbl.push($(this).val())
			});

			$("#attr-name-user-params option").each(function()
			{
				get_attr.push($(this).val())
			});

			if ($('#loop-integer-user-params').is(':checked')){
				radio = 'integer'
			}else{
				radio = 'postgres'
			}


			params = {
						"id": $(".modal-body #etl_id").val(),
						"db": $(".modal-body #db").val(),
						"sql-before": $(".modal-body #sql-before").val().replace(/"/g, '_##_').replace(/'/g, '#--#'),
						"sql-after": $(".modal-body #sql-after").val().replace(/"/g, '_##_').replace(/'/g, '#--#'),
						"json-user-params": $(".modal-body #json-user-params").val(),
						"checkbox-user-params": $(".modal-body #checkbox-user-params").val(),
						"get_loop-user-params": get_loop.join('","'),
						"loop-user-params": $(".modal-body #loop-user-params").val(),
						"radio-params-user": radio,
						"init-loop-integer-user-params": $(".modal-body #init-loop-integer-user-params").val(),
						"end-loop-integer-user-params": $(".modal-body #end-loop-integer-user-params").val(),
						"get_schema-name-user-params": get_sch.join('","'),
						"schema-name-user-params": $(".modal-body #schema-name-user-params").val(),
						"get_table-name-user-params": get_tbl.join('","'),
						"table-name-user-params": $(".modal-body #table-name-user-params").val(),
						"get_attr-name-user-params": get_attr.join('","'),
						"attr-name-user-params": $(".modal-body #attr-name-user-params").val(),
						
					}

					console.log(params)

			$.ajax({
					type: 'POST',
					async: false,
					data: params,
					url: '/gvsigonline/etl/set_workspace_parameters/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success	:function(response){

						$('#modal-set-parameters-workspace').modal('hide')

					},
					error: function(){}
				});

		});

		function runWorkspace(data){

			$.ajax({
				type: 'POST',
				async: false,
				data: {
					"id_ws": data[0],
					"username": '{{ user.username }}',
					'jsonCanvas': false
				},
				url: '/gvsigonline/etl/etl_read_canvas/',
				beforeSend:function(xhr){
					xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
				},
				success	:function(){},
				error: function(){}
			});

		}
			
		function openWorkspace(data){	
				
			location.href = '/gvsigonline/etl/etl_canvas/?lgid=' + data[0];
			
		}

		function deleteWorkspace(data){
			$('#button-delete-workspace-accept').click( function() {
				$.ajax({
					type: 'POST',
					async: false,
					data: {
						"lgid": data[0]
					},
					url: '/gvsigonline/etl/etl_workspace_delete/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success	:function(response){
						$('#modal-delete-workspace-etl').modal('hide');
						location.reload();
					},
					error: function(){}
				});
			});
		};

		function updateWorkspace(data){
			
			$('#update-etl-workspace').click( function() {

				updateData = {"id": data[0], 
							"name": $(".modal-body #etl_name").val(), 
							"description": $(".modal-body #etl_desc").val(), 
							"workspace": data[3],
							"day": $(".modal-body #ws-program-day").val(),
							"time": $(".modal-body #ws-program-time").val(),
							"interval": $(".modal-body #ws-program-interval").val(),
							"unit": $(".modal-body #ws-program-unit").val(),
							"username": username
						}

				if($("#repeat_periodically").is(':checked')){
					updateData["checked"] = true
				} else {
					updateData["checked"] = false
				}

				if($("#change_superuser").is(':checked')){
					updateData["superuser"] = true
				} else {
					updateData["superuser"] = true
				}

				$.ajax({
					type: 'POST',
					async: false,
					data: updateData,
					url: '/gvsigonline/etl/etl_workspace_update/',
					beforeSend:function(xhr){
						xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
					},
					success	:function(response){
						
						$('#modal-update-workspace-etl').modal('hide');
						if(response['exists']=="true"){
							$('#modal-ws-exists').modal('show')
						}else{
							location.reload();
						}
					},
					error: function(){}
				});
			});
		};
	});

    $('#button-ws-exists-accept').on('click', function(){
        $('#modal-ws-exists').modal('hide')
		if (upload == true){
			$('#modal-upload-workspace-etl').modal('show')
			upload = false
		}else{
			$('#modal-update-workspace-etl').modal('show')
		}
        

    })	


	$(".more-hour-options").slideUp("slow")
	
	$('#repeat_periodically').click(function() {

		if($("#repeat_periodically").is(':checked'))
			$(".repeat_periodically_time").slideDown("slow");  // checked
		else
			$(".repeat_periodically_time").slideUp("slow"); 
	});

	function edit_progamming_form(value){
		 if(value == "every"){
			 $(".more-options").slideDown("slow");  // checked
			 $(".more-hour-options").slideUp("slow"); 
		 }else{
			$(".more-options").slideUp("slow"); 
			$(".more-hour-options").slideDown("slow"); 
		 }
	}

	$('#ws-program-time').datetimepicker({
		format: 'HH:mm:ss' 
	});
	
	$('#ws-program-day').on('change', function() {
		edit_progamming_form($(this).val());
	});

    function actualizarInfoPanel(data){

		for(var i=0;i<data["workspaces"].length; i++){

			var workspace = data["workspaces"][i];
			var id = workspace["id_ws"];
			var msg = workspace["message"];
			var status = workspace['status'];

			if(status == ''){

				$("#icon-success-"+id).css("display", "none");
				$("#icon-running-"+id).css("display", "none");
				$("#icon-error-"+id).css("display", "none");

			}

			if(status == 'Running'){

				
				$("#icon-success-"+id).css("display", "none");
				$("#icon-running-"+id).css("display", "inline-block");
				$("#icon-running-"+id).attr("title", msg);
				$("#icon-error-"+id).css("display", "none");
				
			}
			if(status == 'Success'){

				$("#icon-success-"+id).css("display", "inline");
				$("#icon-success-"+id).attr("title", msg);
				$("#icon-running-"+id).css("display", "none");
				$("#icon-error-"+id).css("display", "none");

			}
			if(status == 'Error'){

				$("#icon-success-"+id).css("display", "none");
				$("#icon-running-"+id).css("display", "none");
				$("#icon-error-"+id).css("display", "inline");
				$("#icon-error-"+id).attr("title", msg);

			}
		}

    }

    function getCurrentCanvasStatus(){
		$.ajax({
			//type: 'GET',
        	type: 'POST',
			async: true,
		  	url: '/gvsigonline/etl/etl_list_canvas_status/',
		  	beforeSend:function(xhr){
		    	xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
		  	},
		  	success	:function(response){
		  		actualizarInfoPanel(response);  		
			},
		  	error: function(response){
				actualizarInfoPanel(response);	
		  	}
		});
		return false;
    }

	function startCurrentCanvasStatus(){
		interval = setInterval(function(){ 
			getCurrentCanvasStatus();
		}, 3000);
	}

    startCurrentCanvasStatus();
    getCurrentCanvasStatus()

</script>
<script type="text/javascript" src="{% static "js/lib/draw2d.js" %}"></script>
<script type="text/javascript" src="{% static "js/TableShape.js" %}"></script>

{% endblock %}